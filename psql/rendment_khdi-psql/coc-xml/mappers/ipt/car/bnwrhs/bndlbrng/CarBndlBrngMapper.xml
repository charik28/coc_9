<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="alpass.ipt.car.bnwrhs.bndlbrng.mapper.CarBndlBrngMapper">

    <!--
        [Rechercher] Consulter la liste de la demande d'introduction en bloc !== 일괄반입신청 목록 조회 ==!
        (Jeonghun Lee)
    -->
    <select id="selectBndlBrngRqstList" resultType="alpass.ipt.car.bnwrhs.bndlbrng.vo.CarBndlBrngRqstVo">
        /* alpass.ept.car.bnwrhs.bndlbrng.mapper.CarBndlBrngMapper.selectBndlBrngRqstList */
        <include refid="pagination.header" ></include>
           SELECT
                   A.BNDL_RLBR_RQNO                                 /** @TODO : 번역필요 !== 일괄반출입신청번호 ==! */
                 , A.RLBR_TP_CD                                     /** Code de catégorie d'introduction/sortie !== 반출입구분코드 ==! */
                 , A.JRSD_ORGN_CD                                   /** Code D'Unité Compétente !== 관할조직코드 ==! */
                 , TO_CHAR(A.RLBR_DTTM, 'DD/MM/YYYY') AS RLBR_DTTM  /** Date/Heure d'introduction/sortie !== 반출입일시 ==! */
                 , A.IBOBZ_CD                                       /** Code de zone sous douane !== 보세구역코드 ==! */
                 , C1.IBOBZ_NM                                      /** Code de zone sous douane !== 보세구역코드 ==! */
                 , A.RLBR_PT_CD                                     /** Code de type d'introduction/sortie !== 반출입유형코드 ==! */
                 , TO_CHAR(A.TRSN_DTTM, 'DD/MM/YYYY') AS TRSN_DTTM  /** Date et heure de transmission !== 전송일시 ==! */
                 , A.TRSN_CO_CD                                     /** Code d'entreprise transmettrice !== 전송업체코드 ==! */
                 , TO_CHAR(A.audt_dttm, 'DD/MM/YYYY') AS AUDT_DTTM  /**  Date De L'Étude  !== 심사일시 ==!  */
                 , A.AUDT_PT_CD                                     /**  Code De Type De Contrôle  !== 심사유형코드 ==!  */
                 , A.AUDT_RSLT_CN                                   /**  Contenu Du Résultat De La Vérification  !== 심사결과내용 ==!  */
                 , B.PRCS_STTS_CD                                   /**  Code De Statut De Traitement  !== 처리상태코드 ==!  */
                 , TO_CHAR(B.PRCS_DTTM, 'DD/MM/YYYY') AS PRCS_DTTM
                 , B.AUDT_EMP_ID                                    /**  ID de l'insepcteur  !== 심사직원ID ==!  */
                 , DECODE(C2.EMP_FMNM,NULL,C2.EMP_NM,C2.EMP_FMNM || ' ' ||C2.EMP_NM ) AS AUDT_EMP_NM                         /**  ID de l'insepcteur  !== 심사직원ID ==!  */
                 , (SELECT COUNT(*)
                    FROM   TB_CARE_RLBR Z
                    WHERE  Z.BNDL_RLBR_RQNO = A.BNDL_RLBR_RQNO
                    AND    Z.DEL_YN = 'N') AS BL_CNT                /** Nombre de B/L   !== BL개수 ==!    */
                 , A.DEL_YN                                         /** Suppression On !== 삭제여부 ==! */
                 , A.FRST_REGST_ID                                  /** Id Du Premier Enregistrant  !== 최초등록자ID ==! */
                 , A.FRST_RGSR_DTTM                                 /** Date Et Heure De Premier Enregistrement !== 최초등록일시 ==! */
                 , A.LAST_CHPR_ID                                   /** Id Du Modificateur Final !== 최종변경자ID ==! */
                 , A.LAST_CHG_DTTM                                  /** Date Et Heure De Modification Finale !== 최종변경일시 ==! */
                 , A.ATCH_FILE_ID
            FROM  TB_CARI_BNDL_RLBR A,
                  TB_CARI_CAG_PRCS_BRKD B,
                  TB_CARI_IBOBZ C1,
                  TB_POTI_EMP C2
            WHERE 1 = 1
            AND   A.BNDL_RLBR_RQNO      = B.CAG_RQST_NO(+)
            AND   B.CAG_RQST_TP_CD(+)   = DECODE(#{rlbrTpCd},'I','DCI','O','DCO','DCI')
            AND   B.RQST_DGCNT(+)       = 0
            AND   A.IBOBZ_CD            = C1.IBOBZ_CD(+)
            AND   B.AUDT_EMP_ID         = C2.PBSR_NO(+)
            AND   A.DEL_YN              = 'N'                          /** Suppression ON !== 삭제여부 ==! */

        <if test="prcsSttsCd != null and prcsSttsCd != ''">
            AND   B.PRCS_STTS_CD = #{prcsSttsCd} /**  Code De Statut De Traitement  !== 처리상태코드 ==!  */
        </if>

        <if test="rlbrPtCd != null and rlbrPtCd != ''">
            AND	  EXISTS (SELECT 1
            			  FROM ALPASSINT.TB_CARI_RLBR
            			  WHERE BNDL_RLBR_RQNO  = A.BNDL_RLBR_RQNO
            			  AND   RLBR_PT_CD = #{rlbrPtCd}
            			  AND   DEL_YN = 'N'
            			  ) /**  Code de catégorie d'introduction/sortie  !== 반출입구분코드 ==!  */
        </if>

        <if test="ibobzCd != null and ibobzCd != ''">
            AND   A.IBOBZ_CD = #{ibobzCd} /**  Code de zone sous douane  !== 보세구역코드 ==!  */
        </if>

        <if test="bndlRlbrRqno != null and bndlRlbrRqno != ''">
            AND   A.BNDL_RLBR_RQNO = #{bndlRlbrRqno}     /**  N° Demande D'Introduction/Sortie  !== 일괄반출입신청번호 ==!  */
        </if>

        <if test="mrn != null and mrn != ''">
            AND   EXISTS (SELECT 1
                          FROM   TB_CARI_RLBR Z
                          WHERE  Z.BNDL_RLBR_RQNO   = A.BNDL_RLBR_RQNO
                          AND    Z.DEL_YN           = 'N'
                          AND    Z.CAG_MGMT_NO LIKE #{mrn} || '%'  /**  MRN !== MRN ==!  */
                         )
        </if>

        <if test="cagMgmtNo != null and cagMgmtNo != ''">
            AND   EXISTS (SELECT 1
                          FROM   TB_CARI_RLBR Z
                          WHERE  Z.BNDL_RLBR_RQNO   = A.BNDL_RLBR_RQNO
                          AND    Z.DEL_YN           = 'N'
                          AND    Z.CAG_MGMT_NO      LIKE '%'||REPLACE(#{cagMgmtNo}, '-', '')||'%'      /**  CRN !== 화물관리번호 ==!  */
                         )
        </if>

        <if test="(trsnDttmFrom != null and trsnDttmFrom != '') and (trsnDttmTo != null and trsnDttmTo != '')">
            /**  Date de demande  !== 신청일자 ==!  */
            AND (
                  A.TRSN_DTTM <![CDATA[ >= ]]> TO_DATE(#{trsnDttmFrom}, 'DD/MM/YYYY')       /**  Date et heure de transmission  !== 전송일시 ==!  */
                  AND A.TRSN_DTTM <![CDATA[ <= ]]> TO_DATE(#{trsnDttmTo}, 'DD/MM/YYYY')+0.9999   /**  Date et heure de transmission  !== 전송일시 ==!  */
                )
        </if>

        <if test="(rlbrDttmFrom != null and rlbrDttmFrom != '') and (rlbrDttmTo != null and rlbrDttmTo != '')">
            /**  Date d’introduction  !== 반입일자   ==!  */
            AND (
		          A.RLBR_DTTM <![CDATA[ >= ]]> TO_DATE(#{rlbrDttmFrom}, 'DD/MM/YYYY') /**  Dateheure D'Entrée  !== 반입일시 ==!  */
		          AND A.RLBR_DTTM <![CDATA[ <= ]]> TO_DATE(#{rlbrDttmTo}, 'DD/MM/YYYY')+0.9999 /**  Dateheure D'Entrée  !== 반입일시 ==!  */
                )
        </if>

        <choose>
	        <when test="@alpass.ipt.car.com.util.CarMyBatisUtil@isEqualsStr(scrnTp, '1')">
	            AND B.PRCS_STTS_CD IN ('B02', 'D06', 'D08', 'D09', 'D10')
	            AND B.AUDT_EMP_ID  = #{pbsrNo}
	        </when>
            <otherwise>
                AND B.PRCS_STTS_CD IN ('B02', 'D01', 'D06', 'D08', 'D09', 'D10')
                AND A.JRSD_ORGN_CD LIKE SUBSTR(#{jrsdOrgnCd}, 1, 5) || '%'
            </otherwise>
        </choose>

        ORDER BY A.TRSN_DTTM DESC
        <include refid="pagination.footer" ></include>
    </select>


    <!--
        [Rechercher] Consulter les détails de la demande d'introduction en bloc !== 일괄반입신청 내역 조회 ==!
        (Jeonghun Lee)
    -->
    <select id="selectBndlBrngRqst" resultType="alpass.ipt.car.bnwrhs.bndlbrng.vo.CarBndlBrngRqstVo">
        /* alpass.ipt.car.bnwrhs.bndlbrng.mapper.CarBndlBrngMapper.selectBndlBrngRqst */
        SELECT
              A.BNDL_RLBR_RQNO                                           /**  N° Demande D'Introduction/Sortie  !== 일괄반출입신청번호 ==!  */
            , A.RLBR_TP_CD                                               /** Code de catégorie d'introduction/sortie !== 반출입구분코드 ==! */
            , A.JRSD_ORGN_CD                                             /** Code D'Unité Compétente !== 관할조직코드 ==! */
            , TO_CHAR(A.RLBR_DTTM, 'DD/MM/YYYY') AS RLBR_DTTM            /** Date/Heure d'introduction/sortie !== 반출입일시 ==! */
            , A.IBOBZ_CD                                                 /** Code de zone sous douane !== 보세구역코드 ==! */
            , A.RLBR_PT_CD                                               /** Code de type d'introduction/sortie !== 반출입유형코드 ==! */
            , TO_CHAR(A.TRSN_DTTM, 'DD/MM/YYYY HH24:mi:ss') AS TRSN_DTTM /**  Date et heure de transmission  !== 전송일시 ==!  */
            , A.TRSN_CO_CD                                               /** Code d'entreprise transmettrice !== 전송업체코드 ==! */
			, TO_CHAR(A.AUDT_DTTM, 'DD/MM/YYYY HH24:mi:ss') AS AUDT_DTTM /** Date Et Heure De Traitement !== 처리일시 ==! */
			, A.AUDT_PT_CD                                               /**  Code De Type De Contrôle  !== 심사유형코드 ==!  */
			, A.AUDT_RSLT_CN                                             /**  Contenu Du Résultat De La Vérification  !== 심사결과내용 ==!  */
            , A.DEL_YN                                                   /** Suppression On !== 삭제여부 ==! */
            , B.PRCS_STTS_CD                /**  Code De Statut De Traitement  !== 처리상태코드 ==!  */
            , B.AUDT_EMP_ID             /**  ID de l'insepcteur  !== 심사직원ID ==!  */
            , A.ATCH_FILE_ID
        FROM  TB_CARI_BNDL_RLBR A,
              TB_CARI_CAG_PRCS_BRKD B
       WHERE  A.BNDL_RLBR_RQNO      = B.CAG_RQST_NO(+)
         AND  A.DEL_YN = 'N'                              /** Suppression ON !== 삭제여부 ==! */
         AND  B.CAG_RQST_TP_CD(+)   =  DECODE(#{rlbrTpCd},'I','DCI','O','DCO','DCI')
         AND  B.RQST_DGCNT(+)       = 0
         AND  B.DEL_YN(+)           = 'N'
         AND  A.BNDL_RLBR_RQNO = #{bndlRlbrRqno}          /**  N° Demande D'Introduction/Sortie  !== 일괄반출입신청번호 ==!  */
    </select>

    <!--
        [Rechercher] Consulter la liste de la demande d'introduction !== 반입신청 목록 조회 ==!
        (Jeonghun Lee)
    -->
   <select id="selectBrngRqstList" parameterType="alpass.ipt.car.bnwrhs.bndlbrng.vo.CarBndlBrngRqstVo" resultType="alpass.ipt.car.bnwrhs.bndlbrng.vo.CarBrngRqstVo">
        /* alpass.ipt.car.bnwrhs.bndlbrng.mapper.CarBndlBrngMapper.selectBrngRqstList */
        <if test="allData == null or allData == '' or !allData.equals('Y') ">
            <include refid="pagination.header" ></include>
        </if>
        SELECT
              A.RLBR_RQST_NO                                                        /**  N° Demande D'Introduction/Sortie           !== 반출입신청번호 ==!  */
            , A.RLBR_TP_CD                                                          /**  Code de catégorie d'introduction/sortie    !== 반출입구분코드 ==!  */
            , A.JRSD_ORGN_CD                                                        /**  Code D'Unité Compétente                    !== 관할조직코드 ==!  */
            , TO_CHAR(A.RLBR_DTTM, 'DD/MM/YYYY HH24:mi') AS RLBR_DTTM               /**  Date/Heure d'introduction/sortie           !== 반출입일시 ==!  */
            , A.IBOBZ_CD                                                            /**  Code de zone sous douane                   !== 보세구역코드 ==!  */
            , A.RLBR_PT_CD                                                          /**  Code de type d'introduction/sortie         !== 반출입유형코드 ==!  */
            , A.CAG_MGMT_NO                                                         /**  Crn                                        !== 화물관리번호 ==!  */
            , A.BL_NO                                                               /**  N° De Bl                                   !== BL번호 ==!  */
            , A.RLBR_PCKG_GCNT                                                      /**  Nombre de colis d'introduction/sortie      !== 반출입포장개수 ==!  */
            , A.RLBR_WGHT                                                           /**  Poids d'introduction/sortie                !== 반출입중량 ==!  */
            , A.DIVD_TP_CD                                                          /**  Code De Type D'Éclatement                  !== 분할구분코드 ==!  */
            , A.BRNG_ACDN_PT_CD                                                     /**  Code de type d'accident de l'introduction  !== 반입사고유형코드 ==!  */
            , A.BRNG_ACDN_GCNT                                                      /**  Nombre d'accident d'introduction           !== 반입사고개수 ==!  */
            , A.BRNG_ACDN_WGHT                                                      /**  Poids d'accident d'introduction            !== 반입사고중량 ==!  */
            , TO_CHAR(A.TRSN_DTTM, 'DD/MM/YYYY') AS TRSN_DTTM                       /**  Date et heure de transmission              !== 전송일시 ==!  */
            , A.TRSN_CO_CD                                                          /**  Code d'entreprise transmettrice            !== 전송업체코드 ==!  */
            , A.AUDT_EMP_ID                                                         /**  ID de l'insepcteur                         !== 심사직원ID ==!  */
            , TO_CHAR(A.AUDT_DTTM, 'DD/MM/YYYY HH24:mi:ss') AS AUDT_DTTM            /**  Date De L'Étude                            !== 심사일시 ==!  */
            , A.AUDT_PT_CD                                                          /**  Code De Type De Contrôle                   !== 심사유형코드 ==!  */
            , A.AUDT_RSLT_CN                                                        /**  Contenu Du Résultat De La Vérification     !== 심사결과내용 ==!  */
            , A.DEL_YN                                                              /**  Suppression On                             !== 삭제여부 ==!  */
            , A.FRST_REGST_ID                                                       /**  Id Du Premier Enregistrant                 !== 최초등록자ID ==!  */
            , TO_CHAR(A.FRST_RGSR_DTTM, 'DD/MM/YYYY') AS FRST_RGSR_DTTM             /**  Date Et Heure De Premier Enregistrement    !== 최초등록일시 ==!  */
            , A.LAST_CHPR_ID                                                        /**  Id Du Modificateur Final                   !== 최종변경자ID ==!  */
            , TO_CHAR(A.LAST_CHG_DTTM, 'DD/MM/YYYY') AS LAST_CHG_DTTM               /**  Date Et Heure De Modification Finale       !== 최종변경일시 ==!  */
            , A.RELA_NO                                                             /**  Numéro Concerné                            !== 관련번호 ==!  */
            , A.PCKG_UT_CD                                                          /**  Code De L'Unité De Colis                   !== 포장단위코드 ==!  */
            , A.PDLS_NM                                                             /**  Description commerciale                    !== 품목명 ==!     */
            , A.BNDL_RLBR_RQNO                                                      /** N° demande d'introduction/sortie en bloc !== 일괄반출입신청번호 ==! */
			, (	SELECT A1.EXP_CMDT_BRNG_RQNO
				FROM ALPASSEXT.TB_CARE_RLBR_PRNG A1
				   , ALPASSEXT.TB_CARE_RLBR B1
				WHERE A1.RLBR_PRNG_NO = B1.RLBR_PRNG_NO
				AND   B1.RLBR_RQST_NO = A.RLBR_RQST_NO
				AND   A1.DEL_YN = 'N' ) AS EXP_CMDT_BRNG_RQNO
        FROM  TB_CARI_RLBR A
        WHERE A.DEL_YN = 'N'
        AND   A.BNDL_RLBR_RQNO = #{bndlRlbrRqno}
        ORDER BY A.CAG_MGMT_NO DESC
        <if test="allData == null or allData == '' or !allData.equals('Y') ">
            <include refid="pagination.footer" ></include>
        </if>
    </select>

    <!--
        [Modifier] Modification des infos de contrôle sur la demande d'introduction en bloc !==일괄 반입 신청 심사정보 수정==!
        (Jeonghun Lee)
    -->
    <update id="updateBndlBrngAudt" parameterType="alpass.ipt.car.bnwrhs.bndlbrng.vo.CarBndlBrngRqstVo">
        /* alpass.ipt.car.bnwrhs.bndlbrng.mapper.CarBndlBrngMapper.updateBndlBrngAudt */
        UPDATE TB_CARI_BNDL_RLBR
        SET    LAST_CHPR_ID     = #{lastChprId} /**  Id Du Modificateur Final  !== 최종변경자ID ==!  */
             , LAST_CHG_DTTM    = SYSTIMESTAMP  /**  Date Et Heure De Modification Finale  !== 최종변경일시 ==!  */
	         , AUDT_DTTM        = TO_DATE(#{audtDttm}, 'DDMMYYYYHH24MISS')
             , AUDT_PT_CD       = #{audtPtCd}
             , AUDT_RSLT_CN     = #{audtRsltCn}
        WHERE  BNDL_RLBR_RQNO   = #{bndlRlbrRqno} /**  N° demande d'introduction/sortie en bloc  !== 일괄반출입신청번호 ==!  */
    </update>

	<!--
        [Modifier] Modification des infos de contrôle sur la demande d'introduction en bloc !==일괄 반입 신청 심사정보 수정==!
        (Jeonghun Lee)
	-->
    <update id="updateBndlBrngAudtForEpt" parameterType="alpass.ipt.car.bnwrhs.bndlbrng.vo.CarBndlBrngRqstVo">
        /* alpass.ipt.car.bnwrhs.bndlbrng.mapper.CarBndlBrngMapper.updateBndlBrngAudt */
	    UPDATE TB_CARE_BNDL_RLBR
	    SET    PRCS_STTS_CD    = DECODE(#{audtPtCd}, 'O', 'D08', 'D09')
		     , PRCS_DTTM      = TO_DATE(#{audtDttm}, 'DDMMYYYYHH24MISS')
		     , LAST_CHPR_ID   = #{lastChprId}
		     , LAST_CHG_DTTM  = SYSTIMESTAMP
	    WHERE  BNDL_RLBR_RQNO = #{bndlRlbrRqno} /**  N° demande d'introduction/sortie en bloc  !== 일괄반출입신청번호 ==!  */
    </update>


</mapper>
