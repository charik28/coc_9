<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="alpass.ipt.car.dfsh.mgmt.mapper.CarDfshMgmtMapper">

  <!--
   Consulter la liste des déclarations d'introduction (magasin hors taxe) !==반입 신고서 (면세점) 목록을 조회==!
  -->
  <select id="selectDfshBrngApfmList"
          parameterType="alpass.ipt.car.dfsh.mgmt.vo.CarDfshBrngRqstVo"
          resultType="alpass.ipt.car.dfsh.mgmt.vo.CarDfshBrngRqstVo">
    /* alpass.ipt.car.dfsh.mgmt.mapper.CarDfshMgmtMapper.selectDfshBrngApfmList */
    <include refid="pagination.header"/>
    SELECT TCDBR.BRNG_RQST_NO              /* N° de demande d’introduction !== 반입신고번호 ==! */
         , TO_CHAR(TO_DATE(TCDBR.BRNG_DT, 'YYYYMMDD'),'DD/MM/YYYY') AS BRNG_DT /* Date D'Entrée !== 반입일자 ==! */
         , TO_CHAR(TCDBR.TRSN_DTTM,'DD/MM/YYYY') AS TRSN_DTTM /* Date et heure de transmission !== 전송일시 ==! */
         , TCCPB.PRCS_STTS_CD              /* Code De Statut De Traitement !== 처리상태코드 ==! */
         , TCDBR.IBOBZ_CD                  /* Code de zone sous douane !== 보세구역코드 ==! */
         , tcdbr.JRSD_ORGN_CD              /* Code D'Unité Compétente !== 관할조직코드 ==! */
         , TCDBR.ATCH_FILE_ID              /* Id Du Fichier Joint !== 첨부파일ID ==! */
         , (SELECT LTRIM(CONCAT(EMP_FMNM,' ',EMP_NM))
              FROM TB_POTI_EMP L
             WHERE L.DEL_YN = 'N'
               AND L.PBSR_NO = TCCPB.AUDT_EMP_ID)   AS AUDT_EMP_NM /** Nom du la personne vérifiant !== 심사직원명==! */
         , TCCPB.AUDT_EMP_ID               /* ID de l'insepcteur !== 심사직원ID ==! */
         , TCDBR.AUDT_PT_CD                /* Code De Type De Contrôle !== 심사유형코드 ==! */
         , TO_CHAR(TCDBR.LAST_CHG_DTTM,'DD/MM/YYYY') AS LAST_CHG_DTTM /* Date Et Heure De Modification Finale !== 최종변경일시 ==! */
      FROM TB_CARI_DFSH_BRNG_RQST TCDBR  /* CARI_MAGASIN HORS TAXE_DEMANDE D'INTRODUCTION !== CARI_면세점_반입신고 ==! */
      JOIN TB_CARI_CAG_PRCS_BRKD TCCPB
        ON TCCPB.CAG_RQST_NO = tcdbr.BRNG_RQST_NO
       AND TCCPB.CAG_RQST_TP_CD = 'XCI'
       AND TCCPB.RQST_DGCNT = 0
     WHERE 1=1
    <if test="searBrngRqstNo != null and searBrngRqstNo != ''">
       AND TCDBR.BRNG_RQST_NO LIKE CONCAT(#{searBrngRqstNo},'%')
    </if>
    <if test="searPrcsSttsCd != null and searPrcsSttsCd != ''">
       AND TCCPB.PRCS_STTS_CD = #{searPrcsSttsCd}
    </if>
    <if test="searIbobzCd != null and searIbobzCd != ''">
       AND TCDBR.IBOBZ_CD = #{searIbobzCd}
    </if>
    <if test="searJrsdOrgnCd != null and searJrsdOrgnCd != ''">
       AND TCDBR.JRSD_ORGN_CD = #{searJrsdOrgnCd}
    </if>
    <if test="searchKeywordFrom != '' and searchKeywordTo != '' and searchKeywordFrom != null and searchKeywordTo != null">
       AND TO_DATE(TCDBR.BRNG_DT, 'YYYYMMDD') BETWEEN TO_DATE(#{searchKeywordFrom},'DD/MM/YYYY') AND TO_DATE(#{searchKeywordTo},'DD/MM/YYYY')
    </if>
    <if test="searItmCd != '' and searItmCd != null">
       AND EXISTS (SELECT 1
                     FROM TB_CARI_DFSH_BRNG_RQST_PDLS TCDBRP
                    WHERE TCDBR.BRNG_RQST_NO = TCDBRP.BRNG_RQST_NO
                      AND TCDBRP.ITM_CD = #{searItmCd})
    </if>
    <if test="searHsCd != '' and searHsCd != null">
       AND EXISTS (SELECT 1
                     FROM TB_CARI_DFSH_BRNG_RQST_PDLS TCDBRP
                    WHERE TCDBR.BRNG_RQST_NO = TCDBRP.BRNG_RQST_NO
                      AND TCDBRP.HS_CD = #{searHsCd})
    </if>
    <if test="searBlNo != '' and searBlNo != null">
       AND EXISTS (SELECT 1
                     FROM TB_CARI_DFSH_BRNG_RQST_PDLS TCDBRP
                    WHERE TCDBR.BRNG_RQST_NO = TCDBRP.BRNG_RQST_NO
                      AND TCDBRP.BL_NO = #{searBlNo})
    </if>
   <choose>
       <when test="@alpass.ipt.car.com.util.CarMyBatisUtil@isEqualsStr(scrnTp,'1')">
   AND TCCPB.PRCS_STTS_CD IN ('B02', 'D08', 'D09')
       </when>
       <otherwise>
   AND TCCPB.PRCS_STTS_CD IN ('D01','B02', 'D08', 'D09')
       </otherwise>
   </choose>
     <choose>
         <when test="roleId.equals('CAR086'.toString())">
             AND TCCPB.AUDT_EMP_ID  = #{pbsrNo}
         </when>
         <otherwise>
             AND TCCPB.JRSD_ORGN_CD LIKE SUBSTR(#{jrsdOrgnCd}, 1, 5) || '%'
         </otherwise>
     </choose>
     ORDER BY TCDBR.LAST_CHG_DTTM DESC
    <include refid="pagination.footer"/>
  </select>

  <!--
   Consulter les infos détaillées de la déclaration d'introduction (magasin hors taxe) !==반입 신고서 (면세점) 상세정보를 조회==!
  -->
  <select id="selectDfshBrngApfm"
    parameterType="alpass.ipt.car.dfsh.mgmt.vo.CarDfshBrngRqstVo"
    resultType="alpass.ipt.car.dfsh.mgmt.vo.CarDfshBrngRqstVo">
    /* alpass.ipt.car.dfsh.mgmt.mapper.CarDfshMgmtMapper.selectDfshBrngApfm */
    SELECT TCDBR.BRNG_RQST_NO              /* N° de demande d’introduction !== 반입신고번호 ==! */
         , TO_CHAR(TO_DATE(TCDBR.BRNG_DT, 'YYYYMMDD'),'DD/MM/YYYY') AS BRNG_DT /* Date D'Entrée !== 반입일자 ==! */
         , TO_CHAR(TCDBR.TRSN_DTTM,'DD/MM/YYYY') AS TRSN_DTTM /* Date et heure de transmission !== 전송일시 ==! */
         , TCDBR.RELA_NO                   /* Numéro Concerné !== 관련번호 ==! */
         , (SELECT DISTINCT CAG_MGMT_NO
            FROM TB_CARE_DFSH_BRNG_RQST_PDLS TCDBRP
            WHERE TCDBRP.BRNG_RQST_NO = TCDBR.BRNG_RQST_NO
              AND TCDBRP.DEL_YN = 'N') AS CAG_MGMT_NO
         , (SELECT DISTINCT BL_NO
            FROM TB_CARE_DFSH_BRNG_RQST_PDLS TCDBRP
            WHERE TCDBRP.BRNG_RQST_NO = TCDBR.BRNG_RQST_NO
              AND TCDBRP.DEL_YN = 'N') AS BL_NO
         , D.PCKG_GCNT
         , D.TTWG
         , D.NTWG
         , TCDBR.TRSN_CO_CD                /* Code d'entreprise transmettrice !== 전송업체코드 ==! */
         , TCCDC.CO_NM AS TRSN_CO_NM       /* Nom de l'entreprise transmettrice !== 전송업체명 ==! */
         , TCCPB.PRCS_STTS_CD              /* Code De Statut De Traitement !== 처리상태코드 ==! */
         , TCDBR.IBOBZ_CD                  /* Code de zone sous douane !== 보세구역코드 ==! */
         , C.JRSD_CSTM_CD         /* Code de bureau compétent !== 관할세관코드 ==! */
         , TCDBR.JRSD_ORGN_CD              /* Code D'Unité Compétente !== 관할조직코드 ==! */
         , TCDBR.ATCH_FILE_ID              /* Id Du Fichier Joint !== 첨부파일ID ==! */
         , TCCPB.AUDT_EMP_ID               /* ID de l'insepcteur !== 심사직원ID ==! */
         , TCDBR.AUDT_PT_CD                /* Code De Type De Contrôle !== 심사유형코드 ==! */
         , TO_CHAR(TCDBR.AUDT_DTTM,'DD/MM/YYYY') AS AUDT_DT /* Date et heure De Contrôle !== 심사일시 ==! */
         , TCDBR.AUDT_RSLT_CN               /* Contenu Du Résultat De La Vérification !== 심사결과내용 ==! */
         , TO_CHAR(TCDBR.LAST_CHG_DTTM,'DD/MM/YYYY') AS LAST_CHG_DTTM /* Date Et Heure De Modification Finale !== 최종변경일시 ==! */
      FROM ALPASSINT.TB_CARI_DFSH_BRNG_RQST TCDBR          /* CARE_MAGASIN HORS TAXE_DEMANDE D'INTRODUCTION !== CARE_면세점_반입신고 ==! */
      JOIN TB_CARI_CAG_PRCS_BRKD TCCPB
        ON TCCPB.CAG_RQST_NO = TCDBR.BRNG_RQST_NO
       AND TCCPB.RQST_DGCNT = 0
      LEFT OUTER JOIN (SELECT K1.CO_NM
                            , K1.RPRS_TLPH_NO
                            , K1.CO_ADDR
                            , K2.CO_DCLR_CD
                         FROM TB_COM_CO         K1,
                              TB_COM_CO_DCLR_CD K2
                        WHERE K1.NIF = K2.NIF
                          AND K1.DEL_YN = 'N'
                          AND K2.DEL_YN = 'N'
                          AND K2.RQST_TP_CD IN ('01','02') /* 신규나/수정 상태*/
                          AND K2.PRCS_STTS_CD = 'O' /* 업체  승인상태 */
                          AND K2.USE_YN = 'Y' /* 사용여부 */) TCCDC
        ON TCDBR.TRSN_CO_CD = TCCDC.CO_DCLR_CD
      LEFT JOIN ( SELECT C1.ORGN_CD
                       , C2.ORGN_CD JRSD_CSTM_CD
                   FROM TB_POTI_ORGN C1
                   LEFT JOIN  TB_POTI_ORGN C2
                     ON C1.UPR_ORGN_MGMT_CD = C2.ORGN_MGMT_CD
                  WHERE C1.DEL_YN = 'N'
      ) C
        ON TCDBR.JRSD_ORGN_CD = C.ORGN_CD
      LEFT JOIN (
          SELECT DISTINCT PCKG_GCNT, TTWG, NTWG, BRNG_RQST_NO
            FROM TB_CARI_CAG_DCSH_BL A
               , TB_CARE_DFSH_BRNG_RQST_PDLS B
           WHERE A.CAG_MGMT_NO = B.CAG_MGMT_NO
             AND A.DEL_YN = 'N'
             AND B.DEL_YN = 'N'
      ) D
        ON TCDBR.BRNG_RQST_NO = D.BRNG_RQST_NO
     WHERE TCDBR.BRNG_RQST_NO = #{brngRqstNo}
  </select>

  <!--
   Consulter la liste des infos sur l'article de la déclaration d'introduction (magasin hors taxe) !==반입 신고서 (면세점) 품목정보목록을 조회==!
  -->
  <select id="selectDfshBrngApfmPdlsList"
    parameterType="alpass.ipt.car.dfsh.mgmt.vo.CarDfshBrngRqstVo"
    resultType="alpass.ipt.car.dfsh.mgmt.vo.CarDfshBrngRqstPdlsVo">
    /* alpass.ipt.car.dfsh.mgmt.mapper.CarDfshMgmtMapper.selectDfshBrngApfmPdlsList */
    SELECT BRNG_RQST_NO          /* N° de demande d’introduction !== 반입신고번호 ==! */
         , BRNG_RQST_SRNO        /* N° série de la demande d'introduction !== 반입신고일련번호 ==! */
         , CAG_MGMT_NO           /* Crn !== 화물관리번호 ==! */
         , BL_NO                 /** N° de BL !===BL번호==! */
         , DFSH_TP_CD            /* Code de type de magasin hors taxes !== 면세점구분코드 ==! */
         , ITM_CD                /* Code D'Article !== 아이템코드 ==! */
         , (SELECT ITM_NM        /* Nom D'Article !== 아이템명 ==! */
              FROM TB_CARI_ITM_CD tcic
             WHERE TCIC.ITM_CD = TCDBRP.ITM_CD
               AND TCIC.DFSH_TP_CD = TCDBRP.DFSH_TP_CD) AS ITM_NM
         , HS_CD                 /* Code Sh !== HS코드 ==! */
         , (SELECT HS_DESC       /* Description Du Sh !== HS설명 ==! */
              FROM TB_CLRI_HS_CD TCHC
             WHERE TCHC.DEL_YN = 'N'
               AND TCHC.HS_CD = TCDBRP.HS_CD
               AND TO_CHAR(SYSTIMESTAMP, 'YYYYMMDD') BETWEEN TCHC.HS_APLY_STRT_DT AND TCHC.HS_APLY_END_DT) AS HS_DESC
         , UT_PRC                /* Prix Unitaire !== 단위가격 ==! */
         , CURR_CD               /* Code De Devise !== 통화코드 ==! */
         , BRNG_GCNT             /* Nombre d'introductions !== 반입개수 ==! */
         , (SELECT MSRM_UT_CD
              FROM TB_CARI_ITM_CD TCIC
             WHERE TCDBRP.ITM_CD = TCIC.ITM_CD
               AND TCDBRP.DFSH_TP_CD = TCIC.DFSH_TP_CD
           ) AS MSRM_UT_CD       /* Code d'unité de mesure !== 측정단위코드 ==!  */
         , DEL_YN                /* Suppression On !== 삭제여부 ==! */
         , FRST_REGST_ID         /* Id Du Premier Enregistrant  !== 최초등록자ID ==! */
         , FRST_RGSR_DTTM        /* Date Et Heure De Premier Enregistrement !== 최초등록일시 ==! */
         , LAST_CHPR_ID          /* Id Du Modificateur Final !== 최종변경자ID ==! */
         , LAST_CHG_DTTM         /* Date Et Heure De Modification Finale !== 최종변경일시 ==! */
      FROM TB_CARI_DFSH_BRNG_RQST_PDLS	TCDBRP /* CARE_MAGASIN HORS TAXE_DEMANDE D'INTRODUCTION_ARTICLE !== CARE_면세점_반입신고_품목 ==! */
     WHERE 1=1
       AND TCDBRP.BRNG_RQST_NO	= #{brngRqstNo}			/* N° de demande d’introduction !== 반입신고번호 ==! */
     ORDER BY TCDBRP.BRNG_RQST_SRNO
  </select>

  <!--
 Enregistrer le résultat du contrôle de la déclaration d'introduction (magasin hors taxe) !==반입 신고서 (면세점) 심사결과 등록==!
  -->
  <update id="updateCarBrngApfmAudt"
          parameterType="alpass.ipt.car.dfsh.mgmt.vo.CarDfshBrngRqstVo">
    /* alpass.ipt.car.dfsh.mgmt.mapper.CarDfshMgmtMapper.updateCarBrngApfmAudt */
    UPDATE TB_CARI_DFSH_BRNG_RQST
       SET AUDT_PT_CD     =	#{audtPtCd}   /* Code De Type De Contrôle !== 심사유형코드 ==! */
    <if test="audtDt != '' and audtDt != null">
         , AUDT_DTTM      = SYSTIMESTAMP   /* Date et heure De Contrôle !== 심사일시 ==! */
    </if>
    <if test="audtRsltCn != '' and audtRsltCn != null">
         , AUDT_RSLT_CN    =	#{audtRsltCn}   /* Contenu Du Résultat De La Vérification !== 심사결과내용 ==! */
    </if>
         , DEL_YN         =	'N'   /* Suppression On !== 삭제여부 ==! */
         , LAST_CHPR_ID   =	#{lastChprId}   /* Id Du Modificateur Final !== 최종변경자ID ==! */
         , LAST_CHG_DTTM  =	SYSTIMESTAMP   /* Date Et Heure De Modification Finale !== 최종변경일시 ==! */
    WHERE BRNG_RQST_NO =	#{brngRqstNo}   /* N° de demande d’introduction !== 반입신고번호 ==! */
  </update>

  <!--
 Modifier l'état de traitement de la déclaration d'introduction (magasin hors taxe). !==외부 반입 신고서 (면세점) 처리상태 변경==!
  -->
  <update id="updateEptCarDfshBrngApfm"
          parameterType="alpass.ipt.car.dfsh.mgmt.vo.CarDfshBrngRqstVo">
    /* alpass.ipt.car.dfsh.mgmt.mapper.CarDfshMgmtMapper.updateEptCarDfshBrngApfm */
    UPDATE TB_CARE_DFSH_BRNG_RQST A            /* CARE_MAGASIN HORS TAXE_DEMANDE D'INTRODUCTION !== CARE_면세점_반입신고 ==! */
       SET A.PRCS_STTS_CD  = #{prcsSttsCd}    /* Code De Statut De Traitement !== 처리상태코드 ==! */
         , A.LAST_CHPR_ID  = B.LAST_CHPR_ID    /* Id Du Modificateur Final !== 최종변경자ID ==! */
         , A.LAST_CHG_DTTM = B.LAST_CHG_DTTM   /* Date Et Heure De Modification Finale !== 최종변경일시 ==! */
      FROM TB_CARI_DFSH_BRNG_RQST B            /* CARI_MAGASIN HORS TAXE_DEMANDE D'INTRODUCTION !== CARI_면세점_반입신고 ==! */
     WHERE A.BRNG_RQST_NO = B.BRNG_RQST_NO	   /* N° de demande d’introduction !== 반입신고번호 ==! */
       AND A.BRNG_RQST_NO = #{brngRqstNo}
  </update>

  <!--
  Sauvegarder l'historique de la déclaration d'introduction !== 반입신고서 이력 저장 ==!
  -->
  <insert id="insertDfshRlbrHist"
          parameterType="alpass.ipt.car.dfsh.mgmt.vo.CarDfshRlbrHistVo">
    /* alpass.ipt.car.dfsh.mgmt.mapper.CarDfshMgmtMapper.insertDfshRlbrHist */
    INSERT INTO TB_CARI_DFSH_RLBR_H
    (
         RLBR_HIST_MGMT_NO           /* N° de gestion d'historique d'introduction/sortie !== 반출입이력관리번호 ==! */
        ,RLBR_TP_CD                  /* Code de catégorie d'introduction/sortie !== 반출입구분코드 ==! */
        ,IBOBZ_CD                    /* Code de zone sous douane !== 보세구역코드 ==! */
        ,JRSD_ORGN_CD                /* Code D'Unité Compétente !== 관할조직코드 ==! */
        ,RLBR_DT                   /* Date/Heure d'introduction/sortie !== 반출입일시 ==! */
        ,RLBR_RPRT_PT_CD             /* Code de type de rapport d'introduction/sortie !== 반출입보고유형코드 ==! */
        ,RELA_NO                     /* Numéro Concerné !== 관련번호 ==! */
        ,DEL_YN                      /* Suppression On !== 삭제여부 ==! */
        ,FRST_REGST_ID               /* Id Du Premier Enregistrant  !== 최초등록자ID ==! */
        ,FRST_RGSR_DTTM              /* Date Et Heure De Premier Enregistrement !== 최초등록일시 ==! */
        ,LAST_CHPR_ID                /* Id Du Modificateur Final !== 최종변경자ID ==! */
        ,LAST_CHG_DTTM               /* Date Et Heure De Modification Finale !== 최종변경일시 ==! */
    )
    VALUES
    (
         #{rlbrHistMgmtNo}
        ,#{rlbrTpCd}
        ,#{ibobzCd}
        ,#{jrsdOrgnCd}
        ,TO_CHAR(TO_DATE(#{rlbrDt}, 'dd/MM/yyyy'), 'yyyyMMdd')
        ,#{rlbrRprtPtCd}
        ,#{relaNo}
        ,'N'
        ,#{frstRegstId}
        ,SYSTIMESTAMP
        ,#{lastChprId}
        ,SYSTIMESTAMP
    )
  </insert>

  <!--
  Sauvegarder l'historique de l'article de la déclaration d'introduction !== 반입신고서 품목 이력 저장 ==!
  -->
  <insert id="insertDfshRlbrHistDtl"
    parameterType="alpass.ipt.car.dfsh.mgmt.vo.CarDfshRlbrHistDtlVo">
    /* alpass.ipt.car.dfsh.mgmt.mapper.CarDfshMgmtMapper.insertDfshRlbrHistDtl */
    INSERT INTO TB_CARI_DFSH_RLBR_H_D
    (
        RLBR_HIST_MGMT_NO     /* N° de gestion d'historique d'introduction/sortie !== 반출입이력관리번호 ==! */
        ,HIST_SRNO             /* N° de sequence de l'historique !== 이력일련번호 ==! */
        ,ITM_CD                /* Code D'Article !== 아이템코드 ==! */
        ,HS_CD                 /* Code Sh !== HS코드 ==! */
        ,RLBR_GCNT             /* Nombre d'introductions/sorties !== 반출입개수 ==! */
        ,DEL_YN                /* Suppression On !== 삭제여부 ==! */
        ,FRST_REGST_ID         /* Id Du Premier Enregistrant  !== 최초등록자ID ==! */
        ,FRST_RGSR_DTTM        /* Date Et Heure De Premier Enregistrement !== 최초등록일시 ==! */
        ,LAST_CHPR_ID          /* Id Du Modificateur Final !== 최종변경자ID ==! */
        ,LAST_CHG_DTTM         /* Date Et Heure De Modification Finale !== 최종변경일시 ==! */
    )
    VALUES
    (
        #{rlbrHistMgmtNo}
        ,#{histSrno}
        ,#{itmCd}
        ,#{hsCd}
        ,#{rlbrGcnt}
        ,'N'
        ,#{frstRegstId}
        ,SYSTIMESTAMP
        ,#{lastChprId}
        ,SYSTIMESTAMP
    )
  </insert>

	<!--
	Saisir le stock avec l'historique des introductions/sorties des marchandises en magasin hors taxe. !==화물 면세점 반출입 이력으로 재고를 입력한다.==!
	-->
	<insert id="insertMergeDfshInvnByRlbrH"
    parameterType="alpass.ipt.car.dfsh.mgmt.vo.CarDfshRlbrHistVo">
    /* alpass.ipt.car.dfsh.mgmt.mapper.CarDfshMgmtMapper.insertMergeDfshInvnByRlbrH */
    WITH MERGED AS (
    UPDATE TB_CARI_DFSH_INVN A
       SET DEL_YN = 'N'
         , LAST_CHPR_ID  = #{lastChprId}
         , LAST_CHG_DTTM = SYSTIMESTAMP
         , BRNG_GCNT     = A.BRNG_GCNT + DECODE(B.RLBR_TP_CD, 'I', B.RLBR_GCNT, 0) /** Nombre d'entrées !==반입개수==! */
         , RLSE_GCNT     = A.RLSE_GCNT + DECODE(B.RLBR_TP_CD, 'O', B.RLBR_GCNT, 0) /** Nombre de sorties !==반출개수==! */
      FROM (SELECT B1.RLBR_HIST_MGMT_NO     /** N° de gestion d'historique d'entrée/sortie !==반출입이력관리번호==! */
                 , B1.RLBR_TP_CD            /** Code de catégorie d'entrée/sortie !==반출입구분코드==! */
                 , B1.IBOBZ_CD              /* Code de zone sous douane !== 보세구역코드 ==! */
                 , B1.RLBR_DT               /* Date D'Entrée/Sortie !== 반출입일자 ==! */
                 , B1.RLBR_RPRT_PT_CD       /** Code de type de rapport d'entrée/sortie !==반출입보고유형코드==! */
                 , B1.RELA_NO               /** N˚ de référence !==관련번호==! */
                 , B2.HIST_SRNO             /** N° de séquence de l'histoire !==이력일련번호==! */
                 , B2.ITM_CD                /** Code d'article !==아이템코드==! */
                 , B2.HS_CD                 /** Code SH !==HS코드==! */
                 , B2.RLBR_GCNT             /** Nombre d'entrées/sorties !==반출입개수==! */
              FROM TB_CARI_DFSH_RLBR_H B1
              JOIN TB_CARI_DFSH_RLBR_H_D B2
                ON B1.RLBR_HIST_MGMT_NO = B2.RLBR_HIST_MGMT_NO
              JOIN TB_CARI_ITM_CD B3
                ON B2.ITM_CD = B3.ITM_CD
             WHERE B1.RLBR_HIST_MGMT_NO = #{rlbrHistMgmtNo}
               AND B1.DEL_YN = 'N'
               AND B2.DEL_YN = 'N'
               AND B1.RLBR_HIST_MGMT_NO = B2.RLBR_HIST_MGMT_NO
             ORDER BY B2.HIST_SRNO
           ) B
     WHERE (A.ITM_CD      = B.ITM_CD   /** Code d'article !==아이템코드==! */
           AND A.IBOBZ_CD = B.IBOBZ_CD /* Code de zone sous douane !== 보세구역코드 ==! */
           AND A.BASE_DT  = B.RLBR_DT  /** Date de référence !==기준일자==! */
         )
      RETURNING A.*
    )
    INSERT INTO TB_CARI_DFSH_INVN
     (
          IBOBZ_CD        /* Code de zone sous douane !== 보세구역코드 ==! */
        , ITM_CD          /* Code D'Article !== 아이템코드 ==! */
        , BASE_DT         /* Date De Référence !== 기준일자 ==! */
        , BASE_YY         /* Année De Référence !== 기준년도 ==! */
        , BASE_MM         /* Mois De Référence !== 기준월 ==! */
        , HS_CD           /* Code Sh !== HS코드 ==! */
        , BASE_INVN_GCNT  /* Nbr de stock de référence !== 기준재고개수 ==! */
        , BRNG_GCNT       /* Nombre d'introductions !== 반입개수 ==! */
        , RLSE_GCNT       /* Nombre De Sorties !== 반출개수 ==! */
        , DEL_YN          /* Suppression On !== 삭제여부 ==! */
        , FRST_REGST_ID   /** ID du premier enregistrant  !==최초등록자ID==! */
        , FRST_RGSR_DTTM  /** Date et heure de premier enregistrement !==최초등록일시==! */
        , LAST_CHPR_ID    /** ID du modificateur final !==최종변경자ID==! */
        , LAST_CHG_DTTM   /** Date et heure de modification finale !==최종변경일시==! */
     )
    SELECT B.IBOBZ_CD       /* Code de zone sous douane !== 보세구역코드 ==! */
         , B.ITM_CD         /* Code D'Article !== 아이템코드 ==! */
         , B.RLBR_DT        /* Date De Référence !== 기준일자 ==! */
         , TO_CHAR(TO_DATE(B.RLBR_DT, 'YYYYMMDD'), 'YYYY')        /* Année De Référence !== 기준년도 ==! */
         , TO_CHAR(TO_DATE(B.RLBR_DT, 'YYYYMMDD'), 'MM')        /* Mois De Référence !== 기준월 ==! */
         , B.HS_CD          /* Code Sh !== HS코드 ==! */
         , NVL((SELECT BASE_INVN_GCNT + BRNG_GCNT - RLSE_GCNT
                  FROM TB_CARI_DFSH_INVN
                 WHERE ITM_CD = B.ITM_CD
                   AND IBOBZ_CD = B.IBOBZ_CD
                   AND BASE_DT = TO_CHAR(TO_DATE(B.RLBR_DT, 'YYYYMMDD') - 1, 'YYYYMMDD')
           ), 0)  /* Nbr de stock de référence !== 기준재고개수 ==! */
         , DECODE(B.RLBR_TP_CD, 'I', B.RLBR_GCNT, 0)      /* Nombre d'introductions !== 반입개수 ==! */
         , DECODE(B.RLBR_TP_CD, 'O', B.RLBR_GCNT, 0)      /* Nombre De Sorties !== 반출개수 ==! */
         , 'N'              /* Suppression On !== 삭제여부 ==! */
         , #{frstRegstId}   /** ID du premier enregistrant  !==최초등록자ID==! */
         , SYSTIMESTAMP     /** Date et heure de premier enregistrement !==최초등록일시==! */
         , #{lastChprId}    /** ID du modificateur final !==최종변경자ID==! */
         , SYSTIMESTAMP     /** Date et heure de modification finale !==최종변경일시==! */
      FROM (SELECT B1.RLBR_HIST_MGMT_NO     /** N° de gestion d'historique d'entrée/sortie !==반출입이력관리번호==! */
                 , B1.RLBR_TP_CD            /** Code de catégorie d'entrée/sortie !==반출입구분코드==! */
                 , B1.IBOBZ_CD              /* Code de zone sous douane !== 보세구역코드 ==! */
                 , B1.RLBR_DT               /* Date D'Entrée/Sortie !== 반출입일자 ==! */
                 , B1.RLBR_RPRT_PT_CD       /** Code de type de rapport d'entrée/sortie !==반출입보고유형코드==! */
                 , B1.RELA_NO               /** N˚ de référence !==관련번호==! */
                 , B2.HIST_SRNO             /** N° de séquence de l'histoire !==이력일련번호==! */
                 , B2.ITM_CD                /** Code d'article !==아이템코드==! */
                 , B2.HS_CD                 /** Code SH !==HS코드==! */
                 , B2.RLBR_GCNT             /** Nombre d'entrées/sorties !==반출입개수==! */
              FROM TB_CARI_DFSH_RLBR_H B1
              JOIN TB_CARI_DFSH_RLBR_H_D B2
                ON B1.RLBR_HIST_MGMT_NO = B2.RLBR_HIST_MGMT_NO
              JOIN TB_CARI_ITM_CD B3
                ON B2.ITM_CD = B3.ITM_CD
             WHERE B1.RLBR_HIST_MGMT_NO = #{rlbrHistMgmtNo}
               AND B1.DEL_YN = 'N'
               AND B2.DEL_YN = 'N'
               AND B1.RLBR_HIST_MGMT_NO = B2.RLBR_HIST_MGMT_NO
             ORDER BY B2.HIST_SRNO
           ) B
      WHERE NOT EXISTS
            (SELECT 1
               FROM MERGED
              WHERE MERGED.ITM_CD = B.ITM_CD
                AND MERGED.IBOBZ_CD = B.IBOBZ_CD
                AND MERGED.BASE_DT  = B.RLBR_DT
            )
  </insert>

  <!--
   Consulter la liste des demandes de transfert !==이동신청서 목록을 조회==!
  -->
  <select id="selectDfshMvmnApfmList"
    parameterType="alpass.ipt.car.dfsh.mgmt.vo.CarDfshMvmnRqstVo"
    resultType="alpass.ipt.car.dfsh.mgmt.vo.CarDfshMvmnRqstVo">
    /* alpass.ipt.car.dfsh.mgmt.mapper.CarDfshMgmtMapper.selectDfshMvmnApfmList */
      <include refid="pagination.header"/>
      SELECT MVMN_RQST_NO       /* N° demande de déplacement !== 이동신고번호 ==! */
           , TO_CHAR(TRSN_DTTM,'DD/MM/YYYY') AS TRSN_DTTM /* Date et heure de transmission !== 전송일시 ==! */
           , TCCPB.PRCS_STTS_CD       /* Code De Statut De Traitement !== 처리상태코드 ==! */
           , TO_CHAR(TO_DATE(MVMN_DT, 'YYYYMMDD'),'DD/MM/YYYY') AS MVMN_DT /* Date de déplacement !== 이동일자 ==! */
           , DPRP_IBOBZ_CD      /* Code De Zone Sous Douane De Départ !== 출발지보세구역코드 ==! */
           , DPRP_JRSD_ORGN_CD  /* Code de service compétent de départ !== 출발지관할조직코드 ==! */
           , ARLC_IBOBZ_CD      /* Code De Zone Sous Douane De Destination !== 도착지보세구역코드 ==! */
           , ARLC_JRSD_ORGN_CD  /* Code de service compétent de destination !== 도착지관할조직코드 ==! */
           , TRSN_CO_CD         /* Code d'entreprise transmettrice !== 전송업체코드 ==! */
           , TCDMR.DEL_YN             /* Suppression On !== 삭제여부 ==! */
           , TCDMR.FRST_REGST_ID      /* Id Du Premier Enregistrant  !== 최초등록자ID ==! */
           , TCDMR.FRST_RGSR_DTTM     /* Date Et Heure De Premier Enregistrement !== 최초등록일시 ==! */
           , TCDMR.LAST_CHPR_ID       /* Id Du Modificateur Final !== 최종변경자ID ==! */
           , TO_CHAR(TCDMR.LAST_CHG_DTTM,'DD/MM/YYYY') AS LAST_CHG_DTTM /* Date Et Heure De Modification Finale !== 최종변경일시 ==! */
           , (SELECT LTRIM(CONCAT(EMP_FMNM,' ',EMP_NM))
                FROM TB_POTI_EMP L
               WHERE L.DEL_YN = 'N'
                 AND L.PBSR_NO = tccpb.AUDT_EMP_ID)   AS AUDT_EMP_NM /** Nom du la personne vérifiant !== 심사직원명==! */
           , TCCPB.AUDT_EMP_ID               /* ID de l'insepcteur !== 심사직원ID ==! */
           , AUDT_PT_CD                /* Code De Type De Contrôle !== 심사유형코드 ==! */
      FROM TB_CARI_DFSH_MVMN_RQST tcdmr /* CARE_DEMANDE DE DÉPLACEMENT !== CARE_이동신고 ==! */
      JOIN TB_CARI_CAG_PRCS_BRKD TCCPB
        ON TCCPB.CAG_RQST_NO = TCDMR.MVMN_RQST_NO
       AND TCCPB.RQST_DGCNT = 0
     WHERE 1=1
       AND TCDMR.DEL_YN = 'N'
    <if test="searMvmnRqstNo != null and searMvmnRqstNo != ''">
       AND MVMN_RQST_NO LIKE CONCAT(#{searMvmnRqstNo},'%')
    </if>
    <if test="searPrcsSttsCd != null and searPrcsSttsCd != ''">
      AND TCCPB.PRCS_STTS_CD = #{searPrcsSttsCd}
    </if>
    <if test="searDprpIbobzCd != null and searDprpIbobzCd != ''">
       AND DPRP_IBOBZ_CD = #{searDprpIbobzCd}
    </if>
    <if test="searArlcIbobzCd != null and searArlcIbobzCd != ''">
       AND ARLC_IBOBZ_CD = #{searArlcIbobzCd}
    </if>
    <if test="searMvmnDtFrom != '' and searMvmnDtTo != '' and searMvmnDtFrom != null and searMvmnDtTo != null">
      AND TO_DATE(MVMN_DT, 'YYYYMMDD') BETWEEN TO_DATE(#{searMvmnDtFrom},'DD/MM/YYYY') AND TO_DATE(#{searMvmnDtTo},'DD/MM/YYYY')
    </if>
    <if test="searItmCd != '' and searItmCd != null">
       AND EXISTS (SELECT 1
                     FROM TB_CARI_DFSH_MVMN_RQST_PDLS TCDMRP
                    WHERE TCDMR.MVMN_RQST_NO = TCDMRP.MVMN_RQST_NO
                      AND ITM_CD = #{searItmCd})
    </if>
    <if test="searHsCd != '' and searHsCd != null">
       AND EXISTS (SELECT 1
                     FROM TB_CARI_DFSH_MVMN_RQST_PDLS TCDMRP
                    WHERE TCDMR.MVMN_RQST_NO = TCDMRP.MVMN_RQST_NO
                      AND HS_CD = #{searHsCd})
    </if>
    <choose>
      <when test="@alpass.ipt.car.com.util.CarMyBatisUtil@isEqualsStr(scrnTp,'1')">
      AND TCCPB.PRCS_STTS_CD IN ('B02', 'D08', 'D09')
        </when>
        <otherwise>
      AND TCCPB.PRCS_STTS_CD IN ('D01','B02', 'D08', 'D09')
      </otherwise>
    </choose>
    <choose>
        <when test="roleId.equals('CAR127'.toString())">
            AND TCCPB.AUDT_EMP_ID  = #{pbsrNo}
        </when>
        <otherwise>
            AND TCCPB.JRSD_ORGN_CD LIKE SUBSTR(#{jrsdOrgnCd}, 1, 5) || '%'
        </otherwise>
    </choose>
     ORDER BY TCDMR.LAST_CHG_DTTM DESC
      <include refid="pagination.footer"/>
  </select>

  <!--
   Consulter les infos détaillées de la demande de transfert !==이동신청서 상세정보를 조회==!
  -->
  <select id="selectDfshMvmnApfm"
    parameterType="alpass.ipt.car.dfsh.mgmt.vo.CarDfshMvmnRqstVo"
    resultType="alpass.ipt.car.dfsh.mgmt.vo.CarDfshMvmnRqstVo">
    /* alpass.ipt.car.dfsh.mgmt.mapper.CarDfshMgmtMapper.selectDfshMvmnApfm */
    SELECT MVMN_RQST_NO       /* N° demande de déplacement !== 이동신고번호 ==! */
         , TO_CHAR(TRSN_DTTM,'DD/MM/YYYY') AS TRSN_DTTM /* Date et heure de transmission !== 전송일시 ==! */
         , TCCPB.PRCS_STTS_CD       /* Code De Statut De Traitement !== 처리상태코드 ==! */
         , TO_CHAR(TO_DATE(TCDMR.MVMN_DT, 'YYYYMMDD'),'DD/MM/YYYY') AS MVMN_DT /* Date de déplacement !== 이동일자 ==! */
         , TCDMR.DPRP_IBOBZ_CD      /* Code De Zone Sous Douane De Départ !== 출발지보세구역코드 ==! */
         , C.JRSD_CSTM_CD AS DPRP_JRSD_CSTM_CD         /* Code de bureau compétent !== 출발지관할세관코드 ==! */
         , TCDMR.DPRP_JRSD_ORGN_CD  /* Code de service compétent de départ !== 출발지관할조직코드 ==! */
         , TCDMR.ARLC_IBOBZ_CD      /* Code De Zone Sous Douane De Destination !== 도착지보세구역코드 ==! */
         , D.JRSD_CSTM_CD AS ARLC_JRSD_CSTM_CD         /* Code de bureau compétent !== 도착지관할세관코드 ==! */
         , TCDMR.ARLC_JRSD_ORGN_CD  /* Code de service compétent de destination !== 도착지관할조직코드 ==! */
         , TCDMR.TRSN_CO_CD         /* Code d'entreprise transmettrice !== 전송업체코드 ==! */
         , TCCDC.CO_NM AS TRSN_CO_NM       /* Nom de l'entreprise transmettrice !== 전송업체명 ==! */
         , TCDMR.DEL_YN             /* Suppression On !== 삭제여부 ==! */
         , TCDMR.FRST_REGST_ID      /* Id Du Premier Enregistrant  !== 최초등록자ID ==! */
         , TCDMR.FRST_RGSR_DTTM     /* Date Et Heure De Premier Enregistrement !== 최초등록일시 ==! */
         , TCDMR.LAST_CHPR_ID       /* Id Du Modificateur Final !== 최종변경자ID ==! */
         , TO_CHAR(TCDMR.LAST_CHG_DTTM,'DD/MM/YYYY') AS LAST_CHG_DTTM /* Date Et Heure De Modification Finale !== 최종변경일시 ==! */
         , TCCPB.AUDT_EMP_ID               /* ID de l'insepcteur !== 심사직원ID ==! */
         , TCDMR.AUDT_PT_CD                /* Code De Type De Contrôle !== 심사유형코드 ==! */
         , TO_CHAR(TCDMR.AUDT_DTTM,'DD/MM/YYYY') AS AUDT_DT /* Date et heure De Contrôle !== 심사일시 ==! */
         , TCDMR.AUDT_RSLT_CN               /* Contenu Du Résultat De La Vérification !== 심사결과내용 ==! */
      FROM TB_CARI_DFSH_MVMN_RQST  TCDMR/* CARE_DEMANDE DE DÉPLACEMENT !== CARE_이동신고 ==! */
      JOIN TB_CARI_CAG_PRCS_BRKD TCCPB
        ON TCCPB.CAG_RQST_NO = TCDMR.MVMN_RQST_NO
       AND TCCPB.RQST_DGCNT = 0
      LEFT OUTER JOIN (SELECT K1.CO_NM
                            , K1.RPRS_TLPH_NO
                            , K1.CO_ADDR
                            , K2.CO_DCLR_CD
                         FROM TB_COM_CO         K1,
                              TB_COM_CO_DCLR_CD K2
                        WHERE K1.NIF = K2.NIF
                          AND K1.DEL_YN = 'N'
                          AND K2.DEL_YN = 'N'
                          AND K2.RQST_TP_CD IN ('01','02') /* 신규나/수정 상태*/
                          AND K2.PRCS_STTS_CD = 'O' /* 업체  승인상태 */
                          AND K2.USE_YN = 'Y' /* 사용여부 */) TCCDC
        ON TCDMR.TRSN_CO_CD = TCCDC.CO_DCLR_CD
      LEFT JOIN ( SELECT C1.ORGN_CD
                       , C2.ORGN_CD JRSD_CSTM_CD
                   FROM TB_POTI_ORGN C1
                   LEFT JOIN  TB_POTI_ORGN C2
                     ON C1.UPR_ORGN_MGMT_CD = C2.ORGN_MGMT_CD
                  WHERE C1.DEL_YN = 'N'
      ) C
        ON TCDMR.DPRP_JRSD_ORGN_CD = C.ORGN_CD
      LEFT JOIN ( SELECT C1.ORGN_CD
                       , C2.ORGN_CD JRSD_CSTM_CD
                   FROM TB_POTI_ORGN C1
                   LEFT JOIN  TB_POTI_ORGN C2
                     ON C1.UPR_ORGN_MGMT_CD = C2.ORGN_MGMT_CD
                  WHERE C1.DEL_YN = 'N'
      ) D
        ON TCDMR.ARLC_JRSD_ORGN_CD = D.ORGN_CD
     WHERE TCDMR.MVMN_RQST_NO = #{mvmnRqstNo}
       AND TCDMR.DEL_YN = 'N'
  </select>

  <!--
   Consulter la liste des infos sur l'article de la demande de transfert !==이동신청서 품목정보목록을 조회==!
  -->
  <select id="selectDfshMvmnApfmPdlsList"
    parameterType="alpass.ipt.car.dfsh.mgmt.vo.CarDfshMvmnRqstVo"
    resultType="alpass.ipt.car.dfsh.mgmt.vo.CarDfshMvmnRqstPdlsVo">
    /* alpass.ipt.car.dfsh.mgmt.mapper.CarDfshMgmtMapper.selectDfshMvmnApfmPdlsList */
    SELECT TCDMRP.MVMN_RQST_NO       /* N° demande de déplacement !== 이동신고번호 ==! */
         , TCDMRP.MVMN_RQST_SRNO     /* N° série de la demande de déplacement !== 이동신고일련번호 ==! */
         , TCDMRP.ITM_CD             /* Code D'Article !== 아이템코드 ==! */
         , TCDMRP.DFSH_TP_CD         /* Code de type de magasin hors taxes !== 면세점구분코드 ==! */
         , TCIC.ITM_NM        /* Nom D'Article !== 아이템명 ==! */
         , TCDMRP.HS_CD              /* Code Sh !== HS코드 ==! */
         , (SELECT HS_DESC
              FROM TB_CLRI_HS_CD TCHC
             WHERE TCHC.DEL_YN = 'N'
               AND TCHC.HS_CD = TCDMRP.HS_CD
               AND TO_CHAR(SYSTIMESTAMP, 'YYYYMMDD') BETWEEN TCHC.HS_APLY_STRT_DT AND TCHC.HS_APLY_END_DT) AS HS_CD_NM
         , TCIC.UT_PRC               /* Prix Unitaire !== 단위가격 ==! */
         , TCIC.CURR_CD              /* Code De Devise !== 통화코드 ==! */
         , TCIC.MSRM_UT_CD           /* Code d'unité de mesure !== 측정단위코드 ==! */
         , TCDMRP.MVMN_GCNT          /* Nombre de déplacements !== 이동개수 ==! */
         , TCDMRP.DEL_YN             /* Suppression On !== 삭제여부 ==! */
         , TCDMRP.FRST_REGST_ID      /* Id Du Premier Enregistrant  !== 최초등록자ID ==! */
         , TCDMRP.FRST_RGSR_DTTM     /* Date Et Heure De Premier Enregistrement !== 최초등록일시 ==! */
         , TCDMRP.LAST_CHPR_ID       /* Id Du Modificateur Final !== 최종변경자ID ==! */
         , TCDMRP.LAST_CHG_DTTM      /* Date Et Heure De Modification Finale !== 최종변경일시 ==! */
      FROM TB_CARI_DFSH_MVMN_RQST_PDLS  TCDMRP   /* CARE_DEMANDE DE DÉPLACEMENT_ARTICLE !== CARE_이동신고_품목 ==! */
      JOIN TB_CARI_ITM_CD TCIC
        ON TCDMRP.ITM_CD = TCIC.ITM_CD
       AND TCDMRP.DFSH_TP_CD  = TCIC.DFSH_TP_CD
     WHERE TCDMRP.MVMN_RQST_NO = #{mvmnRqstNo}
       AND TCDMRP.DEL_YN = 'N'
     ORDER BY TCDMRP.MVMN_RQST_SRNO
  </select>

  <!--
 Enregistrer le résultat du contrôle de la demande de transfert !==이동신청서 심사결과 등록==!
  -->
  <update id="updateCarMvmnApfmAudt"
          parameterType="alpass.ipt.car.dfsh.mgmt.vo.CarDfshMvmnRqstVo">
    /* alpass.ipt.car.dfsh.mgmt.mapper.CarDfshMgmtMapper.updateCarMvmnApfmAudt */
    UPDATE TB_CARI_DFSH_MVMN_RQST
       SET AUDT_PT_CD     =	#{audtPtCd}   /* Code De Type De Contrôle !== 심사유형코드 ==! */
    <if test="audtDt != '' and audtDt != null">
         , AUDT_DTTM      = SYSTIMESTAMP   /* Date et heure De Contrôle !== 심사일시 ==! */
    </if>
    <if test="audtRsltCn != '' and audtRsltCn != null">
         , AUDT_RSLT_CN    =	#{audtRsltCn}   /* Contenu Du Résultat De La Vérification !== 심사결과내용 ==! */
    </if>
         , DEL_YN         =	'N'   /* Suppression On !== 삭제여부 ==! */
         , LAST_CHPR_ID   =	#{lastChprId}   /* Id Du Modificateur Final !== 최종변경자ID ==! */
         , LAST_CHG_DTTM  =	SYSTIMESTAMP   /* Date Et Heure De Modification Finale !== 최종변경일시 ==! */
    WHERE MVMN_RQST_NO =	#{mvmnRqstNo}   /* N° de demande d’introduction !== 반입신고번호 ==! */
  </update>

  <!--
 Modifier l'état de traitement de la demande de transfert. !==외부 이동신청서 심사결과 처리상태 변경==!
  -->
  <update id="updateEptCarDfshMvmnApfm"
          parameterType="alpass.ipt.car.dfsh.mgmt.vo.CarDfshMvmnRqstVo">
    /* alpass.ipt.car.dfsh.mgmt.mapper.CarDfshMgmtMapper.updateEptCarDfshMvmnApfm */
    UPDATE TB_CARE_DFSH_MVMN_RQST A            /* CARE_DEMANDE DE DÉPLACEMENT !== CARE_이동신고 ==! */
       SET A.PRCS_STTS_CD  = #{prcsSttsCd}    /* Code De Statut De Traitement !== 처리상태코드 ==! */
         , A.LAST_CHPR_ID  = B.LAST_CHPR_ID    /* Id Du Modificateur Final !== 최종변경자ID ==! */
         , A.LAST_CHG_DTTM = B.LAST_CHG_DTTM   /* Date Et Heure De Modification Finale !== 최종변경일시 ==! */
      FROM TB_CARI_DFSH_MVMN_RQST B            /* CARI_DEMANDE DE DÉPLACEMENT !== CARI_이동신고 ==! */
     WHERE A.MVMN_RQST_NO = B.MVMN_RQST_NO     /* N° demande de déplacement !== 이동신고번호 ==! */
       AND A.MVMN_RQST_NO = #{mvmnRqstNo}
  </update>

  <!--
   Consulter la liste des rapports de vente !==판매보고서 목록을 조회==!
  -->
  <select id="selectDfshSaleRprtList"
          parameterType="alpass.ipt.car.dfsh.mgmt.vo.CarDfshSaleRprtVo"
          resultType="alpass.ipt.car.dfsh.mgmt.vo.CarDfshSaleRprtVo">
    /* alpass.ipt.car.dfsh.mgmt.mapper.CarDfshMgmtMapper.selectDfshSaleRprtList */
      <include refid="pagination.header"/>
    SELECT TCSR.SALE_RPRT_NO     /* N° De Rapport De Vente !== 판매보고번호 ==! */
         , TO_CHAR(TCSR.TRSN_DTTM,'DD/MM/YYYY') AS TRSN_DTTM /* Date et heure de transmission !== 전송일시 ==! */
         , TCCPB.PRCS_STTS_CD     /* Code De Statut De Traitement !== 처리상태코드 ==! */
         , TO_CHAR(TO_DATE(TCSR.SALE_DT, 'YYYYMMDD'),'DD/MM/YYYY') AS SALE_DT /* Date De Vente !== 판매일자 ==! */
         , TO_CHAR(TCSR.TRSN_DTTM,'DD/MM/YYYY') AS RPRT_DT /*  !== 보고일자 ==! */
         , TCSR.TRSN_CO_CD AS TRSN_CO_CD                     /* Code d'entreprise transmettrice !== 전송업체코드 ==! */
         , TCSR.IBOBZ_CD         /* Code de zone sous douane !== 보세구역코드 ==! */
         , TCSR.JRSD_ORGN_CD     /* Code D'Unité Compétente !== 관할조직코드 ==! */
         , TCSR.ATCH_FILE_ID     /* Id Du Fichier Joint !== 첨부파일ID ==! */
         , TCSR.DEL_YN           /* Suppression On !== 삭제여부 ==! */
         , TCSR.FRST_REGST_ID    /* Id Du Premier Enregistrant  !== 최초등록자ID ==! */
         , TCSR.FRST_RGSR_DTTM   /* Date Et Heure De Premier Enregistrement !== 최초등록일시 ==! */
         , TCSR.LAST_CHPR_ID     /* Id Du Modificateur Final !== 최종변경자ID ==! */
         , TO_CHAR(TCSR.LAST_CHG_DTTM,'DD/MM/YYYY') AS LAST_CHG_DTTM /* Date Et Heure De Modification Finale !== 최종변경일시 ==! */
         , TCCPB.AUDT_EMP_ID               /* ID de l'insepcteur !== 심사직원ID ==! */
         , (SELECT LTRIM(CONCAT(EMP_FMNM,' ',EMP_NM))
              FROM TB_POTI_EMP L
             WHERE L.DEL_YN = 'N'
               AND L.PBSR_NO = TCCPB.AUDT_EMP_ID
           ) AS AUDT_EMP_NM
         , TCSR.AUDT_PT_CD                /* Code De Type De Contrôle !== 심사유형코드 ==! */
      FROM TB_CARI_SALE_RPRT	TCSR /* CARE_RAPPORT DE VENTE !== CARE_판매보고 ==! */
      JOIN TB_CARI_CAG_PRCS_BRKD TCCPB
        ON TCCPB.CAG_RQST_NO = TCSR.SALE_RPRT_NO
       AND TCCPB.RQST_DGCNT = 0
     WHERE 1=1
       AND TCSR.DEL_YN = 'N'
    <if test="searSaleRprtNo != null and searSaleRprtNo != ''">
       AND TCSR.SALE_RPRT_NO LIKE CONCAT(#{searSaleRprtNo},'%')
    </if>
    <if test="searPrcsSttsCd != null and searPrcsSttsCd != ''">
      AND TCCPB.PRCS_STTS_CD = #{searPrcsSttsCd}
    </if>
    <if test="searIbobzCd != null and searIbobzCd != ''">
       AND TCSR.IBOBZ_CD = #{searIbobzCd}
    </if>
    <!--<if test="searJrsdOrgnCd != null and searJrsdOrgnCd != ''">
      AND TCSR.JRSD_ORGN_CD = #{searJrsdOrgnCd}
    </if>-->
    <if test="searRprtDtFrom != '' and searRprtDtTo != '' and searRprtDtFrom != null and searRprtDtTo != null">
      AND TCSR.TRSN_DTTM BETWEEN TO_DATE(#{searRprtDtFrom},'DD/MM/YYYY') AND TO_DATE(#{searRprtDtTo},'DD/MM/YYYY')
    </if>
    <if test="searSaleDtFrom != '' and searSaleDtTo != '' and searSaleDtFrom != null and searSaleDtTo != null">
      AND TO_DATE(TCSR.SALE_DT, 'YYYYMMDD') BETWEEN TO_DATE(#{searSaleDtFrom},'DD/MM/YYYY') AND TO_DATE(#{searSaleDtTo},'DD/MM/YYYY')
    </if>
    <if test="searItmCd != '' and searItmCd != null">
       AND EXISTS (SELECT 1
                     FROM TB_CARI_SALE_RPRT_PDLS TCSRP
                    WHERE TCSR.SALE_RPRT_NO = TCSRP.SALE_RPRT_NO
                      and ITM_CD = #{searItmCd})
    </if>
    <if test="searHsCd != '' and searHsCd != null">
       AND EXISTS (SELECT 1
                     FROM TB_CARI_SALE_RPRT_PDLS TCSRP
                    WHERE TCSR.SALE_RPRT_NO = TCSRP.SALE_RPRT_NO
                      AND HS_CD = #{searHsCd})
    </if>
    <choose>
        <when test="@alpass.ipt.car.com.util.CarMyBatisUtil@isEqualsStr(scrnTp,'1')">
   AND TCCPB.PRCS_STTS_CD IN ('B02', 'D08', 'D09')
        </when>
        <otherwise>
   AND TCCPB.PRCS_STTS_CD IN ('D01','B02', 'D08', 'D09')
        </otherwise>
    </choose>

    <choose>
        <when test="roleId.equals('CAR088'.toString())">
            AND TCCPB.AUDT_EMP_ID  = #{pbsrNo}
        </when>
        <otherwise>
            AND TCCPB.JRSD_ORGN_CD LIKE SUBSTR(#{jrsdOrgnCd}, 1, 5) || '%'
        </otherwise>
    </choose>
     ORDER BY TCSR.LAST_CHG_DTTM DESC
      <include refid="pagination.footer"/>
  </select>

  <!--
   Consulter les infos détaillées du rapport de vente !==판매보고서 상세정보를 조회==!
  -->
  <select id="selectDfshSaleRprt"
          parameterType="alpass.ipt.car.dfsh.mgmt.vo.CarDfshSaleRprtVo"
          resultType="alpass.ipt.car.dfsh.mgmt.vo.CarDfshSaleRprtVo">
    /* alpass.ipt.car.dfsh.mgmt.mapper.CarDfshMgmtMapper.selectDfshSaleRprt */
    SELECT TCSR.SALE_RPRT_NO     /* N° De Rapport De Vente !== 판매보고번호 ==! */
         , TO_CHAR(TCSR.TRSN_DTTM,'DD/MM/YYYY') AS TRSN_DTTM /* Date et heure de transmission !== 전송일시 ==! */
         , TCCPB.PRCS_STTS_CD     /* Code De Statut De Traitement !== 처리상태코드 ==! */
         , TO_CHAR(TO_DATE(TCSR.SALE_DT, 'YYYYMMDD'),'DD/MM/YYYY') AS SALE_DT /* Date De Vente !== 판매일자 ==! */
         , TO_CHAR(TCSR.TRSN_DTTM,'DD/MM/YYYY') AS RPRT_DT /*  !== 보고일자 ==! */
         , TCSR.TRSN_CO_CD AS TRSN_CO_CD                     /* Code d'entreprise transmettrice !== 전송업체코드 ==! */
         , TCCDC.CO_NM AS TRSN_CO_NM       /* Nom de l'entreprise transmettrice !== 전송업체명 ==! */
         , TCSR.IBOBZ_CD         /* Code de zone sous douane !== 보세구역코드 ==! */
         , C.JRSD_CSTM_CD        /** Code de bureau compétent !== 관할세관코드 ==! */
         , TCSR.JRSD_ORGN_CD     /* Code D'Unité Compétente !== 관할조직코드 ==! */
         , TCSR.ATCH_FILE_ID     /* Id Du Fichier Joint !== 첨부파일ID ==! */
         , TCSR.DEL_YN           /* Suppression On !== 삭제여부 ==! */
         , TCSR.FRST_REGST_ID    /* Id Du Premier Enregistrant  !== 최초등록자ID ==! */
         , TCSR.FRST_RGSR_DTTM   /* Date Et Heure De Premier Enregistrement !== 최초등록일시 ==! */
         , TCSR.LAST_CHPR_ID     /* Id Du Modificateur Final !== 최종변경자ID ==! */
         , TO_CHAR(TCSR.LAST_CHG_DTTM,'DD/MM/YYYY') AS LAST_CHG_DTTM /* Date Et Heure De Modification Finale !== 최종변경일시 ==! */
         , TCCPB.AUDT_EMP_ID               /* ID de l'insepcteur !== 심사직원ID ==! */
         , TCSR.AUDT_PT_CD                /* Code De Type De Contrôle !== 심사유형코드 ==! */
         , TO_CHAR(TCSR.AUDT_DTTM,'DD/MM/YYYY') AS AUDT_DT /* Date De Contrôle !== 심사일자 ==! */
         , TCSR.AUDT_RSLT_CN               /* Contenu Du Résultat De La Vérification !== 심사결과내용 ==! */
      FROM TB_CARI_SALE_RPRT TCSR	/* CARE_RAPPORT DE VENTE !== CARE_판매보고 ==! */
      JOIN TB_CARI_CAG_PRCS_BRKD TCCPB
        ON TCCPB.CAG_RQST_NO = TCSR.SALE_RPRT_NO
       AND TCCPB.RQST_DGCNT = 0
      LEFT OUTER JOIN (SELECT K1.CO_NM
                            , K1.RPRS_TLPH_NO
                            , K1.CO_ADDR
                            , K2.CO_DCLR_CD
                         FROM TB_COM_CO         K1,
                              TB_COM_CO_DCLR_CD K2
                        WHERE K1.NIF = K2.NIF
                          AND K1.DEL_YN = 'N'
                          AND K2.DEL_YN = 'N'
                          AND K2.RQST_TP_CD IN ('01','02') /* 신규나/수정 상태*/
                          AND K2.PRCS_STTS_CD = 'O' /* 업체  승인상태 */
                          AND K2.USE_YN = 'Y' /* 사용여부 */) TCCDC
        ON TCSR.TRSN_CO_CD = TCCDC.CO_DCLR_CD
      LEFT JOIN ( SELECT C1.ORGN_CD
                       , C2.ORGN_CD JRSD_CSTM_CD
                   FROM TB_POTI_ORGN C1
                   LEFT JOIN  TB_POTI_ORGN C2
                     ON C1.UPR_ORGN_MGMT_CD = C2.ORGN_MGMT_CD
                  WHERE C1.DEL_YN = 'N'
      ) C
        ON TCSR.JRSD_ORGN_CD = C.ORGN_CD
     WHERE 1=1
       AND TCSR.SALE_RPRT_NO = #{saleRprtNo}
  </select>

  <!--
   Consulter la liste des infos sur l'article du rapport de vente !==판매보고서 품목정보목록을 조회==!
  -->
  <select id="selectDfshSaleRprtPdls"
          parameterType="alpass.ipt.car.dfsh.mgmt.vo.CarDfshSaleRprtVo"
          resultType="alpass.ipt.car.dfsh.mgmt.vo.CarDfshSaleRprtPdlsVo">
    /* alpass.ipt.car.dfsh.mgmt.mapper.CarDfshMgmtMapper.selectDfshSaleRprtPdls */
    SELECT SALE_RPRT_NO     /* N° De Rapport De Vente !== 판매보고번호 ==! */
         , SALE_RPRT_SRNO   /* N° De Série De Rapport De Vente !== 판매보고일련번호 ==! */
         , DFSH_TP_CD       /* Code de type de magasin hors taxes !== 면세점구분코드 ==! */
         , ITM_CD           /* Code D'Article !== 아이템코드 ==! */
         , (SELECT ITM_NM        /* Nom D'Article !== 아이템명 ==! */
              FROM TB_CARI_ITM_CD tcic
             WHERE tcic.ITM_CD = TCSRP.ITM_CD
               AND tcic.DFSH_TP_CD = TCSRP.DFSH_TP_CD) AS ITM_NM
         , BYER_NM          /* Nom De L'Acheteur !== 구매자명 ==! */
         , BYER_NAT_CD      /* Code De Pays D'Acheteur !== 구매자국적코드 ==! */
         , PSPR_NO          /* N° De Passeport !== 여권번호 ==! */
         , FLGH_FLNM        /* N° De Vol !== 항공편명 ==! */
         , HS_CD            /* Code Sh !== HS코드 ==! */
         , (SELECT HS_DESC       /* Description Du Sh !== HS설명 ==! */
              FROM TB_CLRI_HS_CD TCHC
             WHERE TCHC.HS_CD = TCSRP.HS_CD
               AND TCHC.DEL_YN = 'N'
               AND TO_CHAR(SYSTIMESTAMP, 'YYYYMMDD') BETWEEN TCHC.HS_APLY_STRT_DT AND TCHC.HS_APLY_END_DT) AS HS_CD_NM
         , SALE_GCNT        /* Nombre De Ventes !== 판매개수 ==! */
         , UT_PRC           /* Prix Unitaire !== 단위가격 ==! */
         , CURR_CD          /* Code De Devise !== 통화코드 ==! */
         , PUCH_AMT         /* Prix D'Achat !== 구매금액 ==! */
         , TCSRP.DSCN_RT AS DSCN_RT /* Solde !== 할인율 ==! */
      FROM TB_CARI_SALE_RPRT_PDLS TCSRP	/* CARE_RAPPORT DE VENTE_ARTICLE !== CARE_판매보고_품목 ==! */
     WHERE 1=1
      AND SALE_RPRT_NO = #{saleRprtNo}
     ORDER BY SALE_RPRT_SRNO
  </select>

  <!--
 Enregistrer le résultat du contrôle du rapport de vente !==판매보고서 심사결과 등록==!
  -->
  <update id="updateCarSaleRprtAudt"
          parameterType="alpass.ipt.car.dfsh.mgmt.vo.CarDfshSaleRprtVo">
    /* alpass.ipt.car.dfsh.mgmt.mapper.CarDfshMgmtMapper.updateCarSaleRprtAudt */
    UPDATE TB_CARI_SALE_RPRT
       SET AUDT_PT_CD     =	#{audtPtCd}   /* Code De Type De Contrôle !== 심사유형코드 ==! */
    <if test="audtDt != '' and audtDt != null">
         , AUDT_DTTM      = SYSTIMESTAMP   /* Date et heure De Contrôle !== 심사일시 ==! */
    </if>
    <if test="audtRsltCn != '' and audtRsltCn != null">
         , AUDT_RSLT_CN    =	#{audtRsltCn}   /* Contenu Du Résultat De La Vérification !== 심사결과내용 ==! */
    </if>
         , DEL_YN         =	'N'   /* Suppression On !== 삭제여부 ==! */
         , LAST_CHPR_ID   =	#{lastChprId}   /* Id Du Modificateur Final !== 최종변경자ID ==! */
         , LAST_CHG_DTTM  =	SYSTIMESTAMP   /* Date Et Heure De Modification Finale !== 최종변경일시 ==! */
    WHERE SALE_RPRT_NO =	#{saleRprtNo}   /* N° De Rapport De Vente !== 판매보고번호 ==! */
  </update>

  <!--
 Modifier l'état de traitement du rapport de vente. !==외부 판매보고서 처리상태 변경==!
  -->
  <update id="updateEptCarDfshSaleRprt"
          parameterType="alpass.ipt.car.dfsh.mgmt.vo.CarDfshSaleRprtVo">
    /* alpass.ipt.car.dfsh.mgmt.mapper.CarDfshMgmtMapper.updateEptCarDfshSaleRprt */
    update tb_care_sale_rprt a				   /* CARE_RAPPORT DE VENTE !== CARE_판매보고 ==! */
       set a.prcs_stts_cd  = #{prcsSttsCd}    /* Code De Statut De Traitement !== 처리상태코드 ==! */
         , a.last_chpr_id  = b.last_chpr_id    /* Id Du Modificateur Final !== 최종변경자ID ==! */
         , a.last_chg_dttm = b.last_chg_dttm   /* Date Et Heure De Modification Finale !== 최종변경일시 ==! */
      from tb_cari_sale_rprt b				   /* CARI_RAPPORT DE VENTE !== CARI_판매보고 ==! */
     where a.sale_rprt_no = b.sale_rprt_no     /* N° De Rapport De Vente !== 판매보고번호 ==! */
       and a.sale_rprt_no = #{saleRprtNo}
  </update>
  
  <!--
   Consulter la liste des rapports hors vente !==판매외보고서 목록을 조회==!
  -->
  <select id="selectDfshNsaleRprtList"
          parameterType="alpass.ipt.car.dfsh.mgmt.vo.CarDfshNsaleRprtVo"
          resultType="alpass.ipt.car.dfsh.mgmt.vo.CarDfshNsaleRprtVo">
    /* alpass.ipt.car.dfsh.mgmt.mapper.CarDfshMgmtMapper.selectDfshNsaleRprtList */
      <include refid="pagination.header"/>
    select TCNRR.NSALE_RPRT_NO        /* N° rapport hors vente !== 판매외보고번호 ==! */
         , TO_CHAR(TCNRR.TRSN_DTTM,'DD/MM/YYYY') AS TRSN_DTTM /* Date et heure de transmission !== 전송일시 ==! */
         , TCCPB.PRCS_STTS_CD         /* Code De Statut De Traitement !== 처리상태코드 ==! */
         , TO_CHAR(TO_DATE(TCNRR.RLSE_DT, 'YYYYMMDD'),'DD/MM/YYYY') AS RLSE_DT /* Date D'Enlèvement !== 반출일자 ==! */
         , TCNRR.NSALE_RPRT_TP_CD     /* Codes de classification des déclarations hors ventes !== 반판매외보고구분코드 ==! */
         , TCNRR.RELA_NO              /* Numéro Concesrné !== 관련번호 ==! */
         , TCNRR.IBOBZ_CD             /* Code de zone sous douane !== 보세구역코드 ==! */
         , TCNRR.JRSD_ORGN_CD         /* Code D'Unité Compétente !== 관할조직코드 ==! */
         , TCNRR.DEL_YN               /* Suppression On !== 삭제여부 ==! */
         , TCNRR.FRST_REGST_ID        /* Id Du Premier Enregistrant  !== 최초등록자ID ==! */
         , TCNRR.FRST_RGSR_DTTM       /* Date Et Heure De Premier Enregistrement !== 최초등록일시 ==! */
         , TCNRR.LAST_CHPR_ID         /* Id Du Modificateur Final !== 최종변경자ID ==! */
         , TO_CHAR(TCNRR.LAST_CHG_DTTM,'DD/MM/YYYY') AS LAST_CHG_DTTM /* Date Et Heure De Modification Finale !== 최종변경일시 ==! */
         , TCCPB.AUDT_EMP_ID               /* ID de l'insepcteur !== 심사직원ID ==! */
         , (SELECT LTRIM(CONCAT(EMP_FMNM,' ',EMP_NM))
              FROM TB_POTI_EMP L
             WHERE L.DEL_YN = 'N'
               AND L.PBSR_NO = TCCPB.AUDT_EMP_ID)   AS AUDT_EMP_NM /** Nom du la personne vérifiant !== 심사직원명==! */
         , TCNRR.AUDT_PT_CD                /* Code De Type De Contrôle !== 심사유형코드 ==! */
         , TO_CHAR(TCNRR.AUDT_DTTM,'DD/MM/YYYY') AS AUDT_DT /* Date De Contrôle !== 심사일자 ==! */
         , TCNRR.AUDT_RSLT_CN               /* Contenu Du Résultat De La Vérification !== 심사결과내용 ==! */
      FROM TB_CARI_NSALE_RLSE_RPRT TCNRR  /* CARE_HORS DE VENTE_RAPPORT DE SORTIE !== CARE_판매외_반출보고 ==! */
      JOIN TB_CARI_CAG_PRCS_BRKD TCCPB
        ON TCCPB.CAG_RQST_NO = TCNRR.NSALE_RPRT_NO
       AND TCCPB.RQST_DGCNT = 0
     WHERE 1=1
       AND TCNRR.DEL_YN = 'N'
    <if test="searNsaleRprtNo != null and searNsaleRprtNo != ''">
       AND TCNRR.NSALE_RPRT_NO LIKE CONCAT(#{searNsaleRprtNo},'%')
    </if>
    <if test="searPrcsSttsCd != null and searPrcsSttsCd != ''">
      AND TCCPB.PRCS_STTS_CD = #{searPrcsSttsCd}
    </if>
    <if test="searIbobzCd != null and searIbobzCd != ''">
       AND TCNRR.IBOBZ_CD = #{searIbobzCd}
    </if>
    <if test="searJrsdOrgnCd != null and searJrsdOrgnCd != ''">
      AND TCNRR.JRSD_ORGN_CD = #{searJrsdOrgnCd}
    </if>
    <if test="searNsaleRprtTpCd != null and searNsaleRprtTpCd != ''">
      AND TCNRR.NSALE_RPRT_TP_CD = #{searNsaleRprtTpCd}
    </if>
    <if test="searRlseDtFrom != '' and searRlseDtTo != '' and searRlseDtFrom != null and searRlseDtTo != null">
      AND TO_DATE(TCNRR.RLSE_DT, 'YYYYMMDD') BETWEEN TO_DATE(#{searRlseDtFrom},'DD/MM/YYYY') AND TO_DATE(#{searRlseDtTo},'DD/MM/YYYY')
    </if>
    <if test="searItmCd != '' and searItmCd != null">
       AND EXISTS (select 1
                     from TB_CARI_NSALE_RLSE_RPRT_PDLS TCNRRP
                    where TCNRR.NSALE_RPRT_NO = TCNRRP.NSALE_RPRT_NO
                      and ITM_CD = #{searItmCd})
    </if>
    <if test="searHsCd != '' and searHsCd != null">
       AND EXISTS (SELECT 1
                     FROM TB_CARI_NSALE_RLSE_RPRT_PDLS TCNRRP
                    WHERE TCNRR.NSALE_RPRT_NO = TCNRRP.NSALE_RPRT_NO
                      AND HS_CD = #{searHsCd})
    </if>
   <choose>
       <when test="@alpass.ipt.car.com.util.CarMyBatisUtil@isEqualsStr(scrnTp,'1')">
   AND TCCPB.PRCS_STTS_CD IN ('B02', 'D08', 'D09')
       </when>
       <otherwise>
   AND TCCPB.PRCS_STTS_CD IN ('D01','B02', 'D08', 'D09')
       </otherwise>
   </choose>
     <choose>
        <when test="roleId.equals('CAR090'.toString())">
            AND TCCPB.AUDT_EMP_ID  = #{pbsrNo}
        </when>
        <otherwise>
            AND TCCPB.JRSD_ORGN_CD LIKE SUBSTR(#{jrsdOrgnCd}, 1, 5) || '%'
        </otherwise>
     </choose>
     ORDER BY TCNRR.LAST_CHG_DTTM DESC
      <include refid="pagination.footer"/>
  </select>

  <!--
   Consulter les infos détaillées du rapport hors vente !==판매외보고서 상세정보를 조회==!
  -->
  <select id="selectDfshNsaleRprt"
          parameterType="alpass.ipt.car.dfsh.mgmt.vo.CarDfshNsaleRprtVo"
          resultType="alpass.ipt.car.dfsh.mgmt.vo.CarDfshNsaleRprtVo">
    /* alpass.ipt.car.dfsh.mgmt.mapper.CarDfshMgmtMapper.selectDfshNsaleRprt */
    SELECT TCNRR.NSALE_RPRT_NO        /* N° rapport hors vente !== 판매외보고번호 ==! */
         , TO_CHAR(TCNRR.TRSN_DTTM,'DD/MM/YYYY') AS TRSN_DTTM /* Date et heure de transmission !== 전송일시 ==! */
         , TCCPB.PRCS_STTS_CD         /* Code De Statut De Traitement !== 처리상태코드 ==! */
         , TO_CHAR(TO_DATE(TCNRR.RLSE_DT, 'YYYYMMDD'),'DD/MM/YYYY') AS RLSE_DT /* Date D'Enlèvement !== 반출일자 ==! */
         , TCNRR.NSALE_RPRT_TP_CD     /* Codes de classification des déclarations hors ventes !== 반판매외보고구분코드 ==! */
         , TCNRR.RELA_NO              /* Numéro Concerné !== 관련번호 ==! */
         , TCNRR.IBOBZ_CD             /* Code de zone sous douane !== 보세구역코드 ==! */
         , C.JRSD_CSTM_CD         /* Code de bureau compétent !== 관할세관코드 ==! */
         , TCNRR.JRSD_ORGN_CD         /* Code D'Unité Compétente !== 관할조직코드 ==! */
         , TCNRR.TRSN_CO_CD                /* Code d'entreprise transmettrice !== 전송업체코드 ==! */
         , TCCDC.CO_NM AS TRSN_CO_NM       /* Nom de l'entreprise transmettrice !== 전송업체명 ==! */
         , TCNRR.DEL_YN               /* Suppression On !== 삭제여부 ==! */
         , TCNRR.FRST_REGST_ID        /* Id Du Premier Enregistrant  !== 최초등록자ID ==! */
         , TCNRR.FRST_RGSR_DTTM       /* Date Et Heure De Premier Enregistrement !== 최초등록일시 ==! */
         , TCNRR.LAST_CHPR_ID         /* Id Du Modificateur Final !== 최종변경자ID ==! */
         , TO_CHAR(TCNRR.LAST_CHG_DTTM,'DD/MM/YYYY') AS LAST_CHG_DTTM /* Date Et Heure De Modification Finale !== 최종변경일시 ==! */
         , TCCPB.AUDT_EMP_ID               /* ID de l'insepcteur !== 심사직원ID ==! */
         , TCNRR.AUDT_PT_CD                /* Code De Type De Contrôle !== 심사유형코드 ==! */
         , TO_CHAR(TCNRR.AUDT_DTTM,'DD/MM/YYYY') AS AUDT_DT /* Date De Contrôle !== 심사일자 ==! */
         , TCNRR.AUDT_RSLT_CN               /* Contenu Du Résultat De La Vérification !== 심사결과내용 ==! */
      FROM TB_CARI_NSALE_RLSE_RPRT  TCNRR /* CARE_HORS DE VENTE_RAPPORT DE SORTIE !== CARE_판매외_반출보고 ==! */
      JOIN TB_CARI_CAG_PRCS_BRKD TCCPB
        ON TCCPB.CAG_RQST_NO = TCNRR.NSALE_RPRT_NO
       AND TCCPB.RQST_DGCNT = 0
      LEFT OUTER JOIN (SELECT K1.CO_NM
                            , K1.RPRS_TLPH_NO
                            , K1.CO_ADDR
                            , K2.CO_DCLR_CD
                         FROM TB_COM_CO         K1,
                              TB_COM_CO_DCLR_CD K2
                        WHERE K1.NIF = K2.NIF
                          AND K1.DEL_YN = 'N'
                          AND K2.DEL_YN = 'N'
                          AND K2.RQST_TP_CD IN ('01','02') /* 신규나/수정 상태*/
                          AND K2.PRCS_STTS_CD = 'O' /* 업체  승인상태 */
                          AND K2.USE_YN = 'Y' /* 사용여부 */) TCCDC
        ON TCNRR.TRSN_CO_CD = TCCDC.CO_DCLR_CD
      LEFT JOIN ( SELECT C1.ORGN_CD
                       , C2.ORGN_CD JRSD_CSTM_CD
                   FROM TB_POTI_ORGN C1
                   LEFT JOIN  TB_POTI_ORGN C2
                     ON C1.UPR_ORGN_MGMT_CD = C2.ORGN_MGMT_CD
                  WHERE C1.DEL_YN = 'N'
      ) C
        ON TCNRR.JRSD_ORGN_CD = C.ORGN_CD
     WHERE 1=1
       AND NSALE_RPRT_NO = #{nsaleRprtNo}
  </select>

  <!--
   Consulter la liste des infos sur l'article du rapport hors vente !==판매외보고서 품목정보목록을 조회==!
  -->
  <select id="selectDfshNsaleRprtPdls"
          parameterType="alpass.ipt.car.dfsh.mgmt.vo.CarDfshNsaleRprtVo"
          resultType="alpass.ipt.car.dfsh.mgmt.vo.CarDfshNsaleRprtPdlsVo">
    /* alpass.ipt.car.dfsh.mgmt.mapper.CarDfshMgmtMapper.selectDfshNsaleRprtPdls */
    select TCNRRP.NSALE_RPRT_NO       /* N° rapport hors vente !== 판매외보고번호 ==! */
         , TCNRRP.NSALE_RPRT_SRNO     /* Numéro de série de rapport non commercial !== 판매외보고일련번호 ==! */
         , TCNRRP.ITM_CD              /* Code D'Article !== 아이템코드 ==! */
         , tcic.ITM_NM                /* Nom D'Article !== 아이템명 ==! */
         , TCNRRP.DFSH_TP_CD          /* Code de type de magasin hors taxes !== 면세점구분코드 ==! */
         , TCNRRP.HS_CD               /* Code Sh !== HS코드 ==! */
         , (SELECT HS_DESC
              FROM TB_CLRI_HS_CD TCHC
             WHERE TCHC.DEL_YN = 'N'
               AND TCHC.HS_CD = TCNRRP.HS_CD
               AND TO_CHAR(SYSTIMESTAMP, 'YYYYMMDD') BETWEEN TCHC.HS_APLY_STRT_DT AND TCHC.HS_APLY_END_DT) AS HS_CD_NM
         , TCNRRP.RLSE_GCNT           /* Nombre De Sorties !== 반출개수 ==! */
         , TCNRRP.UT_PRC              /* Prix Unitaire !== 단위가격 ==! */
         , TCNRRP.CURR_CD             /* Code De Devise !== 통화코드 ==! */
         , TCNRRP.DEL_YN              /* Suppression On !== 삭제여부 ==! */
         , TCNRRP.FRST_REGST_ID       /* Id Du Premier Enregistrant  !== 최초등록자ID ==! */
         , TCNRRP.FRST_RGSR_DTTM      /* Date Et Heure De Premier Enregistrement !== 최초등록일시 ==! */
         , TCNRRP.LAST_CHPR_ID        /* Id Du Modificateur Final !== 최종변경자ID ==! */
         , TCNRRP.LAST_CHG_DTTM       /* Date Et Heure De Modification Finale !== 최종변경일시 ==! */
      from TB_CARI_NSALE_RLSE_RPRT_PDLS TCNRRP /* CARE_HORS DE VENTE_RAPPORT DE SORTIE_ARTICLE !== CARE_판매외_반출보고_품목 ==! */
      JOIN TB_CARI_ITM_CD tcic
        ON TCNRRP.ITM_CD = tcic.ITM_CD
       AND TCNRRP.DFSH_TP_CD  = tcic.DFSH_TP_CD
     WHERE 1=1
       AND TCNRRP.NSALE_RPRT_NO = #{nsaleRprtNo}
       AND TCNRRP.DEL_YN = 'N'
     ORDER BY TCNRRP.NSALE_RPRT_SRNO
  </select>
  
  <!--
 Enregistrer le résultat du contrôle du rapport hors vente !==판매외보고서 심사결과 등록==!
  -->
  <update id="updateCarNsaleRprtAudt"
          parameterType="alpass.ipt.car.dfsh.mgmt.vo.CarDfshNsaleRprtVo">
    /* alpass.ipt.car.dfsh.mgmt.mapper.CarDfshMgmtMapper.updateCarNsaleRprtAudt */
    UPDATE TB_CARI_NSALE_RLSE_RPRT
       SET AUDT_PT_CD     =	#{audtPtCd}   /* Code De Type De Contrôle !== 심사유형코드 ==! */
    <if test="audtDt != '' and audtDt != null">
         , AUDT_DTTM      = SYSTIMESTAMP   /* Date et heure De Contrôle !== 심사일시 ==! */
    </if>
    <if test="audtRsltCn != '' and audtRsltCn != null">
         , AUDT_RSLT_CN    =	#{audtRsltCn}   /* Contenu Du Résultat De La Vérification !== 심사결과내용 ==! */
    </if>
         , DEL_YN         =	'N'   /* Suppression On !== 삭제여부 ==! */
         , LAST_CHPR_ID   =	#{lastChprId}   /* Id Du Modificateur Final !== 최종변경자ID ==! */
         , LAST_CHG_DTTM  =	SYSTIMESTAMP   /* Date Et Heure De Modification Finale !== 최종변경일시 ==! */
    WHERE NSALE_RPRT_NO =	#{nsaleRprtNo}   /* N° De Rapport De Vente !== 판매보고번호 ==! */
  </update>

  <!--
 Modifier l'état de traitement du rapport hors vente. !==외부 판매외보고서 처리상태 변경==!
  -->
  <update id="updateEptCarDfshNsaleRprt"
          parameterType="alpass.ipt.car.dfsh.mgmt.vo.CarDfshNsaleRprtVo">
    /* alpass.ipt.car.dfsh.mgmt.mapper.CarDfshMgmtMapper.updateEptCarDfshNsaleRprt */
    UPDATE TB_CARE_NSALE_RLSE_RPRT A           /* CARE_HORS DE VENTE_RAPPORT DE SORTIE !== CARE_판매외_반출보고 ==! */
       SET A.PRCS_STTS_CD  = #{prcsSttsCd}    /* Code De Statut De Traitement !== 처리상태코드 ==! */
         , A.LAST_CHPR_ID  = B.LAST_CHPR_ID    /* Id Du Modificateur Final !== 최종변경자ID ==! */
         , A.LAST_CHG_DTTM = B.LAST_CHG_DTTM   /* Date Et Heure De Modification Finale !== 최종변경일시 ==! */
      FROM TB_CARI_NSALE_RLSE_RPRT b           /* CARI_HORS DE VENTE_RAPPORT DE SORTIE !== CARI_판매외_반출보고 ==! */
     WHERE A.NSALE_RPRT_NO = B.NSALE_RPRT_NO   /* N° rapport hors vente !== 판매외보고번호 ==! */
       AND A.NSALE_RPRT_NO = #{nsaleRprtNo}
  </update>

  <!--
   Consulter l'inventaire du magasin hors taxe !==면세점재고 목록을 조회==!
  -->
  <select id="selectDfshInvnList"
          parameterType="alpass.ipt.car.dfsh.mgmt.vo.CarDfshInvnVo"
          resultType="alpass.ipt.car.dfsh.mgmt.vo.CarDfshInvnVo">
    /* alpass.ipt.car.dfsh.mgmt.mapper.CarDfshMgmtMapper.selectDfshInvnList */
      <include refid="pagination.header"/>
    SELECT TCDI.IBOBZ_CD         /* Code de zone sous douane !== 보세구역코드 ==! */
			   , (SELECT B.IBOBZ_NM  /* Nom de la zone sous douane !== 보세구역명 ==!*/
			        FROM TB_CARI_IBOBZ B
			       WHERE B.DEL_YN = 'N'
			         AND B.IBOBZ_CD = TCDI.IBOBZ_CD) AS IBOBZ_NM
           , (SELECT B.JRSD_ORGN_CD  /* Nom de la zone sous douane !== 보세구역명 ==!*/
                FROM TB_CARI_IBOBZ B
               WHERE B.DEL_YN = 'N'
                 AND B.IBOBZ_CD = tcdi.IBOBZ_CD) AS JRSD_ORGN_CD 											/** !== 관할세관 ==! */
         , TCDI.ITM_CD           /* Code D'Article !== 아이템코드 ==! */
         , TCDI.HS_CD            /* Code Sh !== HS코드 ==! */
         , (SELECT HS_DESC       /* Description Du Sh !== HS설명 ==! */
              FROM TB_CLRI_HS_CD TCHC
             WHERE TCHC.HS_CD = TCDI.HS_CD
               AND TCHC.DEL_YN = 'N'
               AND TO_CHAR(SYSTIMESTAMP, 'YYYYMMDD') BETWEEN TCHC.HS_APLY_STRT_DT AND TCHC.HS_APLY_END_DT) AS HS_CD_NM
         , TCDI.BASE_DT          /* Date D'Entrée !== 반입일자 ==! */
         , TCDI.BRNG_GCNT        /* Nombre d'introductions !== 반입개수 ==! */
         , TCDI.RLSE_GCNT        /* Nombre De Sorties !== 반출개수 ==! */
         , CASE WHEN TCDI.BASE_INVN_GCNT + TCDI.BRNG_GCNT - TCDI.RLSE_GCNT > 0
                THEN 'Y'
                ELSE 'N'
                 END AS INVN_YN  /* Stock On !== 재고여부 ==! */
         , TCDI.DEL_YN           /* Suppression On !== 삭제여부 ==! */
         , TCDI.FRST_REGST_ID    /* Id Du Premier Enregistrant  !== 최초등록자ID ==! */
         , TCDI.FRST_RGSR_DTTM   /* Date Et Heure De Premier Enregistrement !== 최초등록일시 ==! */
         , TCDI.LAST_CHPR_ID     /* Id Du Modificateur Final !== 최종변경자ID ==! */
         , TCDI.LAST_CHG_DTTM    /* Date Et Heure De Modification Finale !== 최종변경일시 ==! */
         , TCIC.DFSH_TP_CD    /* Code de zone sous douane consacrée aux magasins hors taxe !== 면세점보세구역코드 ==! */
         , TCDI.BASE_INVN_GCNT + TCDI.BRNG_GCNT - TCDI.RLSE_GCNT as INVN_CNT /**  Nombre Du Stock  !== 재고건수 ==!  */
         , TCIC.ITM_NM           /* Nom D'Article !== 아이템명 ==! */
         , TCIC.UT_PRC           /* Prix Unitaire !== 단위가격 ==! */
         , TCIC.CURR_CD          /* Code De Devise !== 통화코드 ==! */
         , TCIC.MSRM_UT_CD       /* Code d'unité de mesure !== 측정단위코드 ==!  */
      FROM TB_CARI_DFSH_INVN TCDI /* CARE_MAGASIN HORS TAXES_STOCK !== CARE_면세점_재고 ==! */
      JOIN TB_CARI_IBOBZ TCI
        ON TCDI.IBOBZ_CD = TCI.IBOBZ_CD
      JOIN TB_CARI_ITM_CD TCIC    /* CARE_CODE d'ARTICLE !== CARE_아이템코드 ==! */
        ON TCDI.ITM_CD = TCIC.ITM_CD
       AND ((TCI.IBOBZ_TP_CD = '08' AND TCIC.DFSH_TP_CD = TCI.DFSH_TP_CD)
           OR TCI.IBOBZ_TP_CD != '08')
     WHERE 1=1
       AND TCDI.BASE_DT = TO_CHAR(TO_DATE(#{searBaseDt}, 'DD/MM/YYYY'),'YYYYMMDD')
    <if test="searItmCd != '' and searItmCd != null">
       AND TCDI.ITM_CD LIKE '%' || #{searItmCd} || '%'
    </if>
    <if test="searHsCd != '' and searHsCd != null">
       AND TCDI.HS_CD LIKE '%' || #{searHsCd} || '%'
    </if>
    <if test="searInvnYn != null and searInvnYn != ''">
      AND CASE WHEN 'N' = #{searInvnYn}
     <![CDATA[
               THEN TCDI.BASE_INVN_GCNT + TCDI.BRNG_GCNT - TCDI.RLSE_GCNT <= 0
               ELSE TCDI.BASE_INVN_GCNT + TCDI.BRNG_GCNT - TCDI.RLSE_GCNT > 0
                END
     ]]>
    </if>
    <if test="searIbobzCd != null and searIbobzCd != ''">
       AND TCDI.IBOBZ_CD = #{searIbobzCd}
    </if>
    <if test="searJrsdOrgnCd != null and searJrsdOrgnCd != ''">
      AND (SELECT B.JRSD_ORGN_CD
                FROM TB_CARI_IBOBZ B
               WHERE B.DEL_YN = 'N'
                 AND B.IBOBZ_CD = TCDI.IBOBZ_CD) = #{searJrsdOrgnCd}
    </if>
     ORDER BY TCDI.IBOBZ_CD, TCDI.ITM_CD
      <include refid="pagination.footer"/>
  </select>

    <!--
    Consulter le stock du magasin hors taxe !==면세점재고 조회==!
    -->
    <select id="selectInvnList" parameterType="alpass.ipt.car.dfsh.mgmt.vo.CarInvnVo" resultType="alpass.ipt.car.dfsh.mgmt.vo.CarInvnVo">
        /* alpass.ipt.car.dfsh.mgmt.mapper.CarDfshMgmtMapper.selectInvnList */
        SELECT A.CAG_MGMT_NO
             , A.IBOBZ_CD
             , A.INVN_PCKG_GCNT
             , A.INVN_WGHT
             , B.PCKG_UT_CD
         FROM TB_CARI_INVN A
            , TB_CARI_CAG_DCSH_BL B
        WHERE A.DEL_YN = 'N'
          AND B.DEL_YN = 'N'
          AND A.INVN_YN = 'Y'
          AND A.CAG_MGMT_NO = B.CAG_MGMT_NO
          AND A.CAG_MGMT_NO = #{cagMgmtNo}
          AND A.IBOBZ_CD = #{ibobzCd}
    </select>

    <!--
    Consulter le nom de l'article !== 아이템명 조회 ==!
    -->
    <select id="selectItmNm" parameterType="alpass.ipt.car.dfsh.mgmt.vo.CarDfshItmCdVo" resultType="alpass.ipt.car.dfsh.mgmt.vo.CarDfshItmCdVo">
        /* alpass.ipt.car.dfsh.mgmt.mapper.CarDfshMgmtMapper.selectItmNm */
        SELECT ITM_NM
          FROM TB_CARI_ITM_CD
         WHERE DEL_YN = 'N'
           AND ITM_CD LIKE CONCAT(#{searItmCd},'%')
    </select>

</mapper>