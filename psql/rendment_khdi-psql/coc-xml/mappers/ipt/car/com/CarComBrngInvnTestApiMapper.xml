<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="alpass.ipt.car.com.mapper.CarComBrngInvnTestApiMapper">

    <!-- Consulter les informations sur l'entrée/sortie prévue des marchandises (Externe). !== 화물 반출입 예정정보를 조회한다(외부).==! -->
    <select id="selectCareRlbrPrng" parameterType="alpass.ipt.car.bnwrhs.cagbrng.vo.CarRlbrPrngVo" resultType="alpass.ipt.car.bnwrhs.cagbrng.vo.CarRlbrPrngVo">
        /* selectCareRlbrPrng */
        SELECT
                 A.RLBR_PRNG_NO               /** 번역예정 !==반출입예정번호==! */
                ,A.RLBR_TP_CD                 /** Code De Catégorie D'Entrée/Sortie !==반출입구분코드==! */
                ,A.RLBR_PT_CD                 /** Code De Type D'Entrée/Sortie !==반출입유형코드==! */
                ,A.IBOBZ_CD                   /** 번역예정 !==보세구역코드==! */
                ,A.CAG_MGMT_NO                /** Crn !==화물관리번호==! */
                ,A.BL_NO                      /** N° De Bl !==BL번호==! */
                ,A.RELA_NO                    /** Numéro Concerné !==관련번호==! */
                ,A.APRE_DT                    /** Date D'Autorisation !==승인일자==! */
                ,A.PCKG_GCNT                  /** Nombre De Colis !==포장개수==! */
                ,A.WGHT                       /** Poids !==중량==! */
                ,A.RLBR_PCKG_GCNT             /** N° De Colisage D'Entrée/Sortie !==반출입포장개수==! */
                ,A.RLBR_WGHT                  /** Poids D'Entrée/Sortie !==반출입중량==! */
                ,A.RLBR_CMPL_YN               /** Fin D'Entrée/Sortie O/N !==반출입완료여부==! */
                ,A.CNSI_NIF                   /** 번역예정 !==수하인납세자식별번호==! */
                ,A.CNSI_NM                    /** Nom Du Destinataire !==수하인명==! */
                ,A.CNSI_ADDR                  /** Adresse Du Destinataire !==수하인주소==! */
                ,A.PDLS_NM                    /**  Nom De L'Article  !== 품목명 ==!  */
        FROM    ALPASSEXT.TB_CARE_RLBR_PRNG A
        WHERE   A.CAG_MGMT_NO = #{cagMgmtNo}  /** CRN != 화물관리번호 =! */
        AND     A.RELA_NO     = #{relaNo}     /** N° concerné != 관련번호 =! */
        AND     A.RLBR_PT_CD  = #{rlbrPtCd}   /** Code de type d'entrée/sortie != 반출입유형코드 =! */
        AND     A.IBOBZ_CD    = #{ibobzCd}    /** 번역예정 !==보세구역코드==! */
        AND     A.DEL_YN      = 'N'
    </select>

    <!-- Enregistrer les informations sur l'entrée/sortie prévue des marchandises (Externe). !== 화물 반출입 예정정보를 등록한다(외부).==! -->
    <insert id="insertCareRlbrPrng" parameterType="alpass.ipt.car.bnwrhs.cagbrng.vo.CarRlbrPrngVo">
        /* insertCareRlbrPrng */
        INSERT INTO ALPASSEXT.TB_CARE_RLBR_PRNG
        (
             RLBR_PRNG_NO               /** 번역예정 !==반출입예정번호==! */
            ,RLBR_TP_CD                 /** Code De Catégorie D'Entrée/Sortie !==반출입구분코드==! */
            ,RLBR_PT_CD                 /** Code De Type D'Entrée/Sortie !==반출입유형코드==! */
            ,IBOBZ_CD                   /** 번역예정 !==보세구역코드==! */
            ,CAG_MGMT_NO                /** Crn !==화물관리번호==! */
            ,BL_NO                      /** N° De Bl !==BL번호==! */
            ,RELA_NO                    /** Numéro Concerné !==관련번호==! */
            ,APRE_DT                    /** Date D'Autorisation !==승인일자==! */
            ,PCKG_GCNT                  /** Nombre De Colis !==포장개수==! */
            ,WGHT                       /** Poids !==중량==! */
            ,RLBR_PCKG_GCNT             /** N° De Colisage D'Entrée/Sortie !==반출입포장개수==! */
            ,RLBR_WGHT                  /** Poids D'Entrée/Sortie !==반출입중량==! */
            ,RLBR_CMPL_YN               /** Fin D'Entrée/Sortie O/N !==반출입완료여부==! */
            ,CNSI_NIF                   /** 번역예정 !==수하인납세자식별번호==! */
            ,CNSI_NM                    /** Nom Du Destinataire !==수하인명==! */
            ,CNSI_ADDR                  /** Adresse Du Destinataire !==수하인주소==! */
            ,PDLS_NM                    /**  Nom De L'Article  !== 품목명 ==!  */
            ,DEL_YN                     /** Suppression On !==삭제여부==! */
            ,FRST_REGST_ID              /** Id Du Premier Enregistrant  !==최초등록자ID==! */
            ,FRST_RGSR_DTTM             /** Date Et Heure De Premier Enregistrement !==최초등록일시==! */
            ,LAST_CHPR_ID               /** Id Du Modificateur Final !==최종변경자ID==! */
            ,LAST_CHG_DTTM              /** Date Et Heure De Modification Finale !==최종변경일시==! */
            ,EXP_CMDT_BRNG_RQNO
        ) VALUES (
             #{rlbrPrngNo}            /** 번역예정 !==반출입예정번호==! */
            ,#{rlbrTpCd}              /** Code De Catégorie D'Entrée/Sortie !==반출입구분코드==! */
            ,#{rlbrPtCd}              /** Code De Type D'Entrée/Sortie !==반출입유형코드==! */
            ,#{ibobzCd}               /** 번역예정 !==보세구역코드==! */
            ,#{cagMgmtNo}             /** Crn !==화물관리번호==! */
             ,#{blNo}                 /** N° de BL !== BL번호 ==! */
            ,#{relaNo}                /** Numéro Concerné !==관련번호==! */
            ,TO_CHAR(SYSDATE, 'YYYYMMDD') /** Date D'Autorisation !==승인일자==! */
            ,#{pckgGcnt}              /** Nombre De Colis !==포장개수==! */
            ,#{wght}                  /** Poids !==중량==! */
            ,0                        /** N° De Colisage D'Entrée/Sortie !==반출입포장개수==! */
            ,0                        /** Poids D'Entrée/Sortie !==반출입중량==! */
            ,NVL(#{rlbrCmplYn} ,'N')                     /** Fin D'Entrée/Sortie O/N !==반출입완료여부==! */
            ,#{cnsiNif}               /** 번역예정 !==수하인납세자식별번호==! */
            ,#{cnsiNm}                /** Nom Du Destinataire !==수하인명==! */
            ,#{cnsiAddr}              /** Adresse Du Destinataire !==수하인주소==! */
            ,#{pdlsNm}                /**  Nom De L'Article  !== 품목명 ==!  */
            ,'N'                      /** Suppression On !==삭제여부==! */
            ,#{frstRegstId}           /** ID du premier enregistrant  !== 최초등록자ID ==! */
            ,SYSTIMESTAMP             /** Date et heure de premier enregistrement !== 최초등록일시 ==! */
            ,#{lastChprId}            /** ID du modificateur final !== 최종변경자ID ==! */ -->
            ,SYSTIMESTAMP             /** Date et heure de modification finale !== 최종변경일시 ==! */
            ,#{expCmdtBrngRqno}
        )
    </insert>

    <!-- Consulter le stock du BL !==BL 재고조회==! -->
    <select id="selectCariInvnList" parameterType="alpass.ipt.car.bnwrhs.caginvn.vo.CarInvnVo" resultType="alpass.ipt.car.bnwrhs.caginvn.vo.CarInvnVo">
        /* selectCariInvnList */
        SELECT
                 A.CAG_MGMT_NO                /** Crn !==화물관리번호==! */
                ,A.IBOBZ_CD                   /** 번역예정 !==보세구역코드==! */
                ,TO_CHAR(A.LAST_BRNG_DTTM, 'YYYYMMDDHH24MISS') AS LAST_BRNG_DTTM /** Date De Denière Entrée !==최종반입일시==! */
                ,A.INVN_PCKG_GCNT             /** Nombre De Colisage Du Stock !==재고포장개수==! */
                ,A.INVN_WGHT                  /** Poids Du Stock !==재고중량==! */
                ,A.BRNG_PCKG_GCNT             /** Nombre De Colis De L'Entrée !==반입포장개수==! */
                ,A.BRNG_WGHT                  /** Poids De L'Entrée !==반입중량==! */
                ,A.RLSE_PCKG_GCNT             /** Nombre De Colisage Sorti !==반출포장개수==! */
                ,A.RLSE_WGHT                  /** Poids De La Sortie !==반출중량==! */
                ,A.INVN_YN                    /** Stock On !==재고여부==! */
        FROM    TB_CARI_INVN A
        WHERE   A.CAG_MGMT_NO = #{cagMgmtNo}  /** CRN != 화물관리번호 =! */
        <if test="ibobzCd != null and ibobzCd != '' ">
        AND     A.IBOBZ_CD    = #{ibobzCd}    /** 번역예정 !==보세구역코드==! */
        </if>
        <if test='invnYn != null and invnYn.equals("Y") '>
        AND        A.INVN_YN = 'Y'
        </if>
        AND        A.DEL_YN = 'N'
    </select>


    <!-- Enregistrer les informations sur le stock sur l'entrée du BL.!==BL의 반입에 대한 재고정보를 등록한다.==! -->
    <insert id="insertMergeBlInvnBrng" parameterType="alpass.ipt.car.bnwrhs.caginvn.vo.CarInvnVo">
        /* insertMergeBlInvnBrng */
        INSERT    INTO TB_CARI_INVN (     CAG_MGMT_NO                /** Crn !==화물관리번호==! */
                    ,IBOBZ_CD                   /** 번역예정 !==보세구역코드==! */
                    ,LAST_BRNG_DTTM             /** Date De Denière Entrée !==최종반입일시==! */
                    ,INVN_PCKG_GCNT             /** Nombre De Colisage Du Stock !==재고포장개수==! */
                    ,INVN_WGHT                  /** Poids Du Stock !==재고중량==! */
                    ,BRNG_PCKG_GCNT             /** Nombre De Colis De L'Entrée !==반입포장개수==! */
                    ,BRNG_WGHT                  /** Poids De L'Entrée !==반입중량==! */
                    ,RLSE_PCKG_GCNT             /** Nombre De Colisage Sorti !==반출포장개수==! */
                    ,RLSE_WGHT                  /** Poids De La Sortie !==반출중량==! */
                    ,INVN_YN                    /** Stock On !==재고여부==! */
                    ,DEL_YN                     /** Suppression On !==삭제여부==! */
                    ,FRST_REGST_ID              /** Id Du Premier Enregistrant  !==최초등록자ID==! */
                    ,FRST_RGSR_DTTM             /** Date Et Heure De Premier Enregistrement !==최초등록일시==! */
                    ,LAST_CHPR_ID               /** Id Du Modificateur Final !==최종변경자ID==! */
                    ,LAST_CHG_DTTM              /** Date Et Heure De Modification Finale !==최종변경일시==! */
        ) VALUES (   #{cagMgmtNo}               /** Crn !==화물관리번호==! */
                    ,#{ibobzCd}                 /** 번역예정 !==보세구역코드==! */
                    ,COALESCE(TO_DATE(#{lastBrngDttm}, 'YYYYMMDDHH24MISS'), SYSDATE) /** Date De Denière Entrée !==최종반입일시==! */
                    ,#{brngPckgGcnt}            /** Nombre De Colisage Du Stock !==재고포장개수==! */
                    ,#{brngWght}                /** Poids Du Stock !==재고중량==! */
                    ,#{brngPckgGcnt}            /** Nombre De Colis De L'Entrée !==반입포장개수==! */
                    ,#{brngWght}                /** Poids De L'Entrée !==반입중량==! */
                    ,0                          /** Nombre De Colisage Sorti !==반출포장개수==! */
                    ,0                          /** Poids De La Sortie !==반출중량==! */
                    ,'Y'                        /** Stock On !==재고여부==! */
                    ,'N'                        /** Suppression On !==삭제여부==! */
                    ,#{frstRegstId}             /** ID du premier enregistrant  != 최초등록자ID =! */
                    ,SYSTIMESTAMP               /** Date et heure de premier enregistrement != 최초등록일시 =! */
                    ,#{lastChprId}              /** ID du modificateur final != 최종변경자ID =! */
                    ,SYSTIMESTAMP               /** Date et heure de modification finale != 최종변경일시 =! */
        )
        ON CONFLICT (CAG_MGMT_NO,IBOBZ_CD)
        DO UPDATE
              SET LAST_BRNG_DTTM  = COALESCE(TO_DATE(#{lastBrngDttm}, 'YYYYMMDDHH24MISS'), SYSDATE) /** !=최종반입일시  =! */
                 ,INVN_PCKG_GCNT  = COALESCE((SELECT INVN_PCKG_GCNT
                                                FROM TB_CARI_INVN
                                               WHERE DEL_YN = 'N'
                                                 AND CAG_MGMT_NO = #{cagMgmtNo}
                                                 AND IBOBZ_CD    = #{ibobzCd}),0) + #{brngPckgGcnt} /** Nombre De Colisage Du Stock !==재고포장개수==! */
                 ,INVN_WGHT       = COALESCE((SELECT INVN_WGHT
                                                FROM TB_CARI_INVN
                                               WHERE DEL_YN = 'N'
                                                 AND CAG_MGMT_NO = #{cagMgmtNo}
                                                 AND IBOBZ_CD    = #{ibobzCd}),0) + #{brngWght}          /** Poids Du Stock !==재고중량==! */
                 ,BRNG_PCKG_GCNT  = COALESCE((SELECT BRNG_PCKG_GCNT
                                                FROM TB_CARI_INVN
                                               WHERE DEL_YN = 'N'
                                                 AND CAG_MGMT_NO = #{cagMgmtNo}
                                                 AND IBOBZ_CD    = #{ibobzCd}),0) + #{brngPckgGcnt} /** Nombre De Colis De L'Entrée !==반입포장개수==! */
                 ,BRNG_WGHT       = COALESCE((SELECT BRNG_WGHT
                                                FROM TB_CARI_INVN
                                               WHERE DEL_YN = 'N'
                                                 AND CAG_MGMT_NO = #{cagMgmtNo}
                                                 AND IBOBZ_CD    = #{ibobzCd}),0) + #{brngWght}          /** Poids De L'Entrée !==반입중량==! */
                 ,RLSE_PCKG_GCNT  = 0                       /** Nombre De Colisage Sorti !==반출포장개수==! */
                 ,RLSE_WGHT       = 0                       /** Poids De La Sortie !==반출중량==! */
                 ,INVN_YN         = 'Y'                     /** Stock On !==재고여부==! */
                 ,DEL_YN          = 'N'
                 ,LAST_CHPR_ID    = #{lastChprId}
                 ,LAST_CHG_DTTM   = SYSTIMESTAMP
    </insert>


    <!-- Modifier les informations sur le stock sur la sortie du BL. !==BL의 반출에 대한 재고정보를 수정한다.==! -->
    <update id="updateBlInvnRlse" parameterType="alpass.ipt.car.bnwrhs.caginvn.vo.CarInvnVo">
        /* updateBlInvnRlse */
        UPDATE    TB_CARI_INVN
        SET         RLSE_PCKG_GCNT = RLSE_PCKG_GCNT + #{rlsePckgGcnt} /** Nombre De Colisage Sorti !==반출포장개수==! */
                ,RLSE_WGHT      = RLSE_WGHT + #{rlseWght}          /** Poids De La Sortie !==반출중량==! */
                ,INVN_PCKG_GCNT = INVN_PCKG_GCNT - #{rlsePckgGcnt} /** Nombre De Colisage Du Stock !==재고포장개수==! */
                ,INVN_WGHT      = INVN_WGHT - #{rlseWght} /** Poids Du Stock !==재고중량==! */
                ,INVN_YN        = CASE    WHEN INVN_PCKG_GCNT <![CDATA[>]]> #{rlsePckgGcnt} OR INVN_WGHT <![CDATA[>]]> #{rlseWght}
                                        THEN 'Y'
                                        ELSE 'N'
                                    END /** Stock On !==재고여부==! */
                ,DEL_YN          = 'N'
                ,LAST_CHPR_ID    = #{lastChprId}
                ,LAST_CHG_DTTM   = SYSTIMESTAMP
        WHERE    CAG_MGMT_NO = #{cagMgmtNo}  /** CRN != 화물관리번호 =! */
        AND        IBOBZ_CD    = #{ibobzCd}    /** 번역예정 !==보세구역코드==! */
    </update>


    <!-- 번역필요 !==BL의 재고정보를 동기화==! -->
    <insert id="insertMergeBlInvnSync" parameterType="alpass.ipt.car.bnwrhs.caginvn.vo.CarInvnVo">
        /* insertMergeBlInvnSync */
        INSERT    INTO ALPASSINT.TB_CARI_INVN( CAG_MGMT_NO                /** Crn !==화물관리번호==! */
                                            ,IBOBZ_CD                   /** 번역예정 !==보세구역코드==! */
                                            ,LAST_BRNG_DTTM             /** Date De Denière Entrée !==최종반입일시==! */
                                            ,INVN_PCKG_GCNT             /** Nombre De Colisage Du Stock !==재고포장개수==! */
                                            ,INVN_WGHT                  /** Poids Du Stock !==재고중량==! */
                                            ,BRNG_PCKG_GCNT             /** Nombre De Colis De L'Entrée !==반입포장개수==! */
                                            ,BRNG_WGHT                  /** Poids De L'Entrée !==반입중량==! */
                                            ,RLSE_PCKG_GCNT             /** Nombre De Colisage Sorti !==반출포장개수==! */
                                            ,RLSE_WGHT                  /** Poids De La Sortie !==반출중량==! */
                                            ,INVN_YN                    /** Stock On !==재고여부==! */
                                            ,DEL_YN                     /** Suppression On !==삭제여부==! */
                                            ,FRST_REGST_ID              /** Id Du Premier Enregistrant  !==최초등록자ID==! */
                                            ,FRST_RGSR_DTTM             /** Date Et Heure De Premier Enregistrement !==최초등록일시==! */
                                            ,LAST_CHPR_ID               /** Id Du Modificateur Final !==최종변경자ID==! */
                                            ,LAST_CHG_DTTM              /** Date Et Heure De Modification Finale !==최종변경일시==! */
        )
        SELECT A.CAG_MGMT_NO   ,
               A.IBOBZ_CD      ,
               A.LAST_BRNG_DTTM,
               A.INVN_PCKG_GCNT,
               A.INVN_WGHT     ,
               A.BRNG_PCKG_GCNT,
               A.BRNG_WGHT     ,
               A.RLSE_PCKG_GCNT,
               A.RLSE_WGHT     ,
               A.INVN_YN       ,
               A.DEL_YN        ,
               A.FRST_REGST_ID ,
               A.FRST_RGSR_DTTM,
               A.LAST_CHPR_ID  ,
               A.LAST_CHG_DTTM
          FROM TB_CARI_INVN A
         WHERE A.CAG_MGMT_NO = #{cagMgmtNo}
           AND A.IBOBZ_CD    = #{ibobzCd}
        ON CONFLICT (CAG_MGMT_NO,IBOBZ_CD)
        DO UPDATE
              SET LAST_BRNG_DTTM = EXCLUDED.LAST_BRNG_DTTM /** Date De Denière Entrée !==최종반입일시==! */
                 ,INVN_PCKG_GCNT = EXCLUDED.INVN_PCKG_GCNT /** Nombre De Colisage Du Stock !==재고포장개수==! */
                 ,INVN_WGHT      = EXCLUDED.INVN_WGHT      /** Poids Du Stock !==재고중량==! */
                 ,BRNG_PCKG_GCNT = EXCLUDED.BRNG_PCKG_GCNT /** Nombre De Colis De L'Entrée !==반입포장개수==! */
                 ,BRNG_WGHT      = EXCLUDED.BRNG_WGHT      /** Poids De L'Entrée !==반입중량==! */
                 ,RLSE_PCKG_GCNT = EXCLUDED.RLSE_PCKG_GCNT /** Nombre De Colisage Sorti !==반출포장개수==! */
                 ,RLSE_WGHT      = EXCLUDED.RLSE_WGHT      /** Poids De La Sortie !==반출중량==! */
                 ,INVN_YN        = EXCLUDED.INVN_YN        /** Stock On !==재고여부==! */
                 ,DEL_YN         = EXCLUDED.DEL_YN         /** Suppression On !==삭제여부==! */
                 ,FRST_REGST_ID  = EXCLUDED.FRST_REGST_ID  /** Id Du Premier Enregistrant  !==최초등록자ID==! */
                 ,FRST_RGSR_DTTM = EXCLUDED.FRST_RGSR_DTTM /** Date Et Heure De Premier Enregistrement !==최초등록일시==! */
                 ,LAST_CHPR_ID   = EXCLUDED.LAST_CHPR_ID   /** Id Du Modificateur Final !==최종변경자ID==! */
                 ,LAST_CHG_DTTM  = EXCLUDED.LAST_CHG_DTTM  /** Date Et Heure De Modification Finale !==최종변경일시==! */
    </insert>


    <!-- 번역필요 !==보세구역 조회==! -->
    <select id="selectCariIbobz" parameterType="alpass.ipt.car.com.vo.CarIbobzVo" resultType="alpass.ipt.car.com.vo.CarIbobzVo">
        /* selectCariIbobz */
        SELECT
                 A.IBOBZ_CD                   /** 번역예정 !==보세구역코드==! */
                ,A.IBOBZ_ATPM_RQST_NO         /** 번역예정 !==보세구역인허가신청번호==! */
                ,A.JRSD_ORGN_CD               /** Code D'Unité Compétente  !==관할조직코드==! */
                ,A.IBOBZ_NM                   /** 번역예정 !==보세구역명==! */
                ,A.IBOBZ_CO_CD                /** 번역예정 !==보세구역업체코드==! */
                ,A.IBOBZ_NIF         /** 번역예정 !==보세구역사업자등록번호==! */
                ,A.IBOBZ_TLPH_NO              /** 번역예정 !==보세구역전화번호==! */
                ,A.IBOBZ_FAX_NO               /** 번역예정 !==보세구역팩스번호==! */
                ,A.IBOBZ_EML                  /** 번역예정 !==보세구역이메일==! */
                ,A.IBOBZ_ADDR                 /** 번역예정 !==보세구역주소==! */
                ,A.IBOBZ_TP_CD                /** 번역예정 !==보세구역구분코드==! */
                ,A.IBOBZ_AREA                 /** 번역예정 !==보세구역면적==! */
                ,A.CAG_KND_SSTVS_YN           /** 번역예정 !==화물종류민감여부==! */
                ,A.CAG_KND_RSK_YN             /** 번역예정 !==화물종류위험여부==! */
                ,A.CAG_KND_CRPT_WRY_YN        /** 번역예정 !==화물종류부패우려여부==! */
                ,A.CAG_KND_ANML_YN            /** 번역예정 !==화물종류동물여부==! */
                ,A.CAG_KND_CMCS_YN            /** 번역예정 !==화물종류화학물여부==! */
                ,A.CAG_KND_HMGNS_CAG_YN       /** 번역예정 !==화물종류균질화물여부==! */
                ,A.CAG_KND_OVSZ_OVSZ_CAG_YN   /** 번역예정 !==화물종류특대화물여부==! */
                ,A.CNTR_TRMN_YN               /** Terminal à conteneurs O/N !==컨테이너터미널여부==! */
                ,A.PTCL_MTR_CN                /** Remarques  !==특이사항내용==! */
                ,A.DEL_YN                     /** Suppression On !==삭제여부==! */
        FROM    TB_CARI_IBOBZ A
        WHERE   A.IBOBZ_CD = #{ibobzCd} /** 번역예정 !==보세구역코드==! */
    </select>

    <!-- Consulter le BL de demandes du fret!==화물신청BL조회==! -->
    <select id="selectCarCagDcshBl" parameterType="alpass.ipt.car.com.vo.CarCagDcshBlVo" resultType="alpass.ipt.car.com.vo.CarCagDcshBlVo">
        /* selectCarCagDcshBl */
        SELECT
                 A.MRN                        /** Mrn !==MRN==! */
                ,A.CAG_MGMT_NO                /** Crn !==화물관리번호==! */
                ,A.MSN                        /** Msn !==MSN==! */
                ,A.HSN                        /** HSN !==HSN==! */
                ,A.BL_NO                      /** N° De Bl !==BL번호==! */
                ,A.HBL_NO                     /** N° De Sous Bl !==HBL번호==! */
                ,A.CAG_TP_CD                  /** Nature De Type De Cargaison !==화물구분코드==! */
                ,A.BL_TP_CD                   /** Code De Catégorie De B/L !==BL구분코드==! */
                ,A.BL_PT_CD                   /** Code De Type De Bl !==BL유형코드==! */
                ,A.CAG_CHRC_CD                /** Nature De Cargaison !==화물특성코드==! */
                ,A.PDLS_NM                    /** Nom De L'Article !==품목명==! */
                ,A.CNSI_TXPR_IDFY_NO          /** Niu Du Destinataire !==수하인납세자식별번호==! */
                ,A.CNSI_NM                    /** Nom Du Destinataire !==수하인명==! */
                ,A.CNSI_ADDR_NM               /** Adresse Du Destinataire !==수하인주소명==! */
                ,A.CNSI_TLPH_NO               /** Téléphone Du Destinataire !==수하인전화번호==! */
                ,A.CNSI_EML                   /** Email Du Destinataire !==수하인이메일==! */
                ,A.DEL_YN                     /** Suppression On !==삭제여부==! */
                ,A.CNSI_TXPR_IDFY_NO_NIN   	  /** NIN de déstinataire !== 수하인납세자식별번호(NIN) ==! */
            	,A.EXPPN_TXPR_IDFY_NO_NIN  	  /** NIN d'exportateur !== 수출자납세자식별번호(NIN) ==! */
        FROM    TB_CARI_CAG_DCSH_BL A
        WHERE   A.CAG_MGMT_NO = #{cagMgmtNo} /** Crn !==화물관리번호==! */
    </select>

    <!-- Sauvegarder l'entrée/sortie !== 반출입 저장 -->
    <insert id="insertCariRlbr" parameterType="alpass.ipt.car.bnwrhs.cagbrng.vo.CarCagBrngRlbrVo">
        INSERT    INTO TB_CARI_RLBR
        (     RLBR_RQST_NO               /** 번역예정 !==반출입신청번호==! */
            ,RLBR_TP_CD                 /** Code De Catégorie D'Entrée		/Sortie !==반출입구분코드==! */
            ,CO_RQST_NO 				/** N° de demande d'entreprise   !==업체신청번호==! */
            ,JRSD_ORGN_CD               /** Code D'Unité Compétente  !==관할조직코드==! */
            ,RLBR_DTTM                  /** Date/Heure D'Entrée/Sortie !==반출입일시==! */
            ,IBOBZ_CD                   /** 번역예정 !==보세구역코드==! */
            ,RLBR_PT_CD                 /** Code De Type D'Entrée/Sortie !==반출입유형코드==! */
            ,CAG_MGMT_NO                /** Crn !==화물관리번호==! */
            ,BL_NO                      /** N° De Bl !==BL번호==! */
            ,RELA_NO                    /** Numéro Concerné !==관련번호==! */
            ,BNDL_RLBR_RQNO				/** N° demande d'introduction/sortie en bloc        !== 일괄반출입신청번호 ==! */
            ,PDLS_NM                    /** Nom De L'Article !==품목명==! */
            ,RLBR_PCKG_GCNT             /** N° De Colisage D'Entrée/Sortie !==반출입포장개수==! */
            ,RLBR_WGHT                  /** Poids D'Entrée/Sortie !==반출입중량==! */
            ,PCKG_UT_CD					/**  Code De L'Unité De Colis  					!== 포장단위코드 ==!  */
            ,DIVD_TP_CD                 /** Code De Type D'Éclatement !==분할구분코드==! */
            ,BRNG_ACDN_PT_CD            /** Code De Type D'Accident De L'Entrée !==반입사고유형코드==! */
            ,BRNG_ACDN_GCNT             /** Nombre D'Accident D'Entrée !==반입사고개수==! */
            ,BRNG_ACDN_WGHT             /** Poids D'Accident D'Entrée !==반입사고중량==! */
            ,TRSN_DTTM                  /** Date Et Heure De Envoyé !==전송일시==! */
            ,TRSN_CO_CD                 /** Code De Compagnie De Envoyé !==전송업체코드==! */
            ,AUDT_EMP_ID                /** Id De La Personne Vérifiant !==심사직원ID==! */
            ,AUDT_DTTM                  /** Date De L'Étude !==심사일시==! */
            ,AUDT_PT_CD                 /** Code De Type De Contrôle !==심사유형코드==! */
            ,AUDT_RSLT_CN               /** Contenu Du Résultat De La Vérification !==심사결과내용==! */
            ,TRSF_PRNG_DT               /** 번역예정 !==양도예정일자==! */
            ,DEL_YN                     /** Suppression On !==삭제여부==! */
            ,FRST_REGST_ID              /** Id Du Premier Enregistrant  !==최초등록자ID==! */
            ,FRST_RGSR_DTTM             /** Date Et Heure De Premier Enregistrement !==최초등록일시==! */
            ,LAST_CHPR_ID               /** Id Du Modificateur Final !==최종변경자ID==! */
            ,LAST_CHG_DTTM              /** Date Et Heure De Modification Finale !==최종변경일시==! */
        ) VALUES (
             #{rlbrRqstNo}            /** 번역예정 !==반출입신청번호==! */
            ,#{rlbrTpCd}              /** Code De Catégorie D'Entrée/Sortie !==반출입구분코드==! */
            ,#{coRqstNo} 				/** N° de demande d'entreprise   !==업체신청번호==! */
            ,#{jrsdOrgnCd}            /** Code D'Unité Compétente  !==관할조직코드==! */
            ,COALESCE(to_timestamp(#{rlbrDttm}, 'YYYYMMDDHH24MISS'), SYSDATE) /** Date/Heure D'Entrée/Sortie !==반출입일시==! */
            ,#{ibobzCd}               /** 번역예정 !==보세구역코드==! */
            ,#{rlbrPtCd}              /** Code De Type D'Entrée/Sortie !==반출입유형코드==! */
            ,#{cagMgmtNo}             /** Crn !==화물관리번호==! */
            ,#{blNo}                  /** N° De Bl !==BL번호==! */
            ,#{relaNo}                /** Numéro Concerné !==관련번호==! */
            ,#{bndlRlbrRqno}		  /** N° demande d'introduction/sortie en bloc        !== 일괄반출입신청번호 ==! */
            ,#{pdlsNm}                /** Nom De L'Article !==품목명==! */
            ,(CASE WHEN #{rlbrPckgGcnt} IS NULL
                   THEN '0'
                   ELSE #{rlbrPckgGcnt}
                   END)                /** N° De Colisage D'Entrée/Sortie !==반출입포장개수==! */
            ,(CASE WHEN #{rlbrWght} IS NULL
                   THEN '0'
                   ELSE #{rlbrWght}
                   END)               /** Poids D'Entrée/Sortie !==반출입중량==! */
    		,#{pckgUtCd}			  /**  Code De L'Unité De Colis  					!== 포장단위코드 ==!  */
            ,#{divdTpCd}              /** Code De Type D'Éclatement !==분할구분코드==! */
            ,#{brngAcdnPtCd}          /** Code De Type D'Accident De L'Entrée !==반입사고유형코드==! */
            ,(CASE WHEN #{brngAcdnGcnt} IS NULL
                   THEN '0'
                   ELSE #{brngAcdnGcnt}
                   END)                    /** Nombre D'Accident D'Entrée !==반입사고개수==! */
            ,(CASE WHEN #{brngAcdnWght} IS NULL
                  THEN '0'
                  ELSE #{brngAcdnWght}
                  END)                     /** Poids D'Accident D'Entrée !==반입사고중량==! */
            ,COALESCE(TO_DATE(#{trsnDttm}, 'YYYYMMDDHH24MISS'), SYSDATE) /** Date Et Heure De Envoyé !==전송일시==! */
            ,#{trsnCoCd}              /** Code De Compagnie De Envoyé !==전송업체코드==! */
            ,#{audtEmpId}             /** Id De La Personne Vérifiant !==심사직원ID==! */
            ,TO_DATE(#{audtDttm}, 'YYYYMMDDHH24MISS') /** Date De L'Étude !==심사일시==! */
            ,#{audtPtCd}              /** Code De Type De Contrôle !==심사유형코드==! */
            ,#{audtRsltCn}            /** Contenu Du Résultat De La Vérification !==심사결과내용==! */
            ,#{trsfPrngDt}            /** 번역예정 !==양도예정일자==! */
            ,'N'                      /** Suppression On !==삭제여부==! */
            ,#{frstRegstId}           /** ID du premier enregistrant  != 최초등록자ID =! */
            ,SYSTIMESTAMP             /** Date et heure de premier enregistrement != 최초등록일시 =! */
            ,#{lastChprId}            /** ID du modificateur final != 최종변경자ID =! */
            ,SYSTIMESTAMP             /** Date et heure de modification finale != 최종변경일시 =! */
        )
       ON CONFLICT ( RLBR_RQST_NO )
       DO UPDATE SET
		  RLBR_PCKG_GCNT 	= #{rlbrPckgGcnt}       /** Nombre de colis d'introduction/sortie 		!== 반출입포장개수 ==! */
		, RLBR_WGHT 		= #{rlbrWght}           /** Poids d'introduction/sortie 				!== 반출입중량 ==! */
		, LAST_CHPR_ID 		= #{lastChprId}         /**  Id Du Modificateur Final                 	!== 최종변경자ID ==!  */
		, LAST_CHG_DTTM 	= SYSTIMESTAMP			/**  Date Et Heure De Modification Finale     	!== 최종변경일시 ==!  */
    </insert>

    <!-- Enregistrer la TB_CARI_RLBR_MDFY !== 반출입 정정 저장 -->
    <insert id="insertCariRlbrMdfy" parameterType="alpass.ipt.car.bnwrhs.cagbrng.vo.CarCagBrngRlbrVo">
        INSERT INTO ALPASSINT.TB_CARI_RLBR_MDFY A
        (     RLBR_RQST_NO               /** N° Demande D'Introduction/Sortie !==반출입신청번호==! */
            ,MDFY_DGCNT					/**  Fréquence de rectification  				!== 정정차수 ==!  */
            ,RLBR_MDFY_TP_CD			/**  Code de catégorie de rectif. d'introduction/sortie	!== 반출입정정구분코드 ==!  */
            ,RLBR_TP_CD                 /** Code De Catégorie D'Entrée		/Sortie !==반출입구분코드==! */
            ,JRSD_ORGN_CD               /** Code D'Unité Compétente  !==관할조직코드==! */
            ,RLBR_DTTM                  /** Date/Heure D'Entrée/Sortie !==반출입일시==! */
            ,IBOBZ_CD                   /** 번역예정 !==보세구역코드==! */
            ,RLBR_PT_CD                 /** Code De Type D'Entrée/Sortie !==반출입유형코드==! */
            ,CAG_MGMT_NO                /** Crn !==화물관리번호==! */
            ,BL_NO                      /** N° De Bl !==BL번호==! */
            ,RELA_NO                    /** Numéro Concerné !==관련번호==! */
            ,PDLS_NM                    /** Nom De L'Article !==품목명==! */
            ,RLBR_PCKG_GCNT             /** N° De Colisage D'Entrée/Sortie !==반출입포장개수==! */
            ,RLBR_WGHT                  /** Poids D'Entrée/Sortie !==반출입중량==! */
            ,PCKG_UT_CD					/**  Code De L'Unité De Colis  					!== 포장단위코드 ==!  */
            ,DIVD_TP_CD                 /** Code De Type D'Éclatement !==분할구분코드==! */
            ,BRNG_ACDN_PT_CD            /** Code De Type D'Accident De L'Entrée !==반입사고유형코드==! */
            ,BRNG_ACDN_GCNT             /** Nombre D'Accident D'Entrée !==반입사고개수==! */
            ,BRNG_ACDN_WGHT             /** Poids D'Accident D'Entrée !==반입사고중량==! */
            ,TRSN_DTTM                  /** Date Et Heure De Envoyé !==전송일시==! */
            ,TRSN_CO_CD                 /** Code De Compagnie De Envoyé !==전송업체코드==! */
            ,AUDT_EMP_ID                /** Id De La Personne Vérifiant !==심사직원ID==! */
            ,AUDT_DTTM                  /** Date De L'Étude !==심사일시==! */
            ,AUDT_PT_CD                 /** Code De Type De Contrôle !==심사유형코드==! */
            ,AUDT_RSLT_CN               /** Contenu Du Résultat De La Vérification !==심사결과내용==! */
            ,DEL_YN                     /** Suppression On !==삭제여부==! */
            ,FRST_REGST_ID              /** Id Du Premier Enregistrant  !==최초등록자ID==! */
            ,FRST_RGSR_DTTM             /** Date Et Heure De Premier Enregistrement !==최초등록일시==! */
            ,LAST_CHPR_ID               /** Id Du Modificateur Final !==최종변경자ID==! */
            ,LAST_CHG_DTTM              /** Date Et Heure De Modification Finale !==최종변경일시==! */
        ) VALUES (
             #{rlbrRqstNo}            /** 번역예정 !==반출입신청번호==! */
            ,NVL((SELECT MAX(MDFY_DGCNT)+1 FROM ALPASSINT.TB_CARI_RLBR_MDFY WHERE RLBR_RQST_NO = #{rlbrRqstNo}),0)	  /**  Fréquence de rectification  				!== 정정차수 ==!  */
            ,'01'		  			  /**  Code de catégorie de rectif. d'introduction/sortie	!== 반출입정정구분코드 ==!  */
            ,#{rlbrTpCd}              /** Code De Catégorie D'Entrée/Sortie !==반출입구분코드==! */
            ,#{jrsdOrgnCd}            /** Code D'Unité Compétente  !==관할조직코드==! */
            ,COALESCE(to_timestamp(#{rlbrDttm}, 'YYYYMMDDHH24MISS'), SYSDATE) /** Date/Heure D'Entrée/Sortie !==반출입일시==! */
            ,#{ibobzCd}               /** 번역예정 !==보세구역코드==! */
            ,#{rlbrPtCd}              /** Code De Type D'Entrée/Sortie !==반출입유형코드==! */
            ,#{cagMgmtNo}             /** Crn !==화물관리번호==! */
            ,#{blNo}                  /** N° De Bl !==BL번호==! */
            ,#{relaNo}                /** Numéro Concerné !==관련번호==! */
            ,#{pdlsNm}                /** Nom De L'Article !==품목명==! */
            ,(CASE WHEN #{rlbrPckgGcnt} IS NULL
                   THEN '0'
                   ELSE #{rlbrPckgGcnt}
                   END)                /** N° De Colisage D'Entrée/Sortie !==반출입포장개수==! */
            ,(CASE WHEN #{rlbrWght} IS NULL
                   THEN '0'
                   ELSE #{rlbrWght}
                   END)               /** Poids D'Entrée/Sortie !==반출입중량==! */
    		,#{pckgUtCd}			  /**  Code De L'Unité De Colis  					!== 포장단위코드 ==!  */
            ,#{divdTpCd}              /** Code De Type D'Éclatement !==분할구분코드==! */
            ,#{brngAcdnPtCd}          /** Code De Type D'Accident De L'Entrée !==반입사고유형코드==! */
            ,(CASE WHEN #{brngAcdnGcnt} IS NULL
                   THEN '0'
                   ELSE #{brngAcdnGcnt}
                   END)                    /** Nombre D'Accident D'Entrée !==반입사고개수==! */
            ,(CASE WHEN #{brngAcdnWght} IS NULL
                  THEN '0'
                  ELSE #{brngAcdnWght}
                  END)                     /** Poids D'Accident D'Entrée !==반입사고중량==! */
            ,COALESCE(TO_DATE(#{trsnDttm}, 'YYYYMMDDHH24MISS'), SYSDATE) /** Date Et Heure De Envoyé !==전송일시==! */
            ,#{trsnCoCd}              /** Code De Compagnie De Envoyé !==전송업체코드==! */
            ,#{audtEmpId}             /** Id De La Personne Vérifiant !==심사직원ID==! */
            ,TO_DATE(#{audtDttm}, 'YYYYMMDDHH24MISS') /** Date De L'Étude !==심사일시==! */
            ,#{audtPtCd}              /** Code De Type De Contrôle !==심사유형코드==! */
            ,#{audtRsltCn}            /** Contenu Du Résultat De La Vérification !==심사결과내용==! */
            ,'N'                      /** Suppression On !==삭제여부==! */
            ,#{frstRegstId}           /** ID du premier enregistrant  != 최초등록자ID =! */
            ,SYSTIMESTAMP             /** Date et heure de premier enregistrement != 최초등록일시 =! */
            ,#{lastChprId}            /** ID du modificateur final != 최종변경자ID =! */
            ,SYSTIMESTAMP             /** Date et heure de modification finale != 최종변경일시 =! */
        )
    </insert>

    <!--
    번역필요 !== 양도예정일자를 조회한다.==!
    -->
    <select id="selectTrsfPrngDt" parameterType="alpass.ipt.car.com.vo.CarCagRlbrVo" resultType="string">
        /* selectTrsfPrngDt */
        SELECT    COALESCE((    SELECT    MIN(TRSF_PRNG_DT)
                        FROM    TB_CARI_RLBR
                        WHERE    CAG_MGMT_NO = (    SELECT    DECODE(W1.BL_PT_CD, 'M', W1.CAG_MGMT_NO
                                                                ,(    SELECT    CAG_MGMT_NO
                                                                    FROM    TB_CARI_CAG_DCSH_BL
                                                                    WHERE    DEL_YN = 'N'
                                                                    AND        MRN = W1.MRN
                                                                    AND        MSN = W1.MSN
                                                                    AND        BL_PT_CD = 'M'
                                                                    )
                                                                )
                                                FROM    TB_CARI_CAG_DCSH_BL W1
                                                WHERE    W1.CAG_MGMT_NO = #{cagMgmtNo}
                                                )
                        AND        DEL_YN = 'N'
                        AND        RLBR_TP_CD = 'I'
                        )
                , TO_CHAR(COALESCE(TO_DATE(#{rlbrDttm}, 'YYYYMMDDHH24MISS'), SYSDATE) + 100, 'YYYYMMDD'))
        FROM    TB_CARI_IBOBZ A
        WHERE   A.IBOBZ_CD = #{ibobzCd} /** 번역예정 !==보세구역코드==! */
    </select>

    <select id="selectBlInvl" parameterType="alpass.ipt.car.bnwrhs.caginvn.vo.CarInvnVo" resultType="alpass.ipt.car.bnwrhs.caginvn.vo.CarInvnVo">
        /* selectBlInvl */
        SELECT A.CAG_MGMT_NO    AS CAG_MGMT_NO   , /** CRN != 화물관리번호 =! */
               A.IBOBZ_CD       AS IBOBZ_CD      , /** Code d'entrepét != 보세창고코드 =! */
               A.LAST_BRNG_DTTM AS LAST_BRNG_DTTM, /** !=  =! */
               A.INVN_PCKG_GCNT AS INVN_PCKG_GCNT, /** !=  =! */
               A.INVN_WGHT      AS INVN_WGHT     , /** !=  =! */
               A.BRNG_PCKG_GCNT AS BRNG_PCKG_GCNT, /** !=  =! */
               A.BRNG_WGHT      AS BRNG_WGHT     , /** !=  =! */
               A.RLSE_PCKG_GCNT AS RLSE_PCKG_GCNT, /** Nombre de colisage sorti != 반출포장개수 =! */
               A.RLSE_WGHT      AS RLSE_WGHT     , /** Poids de la sortie != 반출중량 =! */
               A.INVN_YN        AS INVN_YN       , /** !=  =! */
               A.DEL_YN         AS DEL_YN        , /** Suppression ON != 삭제여부 =! */
               A.FRST_REGST_ID  AS FRST_REGST_ID , /** ID du premier enregistrant  != 최초등록자ID =! */
               A.FRST_RGSR_DTTM AS FRST_RGSR_DTTM, /** Date et heure de premier enregistrement != 최초등록일시 =! */
               A.LAST_CHPR_ID   AS LAST_CHPR_ID  , /** ID du modificateur final != 최종변경자ID =! */
               A.LAST_CHG_DTTM  AS LAST_CHG_DTTM   /** Date et heure de modification finale != 최종변경일시 =! */
          FROM TB_CARI_INVN A
         WHERE A.CAG_MGMT_NO  = #{cagMgmtNo}            /** CRN != 화물관리번호 =! */
           AND A.IBOBZ_CD     = #{ibobzCd}            /** Code d'entrepét != 보세창고코드 =! */
           AND A.DEL_YN       = 'N'
    </select>

    <!--
    TODO 번역필요 !== 양도 해제에 따른 양도예정일자를 수정한다. ==!
   	(Roh Sideuk)
    -->
    <update id="updateCarRlbrFromRele" parameterType="alpass.ipt.car.com.vo.CarCagRlbrVo">
        /* updateCarRlbrFromRele */
        UPDATE TB_CARI_RLBR R
		SET
			R.LAST_CHPR_ID   = #{lastChprId}
            , R.LAST_CHG_DTTM  = TO_TIMESTAMP(#{lastChgDttm},'DDMMYYYYHH24MISS')
			, R.TRSF_PRNG_DT = TO_CHAR(TO_date(#{trsfPrngDt},'DDMMYYYYHH24MISS') + (SELECT PRMT_VAL_CN FROM TB_COM_PRMT WHERE PRMT_ID = 'CAR_0002'), 'YYYYMMDD')
		FROM
			(
			SELECT RLBR_RQST_NO
			FROM TB_CARI_RLBR
			WHERE 1 = 1
				<if test="@alpass.ipt.car.com.util.CarMyBatisUtil@isNotEmpty(rlbrRqstNo)">
	            AND RLBR_RQST_NO = #{rlbrRqstNo}
	            </if>
				AND CAG_MGMT_NO = #{cagMgmtNo}
				AND IBOBZ_CD = #{ibobzCd}

				AND RLBR_TP_CD = 'I'
				AND TRSF_PRNG_DT <![CDATA[ <= ]]> TO_CHAR(TO_date(#{trsfPrngDt},'DDMMYYYYHH24MISS'), 'YYYYMMDD')
				AND DEL_YN = 'N'
			ORDER BY TRSF_PRNG_DT DESC
			LIMIT 1
		) E
		WHERE
			R.RLBR_RQST_NO = E.RLBR_RQST_NO
    </update>

    <!--
    TODO 번역필요 !== 양도 해제에 따른 양도예정일자를 수정한다. ==!
   	(Roh Sideuk)
    -->
    <update id="updateCarEptRlbrFromRele" parameterType="alpass.ipt.car.com.vo.CarCagRlbrVo">
        /* updateCarEptRlbrFromRele */
		UPDATE ALPASSEXT.TB_CARE_RLBR R
		SET
			R.LAST_CHPR_ID   = #{lastChprId}
            , R.LAST_CHG_DTTM  = TO_TIMESTAMP(#{lastChgDttm},'DDMMYYYYHH24MISS')
			, R.TRSF_PRNG_DT = TO_CHAR(TO_date(#{trsfPrngDt},'DDMMYYYYHH24MISS') + (SELECT PRMT_VAL_CN FROM TB_COM_PRMT WHERE PRMT_ID = 'CAR_0002'), 'YYYYMMDD')
		FROM
			(
			SELECT RLBR_RQST_NO
			FROM TB_CARI_RLBR
			WHERE 1=1
				<if test="@alpass.ipt.car.com.util.CarMyBatisUtil@isNotEmpty(rlbrRqstNo)">
	            AND RLBR_RQST_NO = #{rlbrRqstNo}
	            </if>
				AND CAG_MGMT_NO = #{cagMgmtNo}
				AND IBOBZ_CD = #{ibobzCd}
				AND RLBR_TP_CD = 'I'
				AND TRSF_PRNG_DT <![CDATA[ <= ]]> #{trsfPrngDt}
				AND DEL_YN = 'N'
			ORDER BY TRSF_PRNG_DT DESC
			LIMIT 1
		) E
		WHERE
			R.RLBR_RQST_NO = E.RLBR_RQST_NO
    </update>


    <!-- TODO 번역필요 !== 반출입예정정보 채번을 위한 MAX값 조회 ==! -->
    <select id="selectMaxMltCareRlbrPrngNo" parameterType="alpass.ipt.car.bnwrhs.cagbrng.vo.CarCagBrngRlbrVo" resultType="alpass.ipt.car.bnwrhs.cagbrng.vo.CarRlbrPrngVo">

/* alpass.ipt.car.com.mapper.CarComBrngInvnTestApiMapper.selectMaxMltCareRlbrPrngNo*/
        SELECT NVL(MAX(NUMBER(SUBSTR(P.RLBR_PRNG_NO,-6))),0) AS MAX_NO
             , B.IBOBZ_CD
          FROM TB_CARI_CAG_DCSH A
         INNER JOIN TB_CARI_CAG_DCSH_BL B
            ON A.MRN = B.MRN
           AND A.MRN = #{mrn}
           AND B.DEL_YN ='N'
           AND ( B.BL_TP_CD = 'S' OR ( B.BL_TP_CD != 'S' AND B.BL_PT_CD ='H') )
           AND NVL(B.LDUN_YN,'Y') ='Y'
          LEFT JOIN TB_CARE_RLBR_PRNG P
            ON P.RLBR_PT_CD = '10'
           AND P.RLBR_PRNG_NO LIKE TRIM(CONCAT(TO_CHAR(SYSDATE,'YY')))||A.TRSN_CO_CD||#{cagRqstTpCd}||B.IBOBZ_CD||'%'
         WHERE 1=1
         GROUP BY B.IBOBZ_CD
    </select>

    <!-- Enregistrer les informations sur l'entrée/sortie prévue des marchandises (Externe). !== 화물 반출입 예정정보를 등록한다(외부).==! -->
    <insert id="insertMltCareRlbrPrng" parameterType="alpass.ipt.car.bnwrhs.cagbrng.vo.CarRlbrPrngVo">
		/* alpass.ipt.car.com.mapper.CarComBrngInvnTestApiMapper."insertMltRlbrPrng" */
		INSERT INTO ALPASSEXT.TB_CARE_RLBR_PRNG
			(
			  RLBR_PRNG_NO
			, RLBR_TP_CD
			, RLBR_PT_CD
			, IBOBZ_CD
			, CAG_MGMT_NO
			, RELA_NO
			, APRE_DT
			, WGHT
			, RLBR_PCKG_GCNT
			, RLBR_WGHT
			, RLBR_CMPL_YN
			, DEL_YN
			, FRST_REGST_ID
			, FRST_RGSR_DTTM
			, LAST_CHG_DTTM
			, CNSI_NIF
			, CNSI_NM
			, CNSI_ADDR
			, PDLS_NM
			, LAST_CHPR_ID
			, BL_NO
			, PCKG_GCNT
			)
			(
			SELECT NVL ( P.RLBR_PRNG_NO
                       , TRIM(CONCAT(TO_CHAR(SYSDATE,'YY'))) ||
                         A.TRSN_CO_CD ||
                         #{cagRqstTpCd} ||
                         B.IBOBZ_CD ||
                         TRIM(TO_CHAR(#{maxNo} +ROWNUM,'000000')
                      )
                   ) RLBR_PRNG_NO
			     , 'I'  AS RLBR_TP_CD
			     , #{rlbrPtCd} AS RLBR_PT_CD
				 , B.IBOBZ_CD
			     , B.CAG_MGMT_NO AS CAG_MGMT_NO
			     , M.LDUN_RQST_NO AS RELA_NO
				 , TO_CHAR(SYSDATE,'YYYYMMDD')
			     , B.TTWG
			     , 0
			     , 0
			     , 'N'
			     , 'N'
			     , #{frstRegstId}
			     , SYSTIMESTAMP
			     , SYSTIMESTAMP
				 , B.CNSI_TXPR_IDFY_NO as NIF
			     , B.CNSI_NM
			     , B.CNSI_ADDR_NM
			     , B.PDLS_NM
			     , #{lastChprId}
			     , CASE WHEN B.BL_PT_CD = 'M' THEN B.BL_NO ELSE HBL_NO END AS BL_NO
			     , B.PCKG_GCNT
           FROM TB_CARI_CAG_DCSH A
		  INNER JOIN TB_CARI_LDUN M
             ON A.MRN = M.MRN
            AND A.MRN = #{mrn}
            AND A.DEL_YN ='N'
            AND M.DEL_YN ='N'
            AND M.APRE_YN_CD ='O'
          INNER JOIN TB_CARI_LDUN_BL LDUNBL
             ON M.LDUN_RQST_NO = LDUNBL.LDUN_RQST_NO
            AND LDUNBL.DEL_YN = 'N'
          INNER JOIN TB_CARI_CAG_DCSH_BL B
             ON A.MRN = B.MRN
            AND B.IBOBZ_CD = #{ibobzCd}
            AND ( B.BL_TP_CD = 'S' OR ( B.BL_TP_CD != 'S' AND B.BL_PT_CD ='H') )
            AND NVL(B.LDUN_YN,'Y') ='Y'
            AND B.CAG_CHRC_CD != '2'
            AND B.DEL_YN ='N'
            AND B.BL_NO = LDUNBL.BL_NO
          LEFT JOIN TB_CARE_RLBR_PRNG P
             ON P.CAG_MGMT_NO = b.CAG_MGMT_NO
            AND P.RLBR_PT_CD = '10'
            AND P.DEL_YN = 'N'
		  WHERE 1=1
		    AND M.DEL_YN ='N'
		    AND B.DEL_YN ='N'
		    AND NOT EXISTS ( SELECT 1
		                       FROM ALPASSEXT.TB_CARE_RLBR
		                      WHERE CAG_MGMT_NO = B.CAG_MGMT_NO
		                        AND BL_NO = B.BL_NO
		                        AND DEL_YN = 'N'
		                        AND PRCS_STTS_CD NOT IN  ('A01','D09') )
    		)
		ON CONFLICT (RLBR_PRNG_NO)
		DO UPDATE SET
			 LAST_CHPR_ID   = EXCLUDED.LAST_CHPR_ID
           , LAST_CHG_DTTM  = SYSTIMESTAMP
           , APRE_DT = TO_CHAR(SYSDATE,'YYYYMMDD')
           , WGHT = EXCLUDED.WGHT
           , PCKG_GCNT = EXCLUDED.PCKG_GCNT
           , RLBR_WGHT = 0
           , RLBR_PCKG_GCNT  = 0
           , RLBR_CMPL_YN = 'N'
           , DEL_YN = 'N'
           , CNSI_NIF = EXCLUDED.CNSI_NIF
           , CNSI_NM = EXCLUDED.CNSI_NM
           , CNSI_ADDR = EXCLUDED.CNSI_ADDR
           , PDLS_NM = EXCLUDED.PDLS_NM
    </insert>

    <!-- Enregistrer les informations sur l'entrée/sortie prévue des marchandises (Externe). !== 화물 반출입 수출예정정보를 등록한다(외부).==! -->
    <insert id="insertMltCareExpRlbrPrng" parameterType="alpass.ipt.car.bnwrhs.cagbrng.vo.CarRlbrPrngVo">
		/* alpass.ipt.car.com.mapper.CarComBrngInvnTestApiMapper."insertMltCareExpRlbrPrng" */
		INSERT INTO ALPASSEXT.TB_CARE_RLBR_PRNG
			(
			  RLBR_PRNG_NO
			, RLBR_TP_CD
			, RLBR_PT_CD
			, IBOBZ_CD
			, CAG_MGMT_NO
			, RELA_NO
			, APRE_DT
			, WGHT
			, RLBR_PCKG_GCNT
			, RLBR_WGHT
			, RLBR_CMPL_YN
			, DEL_YN
			, FRST_REGST_ID
			, FRST_RGSR_DTTM
			, LAST_CHG_DTTM
			, CNSI_NIF
			, CNSI_NM
			, CNSI_ADDR
			, PDLS_NM
			, LAST_CHPR_ID
			, BL_NO
			, PCKG_GCNT
			, EXP_CMDT_BRNG_RQNO
			)
			(
			SELECT
				   NVL((SELECT RLBR_PRNG_NO FROM TB_CARE_RLBR_PRNG WHERE RLBR_PT_CD = '50' AND IBOBZ_CD =D.IBOBZ_CD AND  CAG_MGMT_NO = D.CAG_MGMT_NO AND DEL_YN = 'N'),
						TRIM(CONCAT(TO_CHAR(SYSDATE,'YY'))) || M.TRSN_CO_CD || #{cagRqstTpCd} || D.IBOBZ_CD ||
				   		TRIM(TO_CHAR(NVL(( SELECT MAX(NUMBER(SUBSTR(RLBR_PRNG_NO,-6))) FROM TB_CARE_RLBR_PRNG WHERE RLBR_PRNG_NO LIKE TRIM(CONCAT(TO_CHAR(SYSDATE,'YY')))||M.TRSN_CO_CD||#{cagRqstTpCd}||D.IBOBZ_CD||'%' ),0) +ROWNUM,'000000')))
				   		AS RLBR_PRNG_NO
			     , 'O'  AS RLBR_TP_CD
			     , #{rlbrPtCd} AS RLBR_PT_CD
				 , D.IBOBZ_CD
			     , D.CAG_MGMT_NO AS CAG_MGMT_NO
			     , M.CAG_DCSH_RGSR_MGMT_NO AS RELA_NO
				 , TO_CHAR(SYSDATE,'YYYYMMDD')
			     , D.TTWG
			     , 0
			     , 0
			     , 'N'
			     , 'N'
			     , #{frstRegstId}
			     , SYSTIMESTAMP
			     , SYSTIMESTAMP
				 , D.CNSI_TXPR_IDFY_NO as NIF
			     , D.CNSI_NM
			     , D.CNSI_ADDR_NM
			     , D.PDLS_NM
			     , #{lastChprId}
			     , CASE WHEN D.BL_PT_CD = 'M' THEN D.BL_NO ELSE HBL_NO END AS BL_NO
			     , D.PCKG_GCNT
			     , (SELECT EXP_CMDT_BRNG_RQNO FROM ALPASSINT.TB_CARI_EXP_CMDT_BRNG WHERE DEL_YN = 'N' AND RELA_NO = X.EXP_FFMN_NO LIMIT 1)
		   FROM TB_CARI_CAG_DCSH M
		  INNER JOIN TB_CARI_CAG_DCSH_BL D
		     ON M.MRN = D.MRN
  	        AND ( D.BL_TP_CD = 'S' OR ( D.BL_TP_CD != 'S' AND D.BL_PT_CD ='H') )
  		  INNER JOIN ALPASSINT.TB_CARI_CAG_DCSH_BL_EXFM X
		     ON D.MRN = X.MRN
  		    AND D.CAG_MGMT_NO = X.CAG_MGMT_NO
		  INNER JOIN TB_CARI_IBOBZ Z
		     ON D.IBOBZ_CD = Z.ibobz_cd
		  WHERE 1=1
		    AND M.DEL_YN ='N'
		    AND D.DEL_YN ='N'
		    AND M.APRE_YN_CD ='O'
		    AND M.MRN = #{mrn}
		    AND NOT EXISTS (SELECT 1 FROM ALPASSEXT.TB_CARE_RLBR WHERE CAG_MGMT_NO = D.CAG_MGMT_NO AND DEL_YN = 'N' AND PRCS_STTS_CD NOT IN  ('A01','D09') )
    		)
		ON CONFLICT (RLBR_PRNG_NO)
		DO UPDATE SET
			 LAST_CHPR_ID   = EXCLUDED.LAST_CHPR_ID
           , LAST_CHG_DTTM  = SYSTIMESTAMP
           , APRE_DT = TO_CHAR(SYSDATE,'YYYYMMDD')
           , WGHT = EXCLUDED.WGHT
           , PCKG_GCNT = EXCLUDED.PCKG_GCNT
           , RLBR_WGHT = 0
           , RLBR_PCKG_GCNT  = 0
           , RLBR_CMPL_YN = 'N'
           , DEL_YN = 'N'
           , CNSI_NIF = EXCLUDED.CNSI_NIF
           , CNSI_NM = EXCLUDED.CNSI_NM
           , CNSI_ADDR = EXCLUDED.CNSI_ADDR
           , PDLS_NM = EXCLUDED.PDLS_NM
           , EXP_CMDT_BRNG_RQNO = EXCLUDED.EXP_CMDT_BRNG_RQNO
    </insert>

	<!-- Consulter la Date d'introduction initiale
		!== 화물관리번호로 최초 승인된 반입일자를 조회한다.자동반출입은 내부에만 생성해서 내부테이블로 조회, 최초반입일자가 정정되는 경우포함==! -->
	<select id="selectFrstRlbrDt" parameterType="alpass.ipt.car.bnwrhs.cagbrng.vo.CarCagBrngRlbrVo" resultType="string">
		/* alpass.ipt.car.com.mapper.CarComBrngInvnTestApiMapper.selectFrstRlbrDt*/
        SELECT TO_CHAR(MIN(A.RLBR_DTTM),'YYYYMMDD') AS RLBR_DTTM
        FROM   ALPASSINT.TB_CARI_RLBR A,  /* CARI_반출입 */
               ALPASSEXT.TB_CARE_RLBR B   /* CARE_반출입 */
        WHERE  A.RLBR_RQST_NO = B.RLBR_RQST_NO
          AND  A.DEL_YN = 'N'
          AND  B.DEL_YN = 'N'
          AND  A.RLBR_TP_CD = 'I'           /** Code de catégorie d'introduction/sortie !== 반출입구분코드 ==! */
          AND  B.PRCS_STTS_CD = 'D08'
          AND  A.CAG_MGMT_NO = #{cagMgmtNo}
	</select>

    <!-- Consulter le stock du BL
    	!==BL 재고조회==! -->
    <select id="selectCariInvnInfo" parameterType="alpass.ipt.car.bnwrhs.caginvn.vo.CarInvnVo" resultType="alpass.ipt.car.bnwrhs.caginvn.vo.CarInvnVo">
	/* alpass.ipt.car.com.mapper.CarComBrngInvnTestApiMapper.selectCariInvnInfo */
    SELECT
	   	   CAG_MGMT_NO                /** Crn !==화물관리번호==! */
         , IBOBZ_CD                   /** Code de zone sous douane !==보세구역코드==! */
         , TO_CHAR(A.LAST_BRNG_DTTM, 'YYYYMMDDHH24MISS') AS LAST_BRNG_DTTM /** Date De Denière Entrée !==최종반입일시==! */
         , INVN_PCKG_GCNT             /** Nombre De Colisage Du Stock !==재고포장개수==! */
         , INVN_WGHT                  /** Poids Du Stock !==재고중량==! */
         , BRNG_PCKG_GCNT             /** Nombre De Colis De L'Entrée !==반입포장개수==! */
         , BRNG_WGHT                  /** Poids De L'Entrée !==반입중량==! */
         , RLSE_PCKG_GCNT             /** Nombre De Colisage Sorti !==반출포장개수==! */
         , RLSE_WGHT                  /** Poids De La Sortie !==반출중량==! */
         , INVN_YN                    /** Stock On !==재고여부==! */
         , DEL_YN                     /** Suppression On !==삭제여부==! */
         , FRST_REGST_ID              /** Id Du Premier Enregistrant  !==최초등록자ID==! */
         , FRST_RGSR_DTTM             /** Date Et Heure De Premier Enregistrement !==최초등록일시==! */
	FROM TB_CARI_INVN A
    WHERE A.CAG_MGMT_NO = #{cagMgmtNo}
    <if test="ibobzCd != null and ibobzCd != '' ">
    AND     A.IBOBZ_CD    = #{ibobzCd}    /** Code de zone sous douane !==보세구역코드==! */
    </if>
    <if test='invnYn != null and invnYn.equals("Y") '>
    AND        A.INVN_YN = 'Y'
    </if>
    AND        A.DEL_YN = 'N'
    </select>

    <!--
	 [Enregistrer] Enregistrer la Quantité de stock
	 !== 재고수량을 등록한다 :: TB_CARI_INVN ==!
	 -->
	<update id="insertMergeRlbrInvn" parameterType="alpass.ipt.car.bnwrhs.caginvn.vo.CarInvnVo">
    	/* alpass.ipt.car.com.mapper.CarComBrngInvnTestApiMapper.insertMergeRlbrInvn */
        INSERT    INTO TB_CARI_INVN (     CAG_MGMT_NO                /** Crn !==화물관리번호==! */
                    ,IBOBZ_CD                   /** Code de zone sous douane !==보세구역코드==! */
                    ,LAST_BRNG_DTTM             /** Date De Denière Entrée !==최종반입일시==! */
                    ,INVN_PCKG_GCNT             /** Nombre De Colisage Du Stock !==재고포장개수==! */
                    ,INVN_WGHT                  /** Poids Du Stock !==재고중량==! */
                    ,BRNG_PCKG_GCNT             /** Nombre De Colis De L'Entrée !==반입포장개수==! */
                    ,BRNG_WGHT                  /** Poids De L'Entrée !==반입중량==! */
                    ,RLSE_PCKG_GCNT             /** Nombre De Colisage Sorti !==반출포장개수==! */
                    ,RLSE_WGHT                  /** Poids De La Sortie !==반출중량==! */
                    ,INVN_YN                    /** Stock On !==재고여부==! */
                    ,DEL_YN                     /** Suppression On !==삭제여부==! */
                    ,FRST_REGST_ID              /** Id Du Premier Enregistrant  !==최초등록자ID==! */
                    ,FRST_RGSR_DTTM             /** Date Et Heure De Premier Enregistrement !==최초등록일시==! */
                    ,LAST_CHPR_ID               /** Id Du Modificateur Final !==최종변경자ID==! */
                    ,LAST_CHG_DTTM              /** Date Et Heure De Modification Finale !==최종변경일시==! */
        ) VALUES (   #{cagMgmtNo}               /** Crn !==화물관리번호==! */
                    ,#{ibobzCd}                 /** Code de zone sous douane !==보세구역코드==! */
                    ,TO_DATE(#{lastBrngDttm},'YYYYMMDDHH24MISS')	/** Date De Denière Entrée !==최종반입일시==! */
                    ,#{invnPckgGcnt}            /** Nombre De Colisage Du Stock !==재고포장개수==! */
                    ,#{invnWght}                /** Poids Du Stock !==재고중량==! */
                    ,#{brngPckgGcnt}            /** Nombre De Colis De L'Entrée !==반입포장개수==! */
                    ,#{brngWght}                /** Poids De L'Entrée !==반입중량==! */
                    ,#{rlsePckgGcnt}            /** Nombre De Colisage Sorti !==반출포장개수==! */
                    ,#{rlseWght}                /** Poids De La Sortie !==반출중량==! */
                    ,#{invnYn}                  /** Stock On !==재고여부==! */
                    ,'N'                        /** Suppression On !==삭제여부==! */
                    ,#{frstRegstId}             /** ID du premier enregistrant  != 최초등록자ID =! */
                    ,SYSTIMESTAMP               /** Date et heure de premier enregistrement != 최초등록일시 =! */
                    ,#{lastChprId}              /** ID du modificateur final != 최종변경자ID =! */
                    ,SYSTIMESTAMP               /** Date et heure de modification finale != 최종변경일시 =! */
        )
        ON CONFLICT (CAG_MGMT_NO, IBOBZ_CD)
        DO UPDATE
              SET LAST_BRNG_DTTM  = TO_DATE(#{lastBrngDttm},'YYYYMMDDHH24MISS')	/** Date De Denière Entrée !==최종반입일시==! */
                 ,INVN_PCKG_GCNT  = #{invnPckgGcnt} 			/** Nombre De Colisage Du Stock !==재고포장개수==! */
                 ,INVN_WGHT       = #{invnWght}    				/** Poids Du Stock !==재고중량==! */
                 ,BRNG_PCKG_GCNT  = #{brngPckgGcnt} 			/** Nombre De Colis De L'Entrée !==반입포장개수==! */
                 ,BRNG_WGHT       = #{brngWght}          		/** Poids De L'Entrée !==반입중량==! */
                 ,RLSE_PCKG_GCNT  = #{rlsePckgGcnt}             /** Nombre De Colisage Sorti !==반출포장개수==! */
                 ,RLSE_WGHT       = #{rlseWght}                 /** Poids De La Sortie !==반출중량==! */
                 ,INVN_YN         = #{invnYn}                   /** Stock On !==재고여부==! */
                 ,DEL_YN          = 'N'							/** Suppression On !==삭제여부==! */
                 ,LAST_CHPR_ID    = #{lastChprId}				/** ID du modificateur final != 최종변경자ID =! */
                 ,LAST_CHG_DTTM   = SYSTIMESTAMP				/** Date et heure de modification finale != 최종변경일시 =! */
    </update>

    <!-- Consulter le stock du export BL
    	!==BL 수출 재고조회==! -->
    <select id="selectCariExpInvnInfo" parameterType="alpass.ipt.car.bnwrhs.caginvn.vo.CarInvnVo" resultType="alpass.ipt.car.bnwrhs.caginvn.vo.CarInvnVo">
		/* alpass.ipt.car.com.mapper.CarComBrngInvnTestApiMapper.selectCariInvnInfo */
	    SELECT
		   	   A.EXP_CMDT_BRNG_RQNO         /** N° Demande D'Introduction/Sortie  	 !==수출물품반입신청번호==! */
	         , A.IBOBZ_CD                   /** Code de zone sous douane !==보세구역코드==! */
	         , A.INVN_PCKG_GCNT             /** Nombre De Colisage Du Stock !==재고포장개수==! */
	         , A.INVN_WGHT                  /** Poids Du Stock !==재고중량==! */
	         , A.BRNG_PCKG_GCNT             /** Nombre De Colis De L'Entrée !==반입포장개수==! */
	         , A.BRNG_WGHT                  /** Poids De L'Entrée !==반입중량==! */
	         , A.RLSE_PCKG_GCNT             /** Nombre De Colisage Sorti !==반출포장개수==! */
	         , A.RLSE_WGHT                  /** Poids De La Sortie !==반출중량==! */
	         , A.INVN_YN                    /** Stock On !==재고여부==! */
	         , A.DEL_YN                     /** Suppression On !==삭제여부==! */
	         , A.FRST_REGST_ID              /** Id Du Premier Enregistrant  !==최초등록자ID==! */
	         , A.FRST_RGSR_DTTM             /** Date Et Heure De Premier Enregistrement !==최초등록일시==! */
		FROM ALPASSINT.TB_CARI_EXP_CMDT_INVN A
	    WHERE A.EXP_CMDT_BRNG_RQNO = #{expCmdtBrngRqno}
	    <if test="ibobzCd != null and ibobzCd != '' ">
	    AND     A.IBOBZ_CD    = #{ibobzCd}    /** Code de zone sous douane !==보세구역코드==! */
	    </if>
	    <if test='invnYn != null and invnYn.equals("Y") '>
	    AND        A.INVN_YN = 'Y'
	    </if>
	    AND        A.DEL_YN = 'N'
    </select>

    <!--
	 [Enregistrer] Enregistrer la Quantité de export stock
	 !== 수출 재고수량을 등록한다 :: TB_CARI_INVN ==!
	 -->
	<update id="insertMergeRlbrExpInvn" parameterType="alpass.ipt.car.bnwrhs.caginvn.vo.CarInvnVo">
    	/*alpass.ipt.car.com.mapper.CarComBrngInvnTestApiMapper.insertMergeRlbrInvn */
        INSERT    INTO TB_CARI_EXP_CMDT_INVN (
        			 EXP_CMDT_BRNG_RQNO         /** N° Demande D'Introduction/Sortie  	 !==수출물품반입신청번호==! */
                    ,IBOBZ_CD                   /** Code de zone sous douane !==보세구역코드==! */
                    ,INVN_PCKG_GCNT             /** Nombre De Colisage Du Stock !==재고포장개수==! */
                    ,INVN_WGHT                  /** Poids Du Stock !==재고중량==! */
                    ,BRNG_PCKG_GCNT             /** Nombre De Colis De L'Entrée !==반입포장개수==! */
                    ,BRNG_WGHT                  /** Poids De L'Entrée !==반입중량==! */
                    ,RLSE_PCKG_GCNT             /** Nombre De Colisage Sorti !==반출포장개수==! */
                    ,RLSE_WGHT                  /** Poids De La Sortie !==반출중량==! */
                    ,INVN_YN                    /** Stock On !==재고여부==! */
                    ,DEL_YN                     /** Suppression On !==삭제여부==! */
                    ,FRST_REGST_ID              /** Id Du Premier Enregistrant  !==최초등록자ID==! */
                    ,FRST_RGSR_DTTM             /** Date Et Heure De Premier Enregistrement !==최초등록일시==! */
                    ,LAST_CHPR_ID               /** Id Du Modificateur Final !==최종변경자ID==! */
                    ,LAST_CHG_DTTM              /** Date Et Heure De Modification Finale !==최종변경일시==! */
        ) VALUES (   #{expCmdtBrngRqno}               /** Crn !==화물관리번호==! */
                    ,#{ibobzCd}                 /** Code de zone sous douane !==보세구역코드==! */
                    ,#{invnPckgGcnt}            /** Nombre De Colisage Du Stock !==재고포장개수==! */
                    ,#{invnWght}                /** Poids Du Stock !==재고중량==! */
                    ,#{brngPckgGcnt}            /** Nombre De Colis De L'Entrée !==반입포장개수==! */
                    ,#{brngWght}                /** Poids De L'Entrée !==반입중량==! */
                    ,#{rlsePckgGcnt}            /** Nombre De Colisage Sorti !==반출포장개수==! */
                    ,#{rlseWght}                /** Poids De La Sortie !==반출중량==! */
                    ,#{invnYn}                  /** Stock On !==재고여부==! */
                    ,'N'                        /** Suppression On !==삭제여부==! */
                    ,#{frstRegstId}             /** ID du premier enregistrant  != 최초등록자ID =! */
                    ,SYSTIMESTAMP               /** Date et heure de premier enregistrement != 최초등록일시 =! */
                    ,#{lastChprId}              /** ID du modificateur final != 최종변경자ID =! */
                    ,SYSTIMESTAMP               /** Date et heure de modification finale != 최종변경일시 =! */
        )
        ON CONFLICT (EXP_CMDT_BRNG_RQNO, IBOBZ_CD)
        DO UPDATE
              SET INVN_PCKG_GCNT  = #{invnPckgGcnt} 			/** Nombre De Colisage Du Stock !==재고포장개수==! */
                 ,INVN_WGHT       = #{invnWght}    				/** Poids Du Stock !==재고중량==! */
                 ,BRNG_PCKG_GCNT  = #{brngPckgGcnt} 			/** Nombre De Colis De L'Entrée !==반입포장개수==! */
                 ,BRNG_WGHT       = #{brngWght}          		/** Poids De L'Entrée !==반입중량==! */
                 ,RLSE_PCKG_GCNT  = #{rlsePckgGcnt}             /** Nombre De Colisage Sorti !==반출포장개수==! */
                 ,RLSE_WGHT       = #{rlseWght}                 /** Poids De La Sortie !==반출중량==! */
                 ,INVN_YN         = #{invnYn}                   /** Stock On !==재고여부==! */
                 ,DEL_YN          = 'N'							/** Suppression On !==삭제여부==! */
                 ,LAST_CHPR_ID    = #{lastChprId}				/** ID du modificateur final != 최종변경자ID =! */
                 ,LAST_CHG_DTTM   = SYSTIMESTAMP				/** Date et heure de modification finale != 최종변경일시 =! */
    </update>

    <!-- [Rechercher] Consulter la liste des "Demande d'accord préalable de l'exploitation de la zone sous douane"
    !== 화물 반입 정보를 조회한다.==! -->
    <select id="selectCarRlbrInfo" parameterType="alpass.ipt.car.bnwrhs.cagbrng.vo.CarCagBrngRlbrVo" resultType="alpass.ipt.car.bnwrhs.cagbrng.vo.CarCagBrngRlbrVo">
        /* selectCarRlbrInfo */
        SELECT
	          A.RLBR_RQST_NO														/**  N° Demande D'Introduction/Sortie  			!== 반출입신청번호 ==!  */
			, A.RLBR_TP_CD															/**  Code de catégorie d'introduction/sortie  	!== 반출입구분코드 ==!  */
			, A.JRSD_ORGN_CD														/**  Code D'Unité Compétente  					!== 관할조직코드 ==!  */
			, A.RLBR_PT_CD															/**  Code de type d'introduction/sortie  		!== 반출입유형코드 ==!  */
			, A.CAG_MGMT_NO															/**  Crn  										!== 화물관리번호 ==!  */
			, A.BL_NO																/**  N° De Bl 								 	!== BL번호 ==!  */
			, A.RLBR_PCKG_GCNT														/**  Nombre de colis d'introduction/sortie  	!== 반출입포장개수 ==!  */
			, A.RLBR_WGHT															/**  Poids d'introduction/sortie  				!== 반출입중량 ==!  */
	        , A.DIVD_TP_CD															/**  Code De Type D'Éclatement  				!== 분할구분코드 ==!  */
			, A.BRNG_ACDN_PT_CD														/**  Code de type d'accident de l'introduction  !== 반입사고유형코드 ==!  */
			, A.BRNG_ACDN_GCNT														/**  Nombre d'accident d'introduction  			!== 반입사고개수 ==!  */
			, A.BRNG_ACDN_WGHT														/**  Poids d'accident d'introduction  			!== 반입사고중량 ==!  */
			, TO_CHAR(A.trsn_dttm, 'DD/MM/YYYY') AS TRSN_DTTM						/**  Date et heure de transmission  			!== 전송일시 ==!  */
			, A.TRSN_CO_CD															/**  Code d'entreprise transmettrice  			!== 전송업체코드 ==!  */
			, A.DEL_YN																/**  Suppression On  							!== 삭제여부 ==!  */
			, A.FRST_REGST_ID														/**  Id Du Premier Enregistrant   				!== 최초등록자ID ==!  */
			, TO_CHAR(A.FRST_RGSR_DTTM, 'DD/MM/YYYY') AS FRST_RGSR_DTTM				/**  Date Et Heure De Premier Enregistrement  	!== 최초등록일시 ==!  */
			, A.LAST_CHPR_ID														/**  Id Du Modificateur Final  					!== 최종변경자ID ==!  */
			, TO_CHAR(A.LAST_CHG_DTTM, 'DD/MM/YYYY') AS LAST_CHG_DTTM				/**  Date Et Heure De Modification Finale  		!== 최종변경일시 ==!  */
			, A.RELA_NO																/**  Numéro Concerné  							!== 관련번호 ==!  */
			, A.PCKG_UT_CD															/**  Code De L'Unité De Colis  					!== 포장단위코드 ==!  */
			, A.TRSF_PRNG_DT														/**  Date D'Aliénation Prévue                   !== 양도예정일자 ==!  */
			, A.CO_RQST_NO 															/**  N° de demande d'entreprise 			 	!== 업체신청번호 ==!  */
        FROM  ALPASSEXT.TB_CARE_RLBR A
        WHERE 1 = 1
        <if test="rlbrPtCd != null and rlbrPtCd != ''">
        AND     A.RLBR_PT_CD  = #{rlbrPtCd}   /** Code de type d'entrée/sortie != 반출입유형코드 =! */
        </if>
        <if test="rlbrTpCd != null and rlbrTpCd != ''">
        AND     A.RLBR_TP_CD  = #{rlbrTpCd}
        </if>
        <if test="ibobzCd != null and ibobzCd != ''">
        AND     A.IBOBZ_CD    = #{ibobzCd}    /** 번역예정 !==보세구역코드==! */
        </if>
        <if test="blNo != null and blNo != ''">
        AND     A.BL_NO  = #{blNo}   /**  N° De Bl 								 	!== BL번호 ==!  */
        </if>
        AND     A.DEL_YN      = 'N'
    </select>

    <!-- !== 화물신고서 정정시 BL을 추가/삭제하는 경우 반입예정정보를 정정한다. ==! -->
    <update id="mdfYRlbrPrng" parameterType="alpass.ipt.car.bnwrhs.cagbrng.vo.CarRlbrPrngVo">
        /* alpass.ipt.car.com.mapper.CarComBrngInvnTestApiMapper.mdfYRlbrPrng */
        UPDATE ALPASSEXT.TB_CARE_RLBR_PRNG A
        SET A.LAST_CHPR_ID = #{lastChprId}
          , A.LAST_CHG_DTTM = SYSTIMESTAMP
        <if test="pckgGcnt != null and pckgGcnt != ''">
          , PCKG_GCNT = #{pckgGcnt}                  /** Nombre De Colis !==포장개수==! */
        </if>
        <if test="wght != null and wght != ''">
          , WGHT = #{wght}                       /** Poids !==중량==! */
        </if>
        <if test="cnsiNif != null and cnsiNif != ''">
          , CNSI_NIF = #{cnsiNif}                  /** 번역예정 !==수하인납세자식별번호==! */
        </if>
        <if test="cnsiNm != null and cnsiNm != ''">
          , CNSI_NM  = #{cnsiNm}                  /** Nom Du Destinataire !==수하인명==! */
        </if>
        <if test="pdlsNm != null and pdlsNm != ''">
          , PDLS_NM   = #{pdlsNm}                 /**  Nom De L'Article  !== 품목명 ==!  */
        </if>
        <if test="cnsiAddr != null and cnsiAddr != ''">
          , CNSI_ADDR = #{cnsiAddr}                 /** Adresse Du Destinataire !==수하인주소==! */
        </if>
        <if test="blNo != null and blNo != ''">
          , BL_NO  = #{blNo}   						/**  N° De Bl 								 	!== BL번호 ==!  */
        </if>
        <if test="ibobzCd != null and ibobzCd != ''">
          , IBOBZ_CD  = #{ibobzCd}
        </if>
          , A.DEL_YN = #{delYn}
        WHERE 1 = 1
        <choose>
        	<when test="cagMgmtNo != null and cagMgmtNo != ''">
		        AND   CAG_MGMT_NO = #{cagMgmtNo}  /** CRN != 화물관리번호 =! */
		        AND   RLBR_TP_CD = #{rlbrTpCd}
        	</when>
        	<otherwise>
        		AND RLBR_PRNG_NO = (SELECT RLBR_PRNG_NO
        							FROM ALPASSEXT.TB_CARE_RLBR_PRNG
        							WHERE IBOBZ_CD = #{ibobzCd}
        							AND   RLBR_TP_CD = #{rlbrTpCd}
        							AND   BL_NO = #{blNo}
        							)
        	</otherwise>
        </choose>
        AND NOT EXISTS ( SELECT 1 FROM ALPASSEXT.TB_CARE_RLBR WHERE CAG_MGMT_NO = A.CAG_MGMT_NO AND IBOBZ_CD = A.IBOBZ_CD AND PRCS_STTS_CD != 'D09' AND DEL_YN = 'N')
        <if test="rlbrPtCd != null and rlbrPtCd != ''">
        AND A.RLBR_PT_CD = #{rlbrPtCd}
        </if>
    </update>

    <!--
	 !== 수출 컨테이너 재고 등록 ==!
	 -->
	<update id="insertMergeRlbrCntrExpInvn" parameterType="alpass.ipt.car.bnwrhs.caginvn.vo.CarInvnVo">
    	/*alpass.ipt.car.com.mapper.CarComBrngInvnTestApiMapper.insertMergeRlbrCntrExpInvn */
        INSERT INTO ALPASSINT.TB_CARI_EXP_CMDT_INVN_CNTR (
        			 EXP_CMDT_BRNG_RQNO         /** N° Demande D'Introduction/Sortie  	 !==수출물품반입신청번호==! */
                    ,IBOBZ_CD                   /** Code de zone sous douane !==보세구역코드==! */
                    ,CNTR_NO
                    ,INVN_YN                    /** Stock On !==재고여부==! */
                    ,DEL_YN                     /** Suppression On !==삭제여부==! */
                    ,FRST_REGST_ID              /** Id Du Premier Enregistrant  !==최초등록자ID==! */
                    ,FRST_RGSR_DTTM             /** Date Et Heure De Premier Enregistrement !==최초등록일시==! */
                    ,LAST_CHPR_ID               /** Id Du Modificateur Final !==최종변경자ID==! */
                    ,LAST_CHG_DTTM              /** Date Et Heure De Modification Finale !==최종변경일시==! */
        ) VALUES (   #{expCmdtBrngRqno}               /** Crn !==화물관리번호==! */
                    ,#{ibobzCd}                 /** Code de zone sous douane !==보세구역코드==! */
                    ,#{cntrNo}
                    ,'Y'                        /** Stock On !==재고여부==! */
                    ,'N'                        /** Suppression On !==삭제여부==! */
                    ,#{frstRegstId}             /** ID du premier enregistrant  != 최초등록자ID =! */
                    ,SYSTIMESTAMP               /** Date et heure de premier enregistrement != 최초등록일시 =! */
                    ,#{lastChprId}              /** ID du modificateur final != 최종변경자ID =! */
                    ,SYSTIMESTAMP               /** Date et heure de modification finale != 최종변경일시 =! */
        )
        ON CONFLICT (EXP_CMDT_BRNG_RQNO, IBOBZ_CD, CNTR_NO)
        DO UPDATE
              SET INVN_YN         = #{invnYn}                   /** Stock On !==재고여부==! */
                 ,DEL_YN          = 'N'							/** Suppression On !==삭제여부==! */
                 ,LAST_CHPR_ID    = #{lastChprId}				/** ID du modificateur final != 최종변경자ID =! */
                 ,LAST_CHG_DTTM   = SYSTIMESTAMP				/** Date et heure de modification finale != 최종변경일시 =! */
    </update>

    <!--
    !== 컨테이너 재고 등록한다 ==!
    -->
	<update id="insertMergeRlbrCntrInvn" parameterType="alpass.ipt.car.bnwrhs.caginvn.vo.CarInvnVo">
    	/* alpass.ipt.car.com.mapper.CarComBrngInvnTestApiMapper.insertMergeRlbrCntrInvn */
        INSERT INTO ALPASSINT.TB_CARI_CNTR_INVN (
                     IBOBZ_CD                   /** Code de zone sous douane !==보세구역코드==! */
                    ,CNTR_NO
        			,CAG_MGMT_NO                /** Crn !==화물관리번호==! */
                    ,INVN_YN                    /** Stock On !==재고여부==! */
                    ,DEL_YN                     /** Suppression On !==삭제여부==! */
                    ,FRST_REGST_ID              /** Id Du Premier Enregistrant  !==최초등록자ID==! */
                    ,FRST_RGSR_DTTM             /** Date Et Heure De Premier Enregistrement !==최초등록일시==! */
                    ,LAST_CHPR_ID               /** Id Du Modificateur Final !==최종변경자ID==! */
                    ,LAST_CHG_DTTM              /** Date Et Heure De Modification Finale !==최종변경일시==! */
        ) VALUES (
                     #{ibobzCd}                 /** Code de zone sous douane !==보세구역코드==! */
                    ,#{cntrNo}
        			,#{cagMgmtNo}               /** Crn !==화물관리번호==! */
                    ,'Y'                        /** Stock On !==재고여부==! */
                    ,'N'                        /** Suppression On !==삭제여부==! */
                    ,#{frstRegstId}             /** ID du premier enregistrant  != 최초등록자ID =! */
                    ,SYSTIMESTAMP               /** Date et heure de premier enregistrement != 최초등록일시 =! */
                    ,#{lastChprId}              /** ID du modificateur final != 최종변경자ID =! */
                    ,SYSTIMESTAMP               /** Date et heure de modification finale != 최종변경일시 =! */
        )
        ON CONFLICT (CAG_MGMT_NO, IBOBZ_CD, CNTR_NO)
        DO UPDATE
              SET INVN_YN         = #{invnYn}                   /** Stock On !==재고여부==! */
                 ,DEL_YN          = 'N'							/** Suppression On !==삭제여부==! */
                 ,LAST_CHPR_ID    = #{lastChprId}				/** ID du modificateur final != 최종변경자ID =! */
                 ,LAST_CHG_DTTM   = SYSTIMESTAMP				/** Date et heure de modification finale != 최종변경일시 =! */
    </update>

    <!--
    !== 수출물품반입번호를 조회.==! -->
    <select id="selectCarExpRlbrInfo" parameterType="alpass.ipt.car.bnwrhs.cagbrng.vo.CarCagBrngRlbrVo" resultType="alpass.ipt.car.bnwrhs.expcmdtbrng.vo.CarExpcmdtbrngVo">
        /* selectCarExpRlbrInfo */
        SELECT
	          A.EXP_CMDT_BRNG_RQNO
			, A.BL_NO															/**  N° De Bl 								 	!== BL번호 ==!  */
			, A.IBOBZ_CD														/**  Nombre de colis d'introduction/sortie  	!== 반출입포장개수 ==!  */
			, A.EXPPN_NIF
			, A.EXPPN_NM
			, A.EXPPN_ADDR_NM
        FROM  ALPASSEXT.TB_CARE_EXP_CMDT_BRNG A
        WHERE 1 = 1
        <if test="expCmdtBrngRqno != null and expCmdtBrngRqno != ''">
        AND   A.EXP_CMDT_BRNG_RQNO  = #{expCmdtBrngRqno}
        </if>
		<if test="blNo != null and blNo != ''">
        AND   A.BL_NO  = #{blNo}
        </if>
        AND   A.DEL_YN = 'N'
        AND   EXISTS ( SELECT 1
                       FROM ALPASSINT.TB_CARI_CAG_PRCS_BRKD /* CARI_화물_처리_내역 */
                       WHERE DEL_YN = 'N'
                       AND PRCS_STTS_CD IN ('D08', 'D10')
                       AND CAG_RQST_NO = A.EXP_CMDT_BRNG_RQNO
                   )
        LIMIT 1
    </select>

  <!--
    [Rechercher] Consulter la liste des "Demande d'accord préalable de l'exploitation de la zone sous douane"
    !== TB_CARI_RLBR 반입 / 반출 (신청) 신고 상세 조회 ==!
    -->
	<select id="selectCagBrngRlbrDetailInfo" resultType="alpass.ipt.car.bnwrhs.cagbrng.vo.CarCagBrngRlbrVo">
	/* alpass.ipt.car.bnwrhs.cagbrng.mapper.CarCagBrngMapper.selectCagBrngRlbrDetailInfo */
		SELECT
	          A.RLBR_RQST_NO														/**  N° Demande D'Introduction/Sortie  			!== 반출입신청번호 ==!  */
			, A.RLBR_TP_CD															/**  Code de catégorie d'introduction/sortie  	!== 반출입구분코드 ==!  */
			, A.JRSD_ORGN_CD														/**  Code D'Unité Compétente  					!== 관할조직코드 ==!  */
			, A.RLBR_DTTM															/**  Date/Heure d'introduction/sortie  			!== 반출입일시 ==!  */
			, A.IBOBZ_CD															/**  Code de zone sous douane  					!== 보세구역코드 ==!  */
			, A.RLBR_PT_CD															/**  Code de type d'introduction/sortie  		!== 반출입유형코드 ==!  */
			, A.CAG_MGMT_NO															/**  Crn  										!== 화물관리번호 ==!  */
			, A.BL_NO																/**  N° De Bl 								 	!== BL번호 ==!  */
			, A.RLBR_PCKG_GCNT														/**  Nombre de colis d'introduction/sortie  	!== 반출입포장개수 ==!  */
			, A.RLBR_WGHT															/**  Poids d'introduction/sortie  				!== 반출입중량 ==!  */
	        , A.DIVD_TP_CD															/**  Code De Type D'Éclatement  				!== 분할구분코드 ==!  */
			, A.BRNG_ACDN_PT_CD														/**  Code de type d'accident de l'introduction  !== 반입사고유형코드 ==!  */
			, A.BRNG_ACDN_GCNT														/**  Nombre d'accident d'introduction  			!== 반입사고개수 ==!  */
			, A.BRNG_ACDN_WGHT														/**  Poids d'accident d'introduction  			!== 반입사고중량 ==!  */
			, A.TRSN_DTTM															/**  Date et heure de transmission  			!== 전송일시 ==!  */
			, A.TRSN_CO_CD															/**  Code d'entreprise transmettrice  			!== 전송업체코드 ==!  */
			, A.DEL_YN																/**  Suppression On  							!== 삭제여부 ==!  */
			, A.FRST_REGST_ID														/**  Id Du Premier Enregistrant   				!== 최초등록자ID ==!  */
			, A.FRST_RGSR_DTTM														/**  Date Et Heure De Premier Enregistrement  	!== 최초등록일시 ==!  */
			, A.LAST_CHPR_ID														/**  Id Du Modificateur Final  					!== 최종변경자ID ==!  */
			, A.LAST_CHG_DTTM														/**  Date Et Heure De Modification Finale  		!== 최종변경일시 ==!  */
			, A.RELA_NO																/**  Numéro Concerné  							!== 관련번호 ==!  */
			, A.PCKG_UT_CD															/**  Code De L'Unité De Colis  					!== 포장단위코드 ==!  */
			, A.TRSF_PRNG_DT														/**  Date D'Aliénation Prévue                   !== 양도예정일자 ==!  */
			, A.CO_RQST_NO 															/**  N° de demande d'entreprise 			 	!== 업체신청번호 ==!  */
			, A.ATCH_FILE_ID
			, A.AUDT_DTTM    														/**  Date De L'Étude  						 	!== 심사일시 ==!  */
			, A.AUDT_PT_CD   														/**  Code De Type De Contrôle  				 	!== 심사유형코드 ==!  */
			, A.AUDT_RSLT_CN 														/**  Contenu Du Résultat De La Vérification  	!== 심사결과내용 ==!  */
			, A.PDLS_NM                                                             /**  Nom De L'Article                           !== 품목명 ==!  */
		FROM ALPASSINT.TB_CARI_RLBR A
		WHERE 1 = 1
		AND   A.DEL_YN = 'N'
        /** Code de type d'introduction/sortie  !== 반출입유형코드 ==!  */
        <if test="rlbrPtCd != null and rlbrPtCd != ''">
          AND  A.RLBR_PT_CD = #{rlbrPtCd}
        </if>

         /**  Code De Statut De Traitement  	!== 반출입구분코드 ==!  */
        <if test="rlbrTpCd != null and rlbrTpCd != ''">
          AND  A.RLBR_TP_CD = #{rlbrTpCd}
        </if>

        /**  Code De Statut De Traitement  		!== 반입신청번호 ==!  */
        <if test="rlbrRqstNo != null and rlbrRqstNo != ''">
          AND  A.RLBR_RQST_NO = #{rlbrRqstNo}
        </if>

         /**  Code De Statut De Traitement  	!== 화물관리번호 ==!  */
        <if test="cagMgmtNo != null and cagMgmtNo != ''">
          AND  A.CAG_MGMT_NO = #{cagMgmtNo}
        </if>
        ORDER BY A.LAST_CHG_DTTM DESC
        LIMIT 1
  </select>

</mapper>
