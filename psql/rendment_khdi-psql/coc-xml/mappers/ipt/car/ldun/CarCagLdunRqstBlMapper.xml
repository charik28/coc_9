<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="alpass.ipt.car.ldun.mapper.CarCagLdunRqstBlMapper">

    <!--
    Voir la liste des B/L !== B/L 목록 조회 ==!
    (Lee KyoungSung)
    -->
    <select id="selectCarCagLdunRqstBlList" parameterType="alpass.ipt.car.ldun.vo.CarCagLdunRqstBlVo" resultType="alpass.ipt.car.ldun.vo.CarCagLdunRqstBlVo">
        /* CarCagLdunRqstBlMapper.selectCarCagLdunRqstBlList */
        SELECT A.ldun_rqst_mgmt_no                                       AS ldun_rqst_mgmt_no    /** N° Demande De La Création De Crn !== 화물관리번호 ==! */
             , A.BL_NO                                                  AS BL_NO               /** N° De Bl !== BL번호 ==! */
             , A.IBOBZ_CD                                               AS IBOBZ_CD            /** Code de zone sous douane !== 보세구역코드 ==! */
             , A.STVD_CD                                                AS STVD_CD             /** Code de zone sous douane !== 보세구역코드 ==! */
             , A.DEL_YN                                                 AS DEL_YN              /** Suppression On !== 삭제여부 ==! */
             , A.FRST_REGST_ID                                          AS FRST_REGST_ID       /** Id Du Premier Enregistrant !== 최초등록자ID ==! */
             , TO_CHAR(A.FRST_RGSR_DTTM,'DD/MM/YYYY HH24:MI:SS')        AS FRST_RGSR_DTTM      /** Date Et Heure De Premier Enregistrement !== 최초등록일시 ==! */
             , A.last_chpr_id                                           AS last_chpr_id        /** Id Du Modificateur Final !== 최종변경자ID ==! */
             , TO_CHAR(A.LAST_CHG_DTTM,'DD/MM/YYYY HH24:MI:SS')         AS LAST_CHG_DTTM       /** Date Et Heure De Modification Finale !== 최종변경일시 ==! */
          FROM TB_CARE_LDUN_BL A
         WHERE 1=1
           AND A.DEL_YN = 'N'
           AND A.ldun_rqst_mgmt_no = #{ldunRqstMgmtNo}              /**  !== 화물관리번호 ==! */
    </select>

	<update id="updateCareLdunRqstBlNo" parameterType="alpass.ipt.car.ldun.vo.CarCagLdunRqstBlVo">
        /* CarCagLdunRqstBlMapper.updateCareLdunRqstBlNo */
        UPDATE alpassext.TB_CARE_LDUN_BL SET
               del_yn = 'N'                                  /** Suppression ON !== 삭제여부 ==! */
             , last_chpr_id = #{lastChprId}                  /** ID du modificateur final !== 최종변경자ID ==! */
             , last_chg_dttm = SYSTIMESTAMP                  /** Date et heure de modification finale !== 최종변경일시 ==! */
             <if test="blNo != null and blNo != ''">
             , BL_NO = #{blNo}                       
             </if>
         WHERE 1=1
           AND ldun_rqst_mgmt_no IN (SELECT LDUN_RQST_MGMT_NO FROM alpassext.TB_CARE_LDUN
								      WHERE MRN = #{mrn}
										AND PRCS_STTS_CD != 'D09'
										AND DEL_YN = 'N'
           							)  
           AND del_yn = 'N'	
           AND bl_no = #{bfBlNo}						
    </update>
    
    <update id="updateCariLdunRqstBlNo" parameterType="alpass.ipt.car.ldun.vo.CarCagLdunRqstBlVo">
        /* CarCagLdunRqstBlMapper.updateCariLdunRqstBlNo */
        UPDATE TB_CARI_LDUN_BL SET
               del_yn = 'N'                                  /** Suppression ON !== 삭제여부 ==! */
             , last_chpr_id = #{lastChprId}                  /** ID du modificateur final !== 최종변경자ID ==! */
             , last_chg_dttm = SYSTIMESTAMP                  /** Date et heure de modification finale !== 최종변경일시 ==! */
             <if test="blNo != null and blNo != ''">
             , BL_NO = #{blNo}                       
             </if>
         WHERE 1=1
           AND ldun_rqst_no IN (SELECT A.LDUN_RQST_NO FROM TB_CARI_LDUN A, TB_CARI_CAG_PRCS_BRKD B
								 WHERE MRN = #{mrn}
								   AND A.DEL_YN = 'N'
								   AND A.LDUN_RQST_NO = B.CAG_RQST_NO
								   AND A.CAG_RQST_TP_CD = B.CAG_RQST_TP_CD
								   AND B.PRCS_STTS_CD = 'D08'
           					   )  
           AND del_yn = 'N'		
           AND bl_no = #{bfBlNo}						
    </update>
    
    <insert id="insertCareLdunRqstBl"
            parameterType="alpass.ipt.car.ldun.vo.CarCagLdunRqstBlVo">
    /* CarCagLdunRqstBlMapper.insertCareLdunRqstBl */
        INSERT INTO alpassext.tb_care_ldun_bl
             ( ldun_rqst_mgmt_no             /** N° De Gestion De Demande De Déchargement !== 양하신청관리번호 ==! */
             , bl_no                         /** N° De Bl !== BL번호 ==! */
             , ibobz_cd                      /** Code de zone sous douane !== 보세구역코드 ==! */
             , stvd_cd                       /** Code De Stevedoremanutentionnaire !== 하역업자코드 ==! */
             , del_yn                        /** Suppression On !== 삭제여부 ==! */
             , frst_regst_id                 /** Id Du Premier Enregistrant !== 최초등록자ID ==! */
             , frst_rgsr_dttm                /** Date Et Heure De Premier Enregistrement !== 최초등록일시 ==! */
             , last_chpr_id                  /** Id Du Modificateur Final !== 최종변경자ID ==! */
             , last_chg_dttm                 /** Date Et Heure De Modification Finale !== 최종변경일시 ==! */
             )
        VALUES ( (SELECT ldun_rqst_mgmt_no
                    FROM alpassext.tb_care_ldun
                   WHERE mrn = #{mrn}
                     AND prcs_stts_cd != 'D09'
                     AND del_yn = 'N')       /** N° De Gestion De Demande De Déchargement !== 양하신청관리번호 ==! */
             , #{blNo}                      /** N° De Bl !== BL번호 ==! */
             , #{ibobzCd}                   /** Code de zone sous douane !== 보세구역코드 ==! */
             , #{stvdCd}                    /** Code De Stevedoremanutentionnaire !== 하역업자코드 ==! */
             , 'N'                           /** Suppression On !== 삭제여부 ==! */
             , #{frstRegstId}                /** Id Du Premier Enregistrant !== 최초등록자ID ==! */
             , SYSTIMESTAMP                  /** Date Et Heure De Premier Enregistrement !== 최초등록일시 ==! */
             , #{lastChprId}                 /** Id Du Modificateur Final !== 최종변경자ID ==! */
             , SYSTIMESTAMP                  /** Date Et Heure De Modification Finale !== 최종변경일시 ==! */
             )
    </insert>
    
    <insert id="insertCariLdunRqstBl"
            parameterType="alpass.ipt.car.ldun.vo.CarCagLdunRqstBlVo">
    /* CarCagLdunRqstBlMapper.insertCariLdunRqstBl */
        INSERT INTO tb_cari_ldun_bl
             ( ldun_rqst_no                  /** N° De Demande De Déchargement !== 하역신청번호 ==! */
             , bl_no                         /** N° De Bl !== BL번호 ==! */
             , ibobz_cd                      /** Code de zone sous douane !== 보세구역코드 ==! */
             , stvd_cd                       /** Code De Stevedoremanutentionnaire !== 하역업자코드 ==! */
             , del_yn                        /** Suppression On !== 삭제여부 ==! */
             , frst_regst_id                 /** Id Du Premier Enregistrant !== 최초등록자ID ==! */
             , frst_rgsr_dttm                /** Date Et Heure De Premier Enregistrement !== 최초등록일시 ==! */
             , last_chpr_id                  /** Id Du Modificateur Final !== 최종변경자ID ==! */
             , last_chg_dttm                 /** Date Et Heure De Modification Finale !== 최종변경일시 ==! */
             )
        VALUES ( (SELECT a.ldun_rqst_no
                    FROM tb_cari_ldun a
                       , tb_cari_cag_prcs_brkd b
                   WHERE mrn = #{mrn}
                     AND a.del_yn = 'N'
                     AND a.ldun_rqst_no = b.cag_rqst_no
                     AND a.cag_rqst_tp_cd = b.cag_rqst_tp_cd
                     AND b.prcs_stts_cd = 'D08')  /** N° De Demande De Déchargement !== 하역신청번호 ==! */
             , #{blNo}                           /** N° De Bl !== BL번호 ==! */
             , #{ibobzCd}                        /** Code de zone sous douane !== 보세구역코드 ==! */
             , #{stvdCd}                         /** Code De Stevedoremanutentionnaire !== 하역업자코드 ==! */
             , 'N'                           /** Suppression On !== 삭제여부 ==! */
             , #{frstRegstId}                    /** Id Du Premier Enregistrant !== 최초등록자ID ==! */
             , SYSTIMESTAMP                   /** Date Et Heure De Premier Enregistrement !== 최초등록일시 ==! */
             , #{lastChprId}                     /** Id Du Modificateur Final !== 최종변경자ID ==! */
             , SYSTIMESTAMP                    /** Date Et Heure De Modification Finale !== 최종변경일시 ==! */
             )
    </insert>
    
    <insert id="insertCareLdunRqstMdfyBlByMblAdd"
            parameterType="alpass.ipt.car.ldun.vo.CarCagLdunRqstMdfyBlVo">
    /* CarCagLdunRqstBlMapper.insertCareLdunRqstMdfyBlByMblAdd */
        INSERT INTO alpassext.tb_care_ldun_mdfy_bl
             ( ldun_rqst_mdfy_mgrn           
             , bl_no                         /** N° De Bl !== BL번호 ==! */
             , ibobz_cd                      /** Code de zone sous douane !== 보세구역코드 ==! */
             , stvd_cd                       /** Code De Stevedoremanutentionnaire !== 하역업자코드 ==! */
             , del_yn                        /** Suppression On !== 삭제여부 ==! */
             , frst_regst_id                 /** Id Du Premier Enregistrant !== 최초등록자ID ==! */
             , frst_rgsr_dttm                /** Date Et Heure De Premier Enregistrement !== 최초등록일시 ==! */
             , last_chpr_id                  /** Id Du Modificateur Final !== 최종변경자ID ==! */
             , last_chg_dttm                 /** Date Et Heure De Modification Finale !== 최종변경일시 ==! */
             , mdfy_dgcnt                    
             )
        VALUES ( (SELECT A.ldun_rqst_mdfy_mgrn
                    FROM tb_cari_ldun_mdfy A
                   WHERE MRN = #{mrn}
                     AND A.DEL_YN = 'N'
                     AND A.mdfy_dgcnt = 0)   
             , #{blNo}                      /** N° De Bl !== BL번호 ==! */
             , #{ibobzCd}                   /** Code de zone sous douane !== 보세구역코드 ==! */
             , #{stvdCd}                    /** Code De Stevedoremanutentionnaire !== 하역업자코드 ==! */
             , 'N'                           /** Suppression On !== 삭제여부 ==! */
             , #{frstRegstId}                /** Id Du Premier Enregistrant !== 최초등록자ID ==! */
             , SYSTIMESTAMP                  /** Date Et Heure De Premier Enregistrement !== 최초등록일시 ==! */
             , #{lastChprId}                 /** Id Du Modificateur Final !== 최종변경자ID ==! */
             , SYSTIMESTAMP                  /** Date Et Heure De Modification Finale !== 최종변경일시 ==! */
             , 0                             
             )
    </insert>
    
    <insert id="insertCariLdunRqstMdfyBlByMblAdd"
            parameterType="alpass.ipt.car.ldun.vo.CarCagLdunRqstMdfyBlVo">
    /* CarCagLdunRqstBlMapper.insertCariLdunRqstMdfyBlByMblAdd */
        INSERT INTO tb_cari_ldun_bl_mdfy
             ( ldun_rqst_mdfy_no           
             , bl_no                         /** N° De Bl !== BL번호 ==! */
             , ibobz_cd                      /** Code de zone sous douane !== 보세구역코드 ==! */
             , stvd_cd                       /** Code De Stevedoremanutentionnaire !== 하역업자코드 ==! */
             , del_yn                        /** Suppression On !== 삭제여부 ==! */
             , frst_regst_id                 /** Id Du Premier Enregistrant !== 최초등록자ID ==! */
             , frst_rgsr_dttm                /** Date Et Heure De Premier Enregistrement !== 최초등록일시 ==! */
             , last_chpr_id                  /** Id Du Modificateur Final !== 최종변경자ID ==! */
             , last_chg_dttm                 /** Date Et Heure De Modification Finale !== 최종변경일시 ==! */
             )
        VALUES ( (SELECT A.ldun_rqst_mdfy_no
                    FROM tb_cari_ldun_mdfy A
                   WHERE MRN = #{mrn}
                     AND A.DEL_YN = 'N'
                     AND A.mdfy_dgcnt = 0)   
             , #{blNo}                      /** N° De Bl !== BL번호 ==! */
             , #{ibobzCd}                   /** Code de zone sous douane !== 보세구역코드 ==! */
             , #{stvdCd}                    /** Code De Stevedoremanutentionnaire !== 하역업자코드 ==! */
             , 'N'                           /** Suppression On !== 삭제여부 ==! */
             , #{frstRegstId}                /** Id Du Premier Enregistrant !== 최초등록자ID ==! */
             , SYSTIMESTAMP                  /** Date Et Heure De Premier Enregistrement !== 최초등록일시 ==! */
             , #{lastChprId}                 /** Id Du Modificateur Final !== 최종변경자ID ==! */
             , SYSTIMESTAMP                  /** Date Et Heure De Modification Finale !== 최종변경일시 ==! */
             )
    </insert>
</mapper>