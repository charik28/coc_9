<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="alpass.ipt.psc.vhcl.pdr.dre.mapper.PscDcshSplmQryMapper">
	<!-- 보완요구 여부 조회   -->
	<select id="selectSplmQryYn" parameterType="alpass.ipt.psc.vhcl.pdr.dre.vo.ClrDedSrchVo" resultType="java.lang.String">
		/* selectSplmQryYn */
		SELECT 1 AS SPLM_QRY_YN
		FROM TB_CLRI_DED_SPLM_QRY
		WHERE DTL_DCSH_NO = #{dtlDcshNo}
		  AND DEL_YN = 'N'
		  AND SPLM_QRY_INFM_YN = 'Y'
		  AND LAST_YN = 'Y'
	</select>

	<!--
    Consultation des demandes de complément !== 보완요구 조회 ==!
    (Kim Kiryong)
    -->
	<!-- ClrDedSplmQryVo selectClrDedSplmQryInfo(ClrDedSplmQryVo searchVo); -->
	<select id="selectSplmQry" parameterType="alpass.ipt.psc.vhcl.pdr.dre.vo.ClrDedSrchVo" resultType="alpass.ipt.psc.vhcl.pdr.dre.vo.ClrDedSplmQryVo">
		SELECT
			A.dtl_dcsh_no
			 , A.splm_qry_dgcnt
			 , A.splm_qry_emp_id
			 , TO_CHAR(TO_DATE(A.splm_qry_dt         , 'YYYYMMDD'),'DD/MM/YYYY') AS splm_qry_dt
			 , A.splm_qry_cn
			 , TO_CHAR(TO_DATE(A.splm_qry_clsn_dt    , 'YYYYMMDD'),'DD/MM/YYYY') AS splm_qry_clsn_dt
			 , A.splm_qry_infm_yn
			 , A.last_yn
			 , A.del_yn
			 , A.frst_regst_id
			 , A.frst_rgsr_dttm
			 , A.last_chpr_id
			 , A.last_chg_dttm
		FROM   TB_CLRI_DED_SPLM_QRY A
		WHERE  A.del_yn = 'N'
		  AND  A.dtl_dcsh_no = #{dtlDcshNo}
		  AND A.last_yn = 'Y'
	</select>


	<!--
    Consultation de la liste des demandes de complément !== 보완요구 목록 조회 ==!
    (Kim Kiryong)
    -->
	<!-- List<ClrDedSplmQryVo> selectSplmQryList(ClrDedSrchVo searchVo); -->
	<select id="selectSplmQryList" parameterType="alpass.ipt.psc.vhcl.pdr.dre.vo.ClrDedSrchVo" resultType="alpass.ipt.psc.vhcl.pdr.dre.vo.ClrDedSplmQryVo">
		<include refid="pagination.header" ></include>
		SELECT
		A.dtl_dcsh_no              /** Numero de la déclaration en détail!! !== 상세신고서번호 ==! */
		, A.splm_qry_dgcnt             /** Nombre de fois de la demande de complément !== 보완요구차수 ==! */
		, A.splm_qry_emp_id            /** ID de la personne demandant le complément !== 보완요구직원ID ==! */
		, TO_CHAR(TO_DATE(A.splm_qry_dt         , 'YYYYMMDD'),'DD/MM/YYYY') AS splm_qry_dt                /** Date de demande de complément !== 보완요구일자 ==! */
		, A.splm_qry_cn                /** Contenu de la demande de complément !== 보완요구내용 ==! */
		, TO_CHAR(TO_DATE(A.splm_qry_clsn_dt    , 'YYYYMMDD'),'DD/MM/YYYY') AS splm_qry_clsn_dt           /** Date d'échéance de la demande de complément !== 보완요구마감일자 ==! */
		, A.splm_qry_infm_yn           /** Demande de complément notifiée on !== 보안요구통보여부 ==! */
		, A.last_yn                    /** Final On !== 최종여부 ==! */
		, A.del_yn                     /** Suppression On !== 삭제여부 ==! */
		, A.frst_regst_id              /** Id Du Premier Enregistrant  !== 최초등록자ID ==! */
		, TO_CHAR(A.frst_rgsr_dttm      , 'DD/MM/YYYY') AS frst_rgsr_dttm             /** Date Et Heure De Premier Enregistrement !== 최초등록일시 ==! */
		, A.last_chpr_id               /** Id Du Modificateur Final !== 최종변경자ID ==! */
		, TO_CHAR(A.last_chg_dttm       , 'DD/MM/YYYY') AS last_chg_dttm              /** Date Et Heure De Modification Finale !== 최종변경일시 ==! */
		FROM   TB_CLRI_DED_SPLM_QRY A
		WHERE  del_yn = 'N'                /** Suppression ON !== 삭제여부 ==! */
		AND  A.dtl_dcsh_no = #{dtlDcshNo}                /** Numero de la déclaration en détail!! !== 상세신고서번호 ==! */
		<include refid="pagination.footer" ></include>
	</select>

	<!-- 보완요구 등록 전 미처리건 조회   -->
	<select id="selectSplmQryInsertDupChk" parameterType="String" resultType="String">
		/* ClriDpsSplm_selectSplmQryInsertDupChk */
		SELECT LAST_YN
		FROM TB_CLRI_DED_SPLM_QRY
		WHERE dtl_dcsh_no = #{dtlDcshNo}
		  AND LAST_YN = 'Y'
		  AND DEL_YN   = 'N'
	</select>

	<!--
    !==보완요구 통보여부('Y') 수정==!
    -->
	<update id="updateSplmQryInfmYn" parameterType="alpass.ipt.psc.vhcl.pdr.dre.vo.ClrDedSplmQryVo">
		/* ClriDpsSplm_updateSplmQryInfmYn */
		UPDATE TB_CLRI_DED_SPLM_QRY
		SET SPLM_QRY_INFM_YN = 'Y'
		  ,  LAST_CHPR_ID = #{lastChprId}                  /** ID du modificateur final !== 최종변경자ID ==! */
		  ,  LAST_CHG_DTTM = SYSTIMESTAMP                  /** Date et heure de modification finale !== 최종변경일시 ==! */
		WHERE  DEL_YN = 'N'                               /** Suppression ON !== 삭제여부 ==! */
		  AND dtl_dcsh_no = #{dtlDcshNo}
		  AND SPLM_QRY_DGCNT = #{splmQryDgcnt}

	</update>


	<!--
    Enregistrement de la demande de complément !== 보완요구 등록 ==!
    (Kim Kiryong)
    -->
	<insert id="insertSplmQry" parameterType="alpass.ipt.psc.vhcl.pdr.dre.vo.ClrDedSplmQryVo">
		<selectKey keyProperty="splmQryDgcnt" resultType="BigDecimal" order="BEFORE">
			SELECT NVL(MAX(SPLM_QRY_DGCNT), 0) + 1 FROM TB_CLRI_DED_SPLM_QRY WHERE dtl_dcsh_no =  #{dtlDcshNo}	AND DEL_YN = 'N'
		</selectKey>
		/* insertClrDedSplmQry */
		INSERT INTO TB_CLRI_DED_SPLM_QRY (
			dtl_dcsh_no                            /** Numero de la déclaration en détail!! !== 상세신고서번호 ==! */
		, splm_qry_dgcnt                       /** Nombre de fois de la demande de complément !== 보완요구차수 ==! */
		, splm_qry_emp_id                      /** ID de la personne demandant le complément !== 보완요구직원ID ==! */
		, splm_qry_dt                          /** Date de demande de complément !== 보완요구일자 ==! */
		, splm_qry_cn                          /** Contenu de la demande de complément !== 보완요구내용 ==! */
		, splm_qry_clsn_dt                     /** Date d'échéance de la demande de complément !== 보완요구마감일자 ==! */
		, splm_qry_infm_yn                     /** Demande de complément notifiée on !== 보안요구통보여부 ==! */
		, last_yn                              /** Final On !== 최종여부 ==! */
		, del_yn                               /** Suppression On !== 삭제여부 ==! */
		, frst_regst_id                        /** Id Du Premier Enregistrant  !== 최초등록자ID ==! */
		, frst_rgsr_dttm                              /** Date Et Heure De Premier Enregistrement !== 최초등록일시 ==! */
		, last_chpr_id                         /** Id Du Modificateur Final !== 최종변경자ID ==! */
		, last_chg_dttm                               /** Date Et Heure De Modification Finale !== 최종변경일시 ==! */
		) VALUES (
					 #{dtlDcshNo}                           /** Numero de la déclaration en détail!! !== 상세신고서번호 ==! */
				 , #{splmQryDgcnt}                              /** Nombre de fois de la demande de complément !== 보완요구차수 ==! */
				 , #{splmQryEmpId}                              /** ID de la personne demandant le complément !== 보완요구직원ID ==! */
				 , TO_CHAR(SYSDATE,'YYYYMMDD')  /** Date de demande de complément !== 보완요구일자 ==! */
				 <if test="splmQryCn != null and splmQryCn != ''">
				 , #{splmQryCn}                                 /** Contenu de la demande de complément !== 보완요구내용 ==! */
				 </if>
		         <if test="splmQryClsnDt != null and splmQryClsnDt != ''">
				 , TO_CHAR(TO_DATE(#{splmQryClsnDt}, 'DD/MM/YYYY'),'YYYYMMDD')  /** Date d'échéance de la demande de complément !== 보완요구마감일자 ==! */
				 </if>
				 , NVL(#{splmQryInfmYn}, 'N')                             /** Demande de complément notifiée on !== 보안요구통보여부 ==! */
				 , 'Y'                                    /** Final On !== 최종여부 ==! */
				 , 'N'                                          /** Suppression On !== 삭제여부 ==! */
				 , #{frstRegstId}                               /** Id Du Premier Enregistrant  !== 최초등록자ID ==! */
				 , SYSTIMESTAMP                                /** Date Et Heure De Premier Enregistrement !== 최초등록일시 ==! */
				 , #{lastChprId}                                /** Id Du Modificateur Final !== 최종변경자ID ==! */
				 , SYSTIMESTAMP                                /** Date Et Heure De Modification Finale !== 최종변경일시 ==! */
				 )
			ON CONFLICT ( dtl_dcsh_no,splm_qry_dgcnt )
        DO UPDATE SET
			splm_qry_emp_id = #{splmQryEmpId}                     /** ID de la personne demandant le complément !== 보완요구직원ID ==! */
		   ,splm_qry_dt = TO_CHAR(SYSDATE, 'YYYYMMDD')  /** Date de demande de complément !== 보완요구일자 ==! */
		    <if test="splmQryCn != null and splmQryCn != ''">
		   ,splm_qry_cn = #{splmQryCn}                           /** Contenu de la demande de complément !== 보완요구내용 ==! */
			</if>
			<if test="splmQryClsnDt != null and splmQryClsnDt != ''">
		   ,splm_qry_clsn_dt = TO_CHAR(TO_DATE(#{splmQryClsnDt}, 'DD/MM/YYYY'),'YYYYMMDD')  /** Date d'échéance de la demande de complément !== 보완요구마감일자 ==! */
			</if>
		   ,splm_qry_infm_yn = NVL(#{splmQryInfmYn}, 'N')                  /** Demande de complément notifiée on !== 보안요구통보여부 ==! */
		   ,last_yn = 'Y'                                  /** Final On !== 최종여부 ==! */
			, del_yn = 'N'
		   ,last_chpr_id = #{lastChprId}                         /** Id Du Modificateur Final !== 최종변경자ID ==! */
		   , last_chg_dttm = SYSTIMESTAMP                               /** Date Et Heure De Modification Finale !== 최종변경일시 ==! */
	</insert>

	<!-- 보완요구 삭제   -->
	<update id="deleteSplmQry" parameterType="alpass.ipt.psc.vhcl.pdr.dre.vo.ClrDedSplmQryVo">
		/* ClriDpsSplm_deleteSplmQry */
		UPDATE TB_CLRI_DED_SPLM_QRY
		SET DEL_YN = 'Y'
		  ,  LAST_CHPR_ID = #{lastChprId}                  /** ID du modificateur final !== 최종변경자ID ==! */
		  ,  LAST_CHG_DTTM = SYSTIMESTAMP                  /** Date et heure de modification finale !== 최종변경일시 ==! */
		WHERE  DEL_YN = 'N'                               /** Suppression ON !== 삭제여부 ==! */
		  AND dtl_dcsh_no = #{dtlDcshNo}
		  AND SPLM_QRY_DGCNT = #{splmQryDgcnt}
	</update>

	<!--
    Consultation de la liste des articles faisant l'objet de la demande de complément !== 보완요구 품목 목록 조회 ==!
    -->
	<select id="selectSplmQryPdlsList" parameterType="alpass.ipt.psc.vhcl.pdr.dre.vo.ClrDedSrchVo" resultType="alpass.ipt.psc.vhcl.pdr.dre.vo.ClrDedPdlsDcshVo">
		/* ClriDpsSplm_selectSplmQryPdlsList */
		SELECT
			A.DTL_DCSH_NO
			 , A.PDLS_NO
			 , A.HS_CD
			 , A.PDLS_NM
			 , A.ORCY_CNTY_CD
			 , C.PDLS_TXBS_NCY_AMT
			 , C.PDLS_TXBS_USD_AMT
			 , (
			SELECT SUM(PAY_TAX_AMT)
			FROM TB_CLRI_DED_VLUT_AUDT_TAX
			WHERE DTL_DCSH_NO = A.DTL_DCSH_NO
			  AND PDLS_NO = A.PDLS_NO
			  AND PAY_KND_CD IN ('1','2')
			  AND DEL_YN = 'N'
			  AND PRC_EV_DGCNT =  ( SELECT MAX(PRC_EV_DGCNT)
									FROM   TB_CLRI_DED_VLUT_AUDT_COMN
									WHERE  DEL_YN = 'N'
									  AND    DTL_DCSH_NO = A.DTL_DCSH_NO
			)
		) AS SUM_PDLS_TAX_AMT
		FROM  TB_CLRI_DED_PDLS A
		   , TB_CLRI_DED_COMN B
		   , TB_CLRI_DED_VLUT_PDLS C
		WHERE A.DTL_DCSH_NO = #{dtlDcshNo}
		  AND A.DTL_DCSH_NO = B.DTL_DCSH_NO
		  AND A.DTL_DCSH_NO = C.DTL_DCSH_NO
		  AND A.PDLS_NO = C.PDLS_NO
		  AND A.DEL_YN = 'N'
		  AND B.DEL_YN = 'N'
		  AND C.DEL_YN = 'N'
		ORDER BY TO_NUMBER(A.PDLS_NO)
	</select>

	<!--
    Consultation de la liste des documents joints faisant l'objet de la demande de complément !== 보완요구 첨부문서 목록 조회 ==!
    -->
	<select id="selectSplmQryAtdocList" parameterType="alpass.ipt.psc.vhcl.pdr.dre.vo.ClrDedSrchVo" resultType="alpass.ipt.psc.vhcl.pdr.dre.vo.ClrDedAtdocVo">
		/* ClriDpsSplm_selectSplmQryAtdocList */
		SELECT
			A.DTL_DCSH_NO
			 , A.ATCH_DOC_SRNO
			 , A.DOC_KND_CD
			 , A.PDLS_NO
			 , A.DOC_NO
			 , A.DOC_DESC
			 , A.ATCH_FILE_NM
			 , A.PBLS_ITT_NM
			 , TO_CHAR(TO_DATE(A.PBLS_DT, 'YYYYMMDD'),'DD/MM/YYYY') AS PBLS_DT
			 , A.ATCH_FILE_ID
		FROM	TB_CLRI_DED_ATDOC A
		WHERE A.DTL_DCSH_NO = #{dtlDcshNo}
		  AND A.DEL_YN = 'N'
	</select>

	<!-- 보완요구 이력 목록 조회   -->
	<select id="selectSplmQryHistList" parameterType="alpass.ipt.psc.vhcl.pdr.dre.vo.ClrDedSrchVo" resultType="alpass.ipt.psc.vhcl.pdr.dre.vo.ClrDedSplmQryDcshVo">
		/* ClriDpsSplm_selectSplmQryHistList */
		SELECT SPLM_QRY_DGCNT
			 , TO_CHAR(TO_DATE(A.SPLM_QRY_DT, 'YYYYMMDD'),'DD/MM/YYYY') AS SPLM_QRY_DT
			 , SUBSTR(A.SPLM_QRY_CN, 0, 20)||'...' AS SPLM_QRY_CN
			 , A.SPLM_QRY_CN AS SPLM_QRY_CN_FULL
			 , A.SPLM_QRY_EMP_ID
			 , (SELECT EMP_NM FROM TB_POTI_EMP WHERE PBSR_NO = A.SPLM_QRY_EMP_ID AND DEL_YN = 'N') AS SPLM_QRY_EMP_NM
			 , NVL(TO_CHAR(TO_DATE(A.SPLM_QRY_CLSN_DT, 'YYYYMMDD'),'DD/MM/YYYY'), TO_CHAR(ADD_MONTHS(SYSDATE, 1), 'DD/MM/YYYY') ) AS SPLM_QRY_CLSN_DT
			 , SPLM_QRY_INFM_YN                                                                                                                        /** !== 보안요구통보여부(Y/N) ==! */
			 , DECODE(SPLM_QRY_INFM_YN, 'Y', DECODE(LAST_YN, 'N', 'Y', 'N')) AS SPLM_CMPL_YN                                                           /** !== 보완완료여부(보완요구통보이후 LAST_YN N이면 수정됨, 아니면 수정안됨) ==! */
		FROM TB_CLRI_DED_SPLM_QRY A
		WHERE DTL_DCSH_NO = #{dtlDcshNo}
		  AND DEL_YN   = 'N'
		ORDER BY FRST_RGSR_DTTM DESC
	</select>

	<!-- 보완요구 처리 여부 조회   -->
	<select id="selectSplmQryPrcsYn" parameterType="alpass.ipt.psc.vhcl.pdr.dre.vo.ClrDedSrchVo" resultType="java.lang.String">
		/* ClriDpsPstp_selectSplmQryPrcsYn */
		SELECT 1 AS SPLM_QRY_PRCS_YN
		FROM TB_CLRI_DED_SPLM_QRY
		WHERE DTL_DCSH_NO = #{dtlDcshNo}
		  AND DEL_YN = 'N'
		  AND SPLM_QRY_INFM_YN = 'N'
		  AND LAST_YN = 'Y'
	</select>
</mapper>
