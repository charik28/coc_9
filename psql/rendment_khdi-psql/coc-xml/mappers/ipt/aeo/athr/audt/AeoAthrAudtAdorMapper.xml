<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<!--
Mapper : Gérer l'auditeur. !== 심사자관리 Mapper.  abdelhak was here==!
(wonjun.cha)
-->
<mapper namespace="alpass.ipt.aeo.athr.audt.mapper.AeoAthrAudtAdorMapper">

    <!--
    [Gérer l'auditeur] Consulter la liste !== [심사자관리] 목록조회 ==!
    -->
    <select id="selectAeoAthrAudtAdorList"
	    parameterType="alpass.ipt.aeo.athr.audt.vo.AeoAthrAudtAdorVo"
	    resultType="alpass.ipt.aeo.athr.audt.vo.AeoAthrAudtAdorVo">
		/* selectAeoAthrAudtAdorList */
	    <include refid="pagination.header"/>
		SELECT
				  EMP.PBSR_NO AS ADOR_ID					/** Id De L'Inspecteur !== 심사자ID ==! */
				, EMP.EMP_NM								/** Nom De L'Employé !== 직원명 ==! */
				, EMP.ORGN_MGMT_CD							/** Code de gestion de l'organisation !== 조직관리코드 ==! */
				, (SELECT ORGN_NM FROM  TB_POTI_ORGN WHERE ORGN_MGMT_CD = UPPER(EMP.ORGN_MGMT_CD)) AS ORGN_NM	/** Nom D'Organisme !== 조직명 ==! */
				, EMP.CSTM_MGMT_CD							/** Code Du Bureau !== 세관관리코드 ==! */
				, (SELECT ORGN_NM FROM  TB_POTI_ORGN WHERE ORGN_MGMT_CD = UPPER(EMP.CSTM_MGMT_CD)) AS CSTM_MGMT_CD_NM	/** Code Du Bureau !== 세관관리코드 ==! */
				, EMP.SCTR_MGMT_CD							/** Code Du Secteur !== 섹터관리코드 ==! */
				, (SELECT ORGN_NM FROM  TB_POTI_ORGN WHERE ORGN_MGMT_CD = UPPER(EMP.SCTR_MGMT_CD)) AS SCTR_MGMT_CD_NM	/** Code Du Secteur !== 섹터관리코드 ==! */
				, EMP.FONC_CD								/** Code de Fonction !==직무코드==! */
				, (SELECT FONC_CD_NM FROM TB_POTI_FONC_CD_LANG WHERE FONC_CD = EMP.FONC_CD AND LANG_CD = #{langCd} AND DEL_YN = 'N') AS FONC_CD_NM	/** Code de Fonction !==직무코드==! */
				, EMP.EML									/** Email !== 이메일 ==! */
				, EMP.DEPT_TLPH_NO							/** N° De Téléphone Fixe Du Bureau !== 부서전화번호 ==! */
		  FROM    TB_POTI_EMP EMP
	          	, VW_POTI_ROLE_UNFC PEA
	     WHERE	  EMP.DEL_YN = 'N'				/** Suppression ON !== 삭제여부 ==! */
	       AND	  PEA.PBSR_NO = EMP.PBSR_NO
        <if test="srchAdorTpCd != null and srchAdorTpCd == 'ADO' ">
           AND    PEA.ROLE_ID = 'AEO003'
        </if>
        <if test="srchAdorTpCd != null and srchAdorTpCd == 'SPT' ">
           AND    PEA.ROLE_ID = 'AEO007'
        </if>
	    <if test="srchCstm != null and srchCstm != ''">
	       AND 	EMP.CSTM_MGMT_CD = ( SELECT ORGN_MGMT_CD FROM TB_POTI_ORGN
                                     WHERE DEL_YN = 'N'
                                     AND ORGN_CD = #{srchCstm}
                                   )
	    </if>
	    <if test="srchSector != null and srchSector != ''">
	       AND 	EMP.ORGN_MGMT_CD = ( SELECT ORGN_MGMT_CD FROM TB_POTI_ORGN
                                     WHERE DEL_YN = 'N'
                                     AND ORGN_CD = #{srchSector}
                                   )
	    </if>
	    <if test="srchName != null and srchName != ''">
	       AND 	EMP.EMP_NM LIKE '%' || #{srchName} || '%'
	    </if>
	    <if test="srchPbsrNo != null and srchPbsrNo != ''">
	       AND  EMP.PBSR_NO = #{srchPbsrNo}
	    </if>
	     ORDER BY EMP.LAST_CHG_DTTM DESC
		<include refid="pagination.footer"/>
	</select>


    <!--
    [Gérer l'auditeur] Enregistrer !== [심사자관리] 등록 ==!
    -->
	<insert id="insertAeoAthrAudtAdor"
		parameterType="alpass.ipt.aeo.athr.audt.vo.AeoAthrAudtAdorVo">
		/* insertAeoAthrAudtAdor */
        WITH UPSERT AS  (
			UPDATE TB_AEOI_ADOR_MGMT
			   SET
					  LAST_CHPR_ID = #{lastChprId}          /** Id Du Modificateur Final !== 최종변경자ID ==! */            
					, LAST_CHG_DTTM = CURRENT_TIMESTAMP		/** Date Et Heure De Modification Finale !== 최종변경일시 ==! */ 
					, DEL_YN = 'N'							/** Suppression On !== 삭제여부 ==! */
			 WHERE
		          	  ADOR_ID = #{adorId}					/** Numéro de série de gestion d'auditeur !== 심사자관리일련번호 ==! */
		       AND	  ADOR_TP_CD = #{adorTpCd}				/** Code de classification d'auditeur !== 심사자구분코드 ==! */
		     RETURNING *
        )
		INSERT INTO TB_AEOI_ADOR_MGMT (
				  ADOR_MGMT_SRNO			/** Numéro de série de gestion d'auditeur !== 심사자관리일련번호 ==! */
				, ADOR_ID					/** Id De L'Inspecteur !== 심사자ID ==! */
				, ADOR_TP_CD				/** Code de classification d'auditeur !== 심사자구분코드 ==! */
				, DEL_YN					/** Suppression On !== 삭제여부 ==! */
				, FRST_REGST_ID				/** Id Du Premier Enregistrant  !== 최초등록자ID ==! */
				, FRST_RGSR_DTTM			/** Date Et Heure De Premier Enregistrement !== 최초등록일시 ==! */
				, LAST_CHPR_ID				/** Id Du Modificateur Final !== 최종변경자ID ==! */
				, LAST_CHG_DTTM				/** Date Et Heure De Modification Finale !== 최종변경일시 ==! */
		)
		SELECT
				  (SELECT LPAD(COALESCE(CAST(MAX(ADOR_MGMT_SRNO) AS INTEGER),0)+1, 5, '0') FROM TB_AEOI_ADOR_MGMT) 			/** Numéro de série de gestion d'auditeur !== 심사자관리일련번호 ==! */  
				, #{adorId}          		/** Id De L'Inspecteur !== 심사자ID ==! */                         
				, #{adorTpCd}          		/** Code de classification d'auditeur !== 심사자구분코드 ==! */        
				, 'N'	         			/** Suppression On !== 삭제여부 ==! */                              
				, #{frstRegstId}          	/** Id Du Premier Enregistrant  !== 최초등록자ID ==! */              
				, CURRENT_TIMESTAMP         /** Date Et Heure De Premier Enregistrement !== 최초등록일시 ==! */   
				, #{lastChprId}          	/** Id Du Modificateur Final !== 최종변경자ID ==! */                 
				, CURRENT_TIMESTAMP         /** Date Et Heure De Modification Finale !== 최종변경일시 ==! */ 
		 WHERE	NOT EXISTS (SELECT * FROM UPSERT)
	</insert>

    <!--
    [Gérer l'auditeur] Modifier !== [심사자관리] 수정 ==!
    -->
	<update id="updateAeoAthrAudtAdor"
		parameterType="alpass.ipt.aeo.athr.audt.vo.AeoAthrAudtAdorVo">
		  /* updateAeoAthrAudtAdor */
		  UPDATE  TB_AEOI_ADOR_MGMT
		  SET
				  LAST_CHPR_ID = #{lastChprId}          /** Id Du Modificateur Final !== 최종변경자ID ==! */            
				, LAST_CHG_DTTM = CURRENT_TIMESTAMP		/** Date Et Heure De Modification Finale !== 최종변경일시 ==! */ 
				, ADOR_ID = #{adorId}          			/** Id De L'Inspecteur !== 심사자ID ==! */
		  WHERE
	          	  DEL_YN = 'N'							/** Suppression ON !== 삭제여부 ==! */
	        AND	  ADOR_MGMT_SRNO = #{adorMgmtSrno}		/** Numéro de série de gestion d'auditeur !== 심사자관리일련번호 ==! */ 
	</update>

    <!--
    [Gérer l'auditeur] Supprimer !== [심사자관리] 삭제 ==!
    -->
	<update id="deleteAeoAthrAudtAdor"
		parameterType="alpass.ipt.aeo.athr.audt.vo.AeoAthrAudtAdorVo">
		  /* deleteAeoAthrAudtAdor */
		  UPDATE  TB_AEOI_ADOR_MGMT
		     SET
				  LAST_CHPR_ID = #{lastChprId}          /** Id Du Modificateur Final !== 최종변경자ID ==! */            
				, LAST_CHG_DTTM = CURRENT_TIMESTAMP		/** Date Et Heure De Modification Finale !== 최종변경일시 ==! */ 
		  		, DEL_YN = 'Y'							/** Suppression On !== 삭제여부 ==! */ 
		   WHERE
	          	  DEL_YN = 'N'							/** Suppression ON !== 삭제여부 ==! */
	        AND	  ADOR_MGMT_SRNO = #{adorMgmtSrno}		/** Numéro de série de gestion d'auditeur !== 심사자관리일련번호 ==! */  
	</update>

    <!--
    [Gérer l'auditeur] Vérifier si l'auditeur a été enregistré !== [심사자관리] 심사자 등록여부 체크 ==!
    -->
	<select id="selectAeoAthrAudtAdorChk"
	    parameterType="alpass.ipt.aeo.athr.audt.vo.AeoAthrAudtAdorVo"
	    resultType="int">
		/* selectAeoAthrAudtAdorChk */
		SELECT
				  COUNT(A.ADOR_ID) AS CNT
		  FROM
			  	  TB_AEOI_ADOR_MGMT A
	     WHERE
	          	  A.DEL_YN = 'N'				/** Suppression ON !== 삭제여부 ==! */
	       AND 	  A.ADOR_TP_CD = #{adorTpCd}	/** Code de classification d'auditeur !== 심사자구분코드 ==! */
	       AND	  A.ADOR_ID = #{adorId}			/** Id De L'Inspecteur !== 심사자ID ==! */
	</select>

</mapper>