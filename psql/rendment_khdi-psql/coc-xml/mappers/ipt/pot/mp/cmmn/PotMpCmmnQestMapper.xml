<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="alpass.ipt.pot.mp.cmmn.mapper.PotMpCmmnQestMapper">

<resultMap id="potMpCmmnQestMap" type="alpass.ipt.pot.mp.cmmn.vo.PotMpCmmnQestVo" >
		<id property="qestSrno" column="QEST_SRNO"></id>
		<result property="drnum" column="drnum" />
		<result property="appClsfCd" column="APP_CLSF_CD" />
		<result property="orgnMgmtCd" column="ORGN_MGMT_CD" />
		<result property="bsopCtgyCd" column="BSOP_CTGY_CD" />
		<result property="qestTtle" column="QEST_TTLE" />
		<result property="qestCn" column="QEST_CN" />
		<result property="qestLqtyCn" column="QEST_LQTY_CN" />
		<result property="mdpnId" column="MDPN_ID" />
		<result property="mdpnNm" column="MDPN_NM" />
		<result property="makeDt" column="MAKE_DT" />
		<result property="inqtCnt" column="INQT_CNT" />
		<result property="oppbYn" column="OPPB_YN" />
		<result property="atchFileId" column="ATCH_FILE_ID" />
		<result property="delYn" column="DEL_YN" />
		<result property="frstRegstId" column="FRST_REGST_ID" />
		<result property="frstRgsrDttm" column="FRST_RGSR_DTTM" />
		<result property="lastChprId" column="LAST_CHPR_ID" />
		<result property="lastChgDttm" column="LAST_CHG_DTTM" />
		<result property="orgnCd" column="ORGN_CD" />
		<result property="makeDttm" column="MAKE_DTTM" />
		<result property="orgnNm" column="ORGN_NM" />
		<collection property="answList" javaType="java.util.ArrayList" ofType="alpass.ipt.pot.mp.cmmn.vo.PotMpCmmnQestAnswVo" resultMap="potMpCmmnQestAnswMap"></collection>
	</resultMap>
	
	<resultMap id="potMpCmmnQestAnswMap" type="alpass.ipt.pot.mp.cmmn.vo.PotMpCmmnQestAnswVo">
		<id property="qestSrno" column="NTAR_SRNO" />
		<id property="answSrno" column="ANSW_SRNO" />
		<result property="answCn" column="ANSW_CN" />
		<result property="anpnId" column="ANPN_ID" />
		<result property="anpnNm" column="ANPN_NM" />
		<result property="answDt" column="ANSW_DT" />
		<result property="answDelYn" column="ANSW_DEL_YN" />
		<result property="answFrstRegstId" column="ANSW_FRST_REGST_ID" />
		<result property="answFrstRgsrDttm" column="ANSW_FRST_RGSR_DTTM" />
		<result property="answLastChprId" column="ANSW_LAST_CHPR_ID" />
		<result property="answLastChgDttm" column="ANSW_LAST_CHG_DTTM" />
	</resultMap>
    
    
  <!--
		Consulter la liste Q&R !==Q&A 목록을 조회한다.==!
	-->
    <select id="selectQestList" parameterType="alpass.ipt.pot.mp.cmmn.vo.PotMpCmmnQestVo" resultType="alpass.ipt.pot.mp.cmmn.vo.PotMpCmmnQestVo">
        /* selectQestList */
        <include refid="pagination.header"/>
		            SELECT
		                  A.QEST_SRNO              
		                , A.APP_CLSF_CD            
		                , A.ORGN_MGMT_CD
                    , A.BSOP_CTGY_CD
		                , A.QEST_TTLE              
		                , NVL(A.QEST_CN, NULL) QEST_CN                
		                , NVL(A.QEST_LQTY_CN, NULL) QEST_LQTY_CN          
		                , A.MDPN_ID   
		                , ( SELECT U.EMP_NM FROM TB_POTI_EMP U WHERE PBSR_NO = A.MDPN_ID) AS MDPN_NM                              
		                , ( SELECT U.EMP_FMNM FROM TB_POTI_EMP U WHERE PBSR_NO = A.MDPN_ID) AS MDPN_FMNM
		                , A.INQT_CNT
		                , A.OPPB_YN   
		                , A.ATCH_FILE_ID           
		                , A.DEL_YN                 
		                , A.FRST_REGST_ID          
		                , TO_CHAR(A.FRST_RGSR_DTTM, 'DD/MM/YYYY HH24:MI:SS') AS FRST_RGSR_DTTM         
		                , A.LAST_CHPR_ID           
		                , TO_CHAR(A.LAST_CHG_DTTM, 'DD/MM/YYYY HH24:MI:SS') AS LAST_CHG_DTTM 
		                , (SELECT ORGN_NM FROM TB_POTI_ORGN WHERE ORGN_MGMT_CD = A.ORGN_MGMT_CD AND DEL_YN = 'N') AS ORGN_NM
		                , TO_CHAR(A.MAKE_DTTM, 'DD/MM/YYYY HH24:mi:ss') AS MAKE_DTTM
		            FROM   TB_POTI_QEST A 
		            WHERE   A.DEL_YN    = 'N' 
		            AND    A.APP_CLSF_CD = 'IPT'
		            <if test="qestTtle != null and qestTtle != '' ">
						AND UPPER(A.QEST_TTLE) like '%' || UPPER(#{qestTtle}) || '%'
					</if>
		        	<if test="bsopCtgyCd != null and bsopCtgyCd != '' ">
						AND A.BSOP_CTGY_CD like '%' || #{bsopCtgyCd} || '%'
					</if>
					<if test="searchKeywordFrom != null and searchKeywordFrom != '' ">
			           <if test="searchKeywordTo != null and searchKeywordTo != '' ">
		           			AND A.MAKE_DTTM
		           				BETWEEN TO_DATE( #{searchKeywordFrom}||'000000' , 'DD/MM/YYYYHH24MISS')
		           				AND TO_DATE( #{searchKeywordTo}||'235959' , 'DD/MM/YYYYHH24MISS')
						</if>
					</if>
					<if test="searchLoginId != null and searchLoginId != '' ">
						AND 
						( (A.OPPB_YN = 'N'
		                     AND  A.MDPN_ID = #{searchLoginId}
		                     ) 
		                  OR A.OPPB_YN = 'Y' 
		                )  
					</if>
					order by A.QEST_SRNO desc
        <include refid="pagination.footer"/> 
    </select>
    
  <!--
		Consulter le nombre de la liste Q&R !==Q&A 목록 개수를 조회한다.==!
	-->
    <select id="selectQestListCnt" parameterType="alpass.ipt.pot.mp.cmmn.vo.PotMpCmmnQestVo" resultType="int">
        /* selectQestListCnt */
        SELECT MAX(DRNUM) FROM (
	        SELECT srt.*, DENSE_RANK() OVER(ORDER BY QEST_SRNO DESC) AS DRNUM FROM (
		        SELECT SQLRSLT.*, rownum as rnum FROM (
		            SELECT
		                  A.QEST_SRNO              
		            FROM   TB_POTI_QEST A, TB_POTI_QEST_ANSW B
		            WHERE  A.QEST_SRNO = B.QEST_SRNO(+)
		            AND    A.DEL_YN    = 'N'
		            AND    B.DEL_YN(+) = 'N'
		            AND    A.APP_CLSF_CD = 'IPT'
		            <if test="qestTtle != null and qestTtle != '' ">
						AND UPPER(A.QEST_TTLE) like '%' || UPPER(#{qestTtle}) || '%'
					</if>
		        	<if test="bsopCtgyCd != null and bsopCtgyCd != '' ">
						AND A.BSOP_CTGY_CD like '%' || #{bsopCtgyCd} || '%'
					</if>
					<if test="searchKeywordFrom != null and searchKeywordFrom != '' ">
			           <if test="searchKeywordTo != null and searchKeywordTo != '' ">
		           			AND A.MAKE_DTTM
		           				BETWEEN TO_DATE( #{searchKeywordFrom}||'000000' , 'DD/MM/YYYYHH24MISS')
		           				AND TO_DATE( #{searchKeywordTo}||'235959' , 'DD/MM/YYYYHH24MISS')
						</if>
					</if>
					<if test="searchLoginId != null and searchLoginId != '' ">
            AND
            ( (A.OPPB_YN = 'N'
            AND  A.MDPN_ID = #{searchLoginId}
            )
            OR A.OPPB_YN = 'Y'
            )
          </if>
		           ORDER BY A.QEST_SRNO DESC
					) SQLRSLT
	        ) srt ORDER BY srt.rnum DESC
        ) 
    </select>
    
  <!--
		Consulter un article du Q&R !==Q&A 게시글을 조회한다.==!
	-->
    <select id="selectQest" parameterType="alpass.ipt.pot.mp.cmmn.vo.PotMpCmmnQestVo" resultMap="potMpCmmnQestMap">
      /* selectQest */
    	SELECT
               A.QEST_SRNO              
             , A.APP_CLSF_CD            
             , A.ORGN_MGMT_CD
    	       , A.BSOP_CTGY_CD
             , A.QEST_TTLE              
             , NVL(A.QEST_CN, NULL) AS QEST_CN                
             , NVL(A.QEST_LQTY_CN, NULL) AS QEST_LQTY_CN           
             , A.MDPN_ID              
             , ( SELECT U.EMP_NM FROM TB_POTI_EMP U WHERE PBSR_NO = A.MDPN_ID) AS MDPN_NM                   
             , TO_CHAR(A.MAKE_DTTM, 'DD/MM/YYYY HH24:mi:ss') AS MAKE_DTTM
             , A.INQT_CNT       
             , A.OPPB_YN        
             , A.ATCH_FILE_ID           
             , A.DEL_YN                 
             , A.FRST_REGST_ID          
             , TO_CHAR(A.FRST_RGSR_DTTM, 'DD/MM/YYYY HH24:MI:SS') AS FRST_RGSR_DTTM         
             , A.LAST_CHPR_ID           
             , TO_CHAR(A.LAST_CHG_DTTM, 'DD/MM/YYYY HH24:MI:SS') AS LAST_CHG_DTTM        
             , B.ANSW_SRNO
             , B.ANSW_CN
             , B.ANPN_ID
             , ( SELECT U.EMP_NM || '(' || N.ORGN_NM || ')' FROM TB_POTI_EMP U, TB_POTI_ORGN N  WHERE PBSR_NO = B.ANPN_ID AND U.ORGN_MGMT_CD = N.ORGN_MGMT_CD) AS ANPN_NM
             , TO_CHAR(TO_DATE(B.ANSW_DT, 'YYYYMMDD'),'DD/MM/YYYY') AS ANSW_DT
             , B.DEL_YN AS ANSW_DEL_YN
             , B.FRST_REGST_ID AS ANSW_FREST_REGST_ID          
             , TO_CHAR(B.FRST_RGSR_DTTM, 'DD/MM/YYYY HH24:MI:SS') AS ANSW_FRST_RGSR_DTTM         
             , B.LAST_CHPR_ID AS ANSW_LAST_CHPR_ID        
             , TO_CHAR(B.LAST_CHG_DTTM, 'DD/MM/YYYY HH24:MI:SS') AS ANSW_LAST_CHG_DTTM
		     , (SELECT ORGN_CD FROM TB_POTI_ORGN WHERE ORGN_MGMT_CD = A.ORGN_MGMT_CD AND DEL_YN  = 'N') AS ORGN_CD
         FROM   TB_POTI_QEST A, TB_POTI_QEST_ANSW B
         WHERE  A.QEST_SRNO = B.QEST_SRNO(+)
         AND    A.QEST_SRNO = #{qestSrno}
         AND    A.DEL_YN    = 'N'
         AND    B.DEL_YN(+) = 'N'
         AND    A.APP_CLSF_CD = 'IPT'
        ORDER BY A.FRST_RGSR_DTTM, A.QEST_SRNO, B.ANSW_SRNO
    </select>
    
  <!--
		Modifier le nombre de vues de l'article du Q&R !==Q&A 게시글 조회수를 수정한다.==!
	-->
    <update id="updateViewQest" parameterType="alpass.ipt.pot.mp.cmmn.vo.PotMpCmmnQestVo">
        /* updateViewQest */
        UPDATE  TB_POTI_QEST SET 
                INQT_CNT = INQT_CNT+1
        WHERE	QEST_SRNO = #{qestSrno}
    </update>

  <!--
		Enregistrer un article du Q&R !==Q&A 게시글을 등록한다.==!
	-->
    <insert id="insertQest" parameterType="alpass.ipt.pot.mp.cmmn.vo.PotMpCmmnQestVo">
    <selectKey keyProperty="qestSrno" keyColumn="QEST_SRNO" resultType="java.math.BigDecimal" order="BEFORE">
    	SELECT NVL(MAX(QEST_SRNO),0) +1 FROM TB_POTI_QEST
    </selectKey>
        /* insertQest */
        INSERT INTO TB_POTI_QEST
                (
                  QEST_SRNO                  
                , APP_CLSF_CD                
                , BSOP_CTGY_CD
                , QEST_TTLE                  
                , QEST_CN                    
                , QEST_LQTY_CN               
                , MDPN_ID                    
                , MAKE_DTTM                    
                , INQT_CNT
                , OPPB_YN                   
                , ATCH_FILE_ID               
                , DEL_YN                  
                , FRST_REGST_ID              
                , FRST_RGSR_DTTM             
                , LAST_CHPR_ID               
                , LAST_CHG_DTTM              
                )
                VALUES
                (
                  #{qestSrno}                
                , 'IPT'               
                , #{bsopCtgyCd}
                , #{qestTtle}                
                , #{qestCn}                  
                , #{qestLqtyCn}              
                , #{mdpnId}               
                , SYSTIMESTAMP
                , #{inqtCnt}            
				, #{oppbYn} 
                , #{atchFileId}           
                , 'N'            
                , #{frstRegstId}          
                , SYSTIMESTAMP            
                , #{lastChprId}           
                , SYSTIMESTAMP            
                )
    </insert>

  <!--
		Modifier un article du Q&R !==Q&A 게시글을 수정한다.==!
	-->
    <update id="updateQest" parameterType="alpass.ipt.pot.mp.cmmn.vo.PotMpCmmnQestVo">
        /* updateQest */
        UPDATE  TB_POTI_QEST SET
            BSOP_CTGY_CD = #{bsopCtgyCd}
        	<if test="qestTtle != null and qestTtle != ''">, QEST_TTLE = #{qestTtle}</if>
        	<if test="(qestCn != null and qestCn != '') or (qestLqtyCn != null and qestLqtyCn != '')">, QEST_CN = #{qestCn}</if>
        	<if test="(qestCn != null and qestCn != '') or (qestLqtyCn != null and qestLqtyCn != '')">, QEST_LQTY_CN = #{qestLqtyCn}</if>
        	<if test="oppbYn != null and oppbYn != ''">, OPPB_YN = #{oppbYn}</if>
        	<if test="atchFileId != null and atchFileId != ''">, ATCH_FILE_ID = #{atchFileId}</if>
        	<if test="lastChprId != null and lastChprId != ''">, LAST_CHPR_ID = #{lastChprId}</if>
        	<if test="lastChprId != null and lastChprId != ''">, LAST_CHG_DTTM = SYSTIMESTAMP</if>
           WHERE  QEST_SRNO = #{qestSrno}                             
    </update>

  <!--
		Supprimer un article du Q&R !==Q&A 게시글을 삭제한다.==!
	-->
    <update id="deleteQest" parameterType="alpass.ipt.pot.mp.cmmn.vo.PotMpCmmnQestVo">
        /* deleteQest */
        UPDATE  TB_POTI_QEST SET 
                DEL_YN = 'Y'                                
             ,  LAST_CHPR_ID = #{lastChprId}                
             ,  LAST_CHG_DTTM = SYSTIMESTAMP                
         WHERE  QEST_SRNO = #{qestSrno}                       
    </update>
    
  <!--
		Enregistrer une réponse de l'article du Q&R !==Q&A 게시글 답변을 등록한다==!
	-->
    <insert id="insertQestAnsw" parameterType="alpass.ipt.pot.mp.cmmn.vo.PotMpCmmnQestAnswVo">
    <selectKey keyProperty="answSrno" keyColumn="ANSW_SRNO" resultType="java.math.BigDecimal" order="BEFORE">
    	SELECT NVL(MAX(ANSW_SRNO),0) +1 FROM TB_POTI_QEST_ANSW WHERE QEST_SRNO = #{qestSrno}
    </selectKey>
        /* insertQestAnsw */
        INSERT INTO TB_POTI_QEST_ANSW
                (
                  QEST_SRNO          
                , APP_CLSF_CD        
                , ANSW_SRNO                  
                , ANSW_CN                    
                , ANPN_ID                    
                , ANSW_DT                    
                , DEL_YN                     
                , FRST_REGST_ID              
                , FRST_RGSR_DTTM             
                , LAST_CHPR_ID               
                , LAST_CHG_DTTM              
                )
                VALUES
                (
                  #{qestSrno}      
                , 'IPT'          
                , #{answSrno}                
                , #{answCn}                  
                , #{anpnId}                  
                , TO_CHAR(SYSTIMESTAMP,'YYYYMMDD')                  
                , 'N'                        
                , #{answFrstRegstId}             
                , SYSTIMESTAMP               
                , #{answLastChprId}              
                , SYSTIMESTAMP               
                )
    </insert>

  <!--
		Modifier une réponse de l'article du Q&R !==Q&A 게시글 답변을 수정한다==!
	-->
    <update id="updateQestAnsw" parameterType="alpass.ipt.pot.mp.cmmn.vo.PotMpCmmnQestAnswVo">
        /* updateQestAnsw */
        UPDATE  TB_POTI_QEST_ANSW 
        <trim prefix="SET" prefixOverrides="," >
        	<if test="answCn != null and answCn != ''">, ANSW_CN = #{answCn}</if>
        	<if test="answLastChprId != null and answLastChprId != ''">, LAST_CHPR_ID = #{answLastChprId}</if>
        	<if test="answLastChprId != null and answLastChprId != ''">, LAST_CHG_DTTM = SYSTIMESTAMP</if>
        </trim>
           WHERE  QEST_SRNO = #{qestSrno}                               
           AND    ANSW_SRNO = #{answSrno}                              
    </update>

  <!--
		Supprimer une réponse de l'article du Q&R !==Q&A 게시글 답변을 삭제한다==!
	-->
    <update id="deleteQestAnsw" parameterType="alpass.ipt.pot.mp.cmmn.vo.PotMpCmmnQestAnswVo">
        /* deleteQestAnsw */
        UPDATE  TB_POTI_QEST_ANSW SET 
                DEL_YN = 'Y'                               
             ,  LAST_CHPR_ID = #{answLastChprId}               
             ,  LAST_CHG_DTTM = SYSTIMESTAMP               
         WHERE  QEST_SRNO = #{qestSrno}               
         <if test="answSrno != null and answSrno != '' ">
         	AND    ANSW_SRNO = #{answSrno}                               
         </if>                
    </update>

</mapper>
