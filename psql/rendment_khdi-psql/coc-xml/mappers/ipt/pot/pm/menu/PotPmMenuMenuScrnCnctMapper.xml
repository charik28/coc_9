<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="alpass.ipt.pot.pm.menu.mapper.PotPmMenuMenuScrnCnctMapper">

    <!--
       Consulter la liste de la connexion des écrans de menu !==메뉴화면연결 목록를 조회한다==!
    -->
    <select id="selectSysMenuTreeList" parameterType="alpass.ipt.pot.pm.menu.vo.PotPmAuthMgmtSysMenuVo"
            resultType="alpass.ipt.pot.pm.menu.vo.PotPmAuthMgmtSysMenuVo">
        /** selectSysMenuTreeList */
        <if test="searMenuNm == null or searMenuNm == ''">
            SELECT
            *
            FROM
            (
            SELECT
            LEVEL
            , (SELECT MENU_NM FROM TB_COM_SYS_MENU_LANG WHERE LANG_CD = #{langCd} AND MENU_SRNO = A.MENU_SRNO) AS NAME
            , A.MENU_SRNO AS C_NODE
            , A.UPR_MENU_SRNO AS P_NODE
            , A.MENU_INDC_ORDR
            ,
            (
            SELECT
            NVL((LISTAGG(LPAD(MENU_INDC_ORDR, 2, '0'), '') WITHIN GROUP (ORDER BY LEVEL DESC)) , '0') AS ORDR
            FROM TB_COM_SYS_MENU MENU
            WHERE MENU.USE_YN = 'Y'
            AND MENU.DEL_YN = 'N'

            START WITH MENU.HSRK_MENU_YN = 'N'
            AND MENU.MENU_SRNO = A.MENU_SRNO
            CONNECT BY PRIOR MENU.UPR_MENU_SRNO = MENU.MENU_SRNO
            ) AS ORDR
            ,
            (
            SELECT
            (SELECT LBL_NM FROM TB_COM_LBL_LANG WHERE LANG_CD = #{langCd} AND LBL_ID = SCRN.SCRN_NM)
            FROM TB_COM_MENU_SCRN_REL SCRN_REL, TB_COM_SYS_SCRN SCRN
            WHERE SCRN_REL.SCRN_ID = SCRN.SCRN_ID
            AND SCRN_REL.DEL_YN = 'N'
            AND SCRN.DEL_YN = 'N'
            AND SCRN.USE_YN = 'Y'
            AND SCRN_REL.MENU_SRNO = A.MENU_SRNO
            ) AS SCRN_NM
            ,
            (
            SELECT
            SCRN_REL.SCRN_ID
            FROM TB_COM_MENU_SCRN_REL SCRN_REL
            WHERE SCRN_REL.DEL_YN = 'N'
            AND SCRN_REL.MENU_SRNO = A.MENU_SRNO
            ) AS SCRN_ID

            FROM TB_COM_SYS_MENU A
            WHERE A.USE_YN = 'Y'
            AND A.DEL_YN = 'N'
            AND A.APP_CLSF_CD = #{searAppClsfCd}

            START WITH A.HSRK_MENU_YN = 'Y'
            CONNECT BY PRIOR A.MENU_SRNO = A.UPR_MENU_SRNO
            ) A ORDER BY ORDR
        </if>

        <if test="searMenuNm != null and searMenuNm != ''">
            SELECT
            DISTINCT *
            FROM
            (
            SELECT

            (SELECT MENU_NM FROM TB_COM_SYS_MENU_LANG WHERE LANG_CD = #{langCd} AND MENU_SRNO = A.MENU_SRNO) AS NAME
            , A.MENU_SRNO AS C_NODE
            , A.UPR_MENU_SRNO AS P_NODE
            , A.MENU_INDC_ORDR
            ,
            (
            SELECT
            NVL((LISTAGG(LPAD(MENU_INDC_ORDR, 2, '0'), '') WITHIN GROUP (ORDER BY LEVEL DESC)) , '0') AS ORDR
            FROM TB_COM_SYS_MENU MENU
            WHERE MENU.USE_YN = 'Y'
            AND MENU.DEL_YN = 'N'

            START WITH MENU.HSRK_MENU_YN = 'N'
            AND MENU.MENU_SRNO = A.MENU_SRNO
            CONNECT BY PRIOR MENU.UPR_MENU_SRNO = MENU.MENU_SRNO
            ) AS ORDR
            ,
            (
            SELECT
            (SELECT MENU_NM FROM TB_COM_SYS_MENU_LANG WHERE LANG_CD = #{langCd} AND MENU_SRNO = SCRN_REL.MENU_SRNO)
            FROM TB_COM_MENU_SCRN_REL SCRN_REL, TB_COM_SYS_SCRN SCRN
            WHERE SCRN_REL.SCRN_ID = SCRN.SCRN_ID
            AND SCRN_REL.DEL_YN = 'N'
            AND SCRN.DEL_YN = 'N'
            AND SCRN.USE_YN = 'Y'
            AND SCRN_REL.MENU_SRNO = A.MENU_SRNO
            ) AS SCRN_NM
            ,
            (
            SELECT
            SCRN_REL.SCRN_ID
            FROM TB_COM_MENU_SCRN_REL SCRN_REL
            WHERE SCRN_REL.DEL_YN = 'N'
            AND SCRN_REL.MENU_SRNO = A.MENU_SRNO
            ) AS SCRN_ID

            FROM
            (

            SELECT DISTINCT A.* FROM TB_COM_SYS_MENU A
            WHERE DEL_YN = 'N'
            AND USE_YN = 'Y'
            START WITH A.MENU_SRNO IN
            (
            SELECT DISTINCT A.UPR_MENU_SRNO FROM TB_COM_SYS_MENU A, TB_COM_SYS_MENU_LANG B
            WHERE A.MENU_SRNO(+) = B.MENU_SRNO
            AND A.DEL_YN = 'N'
            AND B.DEL_YN = 'N'
            AND UPPER(B.MENU_NM) LIKE '%'||UPPER(#{searMenuNm})||'%'
            AND B.LANG_CD = #{langCd}
            AND A.HSRK_MENU_YN = 'N'
            AND A.APP_CLSF_CD = #{searAppClsfCd}
            )
            CONNECT BY PRIOR A.UPR_MENU_SRNO = A.MENU_SRNO

            UNION ALL

            SELECT DISTINCT A.* FROM TB_COM_SYS_MENU A, TB_COM_SYS_MENU_LANG B
            WHERE A.MENU_SRNO(+) = B.MENU_SRNO
            AND A.DEL_YN = 'N'
            AND B.DEL_YN = 'N'
            AND UPPER(B.MENU_NM) LIKE '%'||UPPER(#{searMenuNm})||'%'
            AND B.LANG_CD = #{langCd}
            AND A.HSRK_MENU_YN = 'N'
            AND A.APP_CLSF_CD = #{searAppClsfCd}
            ) A

            ) ORDER BY ORDR
        </if>
    </select>

    <!--
       Enregistrer la connexion des écrans de menu !==메뉴화면연결 등록한다==!
    -->
    <insert id="insertMenuScrnCnct" parameterType="alpass.ipt.pot.pm.menu.vo.PotPmAuthMenuScrnCnctVo">
        /** insertMenuScrnCnct */
        with upsert as
                     (
        UPDATE TB_COM_MENU_SCRN_REL
        SET LAST_CHPR_ID  = #{lastChprId}
          , LAST_CHG_DTTM = SYSTIMESTAMP
          , DEL_YN        = 'N'
          , SCRN_ID       = #{scrnId}
        WHERE MENU_SRNO = #{menuSrno} returning *
      )
        INSERT
        INTO TB_COM_MENU_SCRN_REL
        ( MENU_SRNO
        , SCRN_ID
        , DEL_YN
        , FRST_REGST_ID
        , FRST_RGSR_DTTM
        , LAST_CHPR_ID
        , LAST_CHG_DTTM)
        SELECT #{menuSrno}
             , #{scrnId}
             , 'N'
             , #{frstRegstId}
             , SYSTIMESTAMP
             , #{lastChprId}
             , SYSTIMESTAMP WHERE NOT EXISTS(select * from upsert)
    </insert>

    <!--
       Supprimer la connexion des écrans de menu !==메뉴화면연결을 삭제한다==!
    -->
    <delete id="deleteMenuScrnCnct" parameterType="alpass.ipt.pot.pm.menu.vo.PotPmAuthMenuScrnCnctVo">
        /** deleteMenuScrnCnct */
        UPDATE TB_COM_MENU_SCRN_REL
        SET LAST_CHPR_ID  = #{lastChprId}
          , LAST_CHG_DTTM = SYSTIMESTAMP
          , DEL_YN        = 'Y'
        WHERE MENU_SRNO = #{menuSrno}
          AND DEL_YN = 'N'
    </delete>

</mapper>
