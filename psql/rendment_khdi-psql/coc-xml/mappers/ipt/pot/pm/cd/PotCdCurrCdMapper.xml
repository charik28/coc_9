<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="alpass.ipt.pot.pm.cd.mapper.PotPmCdCurrCdMapper">

  <!--
    Consulter la liste des codes de devise !==통화코드 목록을 조회한다==!
  -->
  <select id="selectCurrCdList"
    parameterType="alpass.ipt.pot.pm.cd.vo.PotPmCdCurrCdVo"
    resultType="alpass.ipt.pot.pm.cd.vo.PotPmCdCurrCdVo">
    /** selectCurrCdList */
    <include refid="pagination.header"/>
    SELECT
    A.CURR_CD
    , A.CURR_CD AS ORG_CURR_CD
    , (SELECT B.CURR_NM FROM TB_COM_CURR_CD_LANG B WHERE B.CURR_CD = A.CURR_CD AND B.LANG_CD = #{langCd}) AS CURR_NM
    , A.DGT3_NUM_CURR_CD
    , A.CURR_SMBL
    , A.RPRS_CNTY_CD
    , FN_GET_CNTY_NM(A.RPRS_CNTY_CD, #{langCd}) AS CNTY_NM
    , A.FRST_REGST_ID
    , TO_CHAR(A.FRST_RGSR_DTTM, 'DD/MM/YYYY') AS FRST_RGSR_DTTM
    , A.LAST_CHPR_ID
    , TO_CHAR(A.LAST_CHG_DTTM, 'DD/MM/YYYY') AS LAST_CHG_DTTM
    FROM TB_COM_CURR_CD A
    WHERE A.DEL_YN = 'N'
    <if test="searCurrCd != null and searCurrCd != ''">
      AND A.CURR_CD LIKE '%'||#{searCurrCd}||'%'
    </if>
    <if test="searDgt3NumCurrCd != null and searDgt3NumCurrCd != ''">
      AND A.DGT3_NUM_CURR_CD = #{searDgt3NumCurrCd}
    </if>
    <if test="searRprsCntyCd != null and searRprsCntyCd != ''">
      AND A.RPRS_CNTY_CD = #{searRprsCntyCd}
    </if>
    <if test="searCurrNm != null and searCurrNm != ''">
      AND A.CURR_CD IN ( SELECT B.CURR_CD
      FROM TB_COM_CURR_CD_LANG B
      WHERE UPPER(B.CURR_NM) LIKE '%'||UPPER(#{searCurrNm})||'%'
      AND B.DEL_YN = 'N'
      )
    </if>
    ORDER BY A.CURR_CD, A.DGT3_NUM_CURR_CD, A.CURR_SMBL, A.RPRS_CNTY_CD, A.FRST_REGST_ID, A.FRST_RGSR_DTTM, A.LAST_CHPR_ID, A.LAST_CHG_DTTM
    <include refid="pagination.footer"/>
  </select>

  <!--
    Consulter la liste des codes de devise !==통화코드(상세) 목록을 조회한다==!
  -->
  <select id="selectCurrCdDetailList" parameterType="alpass.ipt.pot.pm.cd.vo.PotPmCdCurrCdVo" resultType="alpass.ipt.pot.pm.cd.vo.PotPmCdCurrCdLangVo">
    /** "selectCurrCdDetailList" */
    SELECT
      B.CURR_CD AS KEY1
         , A.CD_VDVAL AS LANG_CD
         , B.CURR_NM AS LANG_CN
    FROM TB_COM_COMN_CD_D A,
         TB_COM_CURR_CD_LANG B
    WHERE A.COMN_CD = 'COM_0057'
      AND B.DEL_YN(+) = 'N'
      AND B.CURR_CD(+) = #{currCd}
      AND A.CD_VDVAL  = B.LANG_CD(+)
    ORDER BY TO_NUMBER(A.SORT_ORDR) ASC
  </select>

  <!--
    Vérifier si le code de résion est déjà enregistré !==기존에 등록된 지역코드인지 확인 한다==!
  -->
  <select id="selectCurrCdRegYnCnt" parameterType="alpass.ipt.pot.pm.cd.vo.PotPmCdCurrCdVo" resultType="java.lang.Integer">
    /** selectCurrCdRegYnCnt */
    SELECT
      COUNT(1) AS CNT
    FROM  TB_COM_CURR_CD
    WHERE DEL_YN = 'N'
      AND   CURR_CD = #{currCd}
  </select>

  <!--
    Enregistrer un code de devise !==통화코드를 등록한다.==!
  -->
  <insert id="insertCurrCd" parameterType="alpass.ipt.pot.pm.cd.vo.PotPmCdCurrCdVo">
    /** insertCurrCd */
    with upsert as
    (
      UPDATE TB_COM_CURR_CD SET
          LAST_CHPR_ID = #{lastChprId}
          , LAST_CHG_DTTM = SYSTIMESTAMP
          , DEL_YN = 'N'
          , DGT3_NUM_CURR_CD = #{dgt3NumCurrCd}
          , CURR_SMBL = #{currSmbl}
          , RPRS_CNTY_CD = #{rprsCntyCd}
      WHERE DEL_YN = 'Y' AND CURR_CD = #{currCd}
      RETURNING *
    )
    INSERT INTO TB_COM_CURR_CD
    (
        CURR_CD
        , DGT3_NUM_CURR_CD
        , CURR_SMBL
        , RPRS_CNTY_CD
        , DEL_YN
        , FRST_REGST_ID
        , FRST_RGSR_DTTM
        , LAST_CHPR_ID
        , LAST_CHG_DTTM
    )
    SELECT
        #{currCd}
        , #{dgt3NumCurrCd}
        , #{currSmbl}
        , #{rprsCntyCd}
        , #{delYn}
        , #{frstRegstId}
        , SYSTIMESTAMP
        , #{lastChprId}
        , SYSTIMESTAMP
    WHERE NOT exists(select * from upsert)
  </insert>

  <!--
    Enregistrer le nom du code de devise !==통화코드명을 등록한다.==!
  -->
  <insert id="insertCurrLangCd" parameterType="alpass.ipt.pot.pm.cd.vo.PotPmCdCurrCdLangVo">
    /** insertCurrLangCd */
    with upsert as
    (
        UPDATE TB_COM_CURR_CD_LANG SET
              LAST_CHPR_ID = #{lastChprId}
              , LAST_CHG_DTTM = SYSTIMESTAMP
              , DEL_YN = 'N'
              , CURR_NM = #{langCn}
        WHERE CURR_CD = #{key1}
                AND LANG_CD = #{langCd}
        returning *
    )
    INSERT INTO TB_COM_CURR_CD_LANG
    (
          CURR_CD
          , LANG_CD
          , CURR_NM
          , DEL_YN
          , FRST_REGST_ID
          , FRST_RGSR_DTTM
          , LAST_CHPR_ID
          , LAST_CHG_DTTM
    )
    SELECT
            #{key1}
            , #{langCd}
            , #{langCn}
            , #{delYn}
            , #{frstRegstId}
            , SYSTIMESTAMP
            , #{lastChprId}
            , SYSTIMESTAMP
    WHERE NOT exists(select * from upsert)
  </insert>

  <!--
       Modifier un code de devise !==통화코드를 수정한다.==!
  -->
  <update id="updateCurrCd" parameterType="alpass.ipt.pot.pm.cd.vo.PotPmCdCurrCdVo">
    /** updateCurrCd */
    UPDATE TB_COM_CURR_CD
    SET
      LAST_CHPR_ID = #{lastChprId}
      , LAST_CHG_DTTM = SYSTIMESTAMP
      , DGT3_NUM_CURR_CD = #{dgt3NumCurrCd}
      , CURR_SMBL = #{currSmbl}
      , RPRS_CNTY_CD = #{rprsCntyCd}
      , DEL_YN = #{delYn}
    WHERE CURR_CD = #{currCd}
  </update>

  <!--
     Supprimer un code de devise !==통화코드를 삭제한다.==!
  -->
  <update id="deleteCurrCd" parameterType="alpass.ipt.pot.pm.cd.vo.PotPmCdCurrCdVo">
    /** deleteCurrCd */
    UPDATE TB_COM_CURR_CD
    SET
      LAST_CHPR_ID = #{lastChprId}
      , LAST_CHG_DTTM = SYSTIMESTAMP
      , DEL_YN = 'Y'
    WHERE CURR_CD = #{currCd}
  </update>

  <!--
       Supprimer la langue du code de devise !==통화코드언어를 삭제한다.==!
  -->
  <update id="deleteCurrCdLang" parameterType="alpass.ipt.pot.pm.cd.vo.PotPmCdCurrCdVo">
    /** deleteCurrCdLang */
    UPDATE TB_COM_CURR_CD_LANG
    SET
      LAST_CHPR_ID = #{lastChprId}
      , LAST_CHG_DTTM = SYSTIMESTAMP
      , DEL_YN = 'Y'
    WHERE CURR_CD = #{currCd}
  </update>

</mapper>
