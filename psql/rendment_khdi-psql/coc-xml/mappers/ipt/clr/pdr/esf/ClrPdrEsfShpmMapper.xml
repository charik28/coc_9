<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="alpass.ipt.clr.pdr.esf.mapper.ClrPdrEsfShpmMapper">

  <!--
    Consultation de la liste d'accomplissement de chargement à l'export !== 수출선적이행 목록 조회 ==!
    (Beak SangYeol)
    -->
  <select id="selectShpmFfmnList" parameterType="alpass.ipt.clr.pdr.esf.vo.ClrEsfShpmFfmnSrchVo" resultType="alpass.ipt.clr.pdr.esf.vo.ClrEsfShpmFfmnVo">
    /* selectShpmFfmnList */
    <include refid="pagination.header" ></include>
    SELECT *
    FROM
      (
        SELECT A.DTL_DCSH_NO AS DCLR_NO
              , MIN(A.EXPPN_IDFY_NO) AS EXPPN_IDFY_NO
              , (SELECT EXPPN_CO_NM FROM TB_CLRI_DED_CO WHERE DTL_DCSH_NO = A.DTL_DCSH_NO AND DEL_YN = 'N') AS EXPPN_CO_NM
              , TO_CHAR(TO_DATE(MIN(A.DCLR_DT),'YYYYMMDD'),'DD/MM/YYYY') AS DCLR_DT
              , TO_CHAR(TO_DATE(MIN(A.EXP_FFMN_XPIR_DT),'YYYYMMDD'),'DD/MM/YYYY') AS EXP_FFMN_XPIR_DT
              , TRUNC(MIN(A.AL_TTWG)) AS AL_TTWG
              , TRUNC(MIN(A.AL_NTWG)) AS AL_NTWG
              , MIN(A.PCKG_TGCNT) AS PCKG_TGCNT
              , MIN(A.DSTN_CNTY_CD) AS DSTN_CNTY_CD
              , MIN(A.TRNP_METH_KND_CD) AS TRNP_METH_KND_CD
              , CASE WHEN MAX(B.PRCS_STTS_CD) = 'D07' THEN 'Y'
              WHEN MAX(B.PRCS_STTS_CD) = 'D04' AND TO_DATE(MIN(A.EXP_FFMN_XPIR_DT),'YYYYMMDD') > SYSDATE THEN 'N'
              ELSE 'O'
              END AS EXP_SHPM_STTS
              , MAX(DECODE(B.PRCS_STTS_CD, 'D04', TO_CHAR(B.PRCS_DTRM_DTTM,'DD/MM/YYYY'))) AS ACPT_DT
              , MIN(A.DCLR_CSTM_CD) AS DCLR_CSTM_CD
        FROM TB_CLRI_DED_COMN A
              , TB_CLRI_DED_PRCS_BRKD B
        WHERE 1 = 1
        AND A.DTL_DCSH_NO = B.DTL_DCSH_NO
        AND A.DEL_YN = 'N'
        AND B.DEL_YN = 'N'
        AND A.DCLR_PT_CD IN ('EX1','EX2','EX3')
        --AND A.EPC_CD NOT IN ('EPCXXX', 'EPMXXX')
        <if test="exppnIdfyNo != null and exppnIdfyNo != ''">
          AND A.EXPPN_IDFY_NO = #{exppnIdfyNo}
        </if>
        <if test="dclrNo != null and dclrNo != ''">
          AND A.DTL_DCSH_NO = #{dclrNo}
        </if>
        <if test="cstmCd != null and cstmCd != ''">
          AND A.DCLR_CSTM_CD = #{cstmCd}
        </if>
        <if test="dclrDtFrom != null and dclrDtFrom != ''">
          AND		A.DCLR_DT <![CDATA[ >= ]]> TO_CHAR(TO_DATE(#{dclrDtFrom},'DD/MM/YYYY') , 'YYYYMMDD')
          AND		A.DCLR_DT <![CDATA[ <= ]]> TO_CHAR(TO_DATE(#{dclrDtTo},'DD/MM/YYYY') , 'YYYYMMDD')
        </if>
        <if test="expFfmnXpirDtFrom != null and expFfmnXpirDtFrom != ''">
          AND		A.EXP_FFMN_XPIR_DT <![CDATA[ >= ]]> TO_CHAR(TO_DATE(#{expFfmnXpirDtFrom},'DD/MM/YYYY') , 'YYYYMMDD')
          AND		A.EXP_FFMN_XPIR_DT <![CDATA[ <= ]]> TO_CHAR(TO_DATE(#{expFfmnXpirDtTo},'DD/MM/YYYY') , 'YYYYMMDD')
        </if>

        GROUP BY A.DTL_DCSH_NO
        ORDER BY DCLR_DT DESC
      ) AA
    WHERE 1 = 1
    <if test="expFfmnPrcsSttsCd != null and expFfmnPrcsSttsCd != ''">
      AND AA.EXP_SHPM_STTS = #{expFfmnPrcsSttsCd}
    </if>

    ORDER BY TO_DATE(AA.DCLR_DT, 'DD/MM/YYYY') DESC, DCLR_NO DESC
    <include refid="pagination.footer" ></include>
  </select>


  <select id="selectShpmFfmnDetl" parameterType="alpass.ipt.clr.pdr.esf.vo.ClrEsfShpmFfmnVo" resultType="alpass.ipt.clr.pdr.esf.vo.ClrEsfShpmFfmnDtlVo">
    /* selectShpmFfmnDetl */
    SELECT AA.*
    FROM
      (
        SELECT  A.DTL_DCSH_NO AS DCLR_NO
             , MIN(A.EXPPN_IDFY_NO) AS EXPPN_IDFY_NO
             , MIN(C.EXPPN_CO_NM) AS EXPPN_CO_NM
             , MIN(A.DCLR_PT_CD) AS DCLR_PT_CD
             , TO_CHAR(TO_DATE(MIN(A.DCLR_DT),'YYYYMMDD'),'DD/MM/YYYY') AS DCLR_DT
             , MAX(DECODE(B.PRCS_STTS_CD, 'D04', TO_CHAR(B.PRCS_DTRM_DTTM,'DD/MM/YYYY') )) AS ACPT_DT
             , TO_CHAR(TO_DATE(MIN(A.EXP_FFMN_XPIR_DT),'YYYYMMDD'),'DD/MM/YYYY') AS EXP_FFMN_XPIR_DT
             , MIN(A.AL_TTWG) AS AL_TTWG
             , MIN(A.AL_NTWG) AS AL_NTWG
             , MIN(A.DSTN_CNTY_CD) AS DSTN_CNTY_CD
             , MIN(A.TRNP_METH_KND_CD) AS TRNP_METH_KND_CD
             , DECODE(MIN(A.EXP_FFMN_CMPL_DT), NULL, 'N', 'Y') AS EXP_FFMN_CMPL_YN
             , TO_CHAR(TO_DATE(MIN(A.ASMT_DT),'YYYYMMDD'),'DD/MM/YYYY') AS ASMT_DT
             , MIN(A.BL_NO) AS BL_NO
             , MIN(A.CAG_MGMT_NO) AS CAG_MGMT_NO
             , MIN(A.SHIP_NM) AS SHIP_NM
             , MAX(DECODE(B.PRCS_STTS_CD, 'D07', 'Y', 'N')) AS RLSE_YN
             , MIN(A.LDNP_CD) AS LDNP_CD
             , MIN(A.DCLR_CSTM_CD) AS DCLR_CSTM_CD
             , MIN(A.PCKG_TGCNT) AS PCKG_TGCNT
             , MIN(A.CNTR_CAG_YN) AS CNTR_CAG_YN
             , MIN(A.EPC_CD) AS EPC_CD
             , (SELECT ORGN_NM FROM ALPASSINT.TB_POTI_ORGN WHERE ORGN_CD = A.DCLR_CSTM_CD) AS DCLR_CSTM_NM
        FROM TB_CLRI_DED_COMN A
           , TB_CLRI_DED_PRCS_BRKD B
           , TB_CLRI_DED_CO C
        WHERE A.DTL_DCSH_NO = B.DTL_DCSH_NO
          AND A.DTL_DCSH_NO = C.DTL_DCSH_NO
          AND A.DEL_YN = 'N'
          AND B.DEL_YN = 'N'
          AND C.DEL_YN = 'N'
          AND A.DCLR_PT_CD IN ('EX1','EX2','EX3')
          AND A.DTL_DCSH_NO = #{dclrNo}
        GROUP BY A.DTL_DCSH_NO
      ) AA
  </select>

    <select id="selectShpmFfmnDtlList" parameterType="alpass.ipt.clr.pdr.esf.vo.ClrEsfShpmFfmnVo" resultType="alpass.ipt.clr.pdr.esf.vo.ClrEsfShpmFfmnVo">
        /* selectShpmFfmnDtlList */
        SELECT ROWNUM AS RNUM
             , RQST_NO
             , TO_CHAR(TO_DATE(PRCS_DT, 'YYYYMMDD'),'DD/MM/YYYY') AS PRCS_DT
             , TRUNC(PCKG_QTY) AS PCKG_QTY
             , TRUNC(TTWG) AS TTWG
             , FFMN_TP_CD
        FROM TB_CLRI_EXP_SHPM_FFMN_H
        WHERE DTL_DCSH_NO = #{dclrNo}
          AND DEL_YN = 'N'

    </select>


    <select id="selectShpmFfmnCntrList" parameterType="alpass.ipt.clr.pdr.esf.vo.ClrEsfShpmFfmnVo" resultType="alpass.ipt.clr.pdr.esf.vo.ClrEsfShpmCntrVo">
        /* selectShpmFfmnCntrList */
        WITH FFMN_CNTR AS (
            SELECT AA.DTL_DCSH_NO
                 , AA.RQST_NO
                 , AA.PRCS_DT
                 , BB.CNTR_NO
                 , BB.CNTR_TP_CD
            FROM
                TB_CLRI_EXP_SHPM_FFMN_H AA
               , TB_CLRI_EXP_SHPM_FFMN_CNTR_H BB
            WHERE AA.DTL_DCSH_NO = BB.DTL_DCSH_NO
              AND AA.DTL_DCSH_NO = #{dclrNo}
              AND AA.RQST_NO = BB.RQST_NO
              AND AA.DEL_YN = 'N'
              AND BB.DEL_YN = 'N'
        )
        SELECT A.DTL_DCSH_NO AS DCLR_NO
             , A.CNTR_NO
             , B.RQST_NO
             , TO_CHAR(TO_DATE(B.PRCS_DT , 'YYYYMMDD'),'DD/MM/YYYY') AS PRCS_DT
             , B.CNTR_TP_CD
        FROM TB_CLRI_DED_CNTR A,
             FFMN_CNTR B
        WHERE A.CNTR_NO = B.CNTR_NO(+)
          AND A.DTL_DCSH_NO = B.DTL_DCSH_NO(+)
          AND A.DTL_DCSH_NO = #{dclrNo}
          AND A.DEL_YN = 'N'
        ORDER BY CNTR_SRNO
    </select>
</mapper>