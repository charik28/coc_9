<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="alpass.ipt.clr.pdr.dre.mapper.ClrTfrtAplyInfoMapper">

    <!--
    CLRI_Consultation de la liste des informations d'application du tarif douanier !== CLRI_관세율적용정보 목록 조회 ==!
    (Generated)
    -->
    <!-- List<ClrTfrtAplyInfoVo> selectClrTfrtAplyInfoList(ClrTfrtAplyInfoVo searchVo); -->
    <select id="selectTfrtAplyInfoList" parameterType="alpass.ipt.clr.pdr.dre.vo.ClrTfrtAplyInfoSrchVo" resultType="alpass.ipt.clr.pdr.dre.vo.ClrTfrtAplyInfoVo">
        <include refid="pagination.header" ></include>
        SELECT
        A.tfrt_aply_info_no        /** N° des informations de l'application de tarif !== 관세율적용정보번호 ==! */
        , A.dtl_dcsh_no                /** Numero de la déclaration en détail!! !== 상세신고서번호 ==! */
        , A.prc_ev_dgcnt               /** Nombre De Fois De L'Évaluation De Valeur !== 가격평가차수 ==! */
        , A.prcs_stts_cd AS tfrt_prcs_Stts_Cd
        , FN_GET_CD_VDVAL_NM('COM_0044', A.prcs_Stts_Cd, #{langCd}) AS tfrt_prcs_Stts_nm
        , B.epc_cd
        , B.dclr_pt_cd
        , B.dclr_cstm_cd
        , (select orgn_nm from tb_poti_orgn where orgn_cd = B.DCLR_CSTM_CD) as DCLR_CSTM_NM
        , B.cscl_Pln_Cd
        , B.dclr_pt_cd
        , TO_CHAR(TO_DATE(B.dclr_dt             , 'YYYYMMDD'),'DD/MM/YYYY') AS dclr_dt                    /** Date de déclaration !== 신고일자 ==! */
        , B.prcs_Stts_Cd
        , A.make_pbsr_no
        , A.atch_file_id               /** Id Du Fichier Joint !==  ==! */
        , A.cmdt_desc_cn               /** Contenu de description de marchandise !==  / 물품설명내용 ==! */
        , A.del_yn                     /** Suppression On !==  ==! */
        , A.frst_regst_id              /** Id Du Premier Enregistrant  !==  ==! */
        , TO_CHAR(A.frst_rgsr_dttm      , 'DD/MM/YYYY') AS frst_rgsr_dttm             /** Date Et Heure De Premier Enregistrement !==  ==! */
        , A.last_chpr_id               /** Id Du Modificateur Final !==  ==! */
        , TO_CHAR(A.last_chg_dttm       , 'DD/MM/YYYY') AS last_chg_dttm              /** Date Et Heure De Modification Finale !==  ==! */
        FROM   TB_CLRI_TFRT_APLY_INFO A,
               TB_CLRI_DED_COMN     B
        WHERE  A.del_yn = 'N' AND B.del_yn = 'N'                /** Suppression ON !== 삭제여부 ==! */
            AND A.dtl_dcsh_no = B.dtl_dcsh_no
            AND (exists (
                SELECT 'Y' FROM tb_clri_tfrt_aply_info_d where regst_pbsr_no = #{pbsrNo} OR answ_pbsr_no = #{pbsrNo}
                ) OR A.make_pbsr_no = #{pbsrNo} )
        <if test="tfrtPrcsSttsCd != null and tfrtPrcsSttsCd != ''">
            AND A.prcs_stts_cd = #{tfrtPrcsSttsCd}
        </if>
        <if test="tfrtAplyInfoNo != null and tfrtAplyInfoNo != ''">
            AND A.tfrt_aply_info_no LIKE #{tfrtAplyInfoNo} || '%'
        </if>
        <if test="dtlDcshNo != null and dtlDcshNo != ''">
            AND A.DTL_DCSH_NO LIKE #{dtlDcshNo} || '%'
        </if>
        <if test="dclrPtCd != null and dclrPtCd != ''">
            AND B.dclr_pt_cd = #{dclrPtCd}
        </if>
        <if test="dclrDtFrom != null and dclrDtFrom != ''">
            AND B.DCLR_DT BETWEEN TO_CHAR(TO_DATE(#{dclrDtFrom}, 'DD/MM/YYYY'), 'YYYYMMDD') AND TO_CHAR(TO_DATE(#{dclrDtTo}, 'DD/MM/YYYY'), 'YYYYMMDD')
        </if>
        <if test="(hsCd != null and hsCd != '') or (dlngPdlsNm != null and dlngPdlsNm != '') or (orcyCntyCd != null and orcyCntyCd != '')">
            AND EXISTS (
            SELECT '1' FROM tb_clri_ded_pdls pdls
            WHERE pdls.dtl_dcsh_no = A.dtl_dcsh_no
            AND pdls.del_yn = 'N'
            <if test="hsCd != null and hsCd != ''">
                AND pdls.HS_CD LIKE '%' || #{hsCd} || '%'
            </if>
            <if test="dlngPdlsNm != null and dlngPdlsNm != ''">
                AND pdls.dlng_pdls_nm LIKE '%' || #{dlngPdlsNm} || '%'
            </if>
            <if test="orcyCntyCd != null and orcyCntyCd != ''">
                AND pdls.orcy_cnty_cd = #{orcyCntyCd}
            </if>
            )
        </if>

        <if test="rgsrDttmFrom != null and rgsrDttmFrom != ''">
            AND    TO_CHAR(A.frst_rgsr_dttm, 'YYYYMMDD') BETWEEN TO_CHAR(TO_DATE(#{rgsrDttmFrom}, 'DD/MM/YYYY'), 'YYYYMMDD') AND TO_CHAR(TO_DATE(#{rgsrDttmTo}, 'DD/MM/YYYY'), 'YYYYMMDD')
        </if>
        ORDER BY frst_rgsr_dttm desc
        <include refid="pagination.footer" ></include>
    </select>

    <!--
    CLRI_Consultation des informations d'application du tarif douanier !== CLRI_관세율적용정보 조회 ==!
    (Generated)
    -->
    <!-- ClrTfrtAplyInfoVo selectClrTfrtAplyInfoInfo(ClrTfrtAplyInfoVo searchVo); -->
    <select id="selectTfrtAplyInfo" parameterType="string" resultType="alpass.ipt.clr.pdr.dre.vo.ClrTfrtAplyInfoVo">
        SELECT
            A.tfrt_aply_info_no        /** 	N° des informations de l'application de tarif !==  ==! */
             , A.dtl_dcsh_no                /** Numero de la déclaration en détail!! !== 상세신고서번호 ==! */
             , A.make_pbsr_no               /** N° Matricule Solde De L'Auteur !==  ==! */
             , A.atch_file_id               /** Id Du Fichier Joint !==  ==! */
             , A.cmdt_desc_cn               /** Contenu de description de marchandise !== / 물품설명내용 ==! */
             , A.del_yn                     /** Suppression On !==  ==! */
             , A.frst_regst_id              /** Id Du Premier Enregistrant  !==  ==! */
             , TO_CHAR(A.frst_rgsr_dttm      , 'DD/MM/YYYY HH24:MI:SS') AS frst_rgsr_dttm             /** Date Et Heure De Premier Enregistrement !==  ==! */
             , A.last_chpr_id               /** Id Du Modificateur Final !==  ==! */
             , A.prcs_Stts_Cd AS tfrt_prcs_Stts_Cd
             , FN_GET_CD_VDVAL_NM('COM_0044', A.prcs_Stts_Cd, #{langCd}) AS tfrt_prcs_Stts_nm
             , TO_CHAR(A.last_chg_dttm       , 'DD/MM/YYYY HH24:MI:SS') AS last_chg_dttm              /** Date Et Heure De Modification Finale !==  ==! */
             , B.dclr_cstm_cd
             , (select orgn_nm from tb_poti_orgn where orgn_cd = B.DCLR_CSTM_CD) as DCLR_CSTM_NM
             , (select orgn_nm from tb_poti_orgn where orgn_cd = B.audt_dept_cd) as AUDT_DEPT_NM
             , (select pbsr_no || ' | ' || emp_nm from TB_POTI_EMP where pbsr_no = B.audt_emp_id) AS AUDT_EMP_NM
             , B.cscl_Pln_Cd
             , B.dclr_pt_cd
             , TO_CHAR(TO_DATE(B.dclr_dt             , 'YYYYMMDD'),'DD/MM/YYYY') AS dclr_dt                    /** Date de déclaration !== 신고일자 ==! */
             , B.epc_cd
             , B.prcs_Stts_Cd
             , B.invc_no
             , D.ased_invc_amt as invc_amt
             , D.ased_infee_curr_cd as infee_curr_cd
             , D.ased_invc_fxrt as invc_fxrt
             , D.ased_invc_ncy_amt as invc_ncy_amt
             , D.ased_ttxbs_ncy_amt as ttxbs_ncy_amt
             , D.ased_tvlut_ncy_amt as tvlut_ncy_amt
             , D.prc_ev_dgcnt
             , FN_GET_CD_VDVAL_NM('CLR_0011', B.PRCS_STTS_CD ,'KO') AS PRCS_STTS_NM
             , B.del_yn                     /** Suppression On !==  ==! */
             , B.frst_regst_id              /** Id Du Premier Enregistrant  !==  ==! */
             , TO_CHAR(B.frst_rgsr_dttm      , 'DD/MM/YYYY HH24:MI:SS') AS frst_rgsr_dttm             /** Date Et Heure De Premier Enregistrement !==  ==! */
             , B.last_chpr_id               /** Id Du Modificateur Final !==  ==! */
             , TO_CHAR(B.last_chg_dttm       , 'DD/MM/YYYY HH24:MI:SS') AS last_chg_dttm              /** Date Et Heure De Modification Finale !==  ==! */
             , B.imppn_idfy_no
             , B.exppn_idfy_no
             , C.imppn_addr
             , C.imppn_co_nm
             , C.exppn_addr
             , C.exppn_co_nm
        FROM   tb_clri_tfrt_aply_info A,
               TB_CLRI_DED_COMN B,
               TB_CLRI_DED_CO C,
               TB_CLRI_DED_VLUT_AUDT_COMN D
        WHERE A.del_yn = 'N'
          AND B.del_yn = 'N'                /** Suppression ON !== 삭제여부 ==! */
          AND C.del_yn = 'N'
          AND A.dtl_dcsh_no = B.dtl_dcsh_no
          AND A.dtl_dcsh_no = C.dtl_dcsh_no
          AND A.dtl_dcsh_no = D.dtl_dcsh_no
          AND D.last_yn = 'Y'
          AND A.tfrt_aply_info_no = #{tfrtAplyInfoNo}       /** N° des informations de l'application de tarif !==  ==! */
        LIMIT 1
    </select>

    <!--
    CLRI_Consultation des informations d'application du tarif douanier !== CLRI_관세율적용정보 조회 ==!
    (Generated)
    -->
    <!-- ClrTfrtAplyInfoVo selectClrTfrtAplyInfoInfo(ClrTfrtAplyInfoVo searchVo); -->
    <select id="selectTfrtAplyDedInfo" parameterType="string" resultType="alpass.ipt.clr.pdr.dre.vo.ClrTfrtAplyInfoVo">
        SELECT
            A.dtl_dcsh_no                /** Numero de la déclaration en détail!! !== 상세신고서번호 ==! */
             , '' as tfrt_aply_info_no
             , A.dclr_cstm_cd
             , (select orgn_nm from tb_poti_orgn where orgn_cd = A.DCLR_CSTM_CD) as DCLR_CSTM_NM
             , (select orgn_nm from tb_poti_orgn where orgn_cd = A.audt_dept_cd) as AUDT_DEPT_NM
             , (select pbsr_no || ' | ' || emp_nm from TB_POTI_EMP where pbsr_no = A.audt_emp_id) AS AUDT_EMP_NM
             , TO_CHAR(TO_DATE(A.dclr_dt             , 'YYYYMMDD'),'DD/MM/YYYY') AS dclr_dt                    /** Date de déclaration !== 신고일자 ==! */
             , A.epc_cd
             , A.dclr_pt_cd
             , A.cscl_Pln_Cd
             , A.prcs_Stts_Cd
             , A.invc_no
             , A.audt_emp_id
             , C.ased_invc_amt as invc_amt
             , C.ased_infee_curr_cd as infee_curr_cd
             , C.ased_invc_fxrt as invc_fxrt
             , C.ased_invc_ncy_amt as invc_ncy_amt
             , C.ased_ttxbs_ncy_amt as ttxbs_ncy_amt
             , C.ased_tvlut_ncy_amt as tvlut_ncy_amt
             , C.prc_ev_dgcnt
             , FN_GET_CD_VDVAL_NM('CLR_0011', PRCS_STTS_CD ,#{langCd}) AS PRCS_STTS_NM
             , A.del_yn                     /** Suppression On !==  ==! */
             , A.frst_regst_id              /** Id Du Premier Enregistrant  !==  ==! */
             , TO_CHAR(A.frst_rgsr_dttm      , 'DD/MM/YYYY HH24:MI:SS') AS frst_rgsr_dttm             /** Date Et Heure De Premier Enregistrement !==  ==! */
             , A.last_chpr_id               /** Id Du Modificateur Final !==  ==! */
             , TO_CHAR(A.last_chg_dttm       , 'DD/MM/YYYY HH24:MI:SS') AS last_chg_dttm              /** Date Et Heure De Modification Finale !==  ==! */
             , A.imppn_idfy_no
             , A.exppn_idfy_no
             , B.imppn_addr
             , B.imppn_co_nm
             , B.exppn_addr
             , B.exppn_co_nm
        FROM   TB_CLRI_DED_COMN A,
               TB_CLRI_DED_CO B,
               TB_CLRI_DED_VLUT_AUDT_COMN C
        WHERE  A.del_yn = 'N'                /** Suppression ON !== 삭제여부 ==! */
          AND B.del_yn = 'N'
          AND C.del_yn = 'N'
          AND A.dtl_dcsh_no = B.dtl_dcsh_no
          AND A.dtl_dcsh_no = C.dtl_dcsh_no
          AND C.last_yn = 'Y'
          AND  A.dtl_dcsh_no = #{dtlDcshNo};       /** Numero de la déclaration en détail !==  ==! */
    </select>

    <!--
    CLRI_Enregistrement des informations d'application du tarif douanier !== CLRI_관세율적용정보 등록 ==!
    (Generated)
    -->
    <insert id="insertTfrtAplyInfo" parameterType="alpass.ipt.clr.pdr.dre.vo.ClrTfrtAplyInfoVo">
        /* insertClrTfrtAplyInfo */
        INSERT INTO TB_CLRI_TFRT_APLY_INFO (
            tfrt_aply_info_no                      /** N° des informations de l'application de tarif !==  ==! */
        , dtl_dcsh_no                          /** Numero de la déclaration en détail!! !== 상세신고서번호 ==! */
        , prc_ev_dgcnt                         /** Nombre De Fois De L'Évaluation De Valeur !== 가격평가차수 ==! */
        , make_pbsr_no                         /** N° Matricule Solde De L'Auteur !==  ==! */
        , atch_file_id                         /** Id Du Fichier Joint !==  ==! */
        , cmdt_desc_cn                         /** Contenu de description de marchandise !==  / 물품설명내용 ==! */
        , prcs_stts_cd
        , del_yn                               /** Suppression On !==  ==! */
        , frst_regst_id                        /** Id Du Premier Enregistrant  !==  ==! */
        , frst_rgsr_dttm                              /** Date Et Heure De Premier Enregistrement !==  ==! */
        , last_chpr_id                         /** Id Du Modificateur Final !==  ==! */
        , last_chg_dttm                               /** Date Et Heure De Modification Finale !==  ==! */
        ) VALUES (
                     #{tfrtAplyInfoNo}                      /** 	N° des informations de l'application de tarif !==  ==! */
                 , #{dtlDcshNo}                                 /** Numero de la déclaration en détail!! !== 상세신고서번호 ==! */
                 , #{prcEvDgcnt}                                /** Nombre De Fois De L'Évaluation De Valeur !== 가격평가차수 ==! */
                 , #{makePbsrNo}                                /** N° Matricule Solde De L'Auteur !==  ==! */
                 , #{atchFileId}                                /** Id Du Fichier Joint !==  ==! */
                 , #{cmdtDescCn}                                /** Contenu de description de marchandise !== Contenu de description de marchandise / 물품설명내용 ==! */
                 , '02'
                 , 'N'                                          /** Suppression On !==  ==! */
                 , #{frstRegstId}                               /** Id Du Premier Enregistrant  !==  ==! */
                 , SYSTIMESTAMP                                /** Date Et Heure De Premier Enregistrement !==  ==! */
                 , #{frstRegstId}                                 /** Id Du Modificateur Final !==  ==! */
                 , SYSTIMESTAMP                                /** Date Et Heure De Modification Finale !==  ==! */
                 )
        ON CONFLICT ( tfrt_aply_info_no )
            DO NOTHING
    </insert>

    <!--
    CLRI_Suppression des informations d'application du tarif douanier !== CLRI_관세율적용정보 삭제 ==!
    ()
    -->
    <delete id="deleteTfrtAplyInfo" parameterType="alpass.ipt.clr.pdr.dre.vo.ClrTfrtAplyInfoSrchVo">
        /* CLRI_Suppression des informations d'application du tarif douanier !== CLRI_관세율적용정보 삭제 ==!
        void deleteTfrtAplyInfo(ClrTfrtAplyInfoVo deleteVo);
          */
        UPDATE  TB_CLRI_TFRT_APLY_INFO SET
         last_chpr_id = #{pbsrNo}                         /** Id Du Modificateur Final !==  ==! */
         , del_yn = 'Y'
         , last_chg_dttm = SYSTIMESTAMP                               /** Date Et Heure De Modification Finale !==  ==! */
        WHERE  del_yn = 'N'                /** Suppression ON !== 삭제여부 ==! */
          AND  tfrt_aply_info_no = #{tfrtAplyInfoNo}       /** N° des informations de l'application de tarif !==  ==! */

    </delete>

    <!--
		 Consulter la liste des questions et réponses  !==질의답변 목록을 조회한다.==!
		 Kim Kiryong
	 -->
    <select id="selectDcshTfrtQuesAnswList" parameterType="alpass.ipt.clr.pdr.dre.vo.ClrTfrtAplyInfoDVo" resultType="alpass.ipt.clr.pdr.dre.vo.ClrTfrtAplyInfoDVo">
        /* PotiDcshmgmt_selectListQuesAnsw */
        SELECT
            A.tfrt_aply_info_no
             , A.ques_answ_dgcnt
             , A.QUES_ANSW_CN
             , A.REGST_TP_CD
             , (CASE WHEN #{pbsrNo} = B.make_pbsr_no THEN 'L_REPN' ELSE 'L_ANPN' END) AS REGST_TP_NM
             , (select pbsr_no || ' | ' || emp_nm from TB_POTI_EMP where pbsr_no = A.regst_pbsr_no) AS regst_pbsr_nm
             , TO_CHAR(A.RGSR_DTTM, 'DD/MM/YYYY HH24:MI:SS') AS RGSR_DTTM
             , A.regst_pbsr_no
             , DECODE(A.regst_pbsr_no,#{frstRegstId},'Y' ,'N') REGST_YN
             , A.answ_pbsr_no
             , (select pbsr_no || ' | ' || emp_nm from TB_POTI_EMP where pbsr_no = A.answ_pbsr_no) AS answ_pbsr_nm
             , A.RDNG_YN
             , A.DEL_YN
             , A.FRST_REGST_ID
             , TO_CHAR(A.FRST_RGSR_DTTM, 'DD/MM/YYYY HH24:MI:SS') FRST_RGSR_DTTM
             , A.LAST_CHPR_ID
             , TO_CHAR(A.LAST_CHG_DTTM, 'DD/MM/YYYY HH24:MI:SS') LAST_CHG_DTTM
        FROM   tb_clri_tfrt_aply_info_d A,
               tb_clri_tfrt_aply_info B
        WHERE  A.DEL_YN = 'N' AND B.del_yn = 'N'
          AND A.tfrt_aply_info_no = B.tfrt_aply_info_no
          AND A.tfrt_aply_info_no = #{tfrtAplyInfoNo}
          AND (A.regst_pbsr_no = #{pbsrNo} OR A.answ_pbsr_no = #{pbsrNo})
        ORDER BY A.ques_answ_dgcnt
    </select>

    <update id="updateTfrtAplyInfoCmplY" parameterType="string">
        UPDATE tb_clri_tfrt_aply_info
        SET prcs_stts = '03'
        WHERE   tfrt_aply_info_no = #{tfrtAplyInfoNo}
    </update>

    <update id="updateQuesAnswRdngYn" parameterType="alpass.ipt.clr.pdr.dre.vo.ClrTfrtAplyInfoDVo">
        /* ClriDpsQuesAnsw_updateQuesAnswRdngYn */
        UPDATE  tb_clri_tfrt_aply_info_d SET
            RDNG_YN = 'Y'
        WHERE   tfrt_aply_info_no = #{tfrtAplyInfoNo}
          AND     REGST_TP_CD = 'D'
          AND     RDNG_YN = 'N'
    </update>

    <!-- 
         Enregistrer des questions et réponses    !==질의답변을 등록한다.==!
         Kim Kiryong
     -->
    <insert id="insertDcshTfrtQuesAnsw" parameterType="alpass.ipt.clr.pdr.dre.vo.ClrTfrtAplyInfoDVo">
        /* PotiDcshmgmt_insertQuesAnsw */
        <selectKey order="AFTER" keyProperty="quesAnswDgcnt" resultType="java.math.BigDecimal">
            SELECT NVL(MAX(ques_answ_dgcnt),0) FROM  tb_clri_tfrt_aply_info_d WHERE  tfrt_aply_info_no = #{tfrtAplyInfoNo}
        </selectKey>
        INSERT INTO tb_clri_tfrt_aply_info_d
        (
            tfrt_aply_info_no
        , ques_answ_dgcnt
        , QUES_ANSW_CN
        , REGST_TP_CD
        , RGSR_DTTM
        , regst_pbsr_no
        , answ_pbsr_no
        , RDNG_YN
        , DEL_YN
        , FRST_REGST_ID
        , FRST_RGSR_DTTM
        , LAST_CHPR_ID
        , LAST_CHG_DTTM
        )
        VALUES
            (
                #{tfrtAplyInfoNo}
            , (SELECT NVL(MAX(ques_answ_dgcnt),0)+1 FROM   tb_clri_tfrt_aply_info_d WHERE  tfrt_aply_info_no = #{tfrtAplyInfoNo})
            , #{quesAnswCn}
            , 'C'
            , SYSDATE
            , #{regstPbsrNo}
            , #{answPbsrNo}
            , 'N'
            , 'N'
            , #{frstRegstId}
            , SYSTIMESTAMP
            , #{lastChprId}
            , SYSTIMESTAMP
            )
    </insert>

    <!-- 
            Modifier des questions et réponses    !==질의답변을 수정한다.==!
            Kim Kiryong
        -->
    <update id="updateDcshTfrtQuesAnsw" parameterType="alpass.ipt.clr.pdr.dre.vo.ClrTfrtAplyInfoDVo">
        /* PotiDcshmgmt_updateQuesAnsw */
        UPDATE  tb_clri_tfrt_aply_info_d SET
        <trim prefixOverrides="," >
            QUES_ANSW_CN = #{quesAnswCn}
            , LAST_CHPR_ID = #{lastChprId}
            , LAST_CHG_DTTM = SYSTIMESTAMP
        </trim>
        WHERE  tfrt_aply_info_no = #{tfrtAplyInfoNo}
        AND ques_answ_dgcnt = #{quesAnswDgcnt}
    </update>

    <update id="updateDcshTfrtCmpl" parameterType="string">
        UPDATE tb_clri_tfrt_aply_info
        SET prcs_stts_cd = '03'
        WHERE tfrt_aply_info_no = #{tfrtAplyInfoNo}
    </update>

    <select id="selectMakePbsrNo" parameterType="string" resultType="string">
        SELECT make_pbsr_no FROM tb_clri_tfrt_aply_info where tfrt_aply_info_no = #{tfrtAplyInfoNo}
    </select>

    <select id="selectTfrtCmplYn" parameterType="string" resultType="string">
        SELECT (CASE WHEN prcs_stts_cd = '03' THEN 'Y' ELSE 'N' END) FROM tb_clri_tfrt_aply_info where tfrt_aply_info_no = #{tfrtAplyInfoNo}
    </select>
</mapper>
