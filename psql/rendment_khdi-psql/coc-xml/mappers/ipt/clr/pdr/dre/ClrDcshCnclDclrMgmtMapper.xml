<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="alpass.ipt.clr.pdr.dre.mapper.ClrDcshCnclDclrMgmtMapper">
	<!--
    Consultation de contenus de l'annulation !== 취소 내용 조회 ==!
    -->
	<select id="selectCnclCn" parameterType="alpass.ipt.clr.com.vo.ClrDedCnclSrchVo" resultType="alpass.ipt.clr.pdr.dre.vo.ClrDedCldlCloaVo">
		/* selectCnclCn */
		SELECT
			A.dtl_dcsh_no              /** Numero de la déclaration en détail!! !== 상세신고서번호 ==! */
			 , A.cncl_tp_cd                 /** Code De Type De L'Annulation !== 취소구분코드 ==! */
			 , A.cncl_dgcnt                 /** Nombre De Fois De L'Annulation !== 취소차수 ==! */
			 , A.cncl_emp_id                /** Id De La Personne Annulant !== 취소직원ID ==! */
			 , TO_CHAR(A.cncl_dttm           , 'DD/MM/YYYY') AS cncl_dttm                  /** Date Et Heure De L'Annulation !== 취소일시 ==! */
			 , A.cncl_rsn_cd                /** Code De Motif De L'Annulation !== 취소사유코드 ==! */
			 , A.cncl_cn                    /** Contenu De L'Annulation !== 취소내용 ==! */
			 , A.cncl_infm_yn               /** Annulation Notifiée On !== 취소통보여부 ==! */
			 , (SELECT APRV_PRCS_STTS_CD FROM TB_POTI_APRV WHERE DEL_YN = 'N' AND APRV_ID = A.APRV_ID) AS APRV_PRCS_STTS_CD
			 , A.last_yn                    /** Final On !== 최종여부 ==! */
			 , A.del_yn                     /** Suppression On !== 삭제여부 ==! */
			 , A.frst_regst_id              /** Id Du Premier Enregistrant  !== 최초등록자ID ==! */
			 , TO_CHAR(A.frst_rgsr_dttm      , 'DD/MM/YYYY') AS frst_rgsr_dttm             /** Date Et Heure De Premier Enregistrement !== 최초등록일시 ==! */
			 , A.last_chpr_id               /** Id Du Modificateur Final !== 최종변경자ID ==! */
			 , TO_CHAR(A.last_chg_dttm       , 'DD/MM/YYYY') AS last_chg_dttm              /** Date Et Heure De Modification Finale !== 최종변경일시 ==! */
			 , A.aprv_id                    /** Id D'Approbation  !== 결재 ID ==! */
			 , A.ATCH_FILE_ID
		FROM  TB_CLRI_DED_CLDL_CLOA A
		   , TB_POTI_APRV B
		WHERE A.DTL_DCSH_NO = #{dtlDcshNo}
		  AND A.DEL_YN = 'N'
		  AND A.LAST_YN = 'Y'
		  AND A.APRV_ID = B.APRV_ID(+)
		  AND B.DEL_YN(+) = 'N'
	</select>

	<!--
    Consultation des détails de l'annulation !== 취소 상세 조회 ==!
    -->
	<select id="selectCnclInfo" parameterType="alpass.ipt.clr.pdr.dre.vo.ClrDedCldlCloaVo" resultType="alpass.ipt.clr.pdr.dre.vo.ClrDedCldlCloaVo">
		/* selectCnclCn */
		SELECT
			B.dtl_dcsh_no              /** Numero de la déclaration en détail!! !== 상세신고서번호 ==! */
			 , A.cncl_tp_cd                 /** Code De Type De L'Annulation !== 취소구분코드 ==! */
			 , A.cncl_dgcnt                 /** Nombre De Fois De L'Annulation !== 취소차수 ==! */
			 , A.cncl_emp_id                /** Id De La Personne Annulant !== 취소직원ID ==! */
			 , TO_CHAR(A.cncl_dttm           , 'DD/MM/YYYY') AS cncl_dttm                  /** Date Et Heure De L'Annulation !== 취소일시 ==! */
			 , A.cncl_rsn_cd                /** Code De Motif De L'Annulation !== 취소사유코드 ==! */
			 , A.cncl_cn                    /** Contenu De L'Annulation !== 취소내용 ==! */
			 , A.cncl_infm_yn               /** Annulation Notifiée On !== 취소통보여부 ==! */
			 , (SELECT APRV_PRCS_STTS_CD FROM TB_POTI_APRV WHERE DEL_YN = 'N' AND APRV_ID = A.APRV_ID) AS APRV_PRCS_STTS_CD
			 , A.last_yn                    /** Final On !== 최종여부 ==! */
			 , A.del_yn                     /** Suppression On !== 삭제여부 ==! */
			 , A.frst_regst_id              /** Id Du Premier Enregistrant  !== 최초등록자ID ==! */
			 , TO_CHAR(A.frst_rgsr_dttm      , 'DD/MM/YYYY') AS frst_rgsr_dttm             /** Date Et Heure De Premier Enregistrement !== 최초등록일시 ==! */
			 , A.last_chpr_id               /** Id Du Modificateur Final !== 최종변경자ID ==! */
			 , TO_CHAR(A.last_chg_dttm       , 'DD/MM/YYYY') AS last_chg_dttm              /** Date Et Heure De Modification Finale !== 최종변경일시 ==! */
			 , A.aprv_id                    /** Id D'Approbation  !== 결재 ID ==! */
		FROM  TB_CLRI_DED_CLDL_CLOA A
		   , TB_CLRI_DED_COMN B
		WHERE A.DTL_DCSH_NO = #{dtlDcshNo}
		  AND A.DTL_DCSH_NO = B.DTL_DCSH_NO
		  AND A.DEL_YN = 'N'
		  AND B.DEL_YN = 'N'
		  AND A.LAST_YN = 'Y'
	</select>

	<!--
    Consultation de la liste de l'annulation !== 취소 목록 조회 ==!
    -->
	<select id="selectCnclList" parameterType="alpass.ipt.clr.com.vo.ClrDedCnclSrchVo" resultType="alpass.ipt.clr.pdr.dre.vo.ClrDedCnclAcapVo">
		/* selectCnclList */
		<include refid="pagination.header" ></include>
		SELECT
		A.DTL_DCSH_NO                     /** Numero du DAU !== DED번호 ==! */
		, A.reff_no
		, B.cncl_tp_cd                 /** Code De Type De L'Annulation !== 취소구분코드 ==! */
		, B.cncl_dgcnt                 /** Nombre De Fois De L'Annulation !== 취소차수 ==! */
		, B.cncl_emp_id                /** Id De La Personne Annulant !== 취소직원ID ==! */
		, TO_CHAR(B.cncl_dttm           , 'DD/MM/YYYY') AS cncl_dttm                  /** Date Et Heure De L'Annulation !== 취소일시 ==! */
		, B.cncl_rsn_cd                /** Code De Motif De L'Annulation !== 취소사유코드 ==! */
		, B.cncl_cn                    /** Contenu De L'Annulation !== 취소내용 ==! */
		, B.cncl_infm_yn               /** Annulation Notifiée On !== 취소통보여부 ==! */
		, TO_CHAR(TO_DATE(A.DCLR_DT, 'YYYYMMDD'),'DD/MM/YYYY') AS DCLR_DT
		, A.DCLR_PT_CD
		, A.audt_dept_cd
		, A.CSCL_PLN_CD
		, A.TRNP_METH_KND_CD
		, A.TRNP_METH_IDFY_NO
		, C.DCER_CO_NM
		, A.RLBR_CSTM_CD
		, A.AUDT_EMP_ID
		, (SELECT EMP_NM FROM TB_POTI_EMP WHERE PBSR_NO = A.AUDT_EMP_ID AND DEL_YN = 'N') AS AUDT_EMP_NM
		, DECODE(A.CNCL_DCLR_RCPN_YN, 'Y', 'G01', A.PRCS_STTS_CD) AS PRCS_STTS_CD
		
		FROM  TB_CLRI_DED_COMN A
		, TB_CLRI_DED_CLDL_CLOA B
		, TB_CLRI_DED_CO C
		WHERE A.DTL_DCSH_NO = B.DTL_DCSH_NO
		AND A.DTL_DCSH_NO = C.DTL_DCSH_NO
		AND A.DEL_YN = 'N'
		AND B.DEL_YN = 'N'
		AND C.DEL_YN = 'N'
		AND B.LAST_YN = 'Y'
		<if test='dtlDcshNo != null and dtlDcshNo != "" '>
			AND  A.DTL_DCSH_NO LIKE #{dtlDcshNo}||'%'                        /** Numero du DAU !== DED번호 ==! */
		</if>
		<choose>
			<when test='userRoleTp != null and userRoleTp =="CHPN"'>
				/* !== 담당자 ==!*/
				<if test="userId != null and userId != ''">
					AND A.AUDT_EMP_ID = #{userId}
				</if>

			</when>
			<otherwise>
				/* !== 관리자 ==!*/
				<choose>
					<when test='userRoleTp != null and userRoleTp =="SRVC"'>
						/* !== 부서장 ==!*/
						AND A.audt_dept_cd = #{userDeptCd}
						AND A.DCLR_CSTM_CD = #{userCstmCd}
					</when>
					<when test='userRoleTp != null and userRoleTp =="CSTM"'>
						/* !== 세관장 ==!*/
						AND A.DCLR_CSTM_CD = #{userCstmCd}
					</when>
				</choose>
			</otherwise>
		</choose>
		<if test="reffNo != null and reffNo != ''">
			AND A.REFF_NO LIKE #{reffNo}||'%'
		</if>
		<if test="dclrPtCd != null and dclrPtCd != ''">
			AND A.DCLR_PT_CD = #{dclrPtCd}
		</if>
		<if test="csclPlnCd != null and csclPlnCd != ''">
			AND A.CSCL_PLN_CD = #{csclPlnCd}
		</if>
		<if test="trnpMethKndCd != null and trnpMethKndCd != ''">
			AND A.TRNP_METH_KND_CD = #{trnpMethKndCd}
		</if>
		<if test="cnclTpCd != null and cnclTpCd != ''">
			AND B.CNCL_TP_CD = #{cnclTpCd}
		</if>
		<if test="prcsSttsCd != null and prcsSttsCd != ''">
			<choose>
				<when test="'G01'.equals(prcsSttsCd)">
					AND (A.PRCS_STTS_CD = #{prcsSttsCd} OR A.CNCL_DCLR_RCPN_YN = 'Y')
				</when>
				<otherwise>
					AND A.PRCS_STTS_CD = #{prcsSttsCd}
				</otherwise>
			</choose>
		</if>
		<if test="dclrDtFrom != null and dclrDtFrom != ''">
			AND		A.DCLR_DT <![CDATA[ >= ]]> TO_CHAR(TO_DATE(#{dclrDtFrom},'DD/MM/YYYY'),'YYYYMMDD')
		</if>
		<if test="dclrDtTo != null and dclrDtTo != ''">
			AND		A.DCLR_DT <![CDATA[ <= ]]> TO_CHAR(TO_DATE(#{dclrDtTo},'DD/MM/YYYY'),'YYYYMMDD')
		</if>
		<if test="rqstDtFrom != null and rqstDtFrom != ''">
			AND		B.cncl_dttm <![CDATA[ >= ]]> TO_DATE(#{rqstDtFrom},'DD/MM/YYYY')
		</if>
		<if test="rqstDtTo != null and rqstDtTo != ''">
			AND		B.cncl_dttm <![CDATA[ < ]]> TO_DATE(#{rqstDtTo},'DD/MM/YYYY') + 1
		</if>
		ORDER BY DCLR_DT DESC, DTL_DCSH_NO DESC

		<include refid="pagination.footer" ></include>
	</select>


	<!--
    CLRI_Consultation de l'annulation d'office de la déclaration en détail !== CLRI_상세신고서신고취소직권취소 등록 ==!
    (Kim Kiryong)
    -->
	<insert id="mergeInsertCnclRgsr" parameterType="alpass.ipt.clr.pdr.dre.vo.ClrDedCldlCloaVo">
		<selectKey keyProperty="cnclDgcnt" resultType="BigDecimal" order="BEFORE">
			SELECT NVL(MAX(CNCL_DGCNT), 0) + 1 FROM TB_CLRI_DED_CLDL_CLOA WHERE dtl_dcsh_no =  #{dtlDcshNo}
		</selectKey>
		/* insertClrDedCldlCloa */
		INSERT INTO TB_CLRI_DED_CLDL_CLOA (
			dtl_dcsh_no                            /** Numero de la déclaration en détail!! !== 상세신고서번호 ==! */
		, cncl_tp_cd                           /** Code De Type De L'Annulation !== 취소구분코드 ==! */
		, cncl_dgcnt                           /** Nombre De Fois De L'Annulation !== 취소차수 ==! */
		, cncl_emp_id                          /** Id De La Personne Annulant !== 취소직원ID ==! */
		, cncl_dttm                            /** Date Et Heure De L'Annulation !== 취소일시 ==! */
		, cncl_rsn_cd                          /** Code De Motif De L'Annulation !== 취소사유코드 ==! */
		<if test="cnclCn != null and cnclCn != ''">
		, cncl_cn                              /** Contenu De L'Annulation !== 취소내용 ==! */
		</if>
		, cncl_infm_yn                         /** Annulation Notifiée On !== 취소통보여부 ==! */
		, last_yn                              /** Final On !== 최종여부 ==! */
		, del_yn                               /** Suppression On !== 삭제여부 ==! */
		, frst_regst_id                        /** Id Du Premier Enregistrant  !== 최초등록자ID ==! */
		, frst_rgsr_dttm                              /** Date Et Heure De Premier Enregistrement !== 최초등록일시 ==! */
		, last_chpr_id                         /** Id Du Modificateur Final !== 최종변경자ID ==! */
		, last_chg_dttm                               /** Date Et Heure De Modification Finale !== 최종변경일시 ==! */
		<if test="aprvId != null and aprvId != ''">
		, aprv_id                              /** Id D'Approbation  !== 결재 ID ==! */
		</if>
		) VALUES (
		 #{dtlDcshNo}                           /** Numero de la déclaration en détail!! !== 상세신고서번호 ==! */
	 , #{cnclTpCd}                                  /** Code De Type De L'Annulation !== 취소구분코드 ==! */
	 , #{cnclDgcnt}                                 /** Nombre De Fois De L'Annulation !== 취소차수 ==! */
	 , #{cnclEmpId}                                 /** Id De La Personne Annulant !== 취소직원ID ==! */
	 , SYSDATE                                  /** Date Et Heure De L'Annulation !== 취소일시 ==! */
	 , NVL(#{cnclRsnCd}, 'Z')                                 /** Code De Motif De L'Annulation !== 취소사유코드 ==! */
	<if test="cnclCn != null and cnclCn != ''">
	 , #{cnclCn}                                    /** Contenu De L'Annulation !== 취소내용 ==! */
	</if>
	 , NVL(#{cnclInfmYn}, 'N')                                /** Annulation Notifiée On !== 취소통보여부 ==! */
	 , 'Y'                                    /** Final On !== 최종여부 ==! */
	 , 'N'                                          /** Suppression On !== 삭제여부 ==! */
	 , #{frstRegstId}                               /** Id Du Premier Enregistrant  !== 최초등록자ID ==! */
	 , SYSTIMESTAMP                                /** Date Et Heure De Premier Enregistrement !== 최초등록일시 ==! */
	 , #{lastChprId}                                /** Id Du Modificateur Final !== 최종변경자ID ==! */
	 , SYSTIMESTAMP                                /** Date Et Heure De Modification Finale !== 최종변경일시 ==! */
		<if test="aprvId != null and aprvId != ''">
	 , #{aprvId}                                    /** Id D'Approbation  !== 결재 ID ==! */
		</if>
				 )
			ON CONFLICT ( dtl_dcsh_no,cncl_tp_cd,cncl_dgcnt )
        DO UPDATE SET
		   cncl_dttm = SYSDATE                              /** Date Et Heure De L'Annulation !== 취소일시 ==! */
			<if test="cnclEmpId != null and cnclEmpId != ''">
		   ,cncl_emp_id = #{cnclEmpId}                            /** Id De La Personne Annulant !== 취소직원ID ==! */
			</if>
			<if test="cnclRsnCd != null and cnclRsnCd != ''">
		   ,cncl_rsn_cd = #{cnclRsnCd}                           /** Code De Motif De L'Annulation !== 취소사유코드 ==! */
			</if>
			<if test="cnclCn != null and cnclCn != ''">
		   ,cncl_cn = #{cnclCn}                                  /** Contenu De L'Annulation !== 취소내용 ==! */
			</if>
		   ,cncl_infm_yn = #{cnclInfmYn}                         /** Annulation Notifiée On !== 취소통보여부 ==! */
		   ,last_yn = 'Y'                                  /** Final On !== 최종여부 ==! */
		   ,last_chpr_id = #{lastChprId}                         /** Id Du Modificateur Final !== 최종변경자ID ==! */
		   , last_chg_dttm = SYSTIMESTAMP                               /** Date Et Heure De Modification Finale !== 최종변경일시 ==! */
		<if test="aprvId != null and aprvId != ''">
		   ,aprv_id = #{aprvId}                                  /** Id D'Approbation  !== 결재 ID ==! */
		</if>
	</insert>

	<!--
   Consultation de la série séquentielle de l''annulation (la série séquentielle de l'annulation concerne le numéro de la déclaration. Le code de division de l'annulation n'est pas ajouté) !== 취소차수 조회 (취소 차수는 DED번호에 대한 차수로 취소 구분코드는 추가하지 않음)==!
   -->
	<select id="selectCnclDgcnt" parameterType="alpass.ipt.clr.pdr.dre.vo.ClrDedCldlCloaVo" resultType="java.math.BigDecimal">
		/* selectCnclDgcnt */
		SELECT NVL(MAX(CNCL_DGCNT), 0) AS CNCL_DGCNT
		FROM TB_CLRI_DED_CLDL_CLOA
		WHERE dtl_dcsh_no = #{dtlDcshNo}
		  AND DEL_YN = 'N'
	</select>

	<!--
    Modification de l'annulation/l'annulation d'office final O/N !== 취소/직권취소 최종여부 수정 ==!
    -->
	<update id="updateLastYn" parameterType="alpass.ipt.clr.pdr.dre.vo.ClrDedCldlCloaVo" >
		/* updateLastYn */
		UPDATE TB_CLRI_DED_CLDL_CLOA
		SET LAST_YN = #{lastYn}
		  , LAST_CHPR_ID = #{lastChprId}                /** ID du modificateur final !== 최종변경자ID ==! */
		  , LAST_CHG_DTTM = SYSTIMESTAMP                /** Date et heure de modification finale !== 최종변경일시 ==! */
		WHERE dtl_dcsh_no = #{dtlDcshNo}
		  AND CNCL_DGCNT = #{cnclDgcnt}
		  AND DEL_YN = 'N'

	</update>

	<!--
   Modification de l'annulation/l'annulation d'office !== 취소/직권취소 수정 ==!
   -->
	<update id="updateCnclRgsr" parameterType="alpass.ipt.clr.pdr.dre.vo.ClrDedCldlCloaVo">
		/* updateCnclRgsr */
		UPDATE TB_CLRI_DED_CLDL_CLOA
		SET CNCL_EMP_ID = #{lastChprId}
		<if test="'B'.equals(cnclTpCd)">
			, CNCL_CN = #{cnclCn}
		</if>
		, LAST_CHPR_ID = #{lastChprId}                /** ID du modificateur final !== 최종변경자ID ==! */
		, LAST_CHG_DTTM = SYSTIMESTAMP                /** Date et heure de modification finale !== 최종변경일시 ==! */
		WHERE dtl_dcsh_no = #{dtlDcshNo}
		AND CNCL_TP_CD = #{cnclTpCd}
		AND CNCL_DGCNT = #{cnclDgcnt}
		AND DEL_YN = 'N'
	</update>

	<!--
     Suppression de l'annulation/l'annulation d'office !== 취소/직권취소 삭제 ==!
    -->
	<update id="deleteCnclRgsr" parameterType="alpass.ipt.clr.pdr.dre.vo.ClrDedCldlCloaVo">
		/* deleteCnclRgsr */
		UPDATE  TB_CLRI_DED_CLDL_CLOA SET
			DEL_YN = 'Y'                                  /** Suppression ON !== 삭제여부 ==! */
			,  LAST_CHPR_ID = #{lastChprId}                  /** ID du modificateur final !== 최종변경자ID ==! */
			,  LAST_CHG_DTTM = SYSTIMESTAMP                  /** Date et heure de modification finale !== 최종변경일시 ==! */
		WHERE  DEL_YN = 'N'                                  /** Suppression ON !== 삭제여부 ==! */
		  AND  dtl_dcsh_no = #{dtlDcshNo}                           /** Numero du DAU !== DED번호 ==! */
		  AND  CNCL_TP_CD = #{cnclTpCd}                      /** Code de type de l'annulation !== 취소구분코드 ==! */
		  AND  CNCL_DGCNT = #{cnclDgcnt}                     /** Nombre de fois de l'annulation !== 취소차수 ==! */
	</update>

	<!--
   Consultation générale de l'annulation !== 취소 일반 조회 ==!
   -->
	<select id="selectCnclGnrl" parameterType="alpass.ipt.clr.com.vo.ClrDedCnclSrchVo" resultType="alpass.ipt.clr.pdr.dre.vo.ClrDedCnclGnrlVo">
		/* selectCnclGnrl */
		SELECT
			A.DTL_DCSH_NO
			 , TO_CHAR(TO_DATE(A.DCLR_DT, 'YYYYMMDD'),'DD/MM/YYYY') AS DCLR_DT
			 , A.REFF_NO
			 , A.DCLR_PT_CD
			 , A.DCLR_CSTM_CD
			 , (SELECT ORGN_NM FROM TB_POTI_ORGN WHERE ORGN_CD = A.DCLR_CSTM_CD AND DEL_YN = 'N') AS DCLR_CSTM_NM
			 , A.RLBR_CSTM_CD
			 , (SELECT ORGN_NM FROM TB_POTI_ORGN WHERE ORGN_CD = A.RLBR_CSTM_CD AND DEL_YN = 'N') AS RLBR_CSTM_NM
			 , A.CMDT_STGE_LOCT_CD
			 , A.DCSH_FM_CD
			 , DECODE(A.DCLR_PT_CD, 'IM4', A.IMPPN_IDFY_NO
			, 'IM5', A.IMPPN_IDFY_NO
			, 'IM6', A.IMPPN_IDFY_NO , A.EXPPN_IDFY_NO) AS IDFY_NO

			 , DECODE(A.DCLR_PT_CD, 'IM4', B.IMPPN_CO_NM
			, 'IM5', B.IMPPN_CO_NM
			, 'IM6', B.IMPPN_CO_NM , B.EXPPN_CO_NM) AS CO_NM
			 , A.DCER_CD
			 , A.PRC_DCSH_WRTE_YN /* 가격신고서 기재여부 */
			 , A.CSCL_PSTP_YN
			 , A.CNCL_DCLR_RCPN_YN
			 , A.SELC_RSLT_CD
			 , A.RLSE_YN
			 , A.PRCS_STTS_CD
			 , A.MDFY_DGCNT
			 , A.REFF_NO
			 , TO_CHAR(TO_DATE(A.RQST_DT, 'YYYYMMDD'),'DD/MM/YYYY') AS RQST_DT
			 , A.EPC_CD
			 , A.ADOR_HNOT_OPIN_CN
			 , (SELECT CNCL_RSN_CD FROM TB_CLRI_DED_CLDL_CLOA WHERE DTL_DCSH_NO = A.DTL_DCSH_NO AND DEL_YN = 'N' AND LAST_YN = 'Y') AS CNCL_RSN_CD
			 , (SELECT CNCL_CN FROM TB_CLRI_DED_CLDL_CLOA WHERE DTL_DCSH_NO = A.DTL_DCSH_NO AND DEL_YN = 'N' AND LAST_YN = 'Y') AS CNCL_CN
			 , (SELECT ATCH_FILE_ID FROM TB_CLRI_DED_CLDL_CLOA WHERE DTL_DCSH_NO = A.DTL_DCSH_NO AND DEL_YN = 'N' AND LAST_YN = 'Y') AS ATCH_FILE_ID
		FROM TB_CLRI_DED_COMN A
		   , TB_CLRI_DED_CO B
		WHERE A.DTL_DCSH_NO = B.DTL_DCSH_NO
		  AND A.DEL_YN = B.DEL_YN
		  AND A.DTL_DCSH_NO = #{dtlDcshNo}                         /** Numero du DAU !== DED번호 ==! */
		  AND (A.PRCS_STTS_CD IN ('G01', 'G03', 'G04', 'D02') OR A.CNCL_DCLR_RCPN_YN = 'Y')
		/* 권한에 따른 조회 조건 추가 필요 */

	</select>

	<!--
   Consultation de l'historique de l'annulation !== 취소 이력 조회 ==!
   -->
	<select id="selectCnclHistList" parameterType="alpass.ipt.clr.com.vo.ClrDedCnclSrchVo" resultType="alpass.ipt.clr.pdr.dre.vo.ClrDedCnclHistVo">
		/* selectCnclHistList */
		<include refid="pagination.header" ></include>
		SELECT A.CNCL_DGCNT
			 , C.APRV_DTL_HIST_SRNO
			 , A.CNCL_TP_CD
			 , A.CNCL_CN
			 , A.CNCL_EMP_ID
			 , TO_CHAR(A.CNCL_DTTM, 'DD/MM/YYYY HH24:MI:SS') AS CNCL_DTTM
			 , B.APRV_PRCS_STTS_CD
			 , TO_CHAR(C.APRV_PRCS_DTTM, 'DD/MM/YYYY HH24:MI:SS') AS APRV_PRCS_DTTM
			 , C.APRV_EMP_PBSR_NO
			 , (SELECT EMP_NM FROM TB_POTI_EMP WHERE PBSR_NO = C.APRV_EMP_PBSR_NO AND DEL_YN = 'N') AS APRV_EMP_NM
			 , C.APRV_RSLT_CD
			 , C.APRV_OPIN_CN

		FROM TB_CLRI_DED_CLDL_CLOA A
		   , TB_POTI_APRV B
		   , TB_POTI_APRV_D_H C
		WHERE A.DTL_DCSH_NO = #{dtlDcshNo}
		  AND A.DEL_YN = 'N'
		  AND B.DEL_YN = 'N'
		  AND C.DEL_YN = 'N'
		  AND A.LAST_YN = 'Y'
		  AND A.APRV_ID = B.APRV_ID
		  AND A.APRV_ID = C.APRV_ID
		ORDER BY APRV_DTL_HIST_SRNO
		<include refid="pagination.footer" ></include>
	</select>

	<!--
    Consultation des informations statistiques de ancienne déclaration DED par le CRN et lieu d'emplacement des marchandises !== 화물관리번호, 물품장치장소로 이전 DAU 신고 통계현황 정보 조회 ==!
    -->
	<select id="selectCnclStatsInfo" parameterType="alpass.ipt.clr.pdr.dre.vo.ClrDedGnrlVo" resultType="alpass.ipt.clr.pdr.dre.vo.ClrDedCnclStatsVo">
		SELECT  COUNT(*) AS BF_DCLR_CNT  /* 이전신고 건수 */
		, SUM(DECODE(DCRD_YN, 'Y', 1, 0)) AS DCRD_Y_CNT /* 차상반출 Y 신고 건수 */
		, SUM(DECODE(DCRD_YN, 'N', 1, 0)) AS DCRD_N_CNT /* 차상반출 N 신고 건수 */
		, SUM(DECODE(DIVD_CSCL_TP_CD, 'A', 1, 0)) AS DIVD_CSCL_A_CNT  /* 분할통관구분 A|전체 신고 건수 */
		, SUM(DECODE(DIVD_CSCL_TP_CD, 'I', 1, 0)) AS DIVD_CSCL_I_CNT  /* 분할통관구분 I|분할(시작) 신고 건수 */
		, SUM(DECODE(DIVD_CSCL_TP_CD, 'D', 1, 0)) AS DIVD_CSCL_D_CNT  /* 분할통관구분 D|분할(진행중) 건수 */
		, SUM(DECODE(DIVD_CSCL_TP_CD, 'L', 1, 0)) AS DIVD_CSCL_L_CNT  /* 분할통관구분 L|분할(최종) 건수 */
		FROM TB_CLRI_DED_COMN
		WHERE CAG_MGMT_NO       = #{cagMgmtNo}
		<if test='dcrdYn != null and dcrdYn == "Y"'>
			AND CMDT_STGE_LOCT_CD IS NULL                /* 차상반출인 경우는 IS NULL로 비교함(물품장치위치가 없음) */
		</if>
		<if test='dcrdYn == null or dcrdYn == "N"'>
			<if test="cmdtStgeLoctCd != null and cmdtStgeLoctCd != ''">
				AND CMDT_STGE_LOCT_CD = #{cmdtStgeLoctCd}
			</if>
		</if>
		AND PRCS_STTS_CD NOT IN ('G03', 'G04')          /* 취소건 제외 */
		AND DTL_DCSH_NO <![CDATA[ <> ]]> #{dtlDcshNo}
	</select>

	<!--
       * SQL 설명 : Mettre à jour de l'ID d'approbation de l'annulation de la déclaration DED !== DED 신고서 취소 결재 ID 업데이트 ==!
   -->
	<update id="updateCnclAprvId" parameterType="alpass.ipt.clr.pdr.dre.vo.ClrDedCldlCloaVo">
		/* updateCnclAprvId */
		UPDATE TB_CLRI_DED_CLDL_CLOA
		SET APRV_ID = #{aprvId}
		  , LAST_CHPR_ID = #{lastChprId}                  /** ID du modificateur final !== 최종변경자ID ==! */
		  , LAST_CHG_DTTM = SYSTIMESTAMP                  /** Date et heure de modification finale !== 최종변경일시 ==! */
		WHERE  DEL_YN = 'N'                                  /** Suppression ON !== 삭제여부 ==! */
		  AND DTL_DCSH_NO = #{dtlDcshNo}
		  AND CNCL_TP_CD = #{cnclTpCd}
		  AND CNCL_DGCNT = #{cnclDgcnt}
	</update>

	<!--
     Vérification de l'existence O/N d'un avis !== 고지 존재 여부 확인 ==!
    -->
	<select id="selectNtfcExstYn" parameterType="alpass.ipt.clr.pdr.dre.vo.ClrDedCldlCloaVo" resultType="java.lang.String">
		/* selectNtfcExstYn */
		SELECT 1 AS NTFC_EXST_YN
		FROM   TB_COLI_NTFC
		WHERE  reff_no = #{dtlDcshNo}
		  AND    CNCL_YN = 'N'
		  AND    DEL_YN = 'N'
		  AND    ROWNUM = 1
	</select>

	<!--
    Suppression de l'interface dédouanement-fret
    !== 통관 화물 인터페이스 삭제 ==!
    -->
	<delete id="deleteCsclCagIntf" parameterType="hashMap">
		/* deleteCsclCagIntf */
        <![CDATA[
		DELETE
		FROM TB_CLRI_CSCL_CAG_INTF
		WHERE DTL_DCSH_NO = #{dtlDcshNo}      /** Numéro du DAU !== DED번호 ==! */
		]]>
	</delete>

	<!--
    Saisie de l'interface dédouanement-fret
    !== 통관 화물 인터페이스 입력 ==!
    -->
	<insert id="insertCsclCagIntf" parameterType="hashMap">
		/* insertCsclCagIntf */
        <![CDATA[
		INSERT
		INTO ALPASSINT.TB_CLRI_CSCL_CAG_INTF
		(
			DTL_DCSH_NO                  /** Numéro du DED !== DED번호 ==! */
		, ACPT_DT                      /** Date de l'autorisation d'enlèvement des marchandises !== 수리일자 ==! */
		, MDFY_RQST_YN                 /** !== 정정신청여부 ==! */
		, DCLR_PT_CD                   /** Code de type de déclaration !== 신고유형코드 ==! */
		, EPC_CD                       /** Code EPC !== EPC코드 ==! */
		, DCER_CD                      /** Code du déclarant !== 신고인코드 ==! */
		, CAG_MGMT_NO                  /** CRN !== 화물관리번호 ==! */
		, CMDT_STGE_LOCT_CD            /** Code De Localisation De Stockage !== 물품장치위치코드 ==! */
		, CNTR_CAG_YN                  /** Cargaison conteneurisée ON !== 컨테이너화물여부 ==! */
		, APRE_PCKG_GCNT               /** Nombre de colisage autorisé !== 승인포장개수 ==! */
		, APRE_TTWG                    /** Poids Brut Autorisé !== 승인총중량 ==! */
		, APRE_NTWG                    /** Poids net autorise !== 승인순중량 ==! */
		, PRCS_YN                      /** Traitement ON !== 처리여부 ==! */
		, DEL_YN                       /** Suppression ON !== 삭제여부 ==! */
		, FRST_REGST_ID                /** ID du premier enregistrant  !== 최초등록자ID ==! */
		, FRST_RGSR_DTTM               /** Date et heure de premier enregistrement !== 최초등록일시 ==! */
		, LAST_CHPR_ID                 /** ID du modificateur final !== 최종변경자ID ==! */
		, LAST_CHG_DTTM                /** Date et heure de modification finale !== 최종변경일시 ==! */
		)
		SELECT
			A.DTL_DCSH_NO                /** Numéro du DED !== DED번호 ==! */
			 , ACPT_DT                      /** Date de l'autorisation d'enlèvement des marchandises !== 수리일자 ==! */
			 ,'Y'                /** Demande de la rectification O/N (en cas d'annulation : envoyer à Y) !== 정정신청여부 (취소시 : Y로 보내기로 함) ==! */
			 , A.DCLR_PT_CD                 /** Code de type de déclaration !== 신고유형코드 ==! */
			 , A.EPC_CD                     /** Code EPC !== EPC코드 ==! */
			 , A.DCER_CD                    /** Code du déclarant !== 신고인코드 ==! */
			 , A.CAG_MGMT_NO                /** CRN !== 화물관리번호 ==! */
			 , A.CMDT_STGE_LOCT_CD          /** Code De Localisation De Stockage !== 물품장치위치코드 ==! */
			 , A.CNTR_CAG_YN                /** Cargaison conteneurisée ON !== 컨테이너화물여부 ==! */
			 , A.PCKG_TGCNT                 /** Nombre total de colis !== 포장총개수 ==! */
			 , A.AL_TTWG                    /** Poids brut total !== 전체총중량 ==! */
			 , A.AL_NTWG                    /** Poids brut total !== 전체순중량 ==! */
			 , 'N'                          /** Traitement ON !== 처리여부 ==! */
			 , 'N'                          /** Suppression ON !== 삭제여부 ==! */
			 , #{frstRegstId}               /** ID du premier enregistrant  !== 최초등록자ID ==! */
			 , SYSTIMESTAMP                 /** Date et heure de premier enregistrement !== 최초등록일시 ==! */
			 , #{lastChprId}                /** ID du modificateur final !== 최종변경자ID ==! */
			 , SYSTIMESTAMP                 /** Date et heure de modification finale !== 최종변경일시 ==! */
		FROM  ALPASSINT.TB_CLRI_DED_COMN A
		WHERE A.DEL_YN = 'N'                                /** Suppression ON !== 삭제여부 ==! */
		  AND A.DTL_DCSH_NO = #{dtlDcshNo}                  /** Numéro du DED !== DED번호 ==! */
		]]>
	</insert>

	<!--
    Suppression du conteneur de l'interface dédouanement-fret
    !== 통관 화물 인터페이스 컨테이너 삭제 ==!
    -->
	<delete id="deleteCsclCagIntfCntr" parameterType="hashMap">
		/* deleteCsclCagIntfCntr */
        <![CDATA[
		DELETE
		FROM TB_CLRI_CSCL_CAG_CNTR
		WHERE DTL_DCSH_NO = #{dtlDcshNo}      /** Numéro du DAU !== DED번호 ==! */
		]]>
	</delete>

	<!--
    Saisie du conteneur de l'interface dédouanement-fret
    !== 통관 화물 인터페이스 컨테이너 입력 ==!
    -->
	<insert id="insertCsclCagIntfCntr" parameterType="hashMap">
		/* insertCsclCagIntfCntr */
        <![CDATA[
		INSERT
		INTO TB_CLRI_CSCL_CAG_CNTR
		(
			DTL_DCSH_NO                 /** Numéro du DAU !== DED번호 ==! */
		, CNTR_NO                     /** N° de conteneur !== 컨테이너번호 ==! */
		, CNTR_TP_CD                  /** Code de type de conteneur !== 컨테이너구분코드 ==! */
		, DEL_YN                      /** Suppression ON !== 삭제여부 ==! */
		, FRST_REGST_ID               /** ID du premier enregistrant  !== 최초등록자ID ==! */
		, FRST_RGSR_DTTM              /** Date et heure de premier enregistrement !== 최초등록일시 ==! */
		, LAST_CHPR_ID                /** ID du modificateur final !== 최종변경자ID ==! */
		, LAST_CHG_DTTM               /** Date et heure de modification finale !== 최종변경일시 ==! */
		)
		SELECT 	DTL_DCSH_NO                  /** Numéro du DAU !== DED번호 ==! */
			 , CNTR_NO                      /** N° de conteneur !== 컨테이너번호 ==! */
			 , CNTR_TP_CD                   /** Code de type de conteneur !== 컨테이너구분코드 ==! */
			 , 'N'                          /** Suppression ON !== 삭제여부 ==! */
			 , #{frstRegstId}               /** ID du premier enregistrant  !== 최초등록자ID ==! */
			 , SYSTIMESTAMP                 /** Date et heure de premier enregistrement !== 최초등록일시 ==! */
			 , #{lastChprId}                /** ID du modificateur final !== 최종변경자ID ==! */
			 , SYSTIMESTAMP                 /** Date et heure de modification finale !== 최종변경일시 ==! */
		FROM 	TB_CLRI_DED_CNTR
		WHERE 	DEL_YN = 'N'
		  AND	DTL_DCSH_NO = #{dtlDcshNo}
		]]>
	</insert>

	<!--
		Consulter la liste todo du numéro de DED : !== DED 번호의 todo리스트 조회 ==!
	-->
	<select id="selectTodoIdLst" parameterType="alpass.com.todo.vo.ComTodoVo" resultType="alpass.com.todo.vo.ComTodoVo">
		SELECT TODO_ID
		FROM   TB_POTI_TODO
		WHERE  DEL_YN = 'N'
		  AND    BSOP_CLSF_CD = #{bsopClsfCd}
		  AND    TODO_REFF_NO = #{todoReffNo}
		  AND    MDFY_DGCNT = #{mdfyDgcnt}
		  AND    TODO_STTS_CD = 'A'
		  AND    TODO_BSOP_TP_CD IN ('B04','B05','B06','B07','B16') /* B04:접수, B05:정정접수, B06:취소, B07:통관보류 */
	</select>

	<!--
		* SQL 설명 : Consultation de montant de la caution pour le numéro de la DED concernée !== 해당 DED 번호의 담보금액 조회 ==!
	-->
	<select id="selectCnclMgReleInfo" parameterType="alpass.ipt.clr.pdr.dre.vo.ClrDedSrchVo" resultType="alpass.ipt.clr.pdr.dre.vo.ClrDedCnclMgVo">
		/* ClriDpsCncl_selectCnclMgReleInfo */
		SELECT T.*
			 , T.MG_USE_RELE_AMT - T.MG_AMT AS USE_PSBL_AMT
		FROM
			(
				SELECT
					DECODE(A.DCLR_PT_CD, 'EX1', A.EXPPN_IDFY_NO
						, 'EX2', A.EXPPN_IDFY_NO
						, 'EX3', A.EXPPN_IDFY_NO , A.IMPPN_IDFY_NO) AS IDFY_NO1
					 , A.TXPR_IDFY_NO AS IDFY_NO2
					 , (SELECT NIF FROM TB_COM_CO_DCLR_CD WHERE CO_DCLR_CD = A.DCER_CD AND DEL_YN = 'N') AS IDFY_NO3
					 , (
					WITH USE AS (
						SELECT SUM(USE_AMT) AS USE_AMT
						FROM tb_coli_mg_use
						WHERE reff_no = #{dtlDcshNo}

					),
						 RELE AS (
							 SELECT SUM(mg_rele_amt) AS RELE_AMT
							 FROM tb_coli_mg_rele
							 WHERE reff_no = #{dtlDcshNo}

						 )
					SELECT NVL(A.USE_AMT,0) - NVL(B.RELE_AMT, 0)
							   AS MG_AC_USE_RELE_AMT
					FROM USE A, RELE B
				) AS MG_USE_RELE_AMT
					 , (SELECT NVL(SUM(FLOOR(PAY_TAX_AMT)), 0) FROM ( SELECT NVL(SUM(PAY_TAX_AMT), 0) AS PAY_TAX_AMT
						 FROM TB_CLRI_DED_TAX
						 WHERE DTL_DCSH_NO = #{dtlDcshNo}
						   AND PAY_KND_CD = '0'
						   AND DEL_YN  ='N'
						   GROUP BY TAX_CD)
				) AS MG_AMT


				FROM TB_CLRI_DED_COMN A
				   , TB_CLRI_DED_MG B
				WHERE A.DTL_DCSH_NO = #{dtlDcshNo}
				  AND A.DTL_DCSH_NO = B.dtl_dcsh_no
				  AND A.DEL_YN = 'N'
				  AND B.DEL_YN = 'N'
			) T
	</select>

    <!--
    Consultation de l'annulation O/N de numéro de la notification !== 고지번호 취소여부 조회 ==!
    -->
    <select id="selectCnclNtfc" parameterType="alpass.com.tax.col.ntsh.vo.ComNtfcVo"  resultType="alpass.ipt.clr.pdr.dre.vo.ClrDedCldlCloaVo">
    	/* selectCnclNtfc */
			SELECT
				B.dtl_dcsh_no              /** Numero de la déclaration en détail!! !== 상세신고서번호 ==! */
				 , A.cncl_tp_cd                 /** Code De Type De L'Annulation !== 취소구분코드 ==! */
				 , A.cncl_dgcnt                 /** Nombre De Fois De L'Annulation !== 취소차수 ==! */
				 , A.cncl_emp_id                /** Id De La Personne Annulant !== 취소직원ID ==! */
				 , TO_CHAR(A.cncl_dttm           , 'DD/MM/YYYY') AS cncl_dttm                  /** Date Et Heure De L'Annulation !== 취소일시 ==! */
				 , A.cncl_rsn_cd                /** Code De Motif De L'Annulation !== 취소사유코드 ==! */
				 , A.cncl_cn                    /** Contenu De L'Annulation !== 취소내용 ==! */
				 , A.cncl_infm_yn               /** Annulation Notifiée On !== 취소통보여부 ==! */
				 , (SELECT APRV_PRCS_STTS_CD FROM TB_POTI_APRV WHERE DEL_YN = 'N' AND APRV_ID = A.APRV_ID) AS APRV_PRCS_STTS_CD
				 , A.last_yn                    /** Final On !== 최종여부 ==! */
				 , A.del_yn                     /** Suppression On !== 삭제여부 ==! */
				 , A.frst_regst_id              /** Id Du Premier Enregistrant  !== 최초등록자ID ==! */
				 , TO_CHAR(A.frst_rgsr_dttm      , 'DD/MM/YYYY') AS frst_rgsr_dttm             /** Date Et Heure De Premier Enregistrement !== 최초등록일시 ==! */
				 , A.last_chpr_id               /** Id Du Modificateur Final !== 최종변경자ID ==! */
				 , TO_CHAR(A.last_chg_dttm       , 'DD/MM/YYYY') AS last_chg_dttm              /** Date Et Heure De Modification Finale !== 최종변경일시 ==! */
				 , A.aprv_id                    /** Id D'Approbation  !== 결재 ID ==! */
				 , A.atch_file_id
			FROM  TB_CLRI_DED_CLDL_CLOA A
			   , TB_CLRI_DED_COMN B
			WHERE A.DTL_DCSH_NO = B.DTL_DCSH_NO
			  AND A.DEL_YN = 'N'
			  AND B.DEL_YN = 'N'
			  AND A.LAST_YN = 'Y'
			  AND A.cncl_dgcnt = (
			  	SELECT NVL(MAX(CNCL_DGCNT), 1) as CNCL_DGCNT
    			FROM ALPASSINT.TB_CLRI_DED_CLDL_CLOA e
    			WHERE e.dtl_dcsh_no = A.DTL_DCSH_NO	
    			AND e.DEL_YN = 'N'
    			)
			  AND A.DTL_DCSH_NO = (
					SELECT nvl(dclr_no, reff_no) AS dtl_dcsh_no 
					FROM tb_coli_ntfc c
					WHERE c.ntfc_no = #{ntfcNo}
					AND c.del_yn = 'N'
					AND c.cncl_yn = 'N'
					AND c.reff_no_pt_cd = '002'
					AND c.ntfc_no IN (
						SELECT f.ntfc_no 
						FROM TB_COLI_FINE f 
						WHERE f.del_yn = 'N' 
						AND f.reff_no_pt_cd = c.reff_no_pt_cd
						AND f.reff_no = c.reff_no
						)
					AND c.ntfc_no IN (
						SELECT d.ntfc_no 
						FROM TB_COLI_FINE_BSS d 
						WHERE d.del_yn = 'N' 
						AND d.vltn_cd = 'CNCL'
						)
				)
    </select>
</mapper>
