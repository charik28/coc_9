<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="alpass.ipt.clr.pdr.dre.mapper.ClrDcshPymnMapper">
	<!-- Vérification de la possibilité de remboursement !== 환급 가능여부 체크 ==! -->
	<select id="selectPymnPblsChk" parameterType="alpass.ipt.clr.pdr.dre.vo.ClrDedComnDcshVo" resultType="alpass.ipt.col.drwb.vo.ColDrwbMgmtVo">
		/* selectPymnPblsChk */

	</select>

	<!-- Consultation de l'information de l'émission de l'ordre de paiement !== 지급지시서 발행 정보 조회 ==!  -->
	<select id="selectPymnOrdDtl" parameterType="alpass.ipt.clr.pdr.dre.vo.ClrDedSrchVo" resultType="alpass.ipt.col.drwb.vo.ColDrwbMgmtVo">
		/* selectPymnOrdDtl */
		SELECT
			RQST.DRWB_RQST_NO                 /** N° de demande de remboursement !== 환급신청번호 ==! */
				 , RQST.CSTM_CD                      /** Code du bureau !== 세관코드 ==! */
				 , FN_GET_ORGN_NM(RQST.CSTM_CD) AS CSTM_NM
				 , RQST.ACCT_CD
				 , RQST.PRCS_STTS_CD
				 , RQST.TXPR_IDFY_NO_TP_CD
				 , RQST.TXPR_IDFY_NO                          /** N° de RCCM !== 사업자등록번호 ==! */
				 , RQST.TXPR_NM
				 , RQST.REFF_NO_PT_CD                /** Code de type de numero de reference !== 참조번호유형코드 ==! */
				 , RQST.REFF_NO                      /** N° de reference !== 참조번호 ==! */
				 , RQST.DRWB_RQST_YN                 /** Remboursement demande (ON) !== 환급신청여부 ==! */
				 , TO_CHAR(TO_DATE(RQST.RQST_DT, 'YYYYMMDD'), 'DD/MM/YYYY') AS RQST_DT /** Date de demande !== 신청일자 ==! */
				 , RQST.REPN_ID                      /** ID de la personne demandant !== 신청자ID ==! */
				 , (SELECT EMP_NM FROM TB_POTI_EMP WHERE PBSR_NO = RQST.REPN_ID) AS REPN_NM
				 , RQST.APRV_ID                      /** ID d'approbation  !== 결재ID ==! */
				 , RQST.ATCH_FILE_ID
				 , RQST.RCVE_NO			                /**  !== 영수증번호 ==! */
				 , RCVE.RCVE_AMT			                /**  !== 영수증금액 ==! */
				 , TO_CHAR(TO_DATE(RCVE.RCVE_DT, 'YYYYMMDD'), 'DD/MM/YYYY') AS RCVE_DT /**  !== 영수증일자 ==! */
				 , DRWB.DRWB_NO
				 , RQST.DRWB_DTRM_PT_CD AS DRWB_DTRM_PT_CD
				 , DRWB.RGSR_EMP_ID AS DRWB_RGSR_EMP_ID
				 , (SELECT EMP_NM FROM TB_POTI_EMP WHERE PBSR_NO = DRWB.RGSR_EMP_ID) AS DRWB_RGSR_EMP_NM
				 , RQST.DRWB_AMT AS RQST_DRWB_AMT
				 , DRWB.DRWB_AMT
				 , TO_CHAR(TO_DATE(DRWB.DRWB_DT, 'YYYYMMDD'), 'DD/MM/YYYY') AS DRWB_DT
				 , DRWB.DRWB_RSN_CN
				 , PYMN.PYMN_ORDER_NO
				 , TO_CHAR(TO_DATE(PYMN.PYMN_ORDER_DT, 'YYYYMMDD'), 'DD/MM/YYYY') AS PYMN_ORDER_DT
				 , PYMN.CSTM_CD AS PYMN_CSTM_CD
				 , FN_GET_ORGN_NM(PYMN.CSTM_CD) AS PYMN_CSTM_NM
				 , NVL(RQST.DEPT_CD, PYMN.DEPT_CD) AS DEPT_CD
				 , NVL(DRWB.RGSR_EMP_ID, PYMN.RGSR_EMP_ID) AS PYMN_RGSR_EMP_ID
				 , (SELECT EMP_NM FROM TB_POTI_EMP WHERE PBSR_NO = PYMN.RGSR_EMP_ID) AS PYMN_RGSR_EMP_NM
				 , PYMN.PYMN_AMT
				 , PYMN.ATCH_FILE_ID AS PYMN_ATCH_FILE_ID
		FROM  TB_COLI_DRWB_RQST RQST
				  LEFT JOIN TB_COLI_DRWB DRWB ON DRWB.DEL_YN = 'N' AND RQST.DRWB_RQST_NO = DRWB.DRWB_RQST_NO
				  LEFT JOIN TB_COLI_PYMN_ORDER PYMN ON PYMN.DEL_YN = 'N' AND PYMN.REFF_NO_PT_CD = '018' AND RQST.DRWB_RQST_NO = PYMN.REFF_NO
		   , TB_COLI_RCVE RCVE
		WHERE RQST.DEL_YN = 'N'
		  AND RCVE.DEL_YN = 'N'
		  AND RQST.RCVE_NO = RCVE.RCVE_NO
		  AND RQST.REFF_NO = #{reffNo}
		  ORDER BY PRC_EV_DGCNT DESC LIMIT 1
	</select>

	<insert id="mergeColDrwbRqst" parameterType="alpass.ipt.col.drwb.vo.ColDrwbMgmtVo">
		/* insertColDrwbRqst */
		INSERT INTO TB_COLI_DRWB_RQST (
																		DRWB_RQST_NO
																	<if test="cstmCd != null and cstmCd != ''">
																		, CSTM_CD
																	</if>
																	<if test="deptCd != null and deptCd != ''">
																		, DEPT_CD
																	</if>
																	<if test="acctCd != null and acctCd != ''">
																		, ACCT_CD
																	</if>
																	<if test="rcveNo != null and rcveNo != ''">
																		, RCVE_NO
																	</if>
																	<if test="txprIdfyNoTpCd != null and txprIdfyNoTpCd != ''">
																		, TXPR_IDFY_NO_TP_CD
																	</if>
																	<if test="txprIdfyNo != null and txprIdfyNo != ''">
																		, TXPR_IDFY_NO
																	</if>
																	<if test="txprNm != null and txprNm != ''">
																		, TXPR_NM
																	</if>
																	<if test="reffNoPtCd != null and reffNoPtCd != ''">
																		, REFF_NO_PT_CD
																	</if>
																	<if test="reffNo != null and reffNo != ''">
																		, REFF_NO
																	</if>
																	<if test="drwbRqstYn != null and drwbRqstYn != ''">
																		, DRWB_RQST_YN
																	</if>
																	<if test="rqstDt != null and rqstDt != ''">
																		, RQST_DT
																	</if>
																	<if test="repnId != null and repnId != ''">
																		, REPN_ID
																	</if>
																	<if test="aprvId != null and aprvId != ''">
																		, APRV_ID
																	</if>
																	<if test="atchFileId != null and atchFileId != ''">
																		, ATCH_FILE_ID
																	</if>
																	<if test="prcsSttsCd != null and prcsSttsCd != ''">
																		, PRCS_STTS_CD
																	</if>
																	, DEL_YN
																	<if test="frstRegstId != null and frstRegstId != ''">
																		, FRST_REGST_ID
																		, FRST_RGSR_DTTM
																	</if>
																	<if test="drwbDtrmPtCd != null and drwbDtrmPtCd != ''">
																		, DRWB_DTRM_PT_CD
																	</if>
																	, LAST_CHPR_ID
																	, LAST_CHG_DTTM
		) VALUES (
							 #{drwbRqstNo}
							<if test="cstmCd != null and cstmCd != ''">
								 , #{cstmCd}
							</if>
							<if test="deptCd != null and deptCd != ''">
						 		, #{deptCd}
							</if>
							<if test="acctCd != null and acctCd != ''">
						 		, #{acctCd}
							</if>
							<if test="rcveNo != null and rcveNo != ''">
						 		, #{rcveNo}
							</if>
							<if test="txprIdfyNoTpCd != null and txprIdfyNoTpCd != ''">
								, #{txprIdfyNoTpCd}
							</if>
							<if test="txprIdfyNo != null and txprIdfyNo != ''">
						 		, #{txprIdfyNo}
							</if>
							<if test="txprNm != null and txprNm != ''">
						 		, #{txprNm}
							</if>
							<if test="reffNoPtCd != null and reffNoPtCd != ''">
						 		, #{reffNoPtCd}
							</if>
							<if test="reffNo != null and reffNo != ''">
						 		, #{reffNo}
							</if>
							<if test="drwbRqstYn != null and drwbRqstYn != ''">
						 		, #{drwbRqstYn}
							</if>
							<if test="rqstDt != null and rqstDt != ''">
						 		, TO_CHAR(TO_DATE(#{rqstDt}, 'DD/MM/YYYY'),'YYYYMMDD')
							</if>
							<if test="repnId != null and repnId != ''">
						 		, #{repnId}
							</if>
							<if test="aprvId != null and aprvId != ''">
								, #{aprvId}
							</if>
							<if test="atchFileId != null and atchFileId != ''">
						 		, #{atchFileId}
							</if>
							<if test="prcsSttsCd != null and prcsSttsCd != ''">
						 		, #{prcsSttsCd}
							</if>
						 		, 'N'
							<if test="frstRegstId != null and frstRegstId != ''">
						 		, #{frstRegstId}
								, SYSTIMESTAMP
							</if>
							<if test="drwbDtrmPtCd != null and drwbDtrmPtCd != ''">
								, #{drwbDtrmPtCd}
							</if>
						 , #{lastChprId}
						 , SYSTIMESTAMP
						 )
			ON CONFLICT ( DRWB_RQST_NO )
			DO UPDATE SET
					last_chpr_id = #{lastChprId}
				, last_chg_dttm = SYSTIMESTAMP
			 	<if test="rqstDt != null and rqstDt != ''">
					, RQST_DT = TO_CHAR(TO_DATE(#{rqstDt}, 'DD/MM/YYYY'),'YYYYMMDD')
				</if>
				<if test="cstmCd != null and cstmCd != ''">
					, CSTM_CD = #{cstmCd}
				</if>
				<if test="deptCd != null and deptCd != ''">
					, DEPT_CD = #{deptCd}
				</if>
				<if test="txprIdfyNoTpCd != null and txprIdfyNoTpCd != ''">
					, TXPR_IDFY_NO_TP_CD = #{txprIdfyNoTpCd}
				</if>
				<if test="txprIdfyNo != null and txprIdfyNo != ''">
					,	TXPR_IDFY_NO = #{txprIdfyNo}
				</if>
				<if test="txprNm != null and txprNm != ''">
					, TXPR_NM = #{txprNm}
				</if>
				<if test="reffNoPtCd != null and reffNoPtCd != ''">
					, REFF_NO_PT_CD = #{reffNoPtCd}
				</if>
				<if test="reffNo != null and reffNo != ''">
					, REFF_NO = #{reffNo}
				</if>
				<if test="rcveNo != null and rcveNo != ''">
					, RCVE_NO = #{rcveNo}
				</if>
				<if test="repnId != null and repnId != ''">
					, REPN_ID = #{repnId}
				</if>
				<if test="aprvId != null and aprvId != ''">
					, APRV_ID = #{aprvId}
				</if>
				<if test="prcsSttsCd != null and prcsSttsCd != ''">
					, PRCS_STTS_CD = #{prcsSttsCd}
				</if>
				<if test="delYn != null and delYn != ''">
					, DEL_YN = #{delYn}
				</if>
				<if test="atchFileId != null and atchFileId != ''">
					, ATCH_FILE_ID = #{atchFileId}
				</if>
				<if test="drwbDtrmPtCd != null and drwbDtrmPtCd != ''">
					,DRWB_DTRM_PT_CD = #{drwbDtrmPtCd}
				</if>
	</insert>

	<insert id="mergeColiDrwb" parameterType="alpass.ipt.col.drwb.vo.ColDrwbMgmtVo">
		/* mergeColiDrwb */
		INSERT INTO TB_COLI_DRWB (
															 DRWB_NO
														 , CSTM_CD
														 , DRWB_DTRM_PT_CD
														 , DRWB_RSN_CN
														 , DRWB_RQST_NO
														 , DRWB_AMT
														 , DRWB_DT
														 , ATCH_FILE_ID
														 , RGSR_EMP_ID
														 , DEL_YN
														 , FRST_REGST_ID
														 , FRST_RGSR_DTTM
														 , LAST_CHPR_ID
														 , LAST_CHG_DTTM
		) VALUES (
							 #{drwbNo}
						 , #{cstmCd}
						 , #{drwbDtrmPtCd}
						 , (SELECT FN_GET_CD_VDVAL_NM('COL_0052',#{drwbDtrmPtCd},#{langCd}) FROM DUAL)
						 , #{drwbRqstNo}
						 , #{drwbAmt}
						 , TO_CHAR(CURRENT_DATE,'YYYYMMDD')
						 , #{atchFileId}
						 , #{drwbRgsrEmpId}
						 , 'N'
						 , #{frstRegstId}
						 , SYSTIMESTAMP
						 , #{lastChprId}
						 , SYSTIMESTAMP
						 )
			ON CONFLICT ( DRWB_NO )
			DO UPDATE SET
				last_chpr_id = #{lastChprId}
				, last_chg_dttm = SYSTIMESTAMP
				, DRWB_DT = TO_CHAR(TO_DATE(#{drwbDt}, 'DD/MM/YYYY'),'YYYYMMDD')
				, DRWB_DTRM_PT_CD = #{drwbDtrmPtCd}
				, DRWB_RSN_CN = (SELECT FN_GET_CD_VDVAL_NM('COL_0052',#{drwbDtrmPtCd},#{langCd}) FROM DUAL)
				, RGSR_EMP_ID = #{drwbRgsrEmpId}
				, DRWB_AMT = #{drwbAmt}
				, DEL_YN = NVL(#{delYn},'N')
	</insert>

	<insert id="updateColDrwbRqst" parameterType="alpass.ipt.col.drwb.vo.ColDrwbMgmtVo">
		UPDATE TB_COLI_DRWB_RQST SET
		last_chpr_id = #{lastChprId}
		, last_chg_dttm = SYSTIMESTAMP
		<if test="aprvId != null and aprvId != ''">
			, APRV_ID = #{aprvId}
		</if>
		<if test="prcsSttsCd != null and prcsSttsCd != ''">
			, PRCS_STTS_CD = #{prcsSttsCd}
		</if>
		WHERE DRWB_RQST_NO = #{drwbRqstNo}
	</insert>


	<!-- Consulter les détails de l'avis de paiement !== 고지 상세 조회==! -->
	<select id="selectColNtshInfm" parameterType="alpass.ipt.col.ntsh.vo.ColNtshInfmVo" resultType="alpass.ipt.col.ntsh.vo.ColNtshInfmVo">
		/* selectColNtshInfm */
		SELECT
		NTFC.NTFC_NO                                                      /** N° d'avis !== 고지번호 ==! */
		, NTFC.CSTM_CD                                                      /** Code du bureau !== 세관코드 ==! */
		, FN_GET_ORGN_NM(NTFC.CSTM_CD) AS CSTM_NM
		, NTFC.NTFC_PT_CD                                                   /** Code de type d'avis !== 고지유형코드 ==! */
		, TO_CHAR(TO_DATE(NTFC.NTFC_DT,'YYYYMMDD'),'DD/MM/YYYY') AS NTFC_DT /** Date de notification !== 고지일자 ==! */
		, TO_CHAR(TO_DATE(NTFC.PAY_TMLM_DT,'YYYYMMDD'),'DD/MM/YYYY') AS PAY_TMLM_DT /** Delai de paiement !== 납부기한일자 ==! */
		, NTFC.DLPY_INST_AMT                                                /** Montant des intérêts de retard !== 체납이자금액 ==! */
		, NTFC.ODLPY_INST_AMT                                               /** Montant des intérêts de retard de l'avis original !== 원고지체납이자금액 ==! */
		, NTFC.FINE_AMT                                                     /** Montant d'amende !== 벌금금액 ==! */
		, NTFC.OTHS_PCFE_AMT                                                /** Montant des autres frais exigibles !== 기타수수료금액 ==! */
		, NTFC.TAMT                                                      /** Montant total !== 총금액 ==! */
		, SUM(NTFC.TAMT) over() AS ALL_TAMT																			/** Montant total !== 총금액 ==! 신고서에서 납부한 전체 금액 */
		, NTFC.TXPR_IDFY_NO_TP_CD                                           /** Code de caterogie de NIU !== 납세자식별번호구분코드 ==! */
		, NTFC.TXPR_IDFY_NO                                                 /** NIU !== 납세자식별번호 ==! */
		, NTFC.TXPR_NM                                                      /** Nom du responsable financier !== 납세자명 ==! */
		, NTFC.REFF_NO_PT_CD                                                /** Code de type de numero de reference !== 참조번호유형코드 ==! */
		, NTFC.REFF_NO                                                      /** N° de reference !== 참조번호 ==! */
		, NTFC.DCER_CD                                                      /** Code du declarant !== 신고인코드 ==!*/
		, NTFC.RCVE_YN                                                      /** Encaisse (ON) !== 수납여부 ==! */
		, ( SELECT CD_VDVAL_NM FROM TB_COM_COMN_CD_D_LANG
		WHERE LANG_CD  = NVL(#{langCd},'FR')
		AND   COMN_CD  = 'COM_0016'
		AND   CD_VDVAL = NTFC.RCVE_YN
		) AS RCVE_YN_NM
		, NTFC.PAY_TMLM_XTNS_YN                                             /** Echeance prorogee (ON) !== 납부기한연장여부 ==! */
		, NTFC.DLPY_YN                                                      /** Paiement retarde (ON) !== 체납여부 ==! */
		, NTFC.DLPY_INST_ADJU_YN                                            /** Intérêts De Retard Ajustés (O/N) !== 체납이자조정여부 ==! */
		, NTFC.NTFC_DIVD_YN                                                 /** Avis echelonne (ON) !== 고지분할여부 ==! */
		, NTFC.RECP_PBLS_YN                                                 /** Quittance delivree (ON) !== 영수증발행여부 ==! */
		, NTFC.CNCL_YN                                                      /** Annule (ON) !== 취소여부 ==! */
		, NTFC.ONTFC_NO                                                     /** N° de l'avis original !== 원고지번호 ==! */
		, NTFC.DFPM_PAY_YN                                                  /** Recours au credit d'enlevement (ON) !== 후불납부여부 ==! */
		, NTFC.NTFC_PRCS_STTS_CD                                            /** Code de statut de traitement d'avis !== 고지처리상태코드 ==! */
		, FN_GET_PRCS_STTS_CD_VDVAL_NM('COL_0001', NTFC.NTFC_PRCS_STTS_CD, #{langCd}) AS NTFC_PRCS_STTS_CD_NM /** Code De Statut De Traitement D'Avis !== 고지처리상태코드명 ==! */
		, NTFC.DEL_YN                                                       /** Suppression ON !== 삭제여부 ==! */
		, NTFC.FRST_REGST_ID                                                /** ID du premier enregistrant  !== 최초등록자ID ==! */
		, NTFC.FRST_RGSR_DTTM                                               /** Date et heure de premier enregistrement !== 최초등록일시 ==! */
		, NTFC.LAST_CHPR_ID                                                 /** ID du modificateur final !== 최종변경자ID ==! */
		, NTFC.LAST_CHG_DTTM                                                /** Date et heure de modification finale !== 최종변경일시 ==! */
		, TO_CHAR(TO_DATE(NTFC.CNCL_DT,'YYYYMMDD'),'DD/MM/YYYY') AS CNCL_DT /** Date d'annulation !== 고지취소 신청일자(소멸일자) ==! */
		, TO_CHAR(TO_DATE(RCVE.RCVE_DT,'YYYYMMDD'),'DD/MM/YYYY') AS RCVE_DT /** Date de stockage !== 수납일자 ==! */
		, RCVE.RCVE_PT_CD                                                   /** Code de type d'encaissement !== 수납유형코드 ==! */
		, RCVE.RCVE_NO
		,  CASE WHEN NTFC.DCER_CD IS NOT NULL THEN NTFC.DCER_CD  || ' | ' || (
		SELECT B.CD_VDVAL_NM
		FROM   TB_COM_COMN_CD_D_LANG B
		WHERE  B.DEL_YN = 'N'
		AND    B.COMN_CD LIKE 'COM_0030'
		AND    B.LANG_CD = NVL(#{langCd},'FR')
		AND    B.CD_VDVAL = SUBSTR(NTFC.DCER_CD,0, 1)
		)
		ELSE ''
		END AS DCER_CD_NM
		, NTFC.DEPT_CD
		, NVL(NTFC.PCFE_AMT, 0) AS PCFE_AMT
		FROM  TB_COLI_NTFC NTFC
		LEFT  JOIN TB_COLI_RCVE RCVE           ON RCVE.DEL_YN = 'N' AND NTFC.NTFC_NO = RCVE.NTFC_NO
		WHERE NTFC.DEL_YN  = 'N'
		  AND NTFC.RCVE_YN = 'Y'

		<if test='dclrNo != null and dclrNo != ""'>
			AND   NTFC.DCLR_NO = #{dclrNo}
		</if>

		ORDER BY NTFC.NTFC_NO
		limit 1
	</select>

	<!-- 신고서번호 조회-->
	<select id="selectDtlDcshNo" parameterType="alpass.ipt.clr.pdr.dre.vo.ClrDedSrchVo" resultType="string">
		/* selectDtlDcshNo */
		SELECT REFF_NO                                                      /** N° de reference !== 참조번호 ==! */
		FROM  TB_COLI_DRWB_RQST
		WHERE DRWB_RQST_NO = #{drwbRqstNo}
	</select>


</mapper>