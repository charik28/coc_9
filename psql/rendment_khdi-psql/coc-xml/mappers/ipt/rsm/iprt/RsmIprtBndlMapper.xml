<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "---mybatis.org--DTD Mapper 3.0--EN" "http:--mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="alpass.ipt.rsm.iprt.mapper.RsmIprtBndlMapper">

    <!--
      Supprimer des circuits d'articles en masse !== DED품목채널 일괄 삭제 ==!
    -->
    <delete id="deleteBndlDedPdlsChnl" parameterType="alpass.ipt.rsm.iprt.vo.RsmDedPdlsChnlMgmtVo">
        /* deleteBndlDedPdlsChnl */
        DELETE FROM TB_RSMI_DED_PDLS_CHNL A
        WHERE A.DTL_DCSH_NO = #{dtlDcshNo}       /** Numero du DED !== DED번호 ==! */
        AND A.PDLS_NO = #{pdlsNo}                /** N° D'Article !== 품목번호 ==! */
    </delete>

    <!--
      [Changement du circuit de ciblage] Consulter les détails concernant l'enregistrement par lots !== [선별채널변경] 일괄등록 상세조회  ==!
    -->
    <select id="selectSelcRsltChgBndlRgsr" parameterType="alpass.ipt.rsm.iprt.vo.RsmIprtSearchVo" resultType="alpass.ipt.rsm.com.vo.RsmSelcChgMgmtVo">
        /* selectSelcRsltChgBndlRgsr */
        SELECT A.DTL_DCSH_NO      /* Numero du DED !== DED번호 ==! */
            , A.PDLS_NO           /* N° Article !== 품목번호 ==! */
            , A.CHG_SRNO          /* Ordre du reroutage !== 변경차수 ==! */
            , A.SELC_CHG_TP_CD    /* Historique de circuit  !== 선별변경구분코드  ==! */
            , A.SELC_CHG_CD       /* Code de reroutage du circuit  !== 선별변경코드 ==! */
            , A.SELC_CHG_RSN_CN   /* Description détaillée !== 선별변경구체적사유  ==! */
            , A.SELC_CHG_DT       /* Date du reroutage !== 선별변경일자 ==! */
            , A.APRV_ID           /* ID d'approbation  !== 결재ID ==! */
            , DECODE(A.APRV_ID, NULL, NULL, ( SELECT APRV_PRCS_STTS_CD
                                              FROM TB_POTI_APRV
                                              WHERE DEL_YN = 'N'
                                              AND APRV_ID = A.APRV_ID
                                            )
                    ) AS APRV_PRCS_STTS_CD          /** Code De Statut Du Traitement D'Approbation !== 결재처리상태코드 ==! */
        FROM TB_RSMI_SELC_CHG_MGMT A
        WHERE A.DEL_YN = 'N'
        AND   A.DTL_DCSH_NO  = #{dtlDcshNo}         /** Numero du DED !== DED번호 ==! */
        AND   A.PDLS_NO = #{pdlsNo}                 /** N° D'Article !== 품목번호 ==! */
    </select>

    <!--
    Suivi après l'approbation !== 결재 후속 처리(결재 후속 처리(선별변경일괄등록)) ==!
    -->
    <update id="iprtBndlProcessAprvAfJob" parameterType="alpass.ipt.rsm.com.vo.RsmSelcChgMgmtVo">
        /* iprtBndlProcessAprvAfJob */
        UPDATE TB_RSMI_SELC_CHG_MGMT A
            SET A.APRV_ID     = #{aprvId}                   /** ID d'approbation  !== 결재ID ==! */
        WHERE A.DEL_YN = 'N'
        AND A.DTL_DCSH_NO = #{dtlDcshNo}                    /** Numéro du DED !== DED번호  ==! */
        AND A.PDLS_NO = #{pdlsNo}                           /** N° D'Article !== 품목번호 ==! */
        AND A.CHG_SRNO = ( SELECT MAX(CHG_SRNO)             /** N° De Modification !== 변경일련번호 ==! */
                           FROM TB_RSMI_SELC_CHG_MGMT
                           WHERE DEL_YN = 'N'
                           AND DTL_DCSH_NO = #{dtlDcshNo}
                           AND PDLS_NO = A.PDLS_NO
                         )
    </update>

    <!--
      Consulter les détails en masse sur le circuit reroute !== 선별변경 일괄 상세조회  ==!
    -->
    <select id="selectBndlSelcChgMgmt" parameterType="alpass.ipt.rsm.iprt.vo.RsmComDedDcshSearchVo" resultType="alpass.ipt.rsm.com.vo.RsmSelcChgMgmtVo">
        /* selectBndlSelcChgMgmt */
        SELECT A.DTL_DCSH_NO            /* Numero du DED !== DED번호 ==! */
             , A.PDLS_NO                /* N° Article !== 품목번호 ==! */
             , A.CHG_SRNO               /* Ordre du reroutage !== 변경차수 ==! */
             , A.SELC_CHG_TP_CD         /* Historique de circuit !== 선별변경구분코드 ==! */
             , ( SELECT CD_VDVAL_NM
                 FROM   TB_COM_COMN_CD_D_LANG
                 WHERE  COMN_CD = 'RSM_0015'
                 AND    LANG_CD = #{langCd}
                 AND    CD_VDVAL = A.SELC_CHG_TP_CD
               ) AS SELC_CHG_TP_NM
             , A.SELC_CHG_CD            /* Code de reroutage du circuit  !== 선별변경코드 ==! */
             , ( SELECT CD_VDVAL_NM
                 FROM   TB_COM_COMN_CD_D_LANG
                 WHERE  COMN_CD  = 'RSM_0016'
                 AND    LANG_CD  = #{langCd}
                 AND    CD_VDVAL = A.SELC_CHG_CD
               ) AS SELC_CHG_NM         /** Nom de reroutage du circuit !== 선별변경코드명 ==! */
             , A.SELC_CHG_RSN_CN        /* Description détaillée !== 선별변경구체적사유  ==! */
             , A.SELC_CHG_DT            /* Date du reroutage !== 선별변경일자 ==! */
             , A.APRV_ID                /* ID d'approbation  !== 결재ID ==! */
             , ( SELECT APRV_PRCS_STTS_CD
                 FROM   TB_POTI_APRV CC
                 WHERE  CC.APRV_ID = A.APRV_ID
               ) AS APRV_PRCS_STTS_CD   /* Code de statut du traitement d'approbation  !== 결재처리상태코드  ==! */
        FROM   TB_RSMI_SELC_CHG_MGMT A
        WHERE  A.DEL_YN  = 'N'                  /** Suppression ON !== 삭제여부 ==! */
        AND    A.DTL_DCSH_NO  = #{dtlDcshNo}    /** Numero du DED !== DED번호 ==! */
        ORDER BY A.CHG_SRNO DESC

    </select>

    <!--
      Modification du circuits d'articles (restauration) !== DED품목채널 수정 (원복)  ==!
    -->
    <update id="updateDedPdlsChnl" parameterType="alpass.ipt.rsm.iprt.vo.RsmDedPdlsChnlMgmtVo">
        /* updateDedPdlsChnl */
        UPDATE TB_RSMI_DED_PDLS_CHNL SET
            SELC_RSLT_CD     = #{selcRsltCd}      /* Resultat du ciblage !==선별결과==! */
          , SELC_CHG_YN      = 'N'                /* Circuit rerouté O/N !== 선별변경여부 ==! */
          , LAST_CHPR_ID     = #{lastChprId}      /* ID du modificateur final !== 최종변경자ID ==!*/
          , LAST_CHG_DTTM    = SYSTIMESTAMP       /* Date et heure de modification finale !== 최종변경일시 ==! */
        WHERE DTL_DCSH_NO    = #{dtlDcshNo}       /* Numero du DED !== DED번호 ==! */
        AND PDLS_NO          = #{pdlsNo}          /* N° D'Article !== 품목번호 ==! */
        AND DEL_YN           = 'N'                /* Suppression ON !== 삭제여부 ==! */
    </update>

    <!--
      (Sélection aléatoire vers le scanning) Consulter la liste de numéros d'identification des importateurs visés
      !== (랜덤 스캐닝 검사) 대상 수입자식별번호 목록 조회 ==!
    -->
    <select id="selectTrgtImppnIdfyNoList" parameterType="alpass.ipt.rsm.iprt.vo.ClrDclrAcapVo" resultType="alpass.ipt.rsm.iprt.vo.ClrDclrAcapVo">
        /* selectTrgtImppnIdfyNoList */
        SELECT A.DTL_DCSH_NO        /** Numero du DAU !== 상세신고서번호 ==! */
             , A.DCLR_DT            /** Date de déclaration !== 신고일자 ==! */
             , A.IMPPN_IDFY_NO      /** N° d'identification de l'importateur !== 수입자식별번호 ==! */
        FROM   (
                 SELECT A.DTL_DCSH_NO
                      , A.DCLR_DT
                      , A.PDLS_GCNT
                      , ( SELECT COUNT(1) FROM TB_CLRI_DED_CNTR AA  WHERE AA.DTL_DCSH_NO = A.DTL_DCSH_NO AND AA.DEL_YN ='N') AS CNTR_CNT
                      , A.DCLR_PT_CD
                      , A.EPC_CD
                      , A.WKNG_PT_CD
                      , A.SELC_RSLT_CD
                      , A.IMPPN_IDFY_NO
                      , ( SELECT NIF_STTS_CD FROM TB_POTE_NIF BB WHERE BB.NIF = A.IMPPN_IDFY_NO) AS NIF_STTS_CD
                 FROM   TB_CLRI_DED_COMN A
                 WHERE  DTL_DCSH_NO = #{dtlDcshNo}
               ) A
        WHERE  A.PDLS_GCNT = 1                  /** Nombre D'Articles !== 품목개수 ==! */
        AND    A.CNTR_CNT > 5                   /** Nombre de  conteneur !== 컨테이너 건수  ==! */
        AND    A.NIF_STTS_CD IN ('1','2')       /** Code De Statut NIF !== NIF 상태 ==! */
        AND    A.EPC_CD ='40XX'                 /** Code EPC !== EPC코드 ==! */
        AND    A.WKNG_PT_CD IN ('1','3')        /** Type D'Opération !== 작업유형코드 ==! */
    </select>

    <!--
      Consulter le nombre annuel de conteneurs
      !== 연간 총컨테이너 수 조회 ==!
    -->
    <select id="selectYyTccnt" parameterType="alpass.ipt.rsm.iprt.vo.ClrDclrAcapVo" resultType="int">
        /* selectYyTccnt */
        SELECT COUNT(1) AS CNT      /** Nombre !== 건수 ==! */
        FROM   TB_CLRI_DED_COMN A
        , TB_CLRI_DED_CNTR B
        WHERE  A.IMPPN_IDFY_NO = (          /** N° D'Identification De L'Importateur !== 수입자식별번호 ==! */
            SELECT IMPPN_IDFY_NO
            FROM TB_CLRI_DED_COMN
            WHERE DEL_YN = 'N'
            AND DTL_DCSH_NO = #{dtlDcshNo}
        )
        AND    A.DCLR_DT BETWEEN  TO_CHAR(ADD_MONTHS(SYSDATE, -12), 'YYYYMMDD') AND TO_CHAR(SYSDATE-1, 'YYYYMMDD')                  /** Date de déclaration !== 신고일자 ==! */
        AND    A.DEL_YN ='N'                            /** Suppression ON !== 삭제여부 ==! */
        AND    B.DTL_DCSH_NO = A.DTL_DCSH_NO            /** Numero du DAU !== 상세신고서번호 ==! */
        AND    B.DEL_YN ='N'

    </select>

    <!--
      Consulter le nombre annuel de transactions
      !== 연간 거래 총횟수 조회 ==!
    -->
    <select id="selectYyDlngTncnt" parameterType="alpass.ipt.rsm.iprt.vo.ClrDclrAcapVo" resultType="int">
        /* selectYyDlngTncnt */
        SELECT COUNT(1) AS CNT      /** Nombre !== 건수 ==! */
        FROM   TB_CLRI_DED_COMN A
        WHERE  A.IMPPN_IDFY_NO = (              /** N° D'Identification De L'Importateur !== 수입자식별번호 ==! */
            SELECT IMPPN_IDFY_NO
            FROM TB_CLRI_DED_COMN
            WHERE DEL_YN = 'N'
            AND DTL_DCSH_NO = #{dtlDcshNo}
        )
        AND    A.DCLR_DT BETWEEN  TO_CHAR(ADD_MONTHS(SYSDATE, -12), 'YYYYMMDD') AND TO_CHAR(SYSDATE-1, 'YYYYMMDD')              /** Date de déclaration !== 신고일자 ==! */
    </select>

    <!--
      Consulter le nombre de conteneurs orientés vers le scanning
      !== 랜덤 스캐닝 컨테이너 개수 조회 ==!
    -->
    <select id="selectInscScanCntrCnt" parameterType="alpass.ipt.rsm.iprt.vo.ClrDclrAcapVo" resultType="int">
        /* selectInscScanCntrCnt */
        SELECT COUNT(1) AS CNT      /** Nombre !== 건수 ==! */
        FROM   TB_CLRI_DED_CNTR A
        WHERE  A.DEL_YN = 'N'                       /** Suppression ON !== 삭제여부 ==! */
        AND    A.DTL_DCSH_NO = #{dtlDcshNo}         /** Numero du DAU !== 상세신고서번호 ==! */
        AND    A.INSC_TRGT_YN IS NOT NULL           /** Vérifié les marchandises !== 검사대상여부 ==! */
        AND    A.INSC_TRGT_YN IN ('S','Y')
    </select>

    <!--
      (Sélection aléatoire vers le scanning et le contrôle physique) Consulter la liste des conteneurs visés
      !== (랜덤 스캐닝 검사) 대상 컨테이너 목록 조회 ==!
    -->
    <select id="selectTrgtCntrList" parameterType="alpass.ipt.rsm.iprt.vo.ClrDclrAcapVo" resultType="alpass.ipt.rsm.iprt.vo.ClrDclrAcapCntrVo">
        /* selectTrgtCntrList */
        <![CDATA[
        SELECT
             T.*
            , CASE WHEN T.RNK <= INSC_RT THEN 'Y'
                   WHEN T.RNK > INSC_RT AND T.RNK <= SCN_RT THEN 'S'
              END AS INSC_TRGT_YN           /** Vérifié les marchandises !== 검사 스캔 구분 ==! */
        FROM
        (

            SELECT R.*
                , COUNT(1) OVER() * 0.2 AS INSC_RT      /**  Taux d'inspection !== 검사비율 ==! */
                , COUNT(1) OVER() * 0.4 AS SCN_RT       /** Taux de balayage !== 스캔비율 ==! */
                , DENSE_RANK() OVER(PARTITION BY DTL_DCSH_NO ORDER BY R.RNDM_VAL DESC, R.CNTR_SRNO) AS RNK      /** classement !== 순위 ==! */
            FROM
            (
                SELECT DTL_DCSH_NO              /** Numero de la déclaration en détail !== 상세신고서번호 ==! */
                    , CNTR_SRNO                 /** N° De Séquence Du Conteneur !== 컨테이너일련번호 ==! */
                    , ROUND(DBMS_RANDOM.VALUE() * 100) AS RNDM_VAL      /** Valeur Random !== 랜덤값 ==! */
                FROM TB_CLRI_DED_CNTR
                WHERE DTL_DCSH_NO = #{dtlDcshNo}
                AND   DEL_YN = 'N'
            ) R
        ) T
        WHERE RNK <= SCN_RT
        ]]>
    </select>

    <!--
      Modifier les conteneurs visés (scanning 'S', contrôle physique 'Y')
      !== 컨테이너 검사대상 수정 ( 스캐닝 :: 'S' , 검사 :: 'Y' ) ==!
    -->
    <update id="updateDedCntrInscTrgt" parameterType="alpass.ipt.rsm.iprt.vo.ClrDclrAcapCntrVo">
        /* updateDedCntrInscTrgt */
        UPDATE TB_CLRI_DED_CNTR
        SET INSC_TRGT_YN  = #{inscTrgtYn}           /** Vérifié les marchandises !== 검사대상여부 ==! */
          , LAST_CHPR_ID  = #{lastChprId}           /** ID du modificateur final !== 최종변경자ID ==! */
          , LAST_CHG_DTTM = SYSTIMESTAMP            /** Date et heure de modification finale !== 최종변경일시 ==! */
        WHERE DEL_YN = 'N'                          /** Suppression ON !== 삭제여부 ==! */
        AND DTL_DCSH_NO = #{dtlDcshNo}              /** Numero de la déclaration en détail !== 상세신고서번호 ==! */
        AND CNTR_SRNO = #{cntrSrno}                 /** N° De Séquence Du Conteneur !== 컨테이너일련번호 ==! */

    </update>

</mapper>