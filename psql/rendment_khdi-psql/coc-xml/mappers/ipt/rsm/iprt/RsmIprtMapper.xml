<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "---mybatis.org--DTD Mapper 3.0--EN" "http:--mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="alpass.ipt.rsm.iprt.mapper.RsmIprtMapper">


    <!--
      [Changement du circuit de ciblage] Consulter la liste !== [선별채널변경] 목록조회  ==!
    -->
    <select id="selectSelcRsltChgList" parameterType="alpass.ipt.rsm.iprt.vo.RsmIprtSearchVo" resultType="alpass.ipt.rsm.iprt.vo.RsmIprtResultVo">
        /* selectSelcRsltChgList */
        <include refid="pagination.header" />
        SELECT ROWNUM NO            /* N°  !== 번호 ==! */
             , DECODE(( SELECT COUNT(1) FROM TB_RSMI_SELC_CHG_MGMT S
                        WHERE S.DEL_YN = 'N'
                        AND S.DTL_DCSH_NO = A.DTL_DCSH_NO
                        AND S.APRV_ID IS NOT NULL
                        AND EXISTS ( SELECT 1 FROM TB_POTI_APRV WHERE DEL_YN = 'N' AND APRV_ID = S.APRV_ID AND APRV_PRCS_STTS_CD IN ('I02','I05'))
                       ),0, 'false', 'true') AS CHK_SEL     /** Selectionner O/N !== 선택 여부 ==! */
             , DECODE(( SELECT COUNT(1) FROM TB_RSMI_SELC_CHG_MGMT S
                        WHERE S.DEL_YN = 'N'
                        AND S.DTL_DCSH_NO = A.DTL_DCSH_NO
                       ),0, 'false', 'true') AS READ_SEL    /** en lecture seule ou pas !== ReadOnly 여부 ==! */
             , A.DTL_DCSH_NO        /* Numero du DeD !== DED번호 ==! */
             , A.DCLR_DT            /* Date de DeD !==DED 신고일자==! */
             , A.DCLR_PT_CD         /* Type de forme de DeD !==DED 신고서 유형 ==! */
             , A.CSCL_PLN_CD        /* Code de plan de dedouanement !== 통관계획코드  ==! */
             , A.SELC_RSLT_CD       /* Resultat du ciblage !==선별결과==! */
             , ( SELECT CD_VDVAL_NM FROM 
                 TB_COM_COMN_CD_D_LANG 
                 WHERE COMN_CD = 'RSM_0001' 
                 AND LANG_CD = #{langCd} 
                 AND CD_VDVAL = A.SELC_RSLT_CD
               ) AS SELC_RSLT_NM    /** Nom de resultat de ciblage !== 선별결과 ==!*/
             , ( SELECT DCER_CO_NM
                 FROM   TB_CLRI_DED_CO AA
                 WHERE  AA.DTL_DCSH_NO = A.DTL_DCSH_NO
                ) AS DCER_CO_NM     /* Nom de societe du declarant !== 신고인업체명 ==! */
             , ( SELECT TXPR_CO_NM
                 FROM   TB_CLRI_DED_CO BB
                 WHERE  BB.DTL_DCSH_NO = A.DTL_DCSH_NO
                ) AS TXPR_CO_NM     /* Nom de societe contribuable !== 납세자업체명 ==! */
             , ( SELECT COUNT(1) 
                 FROM   TB_CLRI_DED_VLUT_PDLS AA 
                 WHERE  AA.DTL_DCSH_NO = A.DTL_DCSH_NO 
                 AND    AA.DEL_YN='N'
               ) AS PDLS_GCNT       /* Nombre d'articles !== 품목개수 ==! */
             , A.PRCS_STTS_CD       /* Code de statut de traitement !== 처리상태코드 ==! */
              , ( SELECT DSCL_YN
                  FROM   TB_CLRI_DED_INSC_RSLT DD
                  WHERE  DD.DTL_DCSH_NO = A.DTL_DCSH_NO
                  AND    DD.VIST_INSC_RQST_DGCNT = (SELECT MAX(VIST_INSC_RQST_DGCNT) FROM TB_CLRI_DED_INSC_RSLT WHERE DTL_DCSH_NO = A.DTL_DCSH_NO AND DEL_YN = 'N')
                  AND    DD.DEL_YN = 'N'
                ) AS DSCL_YN        /* Detecte O/N !== 적발여부 ==! */
             , DECODE(( SELECT COUNT(1)
                 FROM   TB_RSMI_SELC_CHG_MGMT CC
                 WHERE  CC.DTL_DCSH_NO = A.DTL_DCSH_NO
                 AND    CC.DEL_YN = 'N'
               ), 0, 'N', 'Y') AS SELC_CHG_YN   /* Circuit reroute O/N !== 선별변경여부 ==! */
              , NVL(( SELECT IPRT_PRCS_STTS_CD
                  FROM   TB_CLRI_DED_INSC_RSLT EE
                  WHERE  EE.DTL_DCSH_NO = A.DTL_DCSH_NO
                  AND    EE.VIST_INSC_RQST_DGCNT = (SELECT MAX(VIST_INSC_RQST_DGCNT) FROM TB_CLRI_DED_INSC_RSLT WHERE DTL_DCSH_NO = A.DTL_DCSH_NO AND DEL_YN = 'N')
                  AND    EE.DEL_YN = 'N'
                ), 'DD4' ) AS IPRT_PRCS_STTS_CD  /* Code de statut de certificat de visite !== 검사결과처리상태코드 ==! */
        FROM   TB_CLRI_DED_COMN A
             , TB_RSMI_DED_SELC B
             , TB_CLRI_DED_PDLS C
        WHERE  A.DEL_YN      = 'N'                      /** Suppression ON !== 삭제여부 ==! */
        <if test='scrnTp == null or "".equals(scrnTp) or scrnTp != "APRV" '>
        AND    A.AUDT_EMP_ID = #{pbsrNo}                /** ID de l'insepcteur !== 심사직원ID ==! */
        </if>
        AND    A.DTL_DCSH_NO = B.DTL_DCSH_NO            /* Numero du DeD !== DED번호 ==! */
        AND    B.DEL_YN      = 'N'                      /** Suppression ON !== 삭제여부 ==! */
        AND    A.PRCS_STTS_CD  IN ( 'D01', 'D02', 'D03', 'D04' )            /** Code De Statut De Traitement !== 처리상태코드 ==! */
        AND    A.DTL_DCSH_NO = C.DTL_DCSH_NO
        AND    C.PDLS_NO = '1'                          /** N° D'Article !== 품목번호 ==! */
        AND    C.DEL_YN = 'N'
        <if test="dtlDcshNo != null and dtlDcshNo != ''"> 
        AND    A.DTL_DCSH_NO = #{dtlDcshNo}   /* Numero du DeD !== DED번호 ==! */
        </if>
        <if test='(dclrStrtDt != null and !"".equals(dclrStrtDt)) and (dclrEndDt != null and !"".equals(dclrEndDt))'> /* Date de DeD !==DED 신고일자==! */
        AND    A.DCLR_DT BETWEEN #{dclrStrtDt} AND #{dclrEndDt}  /* Date de DeD !==DED 신고일자==! */
        </if>
        <if test='dtlDcshNos != null and !"".equals(dtlDcshNos)'>
            <foreach item="dtlDcshNoItem" collection="dtlDcshNos" open="AND A.DTL_DCSH_NO IN (" close=")" separator=",">
                #{dtlDcshNoItem}
            </foreach>
        </if>
        <if test='selcChgYn != null and !"".equals(selcChgYn)'>
        <if test='"Y".equals(selcChgYn)'>
        AND  EXISTS ( SELECT 'X'
                      FROM   TB_RSMI_SELC_CHG_MGMT B
                      WHERE   B.DTL_DCSH_NO = A.DTL_DCSH_NO
                      AND     B.DEL_YN ='N'
                    )
        </if>
        <if test='"N".equals(selcChgYn)'>
        AND  NOT EXISTS ( SELECT 'X'
                          FROM   TB_RSMI_SELC_CHG_MGMT C
                          WHERE   C.DTL_DCSH_NO = A.DTL_DCSH_NO
                          AND     C.DEL_YN ='N'
                        )
        </if>
        </if>
        ORDER BY A.DCLR_DT DESC
        <include refid="pagination.footer" />
    </select>

    <!--
      Consulter les détails de certificat de visite(commun) !== 검사결과 상세조회(공통)  ==!
    -->
    <select id="selectDedInscRslt" parameterType="alpass.ipt.rsm.iprt.vo.RsmIprtSearchVo" resultType="alpass.ipt.rsm.com.vo.RsmDedInscRsltVo">
        /* selectDedInscRslt */
        SELECT
               DISTINCT A.IPRT_PRCS_STTS_CD   /* Code de statut de certificat de visite !== 검사결과처리상태코드 ==!*/
        FROM   TB_CLRI_DED_INSC_RSLT A
        WHERE  A.DTL_DCSH_NO = #{dtlDcshNo}         /* Numero du DeD !== DED번호 ==! */
        AND    A.IPRT_PRCS_STTS_CD = 'DD5'
        AND    A.DEL_YN = 'N'                       /* Suppression ON !== 삭제여부 ==! */
    </select>

    <!--
      Consulter les détails de résultat de reroutage(Final) !== 선별변경 상세조회(최종) ==!
    -->
    <select id="selectMaxSelcChgMgmt" parameterType="alpass.ipt.rsm.iprt.vo.RsmComDedDcshSearchVo" resultType="alpass.ipt.rsm.com.vo.RsmSelcChgMgmtVo">
        /* selectMaxSelcChgMgmt */
        SELECT A.DTL_DCSH_NO       /* Numero du DED !== DED번호 ==! */
             , A.PDLS_NO           /* N° Article !== 품목번호 ==! */
             , A.CHG_SRNO          /* Ordre du reroutage !== 변경차수 ==! */
             , ( SELECT SELC_CHG_TP_CD
                 FROM   TB_RSMI_SELC_CHG_MGMT AA
                 WHERE  AA.DTL_DCSH_NO = A.DTL_DCSH_NO
                 AND    AA.PDLS_NO = A.PDLS_NO
                 AND    AA.DEL_YN = 'N'
                 AND    AA.CHG_SRNO = ( SELECT MAX(BB.CHG_SRNO)
                                        FROM   TB_RSMI_SELC_CHG_MGMT BB
                                        WHERE  BB.DTL_DCSH_NO   = AA.DTL_DCSH_NO
                                        AND    BB.PDLS_NO  = AA.PDLS_NO
                                        AND    BB.DEL_YN   = 'N'
                                        AND    BB.CHG_SRNO <![CDATA[ < ]]> A.CHG_SRNO
                                      )
               ) AS SELC_BFCH_TP_CD     /* Circuit d'auparavant   !== 변경전 선별변경구분코드 ==! */
             , A.SELC_CHG_TP_CD         /* Circuit définitif   !== 변경후 선별변경구분코드 ==! */
             , ( SELECT CD_VDVAL_NM
                 FROM   TB_COM_COMN_CD_D_LANG
                 WHERE  COMN_CD = 'RSM_0015'
                 AND    LANG_CD = #{langCd}
                 AND    CD_VDVAL = A.SELC_CHG_TP_CD
               ) AS SELC_CHG_TP_NM
             , A.SELC_CHG_CD            /* Code de reroutage du circuit    !== 선별변경코드 ==! */
             , ( SELECT CD_VDVAL_NM
                 FROM   TB_COM_COMN_CD_D_LANG
                 WHERE  COMN_CD = 'RSM_0016'
                 AND    LANG_CD = #{langCd}
                 AND    CD_VDVAL = A.SELC_CHG_CD
               ) AS SELC_CHG_NM
             , A.SELC_CHG_RSN_CN        /* Description détaillée !== 선별변경구체적사유  ==! */
             , A.SELC_CHG_DT            /* Date du reroutage !== 선별변경일자 ==! */
             , A.BNDL_APLY_YN
             , A.APRV_ID                /* ID d'approbation  !== 결재ID ==! */
             , ( SELECT APRV_PRCS_STTS_CD
                 FROM   TB_POTI_APRV DD
                 WHERE  DD.APRV_ID = A.APRV_ID
               ) AS APRV_PRCS_STTS_CD   /* Code de statut du traitement d'approbation  !== 결재처리상태코드  ==! */
        FROM   TB_RSMI_SELC_CHG_MGMT A
        WHERE  A.DTL_DCSH_NO  = #{dtlDcshNo}                /* Numero du DED !== DED번호 ==! */
        AND    A.PDLS_NO = #{pdlsNo}                        /* N° D'Article !== 품목번호 ==! */
        AND    A.DEL_YN  = 'N'                              /* Suppression ON !== 삭제여부 ==! */
        AND    A.CHG_SRNO = ( SELECT MAX(CHG_SRNO)          /* N° De Modification !== 변경일련번호 ==! */
                              FROM   TB_RSMI_SELC_CHG_MGMT B
                              WHERE  B.DTL_DCSH_NO = A.DTL_DCSH_NO
                              AND    B.PDLS_NO = A.PDLS_NO
                              AND    B.DEL_YN  = 'N'
                            )
    </select>
    
    
    <!--
      Consulter les détails de résultat de reroutage(historique) !== 선별변경 상세조회(이력)  ==!
    -->
    <select id="selectSelcChgMgmt" parameterType="alpass.ipt.rsm.iprt.vo.RsmComDedDcshSearchVo" resultType="alpass.ipt.rsm.com.vo.RsmSelcChgMgmtVo">
        /* selectSelcChgMgmt */
        SELECT A.DTL_DCSH_NO       /* Numero du DED !== DED번호 ==! */
             , A.PDLS_NO           /* N° Article !== 품목번호 ==! */
             , A.CHG_SRNO          /* Ordre du reroutage !== 변경차수 ==! */
             , A.SELC_CHG_TP_CD    /* 선별변경구분코드   !== Historique de circuit  ==! */
             , ( SELECT CD_VDVAL_NM 
                 FROM   TB_COM_COMN_CD_D_LANG 
                 WHERE  COMN_CD = 'RSM_0015'
                 AND    LANG_CD = #{langCd} 
                 AND    CD_VDVAL = A.SELC_CHG_TP_CD
               ) AS SELC_CHG_TP_NM
             , A.SELC_CHG_CD       /* Code de reroutage du circuit  !== 선별변경코드 ==! */
             , ( SELECT CD_VDVAL_NM 
                 FROM   TB_COM_COMN_CD_D_LANG 
                 WHERE  COMN_CD  = 'RSM_0016' 
                 AND    LANG_CD  = #{langCd} 
                 AND    CD_VDVAL = A.SELC_CHG_CD
               ) AS SELC_CHG_NM
             , A.SELC_CHG_RSN_CN   /* Description détaillée !== 선별변경구체적사유  ==! */
             , A.SELC_CHG_DT       /* Date du reroutage !== 선별변경일자 ==! */
             , A.BNDL_APLY_YN
             , A.APRV_ID           /* ID d'approbation  !== 결재ID ==! */
             , ( SELECT APRV_PRCS_STTS_CD
                 FROM   TB_POTI_APRV CC
                 WHERE  CC.APRV_ID = A.APRV_ID
               ) AS APRV_PRCS_STTS_CD  /* Code de statut du traitement d'approbation  !== 결재처리상태코드  ==! */
             , (SELECT SELC_CHG_YN FROM TB_RSMI_DED_PDLS_CHNL WHERE DEL_YN = 'N' AND DTL_DCSH_NO = A.DTL_DCSH_NO AND PDLS_NO = A.PDLS_NO )  AS SELC_CHG_YN
        FROM   TB_RSMI_SELC_CHG_MGMT A
        WHERE  A.DTL_DCSH_NO  = #{dtlDcshNo}        /* Numero du DED !== DED번호 ==! */
        AND    A.PDLS_NO = #{pdlsNo}                /* N° D'Article !== 품목번호 ==! */
        AND    A.DEL_YN  = 'N'                      /* Suppression ON !== 삭제여부 ==! */
        ORDER BY A.CHG_SRNO DESC

    </select>

    <!--
      Vérifier la présence du code de routage des données !== 선별결과변경 데이터 유무 확인  ==!
    -->
    <select id="selectSelcRsltChg" parameterType="alpass.ipt.rsm.com.vo.RsmSelcChgMgmtVo" resultType="alpass.ipt.rsm.com.vo.RsmSelcChgMgmtVo">
        /* selectSelcRsltChg */
        SELECT A.DTL_DCSH_NO      /* Numero du DED !== DED번호 ==! */
            , A.PDLS_NO           /* N° Article !== 품목번호 ==! */
            , A.CHG_SRNO          /* Ordre du reroutage !== 변경차수 ==! */
            , A.SELC_CHG_TP_CD    /* 선별변경구분코드   !== Historique de circuit  ==! */
            , A.SELC_CHG_CD       /* Code de reroutage du circuit  !== 선별변경코드 ==! */
            , A.SELC_CHG_RSN_CN   /* Description détaillée !== 선별변경구체적사유  ==! */
            , A.SELC_CHG_DT       /* Date du reroutage !== 선별변경일자 ==! */
            , A.APRV_ID           /* ID d'approbation  !== 결재ID ==! */
        FROM TB_RSMI_SELC_CHG_MGMT A
        WHERE A.DTL_DCSH_NO  = #{dtlDcshNo}         /* Numero du DED !== DED번호 ==! */
        AND A.PDLS_NO = #{pdlsNo}                   /* N° D'Article !== 품목번호 ==! */
        AND A.DEL_YN = 'N'                          /* Suppression ON !== 삭제여부 ==! */
    </select>

    <!--
      Supprimer le code du reroutage !== 선별결과변경 삭제 ==!
    -->
    <delete id="deleteSelcRsltChg" parameterType="alpass.ipt.rsm.com.vo.RsmSelcChgMgmtVo" >
        /* deleteSelcRsltChg */
        DELETE FROM TB_RSMI_SELC_CHG_MGMT A
        WHERE A.DTL_DCSH_NO  = #{dtlDcshNo}                 /* Numero du DED !== DED번호 ==! */
        AND A.PDLS_NO = #{pdlsNo}                           /* N° D'Article !== 품목번호 ==! */
        AND A.CHG_SRNO = ( SELECT MAX(CHG_SRNO)             /* N° De Modification !== 변경일련번호 ==! */
                           FROM TB_RSMI_SELC_CHG_MGMT
                           WHERE DEL_YN = 'N'
                           AND DTL_DCSH_NO = #{dtlDcshNo}
                           AND    PDLS_NO = #{pdlsNo}
                          )
    </delete>

    <!--
      Enregistrer l'historique du reroutage !== 선별결과변경 등록  ==!
    -->
    <insert id="insertSelcRsltChg" parameterType="alpass.ipt.rsm.com.vo.RsmSelcChgMgmtVo">
        /* insertSelcRsltChg */
		WITH UPSERT AS (
            UPDATE TB_RSMI_SELC_CHG_MGMT
            SET  SELC_CHG_TP_CD    = #{selcChgTpCd}                                   /* 선별변경구분코드   !== Historique de circuit  ==! */
               , SELC_CHG_CD       = #{selcChgCd}                                     /* Code de reroutage du circuit  !== 선별변경코드 ==! */
               , SELC_CHG_RSN_CN   = #{selcChgRsnCn}                                  /* Description détaillée !== 선별변경구체적사유  ==! */
               , SELC_CHG_DT       = NVL(#{selcChgDt}, TO_CHAR(SYSTIMESTAMP, 'YYYYMMDD'))  /* Date du reroutage !== 선별변경일자 ==! */
               , DEL_YN            = 'N'                                              /* Suppression ON !== 삭제여부 ==!*/
               , LAST_CHPR_ID      = #{lastChprId}                                    /* ID du modificateur final !== 최종변경자ID ==!*/
               , LAST_CHG_DTTM     = SYSTIMESTAMP                                     /* Date et heure de modification finale !== 최종변경일시==!*/
            WHERE DTL_DCSH_NO      = #{dtlDcshNo}                                     /* Numero du DED !== DED번호 ==! */
            RETURNING *
		)
		INSERT INTO TB_RSMI_SELC_CHG_MGMT (
		      DTL_DCSH_NO      /* Numero du DED !== DED번호 ==! */
		    , PDLS_NO          /* N° Article !== 품목번호 ==! */
		    , CHG_SRNO         /* Ordre du reroutage !== 변경차수 ==! */
		    , SELC_CHG_TP_CD   /* 선별변경구분코드   !== Historique de circuit  ==! */
		    , SELC_CHG_CD      /* Code de reroutage du circuit  !== 선별변경코드 ==! */
		    , SELC_CHG_RSN_CN  /* Description détaillée !== 선별변경구체적사유  ==! */
		    , SELC_CHG_DT      /* Date du reroutage !== 선별변경일자 ==! */
            , APRV_ID          /* ID d'approbation  !== 결재ID ==! */
		    , DEL_YN           /* Suppression ON !== 삭제여부==!*/
		    , FRST_REGST_ID    /* ID du premier enregistrant  !== 최초등록자ID ==!*/
		    , FRST_RGSR_DTTM   /* Date et heure de premier enregistrement !== 최초등록일시==!*/
		    , LAST_CHPR_ID     /* ID du modificateur final !== 최종변경자ID ==!*/
		    , LAST_CHG_DTTM    /* Date et heure de modification finale !== 최종변경일시==!*/
		)
		SELECT
		      #{dtlDcshNo}                                     /* Numero du DED !== DED번호 ==! */
		    , #{pdlsNo}                                        /* N° Article !== 품목번호 ==! */
		    , ( SELECT NVL(MAX(CHG_SRNO), 0)+1
			    FROM   TB_RSMI_SELC_CHG_MGMT
			    WHERE  DTL_DCSH_NO = #{dtlDcshNo}
			    AND    PDLS_NO = #{pdlsNo}
		      )                                                /* Ordre du reroutage !== 변경차수 ==! */
		    , #{selcChgTpCd}                                   /* 선별변경구분코드   !== Historique de circuit  ==! */
		    , #{selcChgCd}                                     /* Code de reroutage du circuit  !== 선별변경코드 ==! */
		    , #{selcChgRsnCn}                                  /* Description détaillée !== 선별변경구체적사유  ==! */
		    , NVL(#{selcChgDt}, TO_CHAR(SYSTIMESTAMP, 'YYYYMMDD'))  /* Date du reroutage !== 선별변경일자 ==! */
            , NULL                                             /* ID d'approbation  !== 결재ID ==! */
		    , 'N'                                              /* Suppression ON !== 삭제여부==!*/
		    , #{frstRegstId}                                   /* ID du premier enregistrant  !== 최초등록자ID ==!*/
		    , SYSTIMESTAMP                                     /* Date et heure de premier enregistrement !== 최초등록일시==!*/
		    , #{lastChprId}                                    /* ID du modificateur final !== 최종변경자ID ==!*/
		    , SYSTIMESTAMP                                     /* Date et heure de modification finale !== 최종변경일시==!*/
		WHERE NOT EXISTS (SELECT * FROM UPSERT)
    </insert>
    
    <!--
      Enregistrer l'historique du reroutage !== 선별결과변경 등록 (품목)  ==!
    -->
    <insert id="insertSelcRsltPdlsChg" parameterType="alpass.ipt.rsm.com.vo.RsmSelcChgMgmtVo">
        /* insertSelcRsltPdlsChg */
        INSERT INTO TB_RSMI_SELC_CHG_MGMT (
              DTL_DCSH_NO           /* Numero du DED !== DED번호 ==! */
            , PDLS_NO               /* N° Article !== 품목번호 ==! */
            , CHG_SRNO              /* Ordre du reroutage !== 변경차수 ==! */
            , SELC_CHG_TP_CD        /* Code de type de reroutage !== 선별변경구분코드 ==! */
            , SELC_CHG_CD           /* Code de reroutage du circuit  !== 선별변경코드 ==! */
            , SELC_CHG_RSN_CN       /* Description détaillée !== 선별변경구체적사유  ==! */
            , SELC_CHG_DT           /* Date du reroutage !== 선별변경일자 ==! */
            , APRV_ID               /* ID d'approbation  !== 결재ID ==! */
            , BNDL_APLY_YN          /* Appliquer par traitement par lot ou non !== 일괄적용여부 ==! */
            , DEL_YN                /* Suppression ON !== 삭제여부==!*/
            , FRST_REGST_ID         /* ID du premier enregistrant  !== 최초등록자ID ==!*/
            , FRST_RGSR_DTTM        /* Date et heure de premier enregistrement !== 최초등록일시==!*/
            , LAST_CHPR_ID          /* ID du modificateur final !== 최종변경자ID ==!*/
            , LAST_CHG_DTTM         /* Date et heure de modification finale !== 최종변경일시==!*/
        )
        SELECT
              #{dtlDcshNo}                                     /* Numero du DED !== DED번호 ==! */
            , #{pdlsNo}                                        /* N° Article !== 품목번호 ==! */
            , ( SELECT NVL(MAX(CHG_SRNO), 0)+1
                FROM   TB_RSMI_SELC_CHG_MGMT
                WHERE  DTL_DCSH_NO = #{dtlDcshNo}
                AND    PDLS_NO = #{pdlsNo}
              )                                                /* Ordre du reroutage !== 변경차수 ==! */
            , #{selcChgTpCd}                                   /* Code de type de reroutage !== 선별변경구분코드 ==! */
            , #{selcChgCd}                                     /* Code de reroutage du circuit  !== 선별변경코드 ==! */
            , #{selcChgRsnCn}                                  /* Description détaillée !== 선별변경구체적사유  ==! */
            , NVL(#{selcChgDt}, TO_CHAR(SYSTIMESTAMP, 'YYYYMMDD'))  /* Date du reroutage !== 선별변경일자 ==! */
            , #{aprvId}                                        /* ID d'approbation  !== 결재ID ==! */
            , NVL(#{bndlAplyYn},'N')                           /* Appliquer par traitement par lot ou non !== 일괄적용여부 ==! */
            , 'N'                                              /* Suppression ON !== 삭제여부==!*/
            , #{frstRegstId}                                   /* ID du premier enregistrant  !== 최초등록자ID ==!*/
            , SYSTIMESTAMP                                     /* Date et heure de premier enregistrement !== 최초등록일시==!*/
            , #{lastChprId}                                    /* ID du modificateur final !== 최종변경자ID ==!*/
            , SYSTIMESTAMP                                     /* Date et heure de modification finale !== 최종변경일시==!*/
        ON CONFLICT (DTL_DCSH_NO, PDLS_NO, CHG_SRNO)
        DO UPDATE SET
              SELC_CHG_TP_CD    = #{selcChgTpCd}                                   /* Code de type de reroutage !== 선별변경구분코드 ==! */
            , SELC_CHG_CD       = #{selcChgCd}                                     /* Code de reroutage du circuit  !== 선별변경코드 ==! */
            , SELC_CHG_RSN_CN   = #{selcChgRsnCn}                                  /* Description détaillée !== 선별변경구체적사유  ==! */
            , SELC_CHG_DT       = NVL(#{selcChgDt}, TO_CHAR(SYSTIMESTAMP, 'YYYYMMDD'))  /* Date du reroutage !== 선별변경일자 ==! */
            , BNDL_APLY_YN      = NVL(#{bndlAplyYn},'N')                           /* Appliquer par traitement par lot ou non !== 일괄적용여부 ==! */
            , DEL_YN            = 'N'                                              /* Suppression ON !== 삭제여부 ==!*/
            , LAST_CHPR_ID      = #{lastChprId}                                    /* ID du modificateur final !== 최종변경자ID ==!*/
            , LAST_CHG_DTTM     = SYSTIMESTAMP                                     /* Date et heure de modification finale !== 최종변경일시==!*/
    </insert>

    <!--
      Rerouter le circuit(article) !== DED채널변경(품목) ==!
    -->
    <update id="updateSelcChnlChg" parameterType="alpass.ipt.rsm.iprt.vo.RsmDedPdlsChnlMgmtVo">
        /* updateSelcChnlChg */
		WITH UPSERT AS (
            UPDATE TB_RSMI_DED_PDLS_CHNL SET
                  SELC_RSLT_CD     = #{selcRsltCd}      /* Resultat du ciblage !==선별결과==! */
                , SELC_CHG_YN      = 'Y'                /* Circuit rerouté O/N !== 선별변경여부 ==! */
                , DEL_YN           = 'N'                /* Suppression ON !== 삭제여부 ==! */
                , LAST_CHPR_ID     = #{lastChprId}      /* ID du modificateur final !== 최종변경자ID ==!*/
                , LAST_CHG_DTTM    = SYSTIMESTAMP       /* Date et heure de modification finale !== 최종변경일시 ==! */
            WHERE DTL_DCSH_NO      = #{dtlDcshNo}
              AND PDLS_NO          = #{pdlsNo}
            RETURNING *
		)
		INSERT INTO TB_RSMI_DED_PDLS_CHNL (
			  DTL_DCSH_NO       /* Numero du DED !== DED번호 ==! */
            , PDLS_NO           /* N° d'article !== 품목번호 ==! */
			, SELC_RSLT_CD      /* Resultat du ciblage !==선별결과==! */
			, SELC_CHG_YN       /* Circuit rerouté O/N !== 선별변경여부 ==! */
			, DEL_YN            /* Suppression ON !== 삭제여부==!*/
			, FRST_REGST_ID     /* ID du premier enregistrant  !== 최초등록자ID ==!*/
			, FRST_RGSR_DTTM    /* Date et heure de premier enregistrement !== 최초등록일시 ==!*/
			, LAST_CHPR_ID      /* ID du modificateur final !== 최종변경자ID ==!*/
			, LAST_CHG_DTTM     /* Date et heure de modification finale !== 최종변경일시 ==!*/
		)
		SELECT
			  #{dtlDcshNo}      /* Numero du DED !== DED번호 ==! */
            , #{pdlsNo}         /* N° d'article !== 품목번호 ==! */
			, #{selcRsltCd}     /* Resultat du ciblage !==선별결과==! */
			, 'Y'               /* Circuit rerouté O/N !== 선별변경여부 ==! */
			, 'N'               /* Suppression ON !== 삭제여부==!*/
			, #{frstRegstId}    /* ID du premier enregistrant  !== 최초등록자ID ==! */
			, SYSTIMESTAMP      /* Date et heure de premier enregistrement !== 최초등록일시==! */
			, #{lastChprId}     /* ID du modificateur final !== 최종변경자ID ==! */
			, SYSTIMESTAMP      /* Date et heure de modification finale !== 최종변경일시==! */
		WHERE NOT EXISTS (SELECT * FROM UPSERT)
    </update>

    <!--
      Rerouter le circuit(commun) !== DED채널변경(공통) ==!
    -->
    <update id="updateDedComnSelcChnlChg" parameterType="alpass.ipt.rsm.iprt.vo.RsmDedPdlsChnlMgmtVo">
        /* updateDedComnSelcChnlChg */
        UPDATE TB_CLRI_DED_COMN A
        SET    A.SELC_RSLT_CD  = B.SELC_RSLT_CD     /* Resultat du ciblage !==선별결과==! */
             , A.LAST_CHPR_ID  = #{lastChprId}      /* ID du modificateur final !== 최종변경자ID ==! */
             , A.LAST_CHG_DTTM = SYSTIMESTAMP       /* Date et heure de modification finale !== 최종변경일시==! */
        FROM (
                SELECT SELC_RSLT_CD
                     , DTL_DCSH_NO
                FROM (    SELECT T.DTL_DCSH_NO, T.SELC_RSLT_CD
                          FROM
                          (
                            SELECT A.DTL_DCSH_NO
                                 , A.PDLS_NO
                                 , NVL(B.SELC_RSLT_CD, (SELECT SELC_RSLT_CD FROM TB_RSMI_DED_SELC WHERE DEL_YN = 'N' AND DTL_DCSH_NO = #{dtlDcshNo})) AS SELC_RSLT_CD
                            FROM   TB_CLRI_DED_PDLS A
                                 , TB_RSMI_DED_PDLS_CHNL B
                            WHERE  A.DTL_DCSH_NO = B.DTL_DCSH_NO(+)             /* Numero du DED !== DED번호 ==! */
                            AND A.PDLS_NO = B.PDLS_NO(+)                        /* N° D'Article !== 품목번호 ==! */
                            AND A.DTL_DCSH_NO = #{dtlDcshNo}
                            AND A.DEL_YN = 'N'                                  /* Suppression On !== 삭제여부 ==! */
                            AND B.DEL_YN(+) = 'N'
                          ) T
                          ORDER BY DECODE(T.SELC_RSLT_CD,'R',1,'O',2,'B',3,'G',4) ASC
                  )
                  WHERE ROWNUM = 1
        ) B
        WHERE A.DTL_DCSH_NO = B.DTL_DCSH_NO
        AND   A.DEL_YN = 'N'
    </update>

    <!--
      Supprimer des circuits d'articles !== DED품목채널 삭제 ==!
    -->
    <delete id="deleteDedPdlsChnl" parameterType="alpass.ipt.rsm.iprt.vo.RsmDedPdlsChnlMgmtVo">
        /* deleteDedPdlsChnl */
        DELETE FROM TB_RSMI_DED_PDLS_CHNL A
        WHERE A.DEL_YN = 'N'
        AND A.DTL_DCSH_NO = #{dtlDcshNo}        /* Numero du DED !== DED번호 ==! */
        AND A.PDLS_NO = #{pdlsNo}               /* N° D'Article !== 품목번호 ==! */
    </delete>

    <!--
      Supprimer la gestion du reroutage !== 선별변경관리 삭제 ==!
    -->
    <delete id="deleteSelcChgMgmt" parameterType="alpass.ipt.rsm.com.vo.RsmSelcChgMgmtVo">
        /* deleteSelcChgMgmt */
        DELETE FROM TB_RSMI_SELC_CHG_MGMT A
        WHERE A.DEL_YN = 'N'
        AND A.DTL_DCSH_NO = #{dtlDcshNo}        /* Numero du DED !== DED번호 ==! */
        AND A.PDLS_NO = #{pdlsNo}               /* N° D'Article !== 품목번호 ==! */
    </delete>

    <!--
      Consulter la liste des éléments du code de reroutage !== 선별변경 품목 목록 조회 ==!
    -->
    <select id="selectSelcChgPdlsList" parameterType="alpass.ipt.rsm.iprt.vo.RsmComDedDcshSearchVo"
                  resultType="alpass.ipt.rsm.iprt.vo.RsmIprtSelcChgDedPdlsVo">
        /* selectSelcChgPdlsList */
        SELECT
             A.DTL_DCSH_NO              /** Numero de la déclaration en détail !== 상세신고서번호 ==! */
           , A.PDLS_NO                  /** N° D'Article !== 품목번호 ==! */
           , A.SELC_RSLT_CD             /** Code De Résultat De Ciblage !== 선별결과코드 ==! */
           , A.SELC_CHG_YN              /** Circuit Rerouté O/N !== 선별변경여부 ==! */
           , B.APRV_ID                  /** Id D'Approbation  !== 결재ID ==! */
           , ( SELECT V.APRV_PRCS_STTS_CD
               FROM TB_POTI_APRV V
               WHERE V.DEL_YN = 'N'
               AND V.APRV_ID = B.APRV_ID
             ) AS APRV_STTS_CD          /** Code De Statut Du Traitement D'Approbation !== 결재처리상태코드 ==! */
        FROM TB_RSMI_DED_PDLS_CHNL A
           , TB_RSMI_SELC_CHG_MGMT B
        WHERE A.DEL_YN = 'N'                    /* Suppression ON !== 삭제여부 ==! */
        AND B.DEL_YN = 'N'
        AND A.DTL_DCSH_NO = B.DTL_DCSH_NO       /* Numero du DED !== DED번호 ==! */
        AND A.PDLS_NO = B.PDLS_NO               /* N° D'Article !== 품목번호 ==! */
        AND A.DTL_DCSH_NO = #{dtlDcshNo}
        AND A.SELC_CHG_YN = 'Y'                 /* Circuit Rerouté O/N !== 선별변경여부 ==! */

    </select>

    <!--
      Consulter les éléments du code de reroutage !== 선별변경 품목 조회 ==!
    -->
    <select id="selectSelcChgPdls" parameterType="alpass.ipt.rsm.iprt.vo.RsmComDedDcshSearchVo"
                  resultType="alpass.ipt.rsm.iprt.vo.RsmIprtSelcChgDedPdlsVo">
        /* selectSelcChgPdls */
        SELECT
              A.DTL_DCSH_NO         /** Numero de la déclaration en détail !== 상세신고서번호 ==! */
            , A.PDLS_NO             /** N° D'Article !== 품목번호 ==! */
            , A.SELC_RSLT_CD        /** Code De Résultat De Ciblage !== 선별결과코드 ==! */
            , A.SELC_CHG_YN         /** Circuit Rerouté O/N !== 선별변경여부 ==! */
            , B.APRV_ID             /** Id D'Approbation  !== 결재ID ==! */
            , ( SELECT V.APRV_PRCS_STTS_CD
                FROM TB_POTI_APRV V
                WHERE V.DEL_YN = 'N'
                AND V.APRV_ID = B.APRV_ID
              ) AS APRV_STTS_CD       /** Code De Statut Du Traitement D'Approbation !== 결재처리상태코드 ==! */
        FROM TB_RSMI_DED_PDLS_CHNL A
        , TB_RSMI_SELC_CHG_MGMT B
        WHERE A.DEL_YN = 'N'                        /* Suppression ON !== 삭제여부 ==! */
        AND B.DEL_YN = 'N'
        AND A.DTL_DCSH_NO = B.DTL_DCSH_NO           /* Numero du DED !== DED번호 ==! */
        AND A.PDLS_NO = B.PDLS_NO                   /* N° D'Article !== 품목번호 ==! */
        AND A.DTL_DCSH_NO = #{dtlDcshNo}
        AND A.PDLS_NO = #{pdlsNo}
        AND A.SELC_CHG_YN = 'Y'                     /* Circuit Rerouté O/N !== 선별변경여부 ==! */
    </select>



    
</mapper>