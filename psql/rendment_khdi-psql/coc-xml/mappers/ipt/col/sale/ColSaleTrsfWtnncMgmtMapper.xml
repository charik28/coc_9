<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >

<mapper namespace="alpass.ipt.col.sale.mapper.ColSaleTrsfWtnncMgmtMapper">

    <!--
    Consulter la liste de la gestion du procès-verbal de cession !==양도조서관리목록 조회==!
    -->
    <select id="selectColSaleTrsfWtnncMgmtList" parameterType="alpass.ipt.col.sale.vo.ColSaleTrsfWtnncMgmtVo" resultType="alpass.ipt.col.sale.vo.ColSaleTrsfWtnncMgmtVo">
        /** ColSaleTrsfWtnncMgmtMapper_selectColSaleTrsfWtnncMgmtList **/
        <include refid="pagination.header" />
        SELECT
        TRSF.TRSF_WTNNC_NO
        , TRSF.INVN_MGMT_NO
        , TRSF.PDLS_SRNO
        , TRSF.CSTM_CD
        , FN_GET_ORGN_NM(TRSF.CSTM_CD) AS CSTM_NM								/** Nom Du Bureau !== 세관명 ==! */
        , TRSF.DEPT_CD
        , (SELECT ORGN_NM FROM TB_POTI_ORGN WHERE ORGN_MGMT_CD = UPPER(TRSF.DEPT_CD)) AS DEPT_NM
        , TRSF.REFF_NO_PT_CD
        , TRSF.REFF_NO_PT_TP_NM
        , TRSF.REFF_NO
        , TO_CHAR(TO_DATE(TRSF.REFF_DOC_RGSR_DT,'YYYYMMDD'),'DD/MM/YYYY') AS REFF_DOC_RGSR_DT
        , TRSF.TRSF_PT_CD
        , TRSF.CMDT_NM
        , TRSF.QTY
        , TRSF.PURE_ERN
        , TRSF.RGSR_TRIF
        , TRSF.TAMT
        , TRSF.WORD_AMT_VAL
        , TRSF.TRSF_DTRM_NO
        , TO_CHAR(TO_DATE(TRSF.TRSF_DT,'YYYYMMDD'),'DD/MM/YYYY') AS TRSF_DT
        , TRSF.RECP_NO
        , TO_CHAR(TO_DATE(TRSF.RECP_DT,'YYYYMMDD'),'DD/MM/YYYY') AS RECP_DT
        , TRSF.CLTR_ID
        , TO_CHAR(TO_DATE(TRSF.RGSR_DT,'YYYYMMDD'),'DD/MM/YYYY') AS RGSR_DT
        , TRSF.RMRK_CN
        , TRSF.SCBR_IDFY_NO_TP_CD
        , TRSF.SCBR_IDFY_NO
        , TRSF.SCBR_NM
        , TRSF.ADDR
        , TRSF.ATCH_FILE_ID
        , DTL.LAST_USG_CD
        , TRSF.FRST_REGST_ID								    				/** ID du premier enregistrant !== 최초등록자ID ==! */
        , TRSF.FRST_RGSR_DTTM									    			/** Date et heure de premier enregistrement !== 생성일자 ==! */
        , TRSF.LAST_CHPR_ID														/** ID du modificateur final !== 최종변경자ID ==! */
        , TRSF.LAST_CHG_DTTM													/** Date et heure de modification finale !== 최종변경일시 ==! */
        FROM TB_COLI_TRSF_WTNNC TRSF
        LEFT JOIN TB_COLI_CMDT_INVN_PCDN_DTL DTL ON DTL.INVN_MGMT_NO = TRSF.INVN_MGMT_NO AND DTL.PDLS_SRNO = TRSF.PDLS_SRNO
        WHERE  TRSF.DEL_YN = 'N'
        <if test="sctrCd != null and sctrCd != ''">
            AND  TRSF.CSTM_CD LIKE SUBSTRING(#{sctrCd},1,3) || '%'
        </if>
        <if test="uprOrgnCd != null and uprOrgnCd != ''">
            AND  TRSF.CSTM_CD = #{uprOrgnCd}
        </if>
        <if test="orgnCd != null and orgnCd != ''">
            AND (TRSF.DEPT_CD = #{orgnCd} OR TRSF.DEPT_CD IN (SELECT ORGN_CD FROM TB_POTI_ORGN WHERE (SELECT ACTV_CSTM_CD FROM TB_POTI_ORGN WHERE ORGN_CD = #{orgnCd}) LIKE '%'||ORGN_MGMT_CD||'%')
                                          OR TRSF.DEPT_CD IN (SELECT ORGN_CD FROM TB_POTI_ORGN WHERE ORGN_MGMT_CD IN (SELECT UNNEST(STRING_TO_ARRAY(ACTV_CSTM_CD,'|')) FROM TB_POTI_ORGN WHERE ORGN_MGMT_CD IN (SELECT UNNEST(STRING_TO_ARRAY(ACTV_CSTM_CD,'|')) FROM TB_POTI_ORGN WHERE ORGN_CD = #{orgnCd}))))
        </if>
        <if test='cstmCd != null and cstmCd !="" '>
            AND    TRSF.CSTM_CD = #{cstmCd}
        </if>
        <if test="deptCd != null and deptCd != ''">
            AND (TRSF.DEPT_CD = #{deptCd} OR TRSF.DEPT_CD IN (SELECT ORGN_CD FROM TB_POTI_ORGN WHERE (SELECT ACTV_CSTM_CD FROM TB_POTI_ORGN WHERE ORGN_CD = #{deptCd}) LIKE '%'||ORGN_MGMT_CD||'%')
                                          OR TRSF.DEPT_CD IN (SELECT ORGN_CD FROM TB_POTI_ORGN WHERE ORGN_MGMT_CD IN (SELECT UNNEST(STRING_TO_ARRAY(ACTV_CSTM_CD,'|')) FROM TB_POTI_ORGN WHERE ORGN_MGMT_CD IN (SELECT UNNEST(STRING_TO_ARRAY(ACTV_CSTM_CD,'|')) FROM TB_POTI_ORGN WHERE ORGN_CD = #{deptCd}))
            OR UPR_ORGN_MGMT_CD IN (SELECT UNNEST(STRING_TO_ARRAY(ACTV_CSTM_CD,'|')) FROM TB_POTI_ORGN WHERE ORGN_MGMT_CD IN (SELECT UNNEST(STRING_TO_ARRAY(ACTV_CSTM_CD,'|')) FROM TB_POTI_ORGN WHERE ORGN_CD = #{deptCd}))))
        </if>
        <if test='trsfPtCd != null and trsfPtCd !="" '>
            AND    TRSF.TRSF_PT_CD = #{trsfPtCd}
        </if>
        <if test='rgsrDtFrom != null and rgsrDtFrom !="" and rgsrDtTo != null and rgsrDtTo !="" '>
            AND    TRSF.RGSR_DT BETWEEN TO_CHAR(TO_DATE(#{rgsrDtFrom},'DD/MM/YYYY'),'YYYYMMDD') AND TO_CHAR(TO_DATE(#{rgsrDtTo},'DD/MM/YYYY'),'YYYYMMDD')
        </if>
        ORDER BY TRSF.RGSR_DT desc, TRSF.TRSF_WTNNC_NO ASC
        <include refid="pagination.footer" />
    </select>

    <!--
    Consulter les détails de la gestion du procès-verbal de cession !==양도조서관리상세 조회==!
    -->
    <select id="selectColSaleTrsfWtnncMgmt" parameterType="alpass.ipt.col.sale.vo.ColSaleTrsfWtnncMgmtVo" resultType="alpass.ipt.col.sale.vo.ColSaleTrsfWtnncMgmtVo">
        /** ColSaleTrsfWtnncMgmtMapper_selectColSaleTrsfWtnncMgmt **/
        SELECT
            TRSF.TRSF_WTNNC_NO
            , TRSF.INVN_MGMT_NO
            , TRSF.PDLS_SRNO
            , TRSF.CSTM_CD
            , FN_GET_ORGN_NM(TRSF.CSTM_CD) AS CSTM_NM								/** Nom Du Bureau !== 세관명 ==! */
            , TRSF.DEPT_CD
            , (SELECT ORGN_NM FROM TB_POTI_ORGN WHERE ORGN_MGMT_CD = UPPER(TRSF.DEPT_CD)) AS DEPT_NM
            , TRSF.REFF_NO_PT_CD
            , TRSF.REFF_NO_PT_TP_NM
            , TRSF.REFF_NO
            , TO_CHAR(TO_DATE(TRSF.REFF_DOC_RGSR_DT,'YYYYMMDD'),'DD/MM/YYYY') AS REFF_DOC_RGSR_DT
            , TRSF.TRSF_PT_CD
            , TRSF.CMDT_NM
            , TRSF.QTY
            , TRSF.PURE_ERN
            , TRSF.RGSR_TRIF
            , TRSF.TAMT
            , TRSF.WORD_AMT_VAL
            , TRSF.TRSF_DTRM_NO
            , TO_CHAR(TO_DATE(TRSF.TRSF_DT,'YYYYMMDD'),'DD/MM/YYYY') AS TRSF_DT
            , TRSF.RECP_NO
            , TO_CHAR(TO_DATE(TRSF.RECP_DT,'YYYYMMDD'),'DD/MM/YYYY') AS RECP_DT
            , TRSF.CLTR_ID
            , TO_CHAR(TO_DATE(TRSF.RGSR_DT,'YYYYMMDD'),'DD/MM/YYYY') AS RGSR_DT
            , TRSF.RMRK_CN
            , TRSF.SCBR_IDFY_NO_TP_CD
            , TRSF.SCBR_IDFY_NO
            , TRSF.SCBR_NM
            , TRSF.ADDR
            , TRSF.ATCH_FILE_ID
            , TRSF.FRST_REGST_ID								    				/** ID du premier enregistrant !== 최초등록자ID ==! */
            , TRSF.FRST_RGSR_DTTM									    			/** Date et heure de premier enregistrement !== 생성일자 ==! */
            , TRSF.LAST_CHPR_ID														/** ID du modificateur final !== 최종변경자ID ==! */
            , TRSF.LAST_CHG_DTTM													/** Date et heure de modification finale !== 최종변경일시 ==! */
        FROM TB_COLI_TRSF_WTNNC TRSF
        WHERE  TRSF.DEL_YN = 'N'
        <if test='trsfWtnncNo != null and trsfWtnncNo !="" '>
            AND    TRSF.TRSF_WTNNC_NO = #{trsfWtnncNo}
        </if>
    </select>

    <!--
    Ajouter la gestion du procès-verbal de cession !==양도조서관리 추가==!
    -->
    <insert id="insertColSaleTrsfWtnncMgmt" parameterType="alpass.ipt.col.sale.vo.ColSaleTrsfWtnncMgmtVo">
        /** ColSaleTrsfWtnncMgmtMapper_insertColSaleTrsfWtnncMgmt **/
        INSERT INTO TB_COLI_TRSF_WTNNC (
            TRSF_WTNNC_NO
            , INVN_MGMT_NO
            , PDLS_SRNO
            , CSTM_CD                                                           /** Code du bureau !== 세관코드 ==! */
            , DEPT_CD
            , REFF_NO_PT_CD
            , REFF_NO_PT_TP_NM
            , REFF_NO
            , REFF_DOC_RGSR_DT
            , TRSF_PT_CD
            , CMDT_NM
            , QTY
            , PURE_ERN
            , RGSR_TRIF
            , TAMT
            , WORD_AMT_VAL
            , TRSF_DTRM_NO
            , TRSF_DT
            , RECP_NO
            , RECP_DT
            , CLTR_ID
            , RGSR_DT
            , RMRK_CN
            , SCBR_IDFY_NO_TP_CD
            , SCBR_IDFY_NO
            , SCBR_NM
            , ADDR
            , ATCH_FILE_ID
            , DEL_YN							    						/** Suppression ON !== 삭제여부  ==! */
            , FRST_REGST_ID								    				/** ID du premier enregistrant !== 최초등록자ID ==! */
            , FRST_RGSR_DTTM									    			/** Date et heure de premier enregistrement !== 생성일자 ==! */
            , LAST_CHPR_ID														/** ID du modificateur final !== 최종변경자ID ==! */
            , LAST_CHG_DTTM													/** Date et heure de modification finale !== 최종변경일시 ==! */
        ) VALUES (
            #{trsfWtnncNo}
            , #{invnMgmtNo}
            , #{pdlsSrno}
            , #{cstmCd}
            , #{deptCd}
            , #{reffNoPtCd}
            , #{reffNoPtTpNm}
            , #{reffNo}
            , TO_CHAR(TO_DATE(#{reffDocRgsrDt} , 'DD/MM/YYYY'), 'YYYYMMDD')
            , #{trsfPtCd}
            , #{cmdtNm}
            , #{qty}
            , #{pureErn}
            , #{rgsrTrif}
            , #{tamt}
            , #{wordAmtVal}
            , #{trsfDtrmNo}
            , TO_CHAR(TO_DATE(#{trsfDt} , 'DD/MM/YYYY'), 'YYYYMMDD')
            , #{recpNo}
            , TO_CHAR(TO_DATE(#{recpDt} , 'DD/MM/YYYY'), 'YYYYMMDD')
            , #{cltrId}
            , TO_CHAR(TO_DATE(#{rgsrDt} , 'DD/MM/YYYY'), 'YYYYMMDD')
            , #{rmrkCn}
            , #{scbrIdfyNoTpCd}
            , #{scbrIdfyNo}
            , #{scbrNm}
            , #{addr}
            , #{atchFileId}
            , 'N'
            , #{frstRegstId}
            , SYSTIMESTAMP
            , #{lastChprId}
            , SYSTIMESTAMP
        )
    </insert>

    <!--
    Modifier la gestion du procès-verbal de cession !==양도조서관리 수정==!
    -->
    <update id="updateColSaleTrsfWtnncMgmt" parameterType="alpass.ipt.col.sale.vo.ColSaleTrsfWtnncMgmtVo">
        /** ColSaleTrsfWtnncMgmtMapper_updateColSaleTrsfWtnncMgmt **/
        UPDATE  TB_COLI_TRSF_WTNNC SET
            INVN_MGMT_NO = #{invnMgmtNo}
            , PDLS_SRNO = #{pdlsSrno}
            , REFF_NO_PT_CD = #{reffNoPtCd}
            , REFF_NO_PT_TP_NM = #{reffNoPtTpNm}
            , REFF_NO = #{reffNo}
            , REFF_DOC_RGSR_DT = TO_CHAR(TO_DATE(#{reffDocRgsrDt} , 'DD/MM/YYYY'), 'YYYYMMDD')
            , TRSF_PT_CD = #{trsfPtCd}
            , CMDT_NM = #{cmdtNm}
            , QTY = #{qty}
            , PURE_ERN = #{pureErn}
            , RGSR_TRIF = #{rgsrTrif}
            , TAMT = #{tamt}
            , WORD_AMT_VAL = #{wordAmtVal}
            , TRSF_DTRM_NO = #{trsfDtrmNo}
            , TRSF_DT = TO_CHAR(TO_DATE(#{trsfDt} , 'DD/MM/YYYY'), 'YYYYMMDD')
            , RECP_NO = #{recpNo}
            , RECP_DT = TO_CHAR(TO_DATE(#{recpDt} , 'DD/MM/YYYY'), 'YYYYMMDD')
            , CLTR_ID = #{cltrId}
            , RGSR_DT = TO_CHAR(TO_DATE(#{rgsrDt} , 'DD/MM/YYYY'), 'YYYYMMDD')
            , RMRK_CN = #{rmrkCn}
            , SCBR_IDFY_NO_TP_CD = #{scbrIdfyNoTpCd}
            , SCBR_IDFY_NO = #{scbrIdfyNo}
            , SCBR_NM = #{scbrNm}
            , ADDR = #{addr}
            , LAST_CHPR_ID = #{lastChprId}
            , LAST_CHG_DTTM = SYSTIMESTAMP
        WHERE TRSF_WTNNC_NO = #{trsfWtnncNo}
    </update>

    <!--
    Supprimer la gestion du procès-verbal de cession !==양도조서관리 삭제==!
    -->
    <update id="deleteColSaleTrsfWtnncMgmt" parameterType="alpass.ipt.col.sale.vo.ColSaleTrsfWtnncMgmtVo">
        /** ColSaleTrsfWtnncMgmtMapper_deleteColSaleTrsfWtnncMgmt **/
        UPDATE  TB_COLI_TRSF_WTNNC SET
            DEL_YN = 'Y'
            , LAST_CHPR_ID = #{lastChprId}
            , LAST_CHG_DTTM = SYSTIMESTAMP
        WHERE TRSF_WTNNC_NO = #{trsfWtnncNo}
    </update>

</mapper>