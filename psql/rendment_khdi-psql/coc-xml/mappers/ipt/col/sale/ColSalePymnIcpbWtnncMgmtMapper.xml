<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >

<mapper namespace="alpass.ipt.col.sale.mapper.ColSalePymnIcpbWtnncMgmtMapper">

    <!--
    Consulter la liste de la gestion du procès-verbal de carence !==지불불능조서관리 목록을 조회한다==!
    -->
    <select id="selectColSalePymnIcpbWtnncMgmtList" parameterType="alpass.ipt.col.sale.vo.ColSalePymnIcpbWtnncMgmtVo" resultType="alpass.ipt.col.sale.vo.ColSalePymnIcpbWtnncMgmtVo">
        /** ColSalePymnIcpbWtnncMgmtMapper_selectColSalePymnIcpbWtnncMgmtList **/
        <include refid="pagination.header" />
        SELECT
        PYMN.PYMN_ICPB_WTNNC_NO
        , PYMN.INVN_MGMT_NO
        , PYMN.PDLS_SRNO
        , PYMN.CSTM_CD
        , FN_GET_ORGN_NM(PYMN.CSTM_CD) AS CSTM_NM								/** Nom Du Bureau !== 세관명 ==! */
        , PYMN.DEPT_CD
        , (SELECT ORGN_NM FROM TB_POTI_ORGN WHERE ORGN_MGMT_CD = UPPER(PYMN.DEPT_CD)) AS DEPT_NM
        , PYMN.REFF_NO_PT_CD
        , PYMN.REFF_NO_PT_TP_NM
        , PYMN.REFF_NO
        , PYMN.WTNNC_PT_CD
        , PYMN.PYMN_ICPB_RSN
        , PYMN.CLTR_ID
        , PYMN.TRSF_DTRM_NO
        , TO_CHAR(TO_DATE(PYMN.TRSF_DT,'YYYYMMDD'),'DD/MM/YYYY') AS TRSF_DT
        , TO_CHAR(TO_DATE(PYMN.RGSR_DT,'YYYYMMDD'),'DD/MM/YYYY') AS RGSR_DT
        , PYMN.SCBR_IDFY_NO_TP_CD
        , PYMN.SCBR_IDFY_NO
        , PYMN.SCBR_NM
        , PYMN.ADDR
        , DTL.LAST_USG_CD
        , PYMN.ATCH_FILE_ID
        , PYMN.FRST_REGST_ID								    				/** ID du premier enregistrant !== 최초등록자ID ==! */
        , PYMN.FRST_RGSR_DTTM									    			/** Date et heure de premier enregistrement !== 생성일자 ==! */
        , PYMN.LAST_CHPR_ID														/** ID du modificateur final !== 최종변경자ID ==! */
        , PYMN.LAST_CHG_DTTM													/** Date et heure de modification finale !== 최종변경일시 ==! */
        FROM TB_COLI_PYMN_ICPB_WTNNC PYMN
        LEFT JOIN TB_COLI_CMDT_INVN_PCDN_DTL DTL ON DTL.INVN_MGMT_NO = PYMN.INVN_MGMT_NO AND DTL.PDLS_SRNO = PYMN.PDLS_SRNO
        WHERE  PYMN.DEL_YN = 'N'
        <if test="sctrCd != null and sctrCd != ''">
            AND  PYMN.CSTM_CD LIKE SUBSTRING(#{sctrCd},1,3) || '%'
        </if>
        <if test="uprOrgnCd != null and uprOrgnCd != ''">
            AND  PYMN.CSTM_CD = #{uprOrgnCd}
        </if>
        <if test="orgnCd != null and orgnCd != ''">
            AND (PYMN.DEPT_CD = #{orgnCd} OR PYMN.DEPT_CD IN (SELECT ORGN_CD FROM TB_POTI_ORGN WHERE (SELECT ACTV_CSTM_CD FROM TB_POTI_ORGN WHERE ORGN_CD = #{orgnCd}) LIKE '%'||ORGN_MGMT_CD||'%')
                                          OR PYMN.DEPT_CD IN (SELECT ORGN_CD FROM TB_POTI_ORGN WHERE ORGN_MGMT_CD IN (SELECT UNNEST(STRING_TO_ARRAY(ACTV_CSTM_CD,'|')) FROM TB_POTI_ORGN WHERE ORGN_MGMT_CD IN (SELECT UNNEST(STRING_TO_ARRAY(ACTV_CSTM_CD,'|')) FROM TB_POTI_ORGN WHERE ORGN_CD = #{orgnCd}))))
        </if>
        <if test='cstmCd != null and cstmCd !="" '>
            AND    PYMN.CSTM_CD = #{cstmCd}
        </if>
        <if test="deptCd != null and deptCd != ''">
            AND (PYMN.DEPT_CD = #{deptCd} OR PYMN.DEPT_CD IN (SELECT ORGN_CD FROM TB_POTI_ORGN WHERE (SELECT ACTV_CSTM_CD FROM TB_POTI_ORGN WHERE ORGN_CD = #{deptCd}) LIKE '%'||ORGN_MGMT_CD||'%')
                                          OR PYMN.DEPT_CD IN (SELECT ORGN_CD FROM TB_POTI_ORGN WHERE ORGN_MGMT_CD IN (SELECT UNNEST(STRING_TO_ARRAY(ACTV_CSTM_CD,'|')) FROM TB_POTI_ORGN WHERE ORGN_MGMT_CD IN (SELECT UNNEST(STRING_TO_ARRAY(ACTV_CSTM_CD,'|')) FROM TB_POTI_ORGN WHERE ORGN_CD = #{deptCd}))
            OR UPR_ORGN_MGMT_CD IN (SELECT UNNEST(STRING_TO_ARRAY(ACTV_CSTM_CD,'|')) FROM TB_POTI_ORGN WHERE ORGN_MGMT_CD IN (SELECT UNNEST(STRING_TO_ARRAY(ACTV_CSTM_CD,'|')) FROM TB_POTI_ORGN WHERE ORGN_CD = #{deptCd}))))
        </if>
        <if test='wtnncPtCd != null and wtnncPtCd !="" '>
            AND    PYMN.WTNNC_PT_CD = #{wtnncPtCd}
        </if>
        <if test='rgsrDtFrom != null and rgsrDtFrom !="" and rgsrDtTo != null and rgsrDtTo !="" '>
            AND    PYMN.RGSR_DT BETWEEN TO_CHAR(TO_DATE(#{rgsrDtFrom},'DD/MM/YYYY'),'YYYYMMDD') AND TO_CHAR(TO_DATE(#{rgsrDtTo},'DD/MM/YYYY'),'YYYYMMDD')
        </if>
        ORDER BY PYMN.RGSR_DT desc, PYMN.PYMN_ICPB_WTNNC_NO ASC
        <include refid="pagination.footer" />
    </select>

    <!--
    Consulter les détails de la gestion du procès-verbal de carence !==지불불능조서 상세를 조회한다==!
    -->
    <select id="selectColSalePymnIcpbWtnncMgmt" parameterType="alpass.ipt.col.sale.vo.ColSalePymnIcpbWtnncMgmtVo" resultType="alpass.ipt.col.sale.vo.ColSalePymnIcpbWtnncMgmtVo">
        /** ColSalePymnIcpbWtnncMgmtMapper_selectColSalePymnIcpbWtnncMgmt **/
        SELECT
            PYMN.PYMN_ICPB_WTNNC_NO
            , PYMN.INVN_MGMT_NO
            , PYMN.PDLS_SRNO
            , PYMN.CSTM_CD
            , FN_GET_ORGN_NM(PYMN.CSTM_CD) AS CSTM_NM								/** Nom Du Bureau !== 세관명 ==! */
            , PYMN.DEPT_CD
            , (SELECT ORGN_NM FROM TB_POTI_ORGN WHERE ORGN_MGMT_CD = UPPER(PYMN.DEPT_CD)) AS DEPT_NM
            , PYMN.REFF_NO_PT_CD
            , PYMN.REFF_NO_PT_TP_NM
            , PYMN.REFF_NO
            , PYMN.WTNNC_PT_CD
            , PYMN.PYMN_ICPB_RSN
            , PYMN.CLTR_ID
            , PYMN.TRSF_DTRM_NO
            , TO_CHAR(TO_DATE(PYMN.TRSF_DT,'YYYYMMDD'),'DD/MM/YYYY') AS TRSF_DT
            , TO_CHAR(TO_DATE(PYMN.RGSR_DT,'YYYYMMDD'),'DD/MM/YYYY') AS RGSR_DT
            , PYMN.SCBR_IDFY_NO_TP_CD
            , PYMN.SCBR_IDFY_NO
            , PYMN.SCBR_NM
            , PYMN.ADDR
            , PYMN.ATCH_FILE_ID
            , PYMN.FRST_REGST_ID								    				/** ID du premier enregistrant !== 최초등록자ID ==! */
            , PYMN.FRST_RGSR_DTTM									    			/** Date et heure de premier enregistrement !== 생성일자 ==! */
            , PYMN.LAST_CHPR_ID														/** ID du modificateur final !== 최종변경자ID ==! */
            , PYMN.LAST_CHG_DTTM													/** Date et heure de modification finale !== 최종변경일시 ==! */
        FROM TB_COLI_PYMN_ICPB_WTNNC PYMN
        WHERE  PYMN.DEL_YN = 'N'
        <if test='pymnIcpbWtnncNo != null and pymnIcpbWtnncNo !="" '>
            AND    PYMN.PYMN_ICPB_WTNNC_NO = #{pymnIcpbWtnncNo}
        </if>
    </select>

    <!--
    Ajouter la gestion du procès-verbal de carence !==지불불능조서를 추가한다==!
    -->
    <insert id="insertColSalePymnIcpbWtnncMgmt" parameterType="alpass.ipt.col.sale.vo.ColSalePymnIcpbWtnncMgmtVo">
        /** ColSalePymnIcpbWtnncMgmtMapper_insertColSalePymnIcpbWtnncMgmt **/
        INSERT INTO TB_COLI_PYMN_ICPB_WTNNC (
            PYMN_ICPB_WTNNC_NO
            , INVN_MGMT_NO
            , PDLS_SRNO
            , CSTM_CD                                                           /** Code du bureau !== 세관코드 ==! */
            , DEPT_CD
            , REFF_NO_PT_CD
            , REFF_NO_PT_TP_NM
            , REFF_NO
            , WTNNC_PT_CD
            , PYMN_ICPB_RSN
            , CLTR_ID
            , TRSF_DTRM_NO
            , TRSF_DT
            , RGSR_DT
            , SCBR_IDFY_NO_TP_CD
            , SCBR_IDFY_NO
            , SCBR_NM
            , ADDR
            , ATCH_FILE_ID
            , DEL_YN							    						/** Suppression ON !== 삭제여부  ==! */
            , FRST_REGST_ID								    				/** ID du premier enregistrant !== 최초등록자ID ==! */
            , FRST_RGSR_DTTM									    			/** Date et heure de premier enregistrement !== 생성일자 ==! */
            , LAST_CHPR_ID														/** ID du modificateur final !== 최종변경자ID ==! */
            , LAST_CHG_DTTM													/** Date et heure de modification finale !== 최종변경일시 ==! */
        ) VALUES (
            #{pymnIcpbWtnncNo}
            , #{invnMgmtNo}
            , #{pdlsSrno}
            , #{cstmCd}
            , #{deptCd}
            , #{reffNoPtCd}
            , #{reffNoPtTpNm}
            , #{reffNo}
            , #{wtnncPtCd}
            , #{pymnIcpbRsn}
            , #{cltrId}
            , #{trsfDtrmNo}
            , TO_CHAR(TO_DATE(#{trsfDt} , 'DD/MM/YYYY'), 'YYYYMMDD')
            , TO_CHAR(TO_DATE(#{rgsrDt} , 'DD/MM/YYYY'), 'YYYYMMDD')
            , #{scbrIdfyNoTpCd}
            , #{scbrIdfyNo}
            , #{scbrNm}
            , #{addr}
            , #{atchFileId}
            , 'N'
            , #{frstRegstId}
            , SYSTIMESTAMP
            , #{lastChprId}
            , SYSTIMESTAMP
        )
    </insert>

    <!--
    Modifier la gestion du procès-verbal de carence !==지불불능조서를 수정한다==!
    -->
    <update id="updateColSalePymnIcpbWtnncMgmt" parameterType="alpass.ipt.col.sale.vo.ColSalePymnIcpbWtnncMgmtVo">
        /** ColSalePymnIcpbWtnncMgmtMapper_updateColSalePymnIcpbWtnncMgmt **/
        UPDATE  TB_COLI_PYMN_ICPB_WTNNC SET
            INVN_MGMT_NO = #{invnMgmtNo}
            , PDLS_SRNO = #{pdlsSrno}
            , REFF_NO_PT_CD = #{reffNoPtCd}
            , REFF_NO_PT_TP_NM = #{reffNoPtTpNm}
            , REFF_NO = #{reffNo}
            , WTNNC_PT_CD = #{wtnncPtCd}
            , PYMN_ICPB_RSN = #{pymnIcpbRsn}
            , CLTR_ID = #{cltrId}
            , TRSF_DTRM_NO = #{trsfDtrmNo}
            , TRSF_DT = TO_CHAR(TO_DATE(#{trsfDt} , 'DD/MM/YYYY'), 'YYYYMMDD')
            , RGSR_DT = TO_CHAR(TO_DATE(#{rgsrDt} , 'DD/MM/YYYY'), 'YYYYMMDD')
            , SCBR_IDFY_NO_TP_CD = #{scbrIdfyNoTpCd}
            , SCBR_IDFY_NO = #{scbrIdfyNo}
            , SCBR_NM = #{scbrNm}
            , ADDR = #{addr}
            , ATCH_FILE_ID = #{atchFileId}
            , LAST_CHPR_ID = #{lastChprId}
            , LAST_CHG_DTTM = SYSTIMESTAMP
        WHERE PYMN_ICPB_WTNNC_NO = #{pymnIcpbWtnncNo}
    </update>

    <!--
    Supprimer la gestion du procès-verbal de carence !==지불불능조서를 삭제한다==!
    -->
    <update id="deleteColSalePymnIcpbWtnncMgmt" parameterType="alpass.ipt.col.sale.vo.ColSalePymnIcpbWtnncMgmtVo">
        /** ColSalePymnIcpbWtnncMgmtMapper_deleteColSalePymnIcpbWtnncMgmt **/
        UPDATE  TB_COLI_PYMN_ICPB_WTNNC SET
            DEL_YN = 'Y'
            , LAST_CHPR_ID = #{lastChprId}
            , LAST_CHG_DTTM = SYSTIMESTAMP
        WHERE PYMN_ICPB_WTNNC_NO = #{pymnIcpbWtnncNo}
    </update>

</mapper>