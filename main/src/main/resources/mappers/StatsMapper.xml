<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="dz.coc9.mappers.StatsMapper">

    <!-- 🧩 Filters -->
    <select id="getFilters0" resultType="dz.coc9.vo.brh.StatsFilterDTO">
        SELECT
            ARRAY(SELECT DISTINCT dr FROM rend25.rendement ORDER BY dr) AS drs,
            ARRAY(SELECT DISTINCT idd FROM rend25.rendement ORDER BY idd) AS idds,
            ARRAY(SELECT DISTINCT TO_CHAR(date, 'YYYY-MM') FROM rend25.rendement ORDER BY 1) AS periodes
    </select>

    <select id="getDrFilters" resultType="dz.coc9.vo.brh.StatsFilterDTO">
        SELECT DISTINCT dr
        FROM rend25.rendement
    </select>

    <select id="getIddFilters" resultType="dz.coc9.vo.brh.StatsFilterDTO">
        SELECT DISTINCT dr, idd
        FROM rend25.rendement
    </select>

    <select id="getFilters" resultType="dz.coc9.vo.brh.StatsFilterDTO">
        SELECT DISTINCT dr, idd, TO_CHAR(date, 'YYYY-MM') AS periode
        FROM rend25.rendement
    </select>


    <!-- 🗺️ Map Data -->
    <select id="getMapData" resultType="dz.coc9.vo.brh.StatsMapDTO">
        SELECT
            dr,
            idd,
            wilaya,
            loc_n AS lat,
            loc_e AS lng,
            kif_kg AS kifKg,
            armes_u AS armes,
            tab_kg AS tabacKg,
            carb_l AS carbL,
            date
        FROM rend25.rendement
        WHERE (#{dr} IS NULL OR dr = #{dr})
          AND (#{idd} IS NULL OR idd = #{idd})
          AND (#{periode} IS NULL OR TO_CHAR(date, 'YYYY-MM') = #{periode})
    </select>


    <!-- 📊 Chart Data -->
    <select id="getChartData" resultType="dz.coc9.vo.brh.StatsChartDTO">
        SELECT
            wilaya,
            SUM(kif_kg) AS kifKg,
            SUM(carb_l) AS carbL,
            SUM(tab_kg) AS tabacKg,
            SUM(armes_u) AS armes
        FROM rend25.rendement
        WHERE (#{dr} IS NULL OR dr = #{dr})
          AND (#{idd} IS NULL OR idd = #{idd})
          AND (#{periode} IS NULL OR TO_CHAR(date, 'YYYY-MM') = #{periode})
        GROUP BY wilaya
        ORDER BY wilaya
    </select>


    <!-- ===================================================== -->
    <!--  NEW SECTION FOR DYNAMIC VIEW-BASED ANALYSIS          -->
    <!-- ===================================================== -->
    <select id="selectDynamicStats"
            parameterType="map"
            resultType="dz.coc9.service.dto.DynamicStatsDTO">
        SELECT
        ${selectClause}
        FROM ${viewName}
        <where>
            <if test="filters != null">
                <foreach item="val" index="key" collection="filters" open="" separator="AND" close="">
                    ${key} = #{val}
                </foreach>
            </if>
        </where>
        <if test="orderBy != null">
            ORDER BY ${orderBy}
        </if>
        <if test="limit != null">
            LIMIT #{limit}
        </if>
    </select>

</mapper>
