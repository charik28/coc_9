<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>üåç Vision Spatiale ‚Äì Douane et Lutte contre la Contrebande</title>

  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <style>
    body {
      background-color: #f7f9fc;
      font-family: 'Inter', sans-serif;
    }
    #map {
      width: 100%;
      height: 85vh;
      border-radius: 16px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    .filter-bar select {
      min-width: 150px;
    }
    .leaflet-popup-content {
      font-size: 0.9rem;
      line-height: 1.2rem;
    }
    .legend {
      background: white;
      padding: 10px;
      border-radius: 8px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.2);
      font-size: 0.85rem;
    }
    .legend i {
      width: 16px;
      height: 16px;
      display: inline-block;
      margin-right: 6px;
      border-radius: 3px;
    }
  </style>
</head>

<body>
<div class="container-fluid py-3">
  <div class="d-flex flex-wrap justify-content-between align-items-center mb-3">
    <h4 class="fw-bold mb-2">üåç Vision Spatiale ‚Äì Activit√© des Brigades</h4>
    <div class="d-flex gap-2 filter-bar">
      <select id="filterView" class="form-select form-select-sm">
        <option value="rend25.vw_spatial_summary">Vue Spatiale</option>
        <option value="rend25.vw_monthly_trends">Tendances Mensuelles</option>
      </select>
      <select id="filterDr" class="form-select form-select-sm">
        <option value="">DR (toutes)</option>
      </select>
      <select id="filterIdd" class="form-select form-select-sm">
        <option value="">IDD (tous)</option>
      </select>
      <button class="btn btn-primary btn-sm" onclick="reloadMap()">Actualiser</button>
    </div>
  </div>

  <div id="map"></div>
</div>

<script>
  let map;
  let markersLayer;

  async function fetchFilters() {
    // Simulated filter data (replace later with /api/stats/filters)
    const mock = {
      drs: ["Est", "Centre", "Ouest", "Sud"],
      idds: ["IDD-01", "IDD-02", "IDD-03", "IDD-04"]
    };
    const drSel = document.getElementById('filterDr');
    const iddSel = document.getElementById('filterIdd');
    mock.drs.forEach(dr => drSel.innerHTML += `<option value="${dr}">${dr}</option>`);
    mock.idds.forEach(idd => iddSel.innerHTML += `<option value="${idd}">${idd}</option>`);
  }

  async function fetchMapData(view, filters) {
    // Simulated API response (replace later with /api/stats/map)
    const mockData = Array.from({ length: 40 }, (_, i) => ({
      dr: ["Est", "Ouest", "Centre", "Sud"][Math.floor(Math.random() * 4)],
      idd: "IDD-" + String(Math.floor(Math.random() * 4) + 1).padStart(2, '0'),
      wilaya: "Wilaya " + (Math.floor(Math.random() * 48) + 1),
      lat: 35 + Math.random() * 5,
      lng: 1 + Math.random() * 7,
      kifKg: (Math.random() * 20).toFixed(2),
      carbL: (Math.random() * 500).toFixed(1),
      armes: Math.floor(Math.random() * 10),
      tabacKg: (Math.random() * 50).toFixed(1),
      date: "2025-0" + (1 + Math.floor(Math.random() * 9)) + "-12"
    }));
    return mockData;
  }

  function getIcon(category) {
    const colors = {
      kif: "green",
      armes: "red",
      carburant: "orange",
      tabac: "brown"
    };
    const color = colors[category] || "blue";
    return L.divIcon({
      className: "custom-icon",
      html: `<div style="
          background:${color};
          width:14px;
          height:14px;
          border-radius:50%;
          border:2px solid white;
          box-shadow:0 0 4px rgba(0,0,0,0.3);
        "></div>`,
      iconSize: [16, 16]
    });
  }

  function renderMap(data) {
    if (markersLayer) markersLayer.clearLayers();
    markersLayer = L.layerGroup();

    data.forEach(d => {
      let iconType = d.kifKg > 5 ? 'kif' : d.armes > 0 ? 'armes' : d.carbL > 200 ? 'carburant' : 'tabac';
      const marker = L.marker([d.lat, d.lng], { icon: getIcon(iconType) });
      marker.bindPopup(`
          <b>${d.wilaya}</b><br>
          <small>${d.dr} - ${d.idd}</small><br>
          <hr class="my-1">
          Kif: ${d.kifKg} kg<br>
          Carburant: ${d.carbL} L<br>
          Armes: ${d.armes}<br>
          Tabac: ${d.tabacKg} kg<br>
          <small>${d.date}</small>
        `);
      markersLayer.addLayer(marker);
    });

    markersLayer.addTo(map);
  }

  async function reloadMap() {
    const view = document.getElementById('filterView').value;
    const dr = document.getElementById('filterDr').value;
    const idd = document.getElementById('filterIdd').value;

    const filters = {};
    if (dr) filters.dr = dr;
    if (idd) filters.idd = idd;

    const data = await fetchMapData(view, filters);
    renderMap(data);
  }

  function initMap() {
    map = L.map('map').setView([35.8, 3.2], 6);

    // ‚öôÔ∏è Base layer (can be local or OSM)
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 14,
      attribution: '¬© OpenStreetMap'
    }).addTo(map);

    // üß≠ Legend
    const legend = L.control({ position: 'bottomright' });
    legend.onAdd = function () {
      const div = L.DomUtil.create('div', 'legend');
      div.innerHTML = `
          <div><i style="background:green"></i> Kif & Stup√©fiants</div>
          <div><i style="background:red"></i> Armes</div>
          <div><i style="background:orange"></i> Carburants</div>
          <div><i style="background:brown"></i> Tabac</div>
        `;
      return div;
    };
    legend.addTo(map);
  }

  // init
  initMap();
  fetchFilters().then(reloadMap);
</script>
</body>
</html>
