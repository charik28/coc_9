<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ðŸ“Š Tableau Analytique â€“ Douane et Lutte contre la Contrebande</title>

  <!-- Bootstrap 5 -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    body {
      background-color: #f7f9fc;
      font-family: 'Inter', sans-serif;
    }
    .card {
      border-radius: 16px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.08);
    }
    .filter-bar select {
      min-width: 150px;
    }
    canvas {
      max-height: 400px;
    }
  </style>
</head>

<body>
<div class="container-fluid py-3">
  <div class="d-flex flex-wrap justify-content-between align-items-center mb-3">
    <h4 class="fw-bold mb-2">ðŸ“ˆ Tableau de Bord Analytique</h4>
    <div class="d-flex gap-2 filter-bar">
      <select id="filterView" class="form-select form-select-sm">
        <option value="rend25.vw_monthly_trends">Tendances Mensuelles</option>
        <option value="rend25.vw_goods_summary">Produits Saisis</option>
        <option value="rend25.vw_regional_summary">RÃ©gional</option>
      </select>

      <select id="filterDr" class="form-select form-select-sm">
        <option value="">DR (toutes)</option>
      </select>

      <select id="filterIdd" class="form-select form-select-sm">
        <option value="">IDD (tous)</option>
      </select>

      <select id="chartType" class="form-select form-select-sm">
        <option value="bar">Histogramme</option>
        <option value="line">Courbe</option>
        <option value="pie">Camembert</option>
        <option value="radar">Radar</option>
      </select>

      <button class="btn btn-primary btn-sm" onclick="reloadChart()">Actualiser</button>
    </div>
  </div>

  <div class="card p-3">
    <canvas id="mainChart"></canvas>
  </div>
</div>

<script>
  let chartInstance = null;

  async function fetchFilters() {
    // Simulate API call to /api/stats/filters
    const mock = {
      drs: ["Est", "Centre", "Ouest", "Sud"],
      idds: ["IDD-01", "IDD-02", "IDD-03", "IDD-04"]
    };
    const drSel = document.getElementById('filterDr');
    const iddSel = document.getElementById('filterIdd');
    mock.drs.forEach(dr => drSel.innerHTML += `<option value="${dr}">${dr}</option>`);
    mock.idds.forEach(idd => iddSel.innerHTML += `<option value="${idd}">${idd}</option>`);
  }

  async function loadDynamicStats(view, filters, labelKey, valueKey) {
    const params = new URLSearchParams({
      view,
      select: `${labelKey} as label, sum(${valueKey}) as value`,
      orderBy: labelKey
    });
    for (const [k, v] of Object.entries(filters)) {
      if (v) params.append(`filters[${k}]`, v);
    }

    if(typeof PROFILE_OFFLINE==='undefined' || !PROFILE_OFFLINE) {
      const res = await fetch(`/api/stats/map?view=${view}&dr=${dr || ''}&idd=${idd || ''}`);
      return await res.json();

    }
    else{

      // Simulated data (replace with actual fetch in real API)
      const mockData = [
        {label: "Janv 2025", value: Math.random() * 100},
        {label: "FÃ©vr 2025", value: Math.random() * 100},
        {label: "Mars 2025", value: Math.random() * 100},
        {label: "Avr 2025", value: Math.random() * 100},
        {label: "Mai 2025", value: Math.random() * 100}
      ];
      return mockData;
    }

    // Uncomment when backend is active:
    // const res = await fetch(`/api/stats/dynamic?${params.toString()}`);
    // return await res.json();
  }

  async function reloadChart() {
    const view = document.getElementById('filterView').value;
    const dr = document.getElementById('filterDr').value;
    const idd = document.getElementById('filterIdd').value;
    const chartType = document.getElementById('chartType').value;

    const filters = {};
    if (dr) filters.dr = dr;
    if (idd) filters.idd = idd;

    let labelKey = 'periode';
    let valueKey = 'kifKg';
    if (view.includes('goods')) valueKey = 'tabacKg';
    if (view.includes('regional')) labelKey = 'wilaya';

    const data = await loadDynamicStats(view, filters, labelKey, valueKey);

    const ctx = document.getElementById('mainChart').getContext('2d');
    if (chartInstance) chartInstance.destroy();

    chartInstance = new Chart(ctx, {
      type: chartType,
      data: {
        labels: data.map(d => d.label),
        datasets: [{
          label: `${valueKey}`,
          data: data.map(d => d.value),
          borderWidth: 2,
          fill: true
        }]
      },
      options: {
        responsive: true,
        plugins: {
          legend: { display: true },
          tooltip: { mode: 'index' }
        },
        scales: chartType !== 'pie' ? {
          y: { beginAtZero: true }
        } : {}
      }
    });
  }

  // init
  fetchFilters().then(reloadChart);
</script>
</body>
</html>
