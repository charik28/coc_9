<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="alpass.ipt.pot.pm.co.mapper.PotPmCoUserApreMapper">

     <!-- 
         Consulter la liste des demandes d'inscription des utilisateurs entreprise autorisées !==업체사용자 승인 목록 조회==!
     -->
    <select id="selectUserApreCoList" parameterType="alpass.ipt.pot.pm.co.vo.PotPmCoCouserVo" resultType="alpass.ipt.pot.pm.co.vo.PotPmCoCoVo">
        /** selectUserApreCoList */
      WITH USER_LIST AS (
          SELECT
                 RANK() OVER (PARTITION BY NIF ORDER BY FRST_RGSR_DTTM DESC, USER_ID DESC) AS RN
                ,USER_ID
                ,NIF
                ,USER_TP_CD
                ,USER_NM
                ,USER_FMNM
                ,INHB_RGSR_NO
                ,TLPH_NO
                ,GNDR_CD
                ,USER_ADDR
                ,EML
                ,NAT_CD
                ,PSPR_NO
                ,EML_RCPN_YN
                ,SMS_RCPN_YN
                ,FRST_RGSR_DTTM
          FROM TB_COM_CO_USER
          WHERE DEL_YN          = 'N'      -- 삭제여부
          AND USER_TP_CD        = 'R'      -- COM_0031: 업체사용자구분코드 (E:직원,M:대표위임자,R:대표)
          AND USE_YN            = 'Y'      -- 사용여부
          AND USER_STTS_CD NOT IN ('03')   -- COM_0061: 사용자처리상태코드(01:승인, 02거절:, 03:대기)
      )
      <include refid="pagination.header"/>
      SELECT
      CASE
      WHEN (SUBSTRING(AAA.NIF, 1, 1) = '0' OR SUBSTRING(AAA.NIF, 1, 1) = '1' OR SUBSTRING(AAA.NIF,
      1, 1) = '2') AND SUBSTRING(AAA.NIF, 19, 20) = '00' THEN 'P'
      WHEN (SUBSTRING(AAA.NIF, 1, 1) != '0' AND SUBSTRING(AAA.NIF, 1, 1) != '1') AND
      SUBSTRING(AAA.NIF, 16, 20) = '00000' THEN 'P'
      ELSE 'C'
      END CO_TP_CD
      ,AAA.NIF -- NIF
      ,AAA.CO_NM -- 업체명
      ,AAA.USER_NM -- 대표자명
      ,AAA.USER_FMNM -- 대표자명
      ,AAA.STTS_TP_CD -- 업체상태(COM_0029: 업체상태코드 (01:정상, 02:중지, 03:해지))
      ,AAA.REQST_CNT -- 요청건수(대기자수)
      ,AAA.FRST_RGSR_DTTM
      FROM (
      SELECT
      BB.CO_TP_CD
      , BB.NIF
      , BB.CO_NM
      , AA.USER_NM
      , AA.USER_FMNM
      , BB.STTS_TP_CD
      , CC.CNT AS REQST_CNT2
      , DD.CNT AS REQST_CNT
      , TO_CHAR(BB.FRST_RGSR_DTTM,'DD/MM/YYYY HH24:MI:SS') AS FRST_RGSR_DTTM
      FROM USER_LIST AA
      LEFT OUTER JOIN (SELECT * FROM TB_COM_CO WHERE DEL_YN = 'N' AND STTS_TP_CD = '01') BB ON
      (AA.NIF = BB.NIF)
      LEFT OUTER JOIN (
      SELECT
      NIF, COUNT(*) AS CNT
      FROM TB_COM_CO_USER P
      WHERE P.DEL_YN = 'N'
      <if
        test="searchKeywordFrom != null and searchKeywordFrom != '' and searchKeywordTo != null and searchKeywordTo != '' ">
        AND TO_CHAR(P.FRST_RGSR_DTTM,'YYYYMMDD') BETWEEN TO_CHAR (TO_DATE( #{searchKeywordFrom} ,
        'DD/MM/YYYY'), 'YYYYMMDD')
        AND TO_CHAR(TO_DATE( #{searchKeywordTo} , 'DD/MM/YYYY'), 'YYYYMMDD')
      </if>
      <if test="srchUserSttsCd != null and srchUserSttsCd != ''">
        AND P.USER_STTS_CD = #{srchUserSttsCd}
      </if>
      <if test="srchUserId != null and srchUserId != ''">
        AND UPPER(P.USER_ID) LIKE '%'|| UPPER(#{srchUserId}) ||'%'
      </if>
      <if test="srchUserNm != null and srchUserNm != ''">
        AND UPPER(P.USER_NM) LIKE '%'|| UPPER(#{srchUserNm}) ||'%'
      </if>
      GROUP BY NIF
      ) CC ON (AA.NIF = CC.NIF)
      LEFT OUTER JOIN (
      SELECT
      NIF, COUNT(*) AS CNT
      FROM TB_COM_CO_USER V
      WHERE V.DEL_YN = 'N'
      <if
        test="searchKeywordFrom != null and searchKeywordFrom != '' and searchKeywordTo != null and searchKeywordTo != '' ">
        AND TO_CHAR(V.FRST_RGSR_DTTM,'YYYYMMDD') BETWEEN TO_CHAR (TO_DATE( #{searchKeywordFrom} ,
        'DD/MM/YYYY'), 'YYYYMMDD')
        AND TO_CHAR(TO_DATE( #{searchKeywordTo} , 'DD/MM/YYYY'), 'YYYYMMDD')
      </if>
      AND V.USER_STTS_CD = '03'
      GROUP BY NIF
      ) DD ON (AA.NIF = DD.NIF)
      WHERE AA.NIF IS NOT NULL
      AND AA.RN = 1
      AND BB.STTS_TP_CD <![CDATA[<>]]> '03' -- COM_0029: 업체상태코드 (01:정상, 02:중지, 03:해지)
      <if test="srchNif != null and srchNif != ''">
        AND UPPER(BB.NIF) LIKE '%'|| UPPER(#{srchNif}) ||'%'
      </if>
      <if test="srchCoNm != null and srchCoNm != ''">
        AND UPPER(BB.CO_NM) LIKE '%'||UPPER(#{srchCoNm})||'%'
      </if>
      <if test="!isAllListAuth">
        AND BB.SBMT_CSTM IN (SELECT ORGN_MGMT_CD FROM TB_POTI_ORGN WHERE UPR_ORGN_MGMT_CD = (SELECT
        HSRK_ORGN_MGMT_CD FROM TB_POTI_ORGN WHERE ORGN_MGMT_CD = #{searchSbmtCstm}))
      </if>
      )AAA
      WHERE 1=1
      AND AAA.REQST_CNT2 <![CDATA[>]]> 0
      ORDER BY AAA.FRST_RGSR_DTTM DESC
      <include refid="pagination.footer"/>
    </select>

    <!--
         Consulter les détails des utilisateurs entreprise !==업체사용자 상세 조회==!
     -->
    <select id="selectCoUser" parameterType="alpass.ipt.pot.pm.co.vo.PotPmCoCouserVo" resultType="alpass.ipt.pot.pm.co.vo.PotPmCoCouserVo">
        /** selectCoUser */
        SELECT
              A.USER_ID
            , A.NIF
            , A.USER_TP_CD
            , A.USER_NM
            , CASE WHEN A.NAT_CD IS NULL OR A.NAT_CD = FN_GET_PARAM('DMSC_CNTY_CD')
                   THEN 'Y'
                   ELSE 'N'
                END AS NATV_YN
            , A.INHB_RGSR_NO
            , A.TLPH_NO
            , A.GNDR_CD
            , A.USER_ADDR
            , A.EML
            , A.NAT_CD
            , (SELECT Y.CNTY_NM
                 FROM TB_COM_CNTY_CD X, TB_COM_CNTY_CD_LANG Y
                WHERE X.CNTY_CD = Y.CNTY_CD
                  AND X.DEL_YN = 'N'
                  AND Y.DEL_YN = 'N'
                  AND Y.LANG_CD =  #{langCd} /**P*/
                  AND Y.CNTY_CD = A.NAT_CD ) AS NAT_NM
            , A.PSPR_NO
            , A.EML_RCPN_YN
            , A.SMS_RCPN_YN
      , A.DEL_YN
      , A.FRST_REGST_ID
      , TO_CHAR(A.FRST_RGSR_DTTM,'DD/MM/YYYY HH24:MI:SS') AS FRST_RGSR_DTTM
      , A.LAST_CHPR_ID
      , TO_CHAR(A.LAST_CHG_DTTM,'DD/MM/YYYY HH24:MI:SS') AS LAST_CHG_DTTM
      , A.USER_STTS_CD
      , A.ATCH_FILE_ID
      , A.RTRN_RSN_CN
      , A.USE_YN
      , A.NIN
      , A.PHRM_SRNO
      , A.PHRM_ACTV_DTRM_DT
      , A.PHRM_APPR_ATCH_FILE_ID
      FROM TB_COM_CO_USER A
      WHERE A.DEL_YN = 'N'
      AND A.USER_ID = #{srchUserId}
      <if test="srchNif != null and srchNif != ''">
        AND A.NIF = #{srchNif}
        </if>
        <if test="srchUserTpCd != null and srchUserTpCd != ''">
            AND A.USER_TP_CD = #{srchUserTpCd}
        </if>
    </select>

     <!--
         Consulter les détails des entreprises(id) !==업체정보 조회(id)==!
     -->
    <select id="selectCoByUserId" parameterType="alpass.ipt.pot.pm.co.vo.PotPmCoCouserVo" resultType="alpass.ipt.pot.pm.co.vo.PotPmCoCoVo">
        /** selectCoByUserId */
        SELECT
              A.NIF
            , A.RCCM_NO
            , A.NAFN_TP_CD
            , NVL(A.CO_TP_CD,'C') AS CO_TP_CD
            , A.CO_NM
            , A.STTS_TP_CD
            , A.STTS_CHG_RSN_CN
            , A.RPRS_TLPH_NO
            , A.RPRS_FAX_NO
            , A.RPRS_EML
            , A.CO_ADDR
            , A.LTTD
            , A.LNGT
            , TO_CHAR(A.ACAP_DTTM,'DD/MM/YYYY') AS ACAP_DTTM
            , NVL(A.RQST_TP_CD,'01') AS RQST_TP_CD
            , A.PRCS_STTS_CD
            , A.DEL_YN
            , A.FRST_REGST_ID
            , TO_CHAR(A.FRST_RGSR_DTTM,'DD/MM/YYYY HH24:MI:SS') AS FRST_RGSR_DTTM
            , A.LAST_CHPR_ID
            , TO_CHAR(A.LAST_CHG_DTTM,'DD/MM/YYYY HH24:MI:SS') AS LAST_CHG_DTTM
            , A.ORGN_MGMT_CD
            , (SELECT ORGN_NM FROM TB_POTI_ORGN WHERE ORGN_MGMT_CD =A.ORGN_MGMT_CD) AS ORGN_NM
            , A.ATCH_FILE_ID
            , B.USER_ID
            , B.USER_TP_CD
            , B.USER_NM
            , CASE WHEN B.NAT_CD IS NULL OR B.NAT_CD = FN_GET_PARAM('DMSC_CNTY_CD')
                   THEN 'Y'
                   ELSE 'N'
                END AS NATV_YN
            , B.INHB_RGSR_NO
            , B.TLPH_NO
            , B.GNDR_CD
            , B.USER_ADDR
            , B.EML
            , B.NAT_CD
            , B.PSPR_NO
            , B.EML_RCPN_YN
            , B.SMS_RCPN_YN
            , CASE WHEN A.NIF IS NULL OR USER_ID = #{userId}
                   THEN 'Y'
                   ELSE 'N'
               END               AS IS_RPPN
        FROM TB_COM_CO A
            ,(
               SELECT
                     CASE WHEN NIF IS NOT NULL
                          THEN RANK() OVER (PARTITION BY NIF ORDER BY FRST_RGSR_DTTM DESC, USER_ID DESC)
                          ELSE 1
                      END AS RN
                    ,USER_ID
                    ,NIF
                    ,USER_TP_CD
                    ,USER_NM
                    ,INHB_RGSR_NO
                    ,TLPH_NO
                    ,GNDR_CD
                    ,USER_ADDR
                    ,EML
                    ,NAT_CD
                    ,PSPR_NO
                    ,EML_RCPN_YN
                    ,SMS_RCPN_YN
               FROM TB_COM_CO_USER
               WHERE DEL_YN = 'N'
               AND USER_TP_CD = 'R'
             ) B
        WHERE A.DEL_YN(+)    = 'N'
        AND A.NIF(+)         = B.NIF
        AND 1                 = B.RN
        AND A.NIF = (SELECT T.NIF FROM TB_COM_CO_USER T WHERE T.DEL_YN = 'N' AND T.USER_ID = #{userId} )
    </select>

    <!--
         Consulter les informations de représentant !==대표자 정보 조회==!
     -->
    <select id="selectCoRppnList" parameterType="alpass.ipt.pot.pm.co.vo.PotPmCoCouserVo" resultType="alpass.ipt.pot.pm.co.vo.PotPmCoCouserVo">
        /** selectCoRppnList */
        SELECT
              USER_ID
            , NIF
            , USER_TP_CD
            , USER_NM
            , INHB_RGSR_NO
            , TLPH_NO
            , GNDR_CD
            , USER_ADDR
            , EML
            , NAT_CD
            , PSPR_NO
            , EML_RCPN_YN
            , SMS_RCPN_YN
            , DEL_YN
            , FRST_REGST_ID
            , FRST_RGSR_DTTM
            , LAST_CHPR_ID
            , LAST_CHG_DTTM
            , USER_STTS_CD
            , ATCH_FILE_ID
            , RTRN_RSN_CN
            , USE_YN
            , LEAV_RSN_CN
            , (SELECT RPRS_EML FROM TB_COM_CO WHERE DEL_YN = 'N' AND NIF = A.NIF) AS RPRS_EML
            , (SELECT RPRS_TLPH_NO FROM TB_COM_CO WHERE DEL_YN = 'N' AND NIF = A.NIF) AS RPRS_TLPH_NO
          FROM TB_COM_CO_USER A
         WHERE DEL_YN = 'N'
           AND NIF = #{nif}
           AND USER_TP_CD IN ('M','R')
           AND USE_YN = 'Y'
         ORDER BY USER_TP_CD DESC,FRST_RGSR_DTTM
    </select>

    <!--
         Enregistrer un compte du utilisateur entreprise !==사용자 계정 등록==!
     -->
    <update id="insertUserAcct" parameterType="alpass.ipt.pot.pm.co.vo.PotPmCoCouseracctVo">
        /** insertUserAcct */
        with upsert as
        (
            UPDATE TB_COM_USER_ACCT SET
                    PWD = #{pwd}                                /** Mot de passe !== 비밀번호 ==! */
                    , PWD_CHG_DT = #{pwdChgDt}                    /** Date de modification du mot de passe !== 비밀번호변경일자 ==! */
                    , PWD_INTZ_YN = #{pwdIntzYn}                  /** Initialisation du mot de passe ON !== 비밀번호초기화여부 ==! */
                    , PWD_FAIL_NCNT = 0                           /** Nombre d'essais infructueux du mot de passe !== 비밀번호실패횟수 ==! */
                    , ACCT_LCKED_YN = 'N'                         /** Blocage du compte ON !== 계정잠김여부 ==! */
                    , ACCT_LCKED_RSN_CD = #{acctLckedRsnCd}       /** Code de motif de blocage du compte !== 계정잠김사유코드 ==! */
                    , ACCT_LCKED_DT = #{acctLckedDt}              /** Date de blocage du compte !== 계정잠김일자 ==! */
                    , ACCT_LCKED_RELE_DT = #{acctLckedReleDt}     /** Date d'annulation du blocage du compte !== 계정잠김해제일자 ==! */
                    , ACCT_PUSE_YN = #{acctPuseYn}                /** Suspension du compte ON !== 계정일시정지여부 ==! */
                    , ACCT_PUSE_RSN_CD = #{acctPuseRsnCd}         /** Code de motif de suspension du compte !== 계정일시정지사유코드 ==! */
                    , ACCT_PUSE_STRT_DT = #{acctPuseStrtDt}       /** Date de debut de suspension du compte !== 계정일시정지시작일자 ==! */
                    , ACCT_PUSE_END_DT = #{acctPuseEndDt}         /** Date de fin de suspension du compte  !== 계정일시정지종료일자 ==! */
                    , USER_IP = '127.0.0.1'                       /** @TODO : 번역필요 !== 사용자IP ==! */
                    , USER_CLSF_CD = #{userClsfCd}
                    , ADIT_CRTF_CD = #{aditCrtfCd}
                    , DEL_YN = 'N'
                    , FRST_REGST_ID = #{userId}
                    , FRST_RGSR_DTTM = SYSTIMESTAMP
                    , LAST_CHPR_ID = #{userId}                    /** ID du modificateur final !== 최종변경자ID ==! */
                    , LAST_CHG_DTTM = SYSTIMESTAMP                /** Date et heure de modification finale !== 최종변경일시 ==! */
            WHERE USER_ID = #{userId}
            returning *
        )
        INSERT INTO TB_COM_USER_ACCT
        (
                USER_ID
                , PWD
                , PWD_CHG_DT
                , PWD_INTZ_YN
                , PWD_FAIL_NCNT
                , ACCT_LCKED_YN
                , ACCT_LCKED_RSN_CD
                , ACCT_LCKED_DT
                , ACCT_LCKED_RELE_DT
                , ACCT_PUSE_YN
                , ACCT_PUSE_RSN_CD
                , ACCT_PUSE_STRT_DT
                , ACCT_PUSE_END_DT
                , USER_IP
                , FRST_LGN_YN
                , USER_CLSF_CD
                , ADIT_CRTF_CD
                , DEL_YN
                , FRST_REGST_ID
                , FRST_RGSR_DTTM
                , LAST_CHPR_ID
                , LAST_CHG_DTTM
        )
        SELECT
                #{userId}
                , #{pwd}
                , #{pwdChgDt}
                , #{pwdIntzYn}
                , 0
                , 'N'
                , #{acctLckedRsnCd}
                , #{acctLckedDt}
                , #{acctLckedReleDt}
                , #{acctPuseYn}
                , #{acctPuseRsnCd}
                , #{acctPuseStrtDt}
                , #{acctPuseEndDt}
                , '127.0.0.1'
                , 'Y'
                , #{userClsfCd}
                , #{aditCrtfCd}
                , 'N'
                , #{userId}
                , SYSTIMESTAMP
                , #{userId}
                , SYSTIMESTAMP
        WHERE NOT exists(select * from upsert)
    </update>

    <!--
         Supprimer un rôle de l'utilisateur entreprise !==사용자 기본권한역할 삭제==!
     -->
    <delete id="deleteUserBscsRoleAuth" parameterType="alpass.ipt.pot.pm.co.vo.PotPmCoCouserauthVo">
        /** deleteUserBscsRoleAuth */
        DELETE FROM TB_COM_CO_USER_AUTH
        WHERE USER_ID = #{userId}
          AND ROLE_ID IN
              (
                  SELECT ROLE_ID FROM TB_COM_ROLE
                  WHERE ROLE_PT_CD IN ('01', '02') /** 기본 권한, 직책 권한 */
              )
    </delete>

     <!--
         Consulter une liste de rôles !==역할 목록 조회==!
     -->
    <select id="selectComRoleList" parameterType="alpass.ipt.pot.pm.co.vo.PotPmCoComRoleVo" resultType="alpass.ipt.pot.pm.co.vo.PotPmCoComRoleVo">
        /** selectComRoleList */
            SELECT
                  A.ROLE_ID                    /** ID de role  !== 역할ID ==! */
                , A.APP_CLSF_CD                /** Code de classification des programmes d'appli !== 응용분류코드 ==! */
                , A.BSOP_CLSF_CD               /** Code de domaine de travail !== 업무분류코드 ==! */
                , (SELECT L.ROLE_NM
                     FROM TB_COM_ROLE_LANG L
                    WHERE L.ROLE_ID = A.ROLE_ID
                      AND L.DEL_YN = 'N'
                      AND L.LANG_CD = #{langCd}
                  )        AS ROLE_NM             /** Nom du role  !== 역할명 ==! */
                , A.ROLE_DESC                  /** Description de role  !== 역할설명 ==! */
                , A.USE_YN                     /** Utilise ON !== 사용여부 ==! */
                , A.DEL_YN                     /** Suppression ON !== 삭제여부 ==! */
                , A.FRST_REGST_ID              /** ID du premier enregistrant  !== 최초등록자ID ==! */
                , A.FRST_RGSR_DTTM             /** Date et heure de premier enregistrement !== 최초등록일시 ==! */
                , A.LAST_CHPR_ID               /** ID du modificateur final !== 최종변경자ID ==! */
                , A.LAST_CHG_DTTM              /** Date et heure de modification finale !== 최종변경일시 ==! */
                , A.ROLE_PT_CD
                , A.ROLE_USER_TP_CD
                , A.CO_DCLR_TP_CD              /** @TODO : 번역필요 !== 업체신고유형코드 ==! */
                , A.ITT_TP_CD                  /** @TODO : 번역필요 !== 기관구분코드 ==! */
                , A.ITT_CD
            FROM TB_COM_ROLE A
           WHERE A.DEL_YN = 'N'
            AND A.APP_CLSF_CD = 'EPT'
            AND A.ROLE_ID NOT IN ('POT098', 'POT101', 'POT103', 'POT104', 'POT105', 'POT093') <!-- 관세사 위임 승인 권한 및 은행 관련 역할은 적용하지 않는다.-->
            <if test="coDclrTpCd != null and coDclrTpCd != ''">
            AND A.CO_DCLR_TP_CD = #{coDclrTpCd}
            </if>
    </select>

     <!--
         Enregistrer des rôles un utilisateur entreprise !==사용자 역할 등록==!
     -->
    <update id="insertCoUserAuth" parameterType="alpass.ipt.pot.pm.co.vo.PotPmCoCouserauthVo">
        /** insertCoUserAuth */
        INSERT INTO TB_COM_CO_USER_AUTH
        (
              NIF                          /** N° de RCCM !== 사업자등록번호 ==! */
            , ROLE_ID                      /** ID de role  !== 역할ID ==! */
            , USER_ID                      /** ID d'utilisateur !== 사용자ID ==! */
            , USE_YN                       /** Utilise ON !== 사용여부 ==! */
            , DEL_YN                       /** Suppression ON !== 삭제여부 ==! */
            , FRST_REGST_ID                /** ID du premier enregistrant  !== 최초등록자ID ==! */
            , FRST_RGSR_DTTM               /** Date et heure de premier enregistrement !== 최초등록일시 ==! */
            , LAST_CHPR_ID                 /** ID du modificateur final !== 최종변경자ID ==! */
            , LAST_CHG_DTTM                /** Date et heure de modification finale !== 최종변경일시 ==! */
        )
            VALUES
        (
              #{nif}                       /** N° de RCCM !== 사업자등록번호 ==! */
            , #{roleId}                    /** ID de role  !== 역할ID ==! */
            , #{userId}                    /** ID d'utilisateur !== 사용자ID ==! */
            , 'Y'                          /** Utilise ON !== 사용여부 ==! */
            , 'N'                          /** Suppression ON !== 삭제여부 ==! */
            , #{frstRegstId}               /** ID du premier enregistrant  !== 최초등록자ID ==! */
            , SYSTIMESTAMP                 /** Date et heure de premier enregistrement !== 최초등록일시 ==! */
            , #{lastChprId}                /** ID du modificateur final !== 최종변경자ID ==! */
            , SYSTIMESTAMP                 /** Date et heure de modification finale !== 최종변경일시 ==! */
        )
    </update>

    <!--
         Consulter la liste des codes d'activité des entreprises !==업체신고코드 목록 조회==!
     -->
    <select id="selectCoDclrCdList" parameterType="alpass.ipt.pot.pm.co.vo.PotPmCoCodclrcdVo" resultType="alpass.ipt.pot.pm.co.vo.PotPmCoCodclrcdVo">
        /** selectCoDclrCdList */
        <if test="fullSrchYn == null or fullSrchYn == ''">
             <include refid="pagination.header"/>
        </if>
        SELECT
              A.NIF
            , A.CO_DCLR_TP_CD
            , A.CO_DCLR_CD
            , A.BF_CO_DCLR_CD
            , A.CARR_CD
            , A.RQST_TP_CD
            , A.PRCS_STTS_CD
            , A.DEL_YN
            , A.FRST_REGST_ID
            , TO_CHAR(A.FRST_RGSR_DTTM,'DD/MM/YYYY HH24:MI:SS') AS FRST_RGSR_DTTM
            , A.LAST_CHPR_ID
            , TO_CHAR(A.LAST_CHG_DTTM,'DD/MM/YYYY HH24:MI:SS') AS LAST_CHG_DTTM
            , A.USE_YN
            , TO_CHAR(A.ACAP_DTTM,'DD/MM/YYYY') AS ACAP_DTTM
            , A.CO_DCLR_CD_NM
            , A.ATCH_FILE_ID
            , B.CO_NM
            , B.STTS_TP_CD
            , B.STTS_CHG_RSN_CN
            , B.RPRS_TLPH_NO
            , B.RPRS_FAX_NO
            , B.RPRS_EML
            , B.CO_ADDR
            , C.USER_ID
            , C.USER_TP_CD
            , C.USER_NM
            , CASE WHEN C.NAT_CD IS NULL OR C.NAT_CD = FN_GET_PARAM('DMSC_CNTY_CD')
                   THEN 'Y'
                   ELSE 'N'
                END AS NATV_YN
            , C.INHB_RGSR_NO
            , C.TLPH_NO
            , C.GNDR_CD
            , C.USER_ADDR
      , C.EML
      , C.NAT_CD
      , C.PSPR_NO
      , C.EML_RCPN_YN
      , C.SMS_RCPN_YN
      , NVL(D.STTS_TP_CD, '') AS ORI_WRKR_STTS_TP_CD
      , NVL(D.STTS_TP_CD, '') AS WRKR_STTS_TP_CD
      , D.STTS_CHG_RSN_CN AS WRKR_STTS_CHG_RSN_CN
      , D.WRKR_DTTM
      , D.WRKR_ID
      , A.APPR_QLFC_CD
      , A.APPR_TP_CD
      , A.APPR_CHRC_CD
      , A.DOFO_CN
      FROM TB_COM_CO_DCLR_CD A
      , TB_COM_CO B
      ,(
      SELECT
      RANK() OVER (PARTITION BY NIF ORDER BY FRST_RGSR_DTTM DESC, USER_ID DESC) AS RN
      ,USER_ID
      ,NIF
      ,USER_TP_CD
      ,USER_NM
      ,INHB_RGSR_NO
                    ,TLPH_NO
                    ,GNDR_CD
                    ,USER_ADDR
                    ,EML
                    ,NAT_CD
                    ,PSPR_NO
                    ,EML_RCPN_YN
                    ,SMS_RCPN_YN
               FROM TB_COM_CO_USER
               WHERE DEL_YN   = 'N'
               AND USER_TP_CD = 'R'
               AND USE_YN = 'Y'
               AND USER_STTS_CD NOT IN ('03')
             ) C
           ,(
               SELECT
                     RANK() OVER (PARTITION BY NIF ORDER BY CHG_SRNO DESC) AS RN
                    ,NIF
                    ,CO_DCLR_CD
                    ,CHG_SRNO
                    ,STTS_TP_CD
                    ,STTS_CHG_RSN_CN
                    ,WRKR_ID
                    ,WRKR_DTTM
               FROM TB_COM_CO_DCLR_CD_STTS_H
               WHERE DEL_YN   = 'N'
            ) D
        WHERE A.DEL_YN = 'N'
          AND A.NIF = B.NIF (+)
          AND A.NIF = C.NIF (+)
          AND A.NIF = D.NIF (+)
          AND 1     = C.RN  (+)
          AND 1     = D.RN  (+)
          AND A.NIF = #{srchNif}
        <if test="searchKeywordFrom != null and searchKeywordFrom != '' and searchKeywordTo != null and searchKeywordTo != '' ">
            AND TO_CHAR(A.FRST_RGSR_DTTM,'YYYYMMDD')
                BETWEEN TO_CHAR(TO_DATE( #{searchKeywordFrom} , 'DD/MM/YYYY'), 'YYYYMMDD')
                    AND TO_CHAR(TO_DATE( #{searchKeywordTo}   , 'DD/MM/YYYY'), 'YYYYMMDD')
        </if>
        <if test="srchPrcsSttsCd != null and srchPrcsSttsCd != ''">
            AND A.PRCS_STTS_CD = #{srchPrcsSttsCd}
        </if>
        <if test="srchCoDclrTpCd != null and srchCoDclrTpCd != ''">
            AND A.CO_DCLR_TP_CD = #{srchCoDclrTpCd}
        </if>
        <if test="srchCoNm != null and srchCoNm != ''">
            AND B.CO_NM = #{srchCoNm}
        </if>
        ORDER BY A.CO_DCLR_CD, A.FRST_RGSR_DTTM
        <if test="fullSrchYn == null or fullSrchYn == ''">
           <include refid="pagination.footer"/>
        </if>
    </select>

    <!--
         Enregistrer une relation utilisateur code de réclamation !==업체신고코드사용자관계 등록==!
     -->
    <insert id="insertCoDclrCdUserRel" parameterType="alpass.ipt.pot.pm.co.vo.PotPmCoCodclrcduserrelVo" >
        /** insertCoDclrCdUserRel */
        with upsert as
        (
            UPDATE TB_COM_CO_DCLR_CD_USER_REL SET
                    DEL_YN = 'N'
                    , FRST_REGST_ID = #{frstRegstId}
                    , FRST_RGSR_DTTM = SYSTIMESTAMP
                    , LAST_CHPR_ID = #{lastChprId}
                    , LAST_CHG_DTTM = SYSTIMESTAMP
            WHERE NIF            = #{nif}
            AND CO_DCLR_CD    = #{coDclrCd}
            AND USER_ID         = #{userId}
            returning *
        )
        INSERT INTO TB_COM_CO_DCLR_CD_USER_REL
        (
                NIF
                ,CO_DCLR_CD
                ,USER_ID
                ,DEL_YN
                ,FRST_REGST_ID
                ,FRST_RGSR_DTTM
                ,LAST_CHPR_ID
                ,LAST_CHG_DTTM
        )
        SELECT
                #{nif}
                , #{coDclrCd}
                , #{userId}
                , 'N'
                , #{frstRegstId}
                , SYSTIMESTAMP
                , #{lastChprId}
                , SYSTIMESTAMP
        WHERE NOT exists(select * from upsert)
    </insert>

     <!--
         Enregistrer l'approbation(renvoi) des utilisateurs entreprise !==업체사용자 (승인/반려) 등록==!
     -->
    <update id="updateCoUserApre" parameterType="alpass.ipt.pot.pm.co.vo.PotPmCoCouserVo" >
        /** updateCoUserApre */
        UPDATE TB_COM_CO_USER SET
              USER_STTS_CD        = #{userSttsCd}
            , RTRN_RSN_CN        = #{rtrnRsnCn}
            , USE_YN            = #{useYn}
            , DEL_YN            = #{delYn}
            , LAST_CHPR_ID        = #{lastChprId}
            , LAST_CHG_DTTM        = SYSTIMESTAMP
        WHERE DEL_YN = 'N'
          AND USER_ID = #{userId}
    </update>

    <!--
         Consulter les détails des utilisateurs entreprise !==업체사용자 상세 조회==!
     -->
    <select id="selectCoUserRppn" parameterType="alpass.ipt.pot.pm.co.vo.PotPmCoCouserVo" resultType="alpass.ipt.pot.pm.co.vo.PotPmCoCouserVo">
        /** selectCoUserRppn */
        SELECT
              A.USER_ID
            , A.NIF
            , A.USER_TP_CD
            , A.USER_NM
            , CASE WHEN A.NAT_CD IS NULL OR A.NAT_CD = FN_GET_PARAM('DMSC_CNTY_CD')
                   THEN 'Y'
                   ELSE 'N'
                END AS NATV_YN
            , A.INHB_RGSR_NO
            , A.TLPH_NO
            , A.GNDR_CD
            , A.USER_ADDR
            , A.EML
            , A.NAT_CD
            , (SELECT Y.CNTY_NM
                 FROM TB_COM_CNTY_CD X, TB_COM_CNTY_CD_LANG Y
                WHERE X.CNTY_CD = Y.CNTY_CD
                  AND X.DEL_YN = 'N'
                  AND Y.DEL_YN = 'N'
                  AND Y.LANG_CD =  #{langCd} /**P*/
                  AND Y.CNTY_CD = A.NAT_CD ) AS NAT_NM
            , A.PSPR_NO
            , A.EML_RCPN_YN
            , A.SMS_RCPN_YN
            , A.DEL_YN
            , A.FRST_REGST_ID
            , TO_CHAR(A.FRST_RGSR_DTTM,'DD/MM/YYYY HH24:MI:SS') AS FRST_RGSR_DTTM
            , A.LAST_CHPR_ID
            , TO_CHAR(A.LAST_CHG_DTTM,'DD/MM/YYYY HH24:MI:SS') AS LAST_CHG_DTTM
            , A.USER_STTS_CD
            , A.ATCH_FILE_ID
            , A.RTRN_RSN_CN
            , A.USE_YN
            , TO_CHAR(TO_DATE(A.BRDY, 'DD/MM/YYYY'), 'DD/MM/YYYY') BRDY
        FROM TB_COM_CO_USER A
        WHERE A.DEL_YN = 'N'
        AND A.USER_TP_CD = 'R'
        AND A.USE_YN = 'Y'
        AND A.NIF = #{srchNif}
        AND A.CO_USER_RQST_NO = #{coUserRqstNo}
        AND ROWNUM = 1
        ORDER BY FRST_RGSR_DTTM
    </select>

</mapper>
