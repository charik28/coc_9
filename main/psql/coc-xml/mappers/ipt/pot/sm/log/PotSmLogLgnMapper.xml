<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="alpass.ipt.pot.sm.log.mapper.PotSmLogLgnMapper">

	<!--
		 Consulter la liste des journaux de connexion IPT !== IPT로그인로그  리스트를 조회 ==!
	 -->
	<select id="selectIptLgnLogList" parameterType="alpass.ipt.pot.sm.log.vo.PotSmLogLgnlogVo"
		resultType="alpass.ipt.pot.sm.log.vo.PotSmLogLgnlogVo">
		/** selectIptLgnLogList */
		SELECT
		COUNT(*) OVER() AS TOT_CNT,
		A.USER_ID,
		TO_CHAR(A.LOG_DTL_DTTM, 'DD/MM/YYYY HH24:MI:SS') AS LOG_DTL_DTTM,
		A.TRGT_URL,
		DECODE(A.ERR_CN, null,'N','Y') AS ERR_YN,
		A.ERR_CN,
		A.CNET_IP,
		A.BF_URL,
		A.DEL_YN,
		A.MSG_ID,
		A.OTHS_CN,
		NVL(FN_GET_CD_VDVAL_NM('COM_0016', A.PRCS_YN, #{langCd}), '-') AS PRCS_YN,
		A.FRST_REGST_ID,
		A.FRST_RGSR_DTTM,
		A.LAST_CHPR_ID,
		A.LAST_CHG_DTTM,
		ROWNUM AS RNUM
		FROM TB_COM_SYS_ACES_LOG A
		WHERE A.MSG_ID LIKE 'IPT_%'
		<if test="searUserId != null and searUserId != ''">
			AND   A.USER_ID =  #{searUserId}
		</if>
		<if test="searchKeywordFrom != null and searchKeywordFrom != ''">
			AND A.LOG_DTL_DTTM <![CDATA[ >= ]]> TO_DATE(#{searchKeywordFrom}, 'DD/MM/YYYY')
			AND A.LOG_DTL_DTTM <![CDATA[ < ]]> TO_DATE(#{searchKeywordTo}, 'DD/MM/YYYY') + 0.999999
		</if>
		<if test='searErrYn != null and searErrYn != "" and searErrYn == "N"'>
			AND A.ERR_CN IS NULL
		</if>
		<if test='searErrYn != null and searErrYn != "" and searErrYn == "Y"'>
			AND A.ERR_CN IS NOT NULL
		</if>
		ORDER BY A.LOG_DTL_DTTM DESC
		OFFSET #{firstIndex} ROWS FETCH NEXT #{recordCountPerPage} ROWS ONLY
	</select>

	<!--
		 Consulter la liste des journaux de connexion EPT !== EPT로그인로그  리스트를 조회 ==!
	 -->
	<select id="selectEptLgnLogList" parameterType="alpass.ipt.pot.sm.log.vo.PotSmLogLgnlogVo" resultType="alpass.ipt.pot.sm.log.vo.PotSmLogLgnlogVo">
		/** selectEptLgnLogList */
		SELECT
		COUNT(*) OVER() AS TOT_CNT,
		A.USER_ID,
			TO_CHAR(A.LOG_DTL_DTTM, 'DD/MM/YYYY HH24:MI:SS') AS LOG_DTL_DTTM,
			A.TRGT_URL,
			DECODE(A.ERR_CN, null,'N','Y') AS ERR_YN,
			A.ERR_CN,
			A.CNET_IP,
			A.BF_URL,
			A.DEL_YN,
			A.MSG_ID,
			A.OTHS_CN,
			NVL(FN_GET_CD_VDVAL_NM('COM_0016', A.PRCS_YN, #{langCd}), '-') AS PRCS_YN,
			A.FRST_REGST_ID,
			A.FRST_RGSR_DTTM,
			A.LAST_CHPR_ID,
			A.LAST_CHG_DTTM,
			ROWNUM AS RNUM
		FROM TB_COM_SYS_ACES_LOG A
		WHERE A.MSG_ID LIKE 'EPT_%'
		<if test="searUserId != null and searUserId != ''">
			AND   A.USER_ID =  #{searUserId}
		</if>
		<if test="searchKeywordFrom != null and searchKeywordFrom != ''">
			AND A.LOG_DTL_DTTM <![CDATA[ >= ]]> TO_DATE(#{searchKeywordFrom}, 'DD/MM/YYYY')
			AND A.LOG_DTL_DTTM <![CDATA[ < ]]> TO_DATE(#{searchKeywordTo}, 'DD/MM/YYYY') + 0.999999
		</if>
		<if test='searErrYn != null and searErrYn != "" and searErrYn == "N"'>
			AND A.ERR_CN IS NULL
		</if>
		<if test='searErrYn != null and searErrYn != "" and searErrYn == "Y"'>
			AND A.ERR_CN IS NOT NULL
		</if>
		ORDER BY A.LOG_DTL_DTTM DESC
		OFFSET #{firstIndex} ROWS FETCH NEXT #{recordCountPerPage} ROWS ONLY
	</select>

	<!--
		 Consulter la liste des fichiers journaux de l'accès au système EPT !== EPT시스템접근로그  리스트를 조회 ==!
	 -->
	<select id="selectEptLgnLogList_old" parameterType="alpass.ipt.pot.sm.log.vo.PotSmLogLgnlogVo" resultType="alpass.ipt.pot.sm.log.vo.PotSmLogLgnlogVo">
		/** selectEptLgnLogList */
		<include refid="pagination.header"/>
		SELECT 
		       A.*
		     , TO_CHAR(A.LOG_DTL_DTTM_TMP,'DD/MM/YYYY HH24:MI:SS') AS LOG_DTL_DTTM
		FROM    
		(       	
			SELECT 
				   A.USER_ID
				 , A.LOG_DTL_DTTM AS LOG_DTL_DTTM_TMP
				 , A.TRGT_URL
				 , A.ERR_CN
				 , A.CNET_IP
				 , A.BF_URL
				 , A.DEL_YN
				 , A.MSG_ID
				 , A.OTHS_CN
				 , FN_GET_CD_VDVAL_NM('COM_0016', B.ERR_YN, #{langCd}) AS ERR_YN
				 , (SELECT FN_GET_CD_VDVAL_NM('COM_0016', A.PRCS_YN, #{langCd}) FROM DUAL) AS PRCS_YN
				 , A.FRST_REGST_ID
				 , A.FRST_RGSR_DTTM
				 , A.LAST_CHPR_ID
				 , A.LAST_CHG_DTTM		
			FROM  TB_COM_SYS_ACES_LOG A,
						(SELECT B.USER_ID
						, B.MSG_ID
						, CASE WHEN B.ERR_CN != NULL OR B.ERR_CN != '' THEN 'Y'
						ELSE 'N' END AS ERR_YN
						FROM TB_COM_SYS_ACES_LOG B
						WHERE B.DEL_YN = 'N') B
			WHERE A.USER_ID = B.USER_ID
			AND A.MSG_ID = B.MSG_ID
			AND A.DEL_YN = 'N'
		  AND A.MSG_ID like 'EPT_%'
			<if test="searUserId != null and searUserId != ''">
			AND   A.USER_ID =  #{searUserId}
			</if>	
			<if test="searchKeywordFrom != null and searchKeywordFrom != ''">
			AND  TO_CHAR(A.LOG_DTL_DTTM, 'YYYYMMDD') BETWEEN TO_CHAR(TO_DATE(#{searchKeywordFrom}, 'DD/MM/YYYY'), 'YYYYMMDD') AND TO_CHAR(TO_DATE(#{searchKeywordTo}, 'DD/MM/YYYY'), 'YYYYMMDD')
			</if>
			<if test="searErrYn != null and searErrYn != ''">
				AND B.ERR_YN =  #{searErrYn}
			</if>
		  ORDER BY LOG_DTL_DTTM DESC
		) A
		<include refid="pagination.footer"/>
	</select>
																									
</mapper>
