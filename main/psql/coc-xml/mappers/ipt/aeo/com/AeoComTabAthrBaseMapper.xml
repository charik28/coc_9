<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<!--
Mapper : [OEA commun] Demande d'agrément - l'onglet des Critères de l'agrément !==[AEO 공통] 공인신청서 공인기준 탭 Mapper==!
(wonjun.cha)
-->
<mapper namespace="alpass.ipt.aeo.com.mapper.AeoComTabAthrBaseMapper">

    <!--
    [OEA commun] Consulter la liste des critères d'agrément !==[AEO 공통] 공인기준 목록 조회==!
    -->
	<select id="selectAeoComAthrBaseList"
	    parameterType="alpass.ipt.aeo.com.vo.AeoComAthrBaseVo"
	    resultType="alpass.ipt.aeo.com.vo.AeoComAthrBaseVo">
		/* selectAeoComAthrBaseList */
		SELECT
				  A.ATHR_BASE_MGMT_SRNO        /** Numéro de série de gestion des critères d'agrément !== 공인기준관리일련번호 ==! */
                , B.AEO_ATHR_RQST_NO           /** Numéro de demande du statut OEA !== AEO공인신청번호 ==! */
                , A.EV_LRCL_CD                 /** Code De Catégorie D'Évaluation !== 평가대분류코드 ==! */
                , FN_GET_CD_VDVAL_NM('AEO_0013', A.EV_LRCL_CD, #{langCd}) AS EV_LRCL_NM                 	/** Code De Catégorie D'Évaluation !== 평가대분류코드 ==! */
                , A.EV_SMCL_CD                 /** Code De Facteurs D'Évaluation !== 평가소분류코드 ==! */
                , FN_GET_CD_VDVAL_NM('AEO_0014', A.EV_SMCL_CD, #{langCd}) AS EV_SMCL_NM                 	/** Code De Facteurs D'Évaluation !== 평가소분류코드 ==! */
                , A.AUDT_TP_CD                 /** Code de classification d'audit !== 심사구분코드 ==! */
                , FN_GET_CD_VDVAL_NM('AEO_0001', A.AUDT_TP_CD, #{langCd}) AS AUDT_TP_NM                 	/** Code de classification d'audit !== 심사구분코드 ==! */
                , CASE A.AUDT_TP_CD WHEN '01' THEN 'Y' WHEN 'AL' THEN 'Y' ELSE '' END AS AUDT_TP_CD_01
                , CASE A.AUDT_TP_CD WHEN '02' THEN 'Y' WHEN 'AL' THEN 'Y' ELSE '' END AS AUDT_TP_CD_02
                , A.USE_YN                     /** Utilisé On !== 사용여부 ==! */
                , A.BASE_DESC                  /** Description De Critère !== 기준설명 ==! */
                , A.EV_BSS_CN                  /** Fondement d'évaluation !== 평가근거내용 ==! */
                , A.SORT_ORDR                  /** Ordre D'Alignement !== 정렬순서 ==! */
                , NVL(B.CO_EV_SCR, 0) AS CO_EV_SCR                      /** Note D'Évaluation  !== 업체평가점수 ==! */
                , TO_CHAR(NVL(B.CO_EV_SCR, 0)) AS CO_EV_SCR_CHAR        /** Note D'Évaluation  !== 업체평가점수 ==! */
                , NVL(B.ISTM_AUDT_SCR, 0) AS ISTM_AUDT_SCR              /** Note de l'audit documentaire !== 서류심사점수 ==! */
                , NVL(B.SPOT_AUDT_SCR, 0) AS SPOT_AUDT_SCR              /** Note de l'audit sur site !== 현장심사점수 ==! */
		  FROM
		  		  TB_AEOI_ATHR_BASE_MGMT A    /** AEOI_GESTION DES CRITÈRES D'AGRÉMENT !== AEOI_공인기준관리 ==! */
		  		, TB_AEOI_ATHR_BASE_EV B      /** AEOI_ÉVALUATION DES CRITÈRES D'AGRÉMENT !== AEOI_공인기준평가 ==! */
		 WHERE
		 		  A.ATHR_BASE_MGMT_SRNO = B.ATHR_BASE_MGMT_SRNO(+)
           AND	  A.DEL_YN = 'N'									/** Suppression ON !== 삭제여부 ==! */
           AND	  A.USE_YN = 'Y'									/** Utilisé On !== 사용여부 ==! */
           AND	  B.AEO_ATHR_RQST_NO(+) = #{aeoAthrRqstNo}       	/** Numéro de demande du statut OEA !== AEO공인신청번호 ==! */
		<if test='evLrclCd != null and !"".equals(evLrclCd)'>
		   AND    A.EV_LRCL_CD = #{evLrclCd}                        /** Code De Catégorie D'Évaluation !== 평가대분류코드 ==! */
		</if>
         ORDER BY A.EV_LRCL_CD, A.EV_SMCL_CD, A.SORT_ORDR
	</select>

    <!--
    [OEA commun] Enregistrer la liste des critères d'agrément !==[AEO 공통] 공인기준 목록 등록==!
    -->
	<insert id="insertAeoComAthrBase"
		parameterType="alpass.ipt.aeo.com.vo.AeoiAthrBaseEvVo">
		/* insertAeoComAthrBase */
        WITH UPSERT AS  (
			UPDATE TB_AEOI_ATHR_BASE_EV                     /** AEOI_ÉVALUATION DES CRITÈRES D'AGRÉMENT !== AEOI_공인기준평가 ==! */
			   SET
					  LAST_CHPR_ID = #{lastChprId}          /** Id Du Modificateur Final !== 최종변경자ID ==! */
					, LAST_CHG_DTTM = CURRENT_TIMESTAMP		/** Date Et Heure De Modification Finale !== 최종변경일시 ==! */ 
			    <if test='coEvScr != null and !"".equals(coEvScr)'>
					, CO_EV_SCR = #{coEvScr}                      /** Note D'Évaluation  !== 업체평가점수 ==! */
			    </if>
			    <if test='istmAudtScr != null and !"".equals(istmAudtScr)'>
	                , ISTM_AUDT_SCR = #{istmAudtScr}              /** Note de l'audit documentaire !== 서류심사점수 ==! */
			    </if>
			    <if test='spotAudtScr != null and !"".equals(spotAudtScr)'>
	                , SPOT_AUDT_SCR = #{spotAudtScr}              /** Note de l'audit sur site !== 현장심사점수 ==! */
			    </if>
			 WHERE
            		  ATHR_BASE_MGMT_SRNO = #{athrBaseMgmtSrno}   /** Numéro de série de gestion des critères d'agrément !== 공인기준관리일련번호 ==! */
            	AND	  AEO_ATHR_RQST_NO = #{aeoAthrRqstNo}         /** Numéro de demande du statut OEA !== AEO공인신청번호 ==! */
		     RETURNING *
        )
		INSERT INTO TB_AEOI_ATHR_BASE_EV (          /** AEOI_ÉVALUATION DES CRITÈRES D'AGRÉMENT !== AEOI_공인기준평가 ==! */
					  ATHR_BASE_MGMT_SRNO          	/** Numéro de série de gestion des critères d'agrément !== 공인기준관리일련번호 ==! */
	                , AEO_ATHR_RQST_NO             	/** Numéro de demande du statut OEA !== AEO공인신청번호 ==! */
	                , CO_EV_SCR                    	/** Note D'Évaluation  !== 업체평가점수 ==! */
	                , ISTM_AUDT_SCR                	/** Note de l'audit documentaire !== 서류심사점수 ==! */
	                , SPOT_AUDT_SCR                	/** Note de l'audit sur site !== 현장심사점수 ==! */
					, FRST_REGST_ID					/** Id Du Premier Enregistrant  !== 최초등록자ID ==! */
					, FRST_RGSR_DTTM				/** Date Et Heure De Premier Enregistrement !== 최초등록일시 ==! */
					, LAST_CHPR_ID					/** Id Du Modificateur Final !== 최종변경자ID ==! */
					, LAST_CHG_DTTM					/** Date Et Heure De Modification Finale !== 최종변경일시 ==! */
		)
		SELECT
					  #{athrBaseMgmtSrno}          	/** Numéro de série de gestion des critères d'agrément !== 공인기준관리일련번호 ==! */
	                , #{aeoAthrRqstNo}             	/** Numéro de demande du statut OEA !== AEO공인신청번호 ==! */
	                , #{coEvScr}                   	/** Note D'Évaluation  !== 업체평가점수 ==! */
	                , #{istmAudtScr}               	/** Note de l'audit documentaire !== 서류심사점수 ==! */
	                , #{spotAudtScr}               	/** Note de l'audit sur site !== 현장심사점수 ==! */                         
					, #{frstRegstId}          		/** Id Du Premier Enregistrant  !== 최초등록자ID ==! */              
					, CURRENT_TIMESTAMP          	/** Date Et Heure De Premier Enregistrement !== 최초등록일시 ==! */   
					, #{lastChprId}          		/** Id Du Modificateur Final !== 최종변경자ID ==! */                 
					, CURRENT_TIMESTAMP          	/** Date Et Heure De Modification Finale !== 최종변경일시 ==! */  
		 WHERE	NOT EXISTS (SELECT * FROM UPSERT)
	</insert>

    <!--
    [OEA commun] Modifier la liste des critères d'agrément !==[AEO 공통] 공인기준 목록 수정==!
    -->
	<update id="updateAeoComAthrBase"
		parameterType="alpass.ipt.aeo.com.vo.AeoiAthrBaseEvVo">
		/* updateAeoComAthrBase */
		UPDATE	  TB_AEOI_ATHR_BASE_EV                          /** AEOI_ÉVALUATION DES CRITÈRES D'AGRÉMENT !== AEOI_공인기준평가 ==! */
		   SET
				  LAST_CHPR_ID = #{lastChprId}          		/** Id Du Modificateur Final !== 최종변경자ID ==! */
				, LAST_CHG_DTTM = CURRENT_TIMESTAMP				/** Date Et Heure De Modification Finale !== 최종변경일시 ==! */ 
		    <if test='coEvScr != null and !"".equals(coEvScr)'>
				, CO_EV_SCR = #{coEvScr}                      	/** Note D'Évaluation !== 업체평가점수 ==! */
		    </if>
		    <if test='istmAudtScr != null and !"".equals(istmAudtScr)'>
                , ISTM_AUDT_SCR = #{istmAudtScr}              	/** Note de l'audit documentaire !== 서류심사점수 ==! */
		    </if>
		    <if test='spotAudtScr != null and !"".equals(spotAudtScr)'>
                , SPOT_AUDT_SCR = #{spotAudtScr}              	/** Note de l'audit sur site !== 현장심사점수 ==! */
		    </if>
		 WHERE
           		  ATHR_BASE_MGMT_SRNO = #{athrBaseMgmtSrno}   	/** Numéro de série de gestion des critères d'agrément !== 공인기준관리일련번호 ==! */
           AND	  AEO_ATHR_RQST_NO = #{aeoAthrRqstNo}         	/** Numéro de demande du statut OEA !== AEO공인신청번호 ==! */
	</update>

	<!--
    [OEA commun] Modifier le trimetre d'évaluation et la note du niveau de conformité pour la demande d'agrément !==[AEO 공통] 공인신청 평가분기, 법규준수점수 수정==!
    -->
	<update id="updateAeoComAthrApfmLwcsScr"
		parameterType="alpass.ipt.aeo.com.vo.AeoiAthrBaseEvVo">
		/* updateAeoComAthrApfmLwcsScr */
		UPDATE TB_AEOI_ATHR_RQST A                                    /* AEOI_DEMANDE D'AGRÉMENT !== AEOI_공인신청 ==! */
		SET    A.EV_QRT = (SELECT C.EV_QRT                            /* Trimestre d'évaluation !== 평가분기 ==! */
						   FROM   TB_RSMI_CO_EV_COMN C                /* RSMI_EVALUATION DES OPÉRATEURS COMMUNE !== RSMI_업체평가공통 ==! */
						   WHERE  C.DEL_YN = 'N'
						   AND    C.NIF = A.NIF
						   ORDER BY C.EV_QRT DESC
						   FETCH FIRST 1 ROWS ONLY)
		     , A.CO_EV_SCR = (SELECT C.CO_EV_SCR                      /* Note d'évaluation !== 업체평가점수 ==! */
							  FROM   TB_RSMI_CO_EV_COMN C             /* RSMI_EVALUATION DES OPÉRATEURS COMMUNE !== RSMI_업체평가공통 ==! */
							  WHERE  C.DEL_YN = 'N'
							  AND    C.NIF = A.NIF
							  ORDER BY C.EV_QRT DESC
							  FETCH FIRST 1 ROWS ONLY)
		     , A.LAST_CHPR_ID = #{lastChprId}            /** Id Du Modificateur Final !== 최종변경자ID ==! */
		     , A.LAST_CHG_DTTM = CURRENT_TIMESTAMP       /** Date Et Heure De Modification Finale !== 최종변경일시 ==! */
		WHERE  A.DEL_YN = 'N'
		AND    A.AEO_ATHR_RQST_NO = #{aeoAthrRqstNo}
	</update>

</mapper>