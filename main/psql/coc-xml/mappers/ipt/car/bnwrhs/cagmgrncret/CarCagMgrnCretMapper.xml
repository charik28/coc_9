<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="alpass.ipt.car.bnwrhs.cagmgrncret.mapper.CarCagMgrnCretMapper">
  <!-- 보세구역 : 화물관리번호신청 업무  (By Haechul.shin on 14/10/2022) -->
  <!--
    [Rechercher] Consulter la liste des "Demande d'accord préalable de l'exploitation de la zone sous douane"
    !== 화물관리신청번호생성 목록 조회 ==!
   -->
	<select id="selectCagMgrnCretList" resultType="alpass.ipt.car.bnwrhs.cagmgrncret.vo.CarCagMgrnCretVo">
	    /* alpass.ipt.car.bnwrhs.cagmgrncret.mapper.CarCagMgrnCretMapper.selectCagMgrnCretList */
	    <include refid="pagination.header" ></include>
		SELECT
	          A.CAG_MGRN_CRET_RQNO			/**  Crn  												!== 화물관리생성신청번호 ==!  */
	        , A.CAG_MGMT_NO					/**  Crn  												!== 화물관리번호 ==!  */
			, A.RQST_RSN_CN					/**  Motif De Demande De Crn  							!== 화물관리번호신청사유내용 ==!  */
			, A.JRSD_ORGN_CD				/**  Code D'Unité Compétente  							!== 관할조직코드 ==!  */
			, (SELECT ORGN_NM    /** Service compétent !== 관할조직 ==! */
				 FROM TB_POTI_ORGN
				WHERE ORGN_CD = A.JRSD_ORGN_CD) AS JRSD_ORGN_NM
			, A.IBOBZ_CD					/**  Code de zone sous douane  							!== 보세구역코드 ==!  */
		    , (SELECT IBOBZ_NM  /* Nom de la zone sous douane !== 보세구역명 ==! */
			       FROM TB_CARI_IBOBZ
			      WHERE DEL_YN = 'N'
			        AND IBOBZ_CD = A.IBOBZ_CD) AS IBOBZ_NM
			, A.EXPPN_NM					/**  Nom De L'Exportateur  								!== 수출자명 ==!  */
			, A.EXPPN_ADDR					/**  Adresse De L'Exportateur  							!== 수출자주소 ==!  */
			, A.EXPPN_TLPH_NO				/**  Téléphone De L'Exportateur  						!== 수출자전화번호 ==!  */
			, A.EXPPN_NIF					/**  NIF de l'exportateur 					 			!== 수출자사업자등록번호 ==!  */
			, A.CNSI_NM						/**  Nom de destinataire  								!== 수하인명 ==!  */
			, A.CNSI_ADDR					/**  Adresse de destinataire  							!== 수하인주소 ==!  */
			, A.CNSI_TLPH_NO				/**  N° de téléphone de destinataire 					!== 수하인전화번호 ==!  */
			, A.CNSI_NIF					/**  N° du registre du commerce de destinataire  		!== 수하인사업자등록번호 ==!  */
			, TO_CHAR(A.TRSN_DTTM, 'DD/MM/YYYY') AS TRSN_DTTM	/**  Date et heure de transmission  !== 전송일시 ==!  */
			, A.TRSN_CO_CD					/**  Code d'entreprise transmettrice 			 		!== 전송업체코드 ==!  */
			, A.DEL_YN						/**  Suppression On  							!== 삭제여부 ==!  */
			, A.FRST_REGST_ID				/**  Id Du Premier Enregistrant  				!== 최초등록자ID ==!  */
			, A.FRST_RGSR_DTTM				/**  Date Et Heure De Premier Enregistrement  	!== 최초등록일시 ==!  */
			, A.LAST_CHPR_ID				/**  Id Du Modificateur Final  					!== 최종변경자ID ==!  */
			, A.LAST_CHG_DTTM				/**  Date Et Heure De Modification Finale  		!== 최종변경일시 ==!  */
			, A.RQST_CO_ADDR                /**  Adresse D'Opérateur Demandeur  			!== 신청업체주소 ==!  */
			, A.RQST_CO_CD					/**  Code d'entreprise de la demande  			!== 신청업체코드 ==!  */
	  		, A.RQST_CO_TLPH_NO  			/**   											!== 신청업체전화번호 ==!  */
			, A.CMDT_DESC 					/**   											!== 물품설명 ==!  */
			, A.AL_PCKG_GCNT     			/**   											!== 전체포장개수 ==!  */
			, A.AL_TTWG						/**   											!== 전체총중량 ==!  */
			, A.PCKG_UT_CD 					/** Code d'unite de colis de l'article        	!== 품목포장단위코드 ==! */

			, A.AUDT_PT_CD  				/**  Code De Type De Contrôle  					!== 심사유형코드 ==!  */
			, A.AUDT_RSLT_CN 				/**  Contenu Du Résultat De La Vérification  	!== 심사결과내용 ==!  */

			,B.PRCS_STTS_CD				/**  Code De Statut De Traitement  					!== 처리상태코드 ==!  */
			,B.AUDT_EMP_ID 					/**  ID de l'insepcteur  					     !== 심사직원ID ==!  */
			,(SELECT DECODE(L.EMP_FMNM,NULL,L.EMP_NM,L.EMP_FMNM || ' ' ||L.EMP_NM )
	                  FROM TB_POTI_EMP L
	                 WHERE L.DEL_YN = 'N'
	                   AND L.PBSR_NO = B.AUDT_EMP_ID)           AS AUDT_EMP_NM
			,TO_CHAR(B.PRCS_DTTM,'DD/MM/YYYY') AS PRCS_DTTM	    /** DATE De Statut De Traitement   !==처리일시==! */
			,B.PRCS_STTS_CD                       		        /** Code De Statut De Traitement  !==처리상태코드==! */

		FROM  ALPASSINT.TB_CARI_CAG_MGMT_NO_CRET A
		   ,  ALPASSINT.TB_CARI_CAG_PRCS_BRKD B
		WHERE A.CAG_MGRN_CRET_RQNO = B.CAG_RQST_NO
		AND   B.CAG_RQST_TP_CD  = 'CRN'
		AND   B.RQST_DGCNT      = 0
	    AND   A.DEL_YN = 'N'           /** Suppression ON !== 삭제여부 ==! */

		<if test="roleId != null and roleId.equals('CAR081'.toString())">
		/** 관리자인경우 */
		AND A.JRSD_ORGN_CD LIKE SUBSTR(#{jrsdOrgnCd}, 1, 5) || '%'
		</if>

		<if test="roleId != null and roleId.equals('CAR082'.toString())">
		/** 심사자인경우 */
		AND B.AUDT_EMP_ID = #{pbsrNo}
		</if>


        <if test="(searchKeywordFrom != null and searchKeywordFrom != '') and (searchKeywordTo != null and searchKeywordTo != '')">
          AND (
            (
              A.FRST_RGSR_DTTM <![CDATA[ >= ]]> TO_DATE(#{searchKeywordFrom}, 'DD/MM/YYYY')       /**  Date et heure de transmission  !== 전송일시 ==!  */
              AND A.FRST_RGSR_DTTM <![CDATA[ <= ]]> TO_DATE(#{searchKeywordTo}, 'DD/MM/YYYY')+0.9999   /**  Date et heure de transmission  !== 전송일시 ==!  */
            ) OR (
                A.FRST_RGSR_DTTM <![CDATA[ >= ]]> TO_TIMESTAMP(#{searchKeywordFrom}, 'DD/MM/YYYY')
                AND A.FRST_RGSR_DTTM <![CDATA[ <= ]]> TO_TIMESTAMP(#{searchKeywordTo}, 'DD/MM/YYYY')+0.9999
            )
          )
        </if>

        <if test="cagMgrnCretRqno != null and cagMgrnCretRqno != ''">
          AND  A.CAG_MGRN_CRET_RQNO = #{cagMgrnCretRqno}         /**  Code De Statut De Traitement  !== 신청번호 ==!  */
        </if>
        <if test="cagMgmtNo != null and cagMgmtNo != ''">
          AND  A.CAG_MGMT_NO = #{cagMgmtNo}                      /**  Code De Statut De Traitement  !== 관리번호 ==!  */
        </if>
        <if test="prcsSttsCd != null and prcsSttsCd != ''">
          AND  B.PRCS_STTS_CD = #{prcsSttsCd}                   /**  Code De Statut De Traitement  !== 처리상태코드 ==!  */
        </if>

		ORDER BY A.FRST_RGSR_DTTM DESC
		<include refid="pagination.footer" ></include>
	</select>

	<!--
    [Rechercher] Consulter la liste des "Demande d'accord préalable de l'exploitation de la zone sous douane"
    !== 화물관리신청번호생성 detail 조회 ==!
   -->
  <select id="selectCagMgrnCretDetailInfo" parameterType="alpass.ipt.car.bnwrhs.cagmgrncret.vo.CarCagMgrnCretVo" resultType="alpass.ipt.car.bnwrhs.cagmgrncret.vo.CarCagMgrnCretVo">
	/* alpass.ipt.car.bnwrhs.cagmgrncret.mapper.CarCagMgrnCretMapper.selectCagMgrnCretDetailInfo */
	SELECT
          A.CAG_MGRN_CRET_RQNO			/**  Crn  												!== 화물관리생성신청번호 ==!  */
        , A.CAG_MGMT_NO					/**  Crn  												!== 화물관리번호 ==!  */
		, A.RQST_RSN_CN					/**  Motif De Demande De Crn  							!== 화물관리번호신청사유내용 ==!  */
		, A.JRSD_ORGN_CD				/**  Code D'Unité Compétente  							!== 관할조직코드 ==!  */
		, (SELECT ORGN_NM    /** Service compétent !== 관할조직 ==! */
			 FROM TB_POTI_ORGN
			WHERE ORGN_CD = A.JRSD_ORGN_CD) AS JRSD_ORGN_NM
		, A.IBOBZ_CD					/**  Code de zone sous douane  							!== 보세구역코드 ==!  */
	    , (SELECT IBOBZ_NM  /* Nom de la zone sous douane !== 보세구역명 ==! */
		       FROM TB_CARI_IBOBZ
		      WHERE DEL_YN = 'N'
		        AND IBOBZ_CD = A.IBOBZ_CD) AS IBOBZ_NM
		, (SELECT C2.ORGN_CD JRSD_CSTM_CD
		   FROM TB_POTI_ORGN C1
		   LEFT JOIN  TB_POTI_ORGN C2
		     ON C1.UPR_ORGN_MGMT_CD = C2.ORGN_MGMT_CD
		  WHERE C1.DEL_YN = 'N'
		  AND C1.ORGN_CD = A.JRSD_ORGN_CD ) AS JRSD_CSTM_CD
		, A.EXPPN_NM					/**  Nom De L'Exportateur  								!== 수출자명 ==!  */
		, A.EXPPN_ADDR					/**  Adresse De L'Exportateur  							!== 수출자주소 ==!  */
		, A.EXPPN_TLPH_NO				/**  Téléphone De L'Exportateur  						!== 수출자전화번호 ==!  */
		, A.EXPPN_NIF					/**  NIF de l'exportateur 					 			!== 수출자사업자등록번호 ==!  */
		, A.CNSI_NM						/**  Nom de destinataire  								!== 수하인명 ==!  */
		, A.CNSI_ADDR					/**  Adresse de destinataire  							!== 수하인주소 ==!  */
		, A.CNSI_TLPH_NO				/**  N° de téléphone de destinataire 					!== 수하인전화번호 ==!  */
		, A.CNSI_NIF					/**  N° du registre du commerce de destinataire  		!== 수하인사업자등록번호 ==!  */
		, TO_CHAR(A.TRSN_DTTM, 'DD/MM/YYYY') AS trsn_dttm	/**  Date et heure de transmission  !== 전송일시 ==!  */
		, A.TRSN_CO_CD					/**  Code d'entreprise transmettrice 			 		!== 전송업체코드 ==!  */
		, A.DEL_YN						/**  Suppression On  							!== 삭제여부 ==!  */
		, A.FRST_REGST_ID				/**  Id Du Premier Enregistrant  				!== 최초등록자ID ==!  */
		, A.FRST_RGSR_DTTM				/**  Date Et Heure De Premier Enregistrement  	!== 최초등록일시 ==!  */
		, A.LAST_CHPR_ID				/**  Id Du Modificateur Final  					!== 최종변경자ID ==!  */
		, A.LAST_CHG_DTTM				/**  Date Et Heure De Modification Finale  		!== 최종변경일시 ==!  */
		, A.RQST_CO_ADDR                /**  Adresse D'Opérateur Demandeur  			!== 신청업체주소 ==!  */
		, A.RQST_CO_CD					/**  Code d'entreprise de la demande  			!== 신청업체코드 ==!  */
  		, A.RQST_CO_TLPH_NO  			/**   											!== 신청업체전화번호 ==!  */
		, A.CMDT_DESC 					/**   											!== 물품설명 ==!  */
		, A.AL_PCKG_GCNT     			/**   											!== 전체포장개수 ==!  */
		, A.AL_TTWG						/**   											!== 전체총중량 ==!  */
		, A.PCKG_UT_CD  			/**  Code De L'Unité De Colis  !== 포장단위코드 ==!  */

		, A.AUDT_PT_CD  				/**  Code De Type De Contrôle  					!== 심사유형코드 ==!  */
		, A.AUDT_RSLT_CN 				/**  Contenu Du Résultat De La Vérification  	!== 심사결과내용 ==!  */

		,BRKD.PRCS_STTS_CD				/**  Code De Statut De Traitement  				!== 처리상태코드 ==!  */
		,BRKD.AUDT_EMP_ID 					/**  ID de l'insepcteur  					     !== 심사직원ID ==!  */
		,(SELECT DECODE(L.EMP_FMNM,NULL,L.EMP_NM,L.EMP_FMNM || ' ' ||L.EMP_NM )
                  FROM TB_POTI_EMP L
                 WHERE L.DEL_YN = 'N'
                   AND L.PBSR_NO = BRKD.AUDT_EMP_ID)           AS AUDT_EMP_NM
		,TO_CHAR(BRKD.PRCS_DTTM,'DD/MM/YYYY') AS PRCS_DTTM	    /** DATE De Statut De Traitement   !==처리일시==! */
		,BRKD.PRCS_STTS_CD                       		        /** Code De Statut De Traitement  !==처리상태코드==! */

	FROM ALPASSINT.TB_CARI_CAG_MGMT_NO_CRET A
	   , ALPASSINT.TB_CARI_CAG_PRCS_BRKD BRKD
	WHERE A.DEL_YN = 'N'           /** Suppression ON !== 삭제여부 ==! */
	AND   A.CAG_MGRN_CRET_RQNO = BRKD.CAG_RQST_NO
    AND   BRKD.CAG_RQST_TP_CD  = 'CRN'
    AND   BRKD.RQST_DGCNT      = 0
	<if test="cagMgrnCretRqno != null and cagMgrnCretRqno != ''">
    AND  A.CAG_MGRN_CRET_RQNO = #{cagMgrnCretRqno}         /**  Code De Statut De Traitement  !== 신청번호 ==!  */
    </if>
    <if test="cagMgmtNo != null and cagMgmtNo != ''">
    AND  A.CAG_MGMT_NO = #{cagMgmtNo}                      /**  Code De Statut De Traitement  !== 관리번호 ==!  */
    </if>
    <if test="prcsSttsCd != null and prcsSttsCd != ''">
    AND  BRKD.PRCS_STTS_CD = #{prcsSttsCd}                    /**  Code De Statut De Traitement  !== 처리상태코드 ==!  */
    </if>

   </select>

   <select id="selectCagMgrnPdlsList" resultType="alpass.ipt.car.bnwrhs.cagmgrncret.vo.CarCagMgrnPdlsVo">
    /* alpass.ipt.car.bnwrhs.cagmgrncret.mapper.CarCagMgrnCretMapper.CarCagMgrnCretMapper */
    SELECT
	      A.CAG_MGRN_CRET_RQNO
	    , A.PDLS_SRNO  			/**  N° de séquence de l'article  !== 품목일련번호 ==!  */
		, A.HS_CD  				/**  Code Sh  !== HS코드 ==!  */
		, A.PDLS_NM  			/**  Nom De L'Article  !== 품목명 ==!  */
		, A.PCKG_GCNT  			/**  Nombre De Colis  !== 포장개수 ==!  */
		, A.PCKG_UT_CD  			/**  Code De L'Unité De Colis  !== 포장단위코드 ==!  */
		, A.WGHT  				/**  Poids  !== 중량 ==!  */
		, A.DEL_YN  			/**  Suppression On  !== 삭제여부 ==!  */
		, A.FRST_REGST_ID  		/**  Id Du Premier Enregistrant   !== 최초등록자ID ==!  */
		, A.FRST_RGSR_DTTM  		/**  Date Et Heure De Premier Enregistrement  !== 최초등록일시 ==!  */
		, A.last_chpr_id  		/**  Id Du Modificateur Final  !== 최종변경자ID ==!  */
		, A.LAST_CHG_DTTM 		/**  Date Et Heure De Modification Finale  !== 최종변경일시 ==!  */
	 FROM ALPASSINT.TB_CARI_CAG_MGMT_NO_CRET_PDLS A
   	    WHERE
         A.DEL_YN = 'N'    /** Suppression ON !== 삭제여부 ==! */

       <if test="cagMgrnCretRqno != null and cagMgrnCretRqno != ''">
          AND  A.CAG_MGRN_CRET_RQNO = #{cagMgrnCretRqno}         /**  Code De Statut De Traitement  !== 신청번호 ==!  */
       </if>
   </select>

   <!--
	 [Supprimer] Demande d’introduction
	 !== 화물관리신청 저장한다. ==!
	 -->
	<update id="cagMgrnCretSave" parameterType="alpass.ipt.car.bnwrhs.cagmgrncret.vo.CarCagMgrnCretVo">
    	/* alpass.ipt.car.bnwrhs.cagmgrncret.mapper.CarCagMgrnCretMapper.cagMgrnCretSave */
	    UPDATE ALPASSINT.TB_CARI_CAG_MGMT_NO_CRET
	       SET
	          AUDT_EMP_ID  = #{audtEmpId}    /**  ID de l'insepcteur  !== 심사직원ID ==!  */
			, AUDT_DTTM    = SYSTIMESTAMP 	/**  Date De L'Étude  !== 심사일시 ==!  */
			, AUDT_PT_CD   = #{audtPtCd} 	/**  Code De Type De Contrôle  !== 심사유형코드 ==!  */
			, AUDT_RSLT_CN = #{audtRsltCn} 	/**  Contenu Du Résultat De La Vérification  !== 심사결과내용 ==!  */
			, LAST_CHG_DTTM = SYSTIMESTAMP	/**  Date Et Heure De Modification Finale  	    !== 최종변경일시   ==!*/
			, LAST_CHPR_ID = #{lastChprId}	/**  Id Du Modificateur Final					!== 최종변경자ID   ==!*/
		WHERE CAG_MGRN_CRET_RQNO = #{cagMgrnCretRqno}         /**  Code De Statut De Traitement  !== 신청번호 ==!  */
    </update>

	<!--
	 [Supprimer] Demande d’introduction
	 !== 화물관리신청 [심사완료] 저장한다. TO EPT==!
	 -->
	<update id="cagMgrnCretEptConfirm" parameterType="alpass.ipt.car.bnwrhs.cagmgrncret.vo.CarCagMgrnCretVo">
    	/* alpass.ept.car.bnwrhs.cagmgrncret.mapper.CarCagMgrnCretMapper.cagMgrnCretEptConfirm */
	    UPDATE ALPASSEXT.TB_CARE_CAG_MGMT_NO_CRET
	       SET
	          PRCS_STTS_CD = #{prcsSttsCd}	/**  Code De Statut De Traitement  !== 처리상태코드/ 심사유형코드 저장 ==!  */
			, LAST_CHG_DTTM = SYSTIMESTAMP	/**  Date Et Heure De Modification Finale  	    !== 최종변경일시   ==!*/
			, LAST_CHPR_ID = #{lastChprId}	/**  Id Du Modificateur Final					!== 최종변경자ID   ==!*/
		WHERE CAG_MGRN_CRET_RQNO = #{cagMgrnCretRqno}         /**  Code De Statut De Traitement  !== 신청번호 ==!  */
    </update>
</mapper>
