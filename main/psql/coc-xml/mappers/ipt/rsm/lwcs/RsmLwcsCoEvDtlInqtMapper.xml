<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<!--
  Mapper : Consulter les détails du niveau de conformité !== 업체평가상세조회 Mapper ==!
-->
<mapper namespace="alpass.ipt.rsm.lwcs.mapper.RsmLwcsCoEvDtlInqtMapper">

    <!-- 
    [Consulter les détails d'évaluation des opérateurs] Consulter la liste !== [업체평가상세조회] 목록조회 ==!
    -->
    <select id="selectCoEvDtlInqtList"
        parameterType="alpass.ipt.rsm.lwcs.vo.RsmLwcsCoEvDtlInqtVo"
        resultType="alpass.ipt.rsm.lwcs.vo.RsmLwcsCoEvDtlInqtVo">
        /* selectCoEvDtlInqtList */
        <include refid="pagination.header"/>
        SELECT
	          EV_QRT                                              /* Trimestre d'évaluation  !== 평가분기 ==!*/
	        , EV_CO_TP_CD                                         /* Code de type de contrat !== 평가업체구분코드 ==!*/
	        , EV_QRT_SRNO                                         /* Numéro de série de la période d'évaluation !== 평가분기일련번호 ==!*/
	        , NIF                                                 /* NIF !== 납세번호 ==! */
	        , DECODE(EV_CO_TP_CD, 'A', NVL((SELECT CO_NM FROM TB_COM_CO WHERE NIF = A.NIF), (SELECT CO_DCLR_CD_NM FROM TB_COM_CO_DCLR_CD WHERE DEL_YN = 'N' AND CO_DCLR_CD = A.NIF)), 'B', (SELECT CONM FROM TB_POTE_NIF WHERE NIF = A.NIF )) AS CO_NM
	        , EV_GD_CD                                            /* Code de groupe d'évaluation !== 평가등급코드 ==!*/
	        , NVL(EV_GD_ACML_DSTB_RT, 0) AS EV_GD_ACML_DSTB_RT    /* Taux de distribution cumulative du groupe d'évaluation !== 평가등급누적분포율 ==!*/
	        , CO_EV_RNK                                           /* Rang d'évaluation !== 업체평가순위 ==!*/
	        , NVL(DCLR_ACDG_SCR, 0) AS DCLR_ACDG_SCR              /* Note de la précision de déclaration !== 신고정확도점수 ==!*/
	        , NVL(IMPO_VLTN_MTR_SCR, 0) AS IMPO_VLTN_MTR_SCR      /* Note de l'infraction majeure  !== 중요위반사항점수 ==!*/
	        , NVL(TRIF_CODG_SCR, 0) AS TRIF_CODG_SCR              /* Note de la conformité !== 관세협력도점수 ==!*/
	        , NVL(CO_EV_SCR, 0) AS CO_EV_SCR                      /* Note d'évaluation  !== 업체평가점수 ==!*/
	        , NVL(DCLR_CNT, 0) AS DCLR_CNT                        /* Nombre de déclarations !== 신고건수 ==!*/
	        , NVL(DCLR_PDLS_CNT, 0) AS DCLR_PDLS_CNT              /* Nombre d'article déclaré !== 신고품목건수 ==!*/
	        , NVL(FRST_PAY_XAMT, 0) AS FRST_PAY_XAMT              /* Droits et taxes payés  !== 최초납부세액 ==!*/
	        , NVL(ADIT_PAY_XAMT, 0) AS ADIT_PAY_XAMT              /* Droits et taxes additionnels !== 추가납부세액 ==!*/
	        , NVL(LAST_PAY_XAMT, 0) AS LAST_PAY_XAMT              /* Montant définitif de droits et taxes payés !== 최종납부세액 ==!*/
	        , NVL(XAMT_CHG_RT, 0) AS XAMT_CHG_RT                  /* Taux de redressement !== 세액변경율 ==!*/
	        , DEL_YN                                              /* Suppression ON !== 삭제여부 ==!*/
	        , FRST_REGST_ID                                       /* ID du premier enregistrant  !== 최초등록자ID ==!*/
	        , FRST_RGSR_DTTM                                      /* Date et heure de premier enregistrement !== 최초등록일시 ==!*/
	        , LAST_CHPR_ID                                        /* ID du modificateur final !== 최종변경자ID ==!*/
	        , LAST_CHG_DTTM                                       /* Date et heure de modification finale !== 최종변경일시 ==!*/
	    FROM  TB_RSMI_CO_EV_COMN A
	    WHERE EXISTS (
	          SELECT
	                *
	          FROM  (
	                SELECT
	                      NIF
	                    , MAX(EV_QRT) AS EV_QRT
	                    , MAX(EV_QRT_SRNO) AS EV_QRT_SRNO
	                FROM  TB_RSMI_CO_EV_COMN
	                WHERE DEL_YN = 'N'
	                GROUP BY NIF, EV_QRT
	          ) B
	          WHERE A.NIF = B.NIF
	          AND   A.EV_QRT = B.EV_QRT
	          AND   A.EV_QRT_SRNO = B.EV_QRT_SRNO
	    )
	    AND   EV_CO_TP_CD = #{evCoTpCd}
	    AND   EV_QRT BETWEEN #{startEvQrt} AND #{endEvQrt}
	    <if test='nif != null and !"".equals(nif)'>
	    AND   NIF = #{nif}                                    /* NIF !== 납세번호 ==! */
	    </if>
	    AND   EV_GD_CD IN 									  /* Code de groupe d'évaluation !== 평가등급코드 ==! */
	    <foreach item="item" index="index" collection="evGdCds" open="(" close=")" separator=",">
	    #{item}
	    </foreach>
	    ORDER BY NIF DESC, EV_QRT DESC, EV_CO_TP_CD ASC, EV_QRT_SRNO ASC
	    <include refid="pagination.footer"/>
	    
    </select>

	<!--
      [Consulter les détails d'évaluation des opérateurs] Consulter les détails !== [업체평가상세조회] 상세조회 ==!
    -->
	<select id="selectCoEvDtlInqtDetail"
		parameterType="alpass.ipt.rsm.lwcs.vo.RsmLwcsCoEvDtlInqtVo"
		resultType="alpass.ipt.rsm.lwcs.vo.RsmLwcsCoEvDtlInqtVo">
		/* selectCoEvDtlInqtDetail */
		SELECT
			  EV_QRT                                              /* Trimestre d'évaluation  !== 평가분기 ==!*/
			, EV_CO_TP_CD                                         /* Code de type de contrat !== 평가업체구분코드 ==!*/
			, EV_QRT_SRNO                                         /* Numéro de série de la période d'évaluation !== 평가분기일련번호 ==!*/
			, NIF                                                 /* NIF !== 납세번호 ==! */
			, DECODE(EV_CO_TP_CD, 'A', (SELECT CO_NM FROM TB_COM_CO WHERE NIF = A.NIF), 'B', (SELECT CONM FROM TB_POTE_NIF WHERE NIF = A.NIF))  AS NIF_NM
			, EV_GD_CD                                            /* Code de groupe d'évaluation !== 평가등급코드 ==!*/
			, NVL(EV_GD_ACML_DSTB_RT, 0) AS EV_GD_ACML_DSTB_RT    /* Taux de distribution cumulative du groupe d'évaluation !== 평가등급누적분포율 ==!*/
			, CO_EV_RNK                                           /* Rang d'évaluation !== 업체평가순위 ==!*/
			, NVL(DCLR_ACDG_SCR, 0) AS DCLR_ACDG_SCR              /* Note de la précision de déclaration !== 신고정확도점수 ==!*/
			, NVL(IMPO_VLTN_MTR_SCR, 0) AS IMPO_VLTN_MTR_SCR      /* Note de l'infraction majeure  !== 중요위반사항점수 ==!*/
			, NVL(TRIF_CODG_SCR, 0) AS TRIF_CODG_SCR              /* Note de la conformité !== 관세협력도점수 ==!*/
			, NVL(CO_EV_SCR, 0) AS CO_EV_SCR                      /* Note d'évaluation  !== 업체평가점수 ==!*/
			, NVL(DCLR_CNT, 0) AS DCLR_CNT                        /* Nombre de déclarations !== 신고건수 ==!*/
			, NVL(DCLR_PDLS_CNT, 0) AS DCLR_PDLS_CNT              /* Nombre d'article déclaré !== 신고품목건수 ==!*/
			, NVL(FRST_PAY_XAMT, 0) AS FRST_PAY_XAMT              /* Droits et taxes payés  !== 최초납부세액 ==!*/
			, NVL(ADIT_PAY_XAMT, 0) AS ADIT_PAY_XAMT              /* Droits et taxes additionnels !== 추가납부세액 ==!*/
			, NVL(LAST_PAY_XAMT, 0) AS LAST_PAY_XAMT              /* Montant définitif de droits et taxes payés !== 최종납부세액 ==!*/
			, NVL(XAMT_CHG_RT, 0) AS XAMT_CHG_RT                  /* Taux de redressement !== 세액변경율 ==!*/
			, DEL_YN                                              /* Suppression ON !== 삭제여부 ==!*/
			, FRST_REGST_ID                                       /* ID du premier enregistrant  !== 최초등록자ID ==!*/
			, FRST_RGSR_DTTM                                      /* Date et heure de premier enregistrement !== 최초등록일시 ==!*/
			, LAST_CHPR_ID                                        /* ID du modificateur final !== 최종변경자ID ==!*/
			, LAST_CHG_DTTM                                       /* Date et heure de modification finale !== 최종변경일시 ==!*/
		FROM  TB_RSMI_CO_EV_COMN A
		WHERE A.DEL_YN = 'N' 									  /* Suppression ON !== 삭제여부 ==!*/
		AND A.NIF = #{nif}                                        /* NIF !== 납세번호 ==! */
		AND A.EV_QRT = #{evQrt} 								  /* Trimestre d'évaluation  !== 평가분기 ==!*/
		AND A.EV_CO_TP_CD = #{evCoTpCd} 						  /* Code de type de contrat !== 평가업체구분코드 ==!*/
	</select>
    
    <!-- 
      [Consulter les détails d'évaluation des opérateurs] Consulter la liste des notes d'évaluation !== [업체평가상세조회] 평가점수 목록조회 ==!
    -->
    <select id="selectEvaluationScoreDetailList" 
        parameterType="alpass.ipt.rsm.lwcs.vo.RsmLwcsCoEvDtlInqtVo" 
        resultType="alpass.ipt.rsm.lwcs.vo.RsmLwcsCoEvDtlInqtVo">
        /* selectEvaluationScoreDetailList */
	    SELECT
	        ROWNUM NO
	        , MSTR.*
	    FROM (
	        SELECT
	              EVFTOR.EV_LRCL_CD                 /* Code de catégorie d'évaluation !== 평가대분류코드 ==! */
	            , EVFTOR.EV_MDCL_CD                 /* Code de sous-catégorie d'évaluation  !== 평가중분류코드 ==! */
	            , EVFTOR.EV_SMCL_CD                 /* Code de facteurs d'évaluation !== 평가소분류코드 ==! */
	            , EVFTOR.SYS_CLCU_YN                /* Calcul par système O/N !== 시스템계산여부 ==! */
	            , EVFTOR.EV_CO_TP_CD                /* Code de type de contrat !== 평가업체구분코드 ==! */
	            , EVSCR.EV_QRT                      /* Trimestre d'évaluation  !== 평가분기 ==! */
	            , EVSCR.EV_QRT_SRNO                 /* Numéro De Série De La Période D'Évaluation !== 평가분기일련번호 ==! */
	            , EVSCR.NIF                         /* NIF !== 납세번호 ==! */
	            , EVSCR.EV_SMCL_SCR                 /* Note de facteurs d'évaluation  !== 평가소분류점수 ==! */
	        FROM  TB_RSMI_EV_FTOR_CD EVFTOR
	            , (
	                SELECT
	                      *
	                FROM  TB_RSMI_SYS_CO_EV_SCR A
	                WHERE DEL_YN = 'N'                  /* Suppression ON !== 삭제여부 ==! */
	                AND   EV_CO_TP_CD = #{evCoTpCd}     /* Code de type de contrat !== 평가업체구분코드 ==! */
	                AND   EV_QRT = #{evQrt} 			/** Trimestre D'Évaluation  !== 평가분기 ==! */
	                AND   EV_QRT_SRNO = ( 				/* Numéro De Série De La Période D'Évaluation !== 평가분기일련번호 ==! */
						SELECT MAX(EV_QRT_SRNO)
						FROM TB_RSMI_SYS_CO_EV_SCR
						WHERE DEL_YN = 'N'
						AND EV_QRT = #{evQrt}
						AND EV_CO_TP_CD = #{evCoTpCd}
						AND NIF = #{nif}
					)
	                AND   NIF = #{nif} 					/* NIF !== 납세번호 ==! */
	            ) EVSCR
	        WHERE EVFTOR.EV_CO_TP_CD = EVSCR.EV_CO_TP_CD(+) 		/* Code de type de contrat !== 평가업체구분코드 ==! */
	        AND   EVFTOR.EV_SMCL_CD = EVSCR.EV_SMCL_CD(+) 			/* Code de facteurs d'évaluation !== 평가소분류코드 ==! */
	        AND   EVFTOR.DEL_YN = 'N' 								/* Suppression ON !== 삭제여부 ==! */
	        AND   EVFTOR.EV_CO_TP_CD = #{evCoTpCd} 					/* Code de type de contrat !== 평가업체구분코드 ==! */
	        ORDER BY EVFTOR.EV_CO_TP_CD,  EVFTOR.EV_SMCL_CD
	    ) MSTR
    </select>
    
    <!-- 
      [Consulter les détails d'évaluation des opérateurs] Consulter la liste des notes d'évaluation !== [업체평가상세조회] 평가점수 목록조회 ==!
    -->
    <select id="selectEvaluationScoreDetailChartList" 
        parameterType="alpass.ipt.rsm.lwcs.vo.RsmLwcsCoEvDtlInqtVo" 
        resultType="alpass.ipt.rsm.lwcs.vo.RsmLwcsCoEvDtlInqtVo">
        /* selectEvaluationScoreDetailChartList */
	    SELECT
	          'Q' || SUBSTR(EV_QRT, 5, 1) || ' ' ||SUBSTR(EV_QRT, 0, 4) || ' (' || EV_GD_CD || ')' AS EV_QRT /* Trimestre d'évaluation  !== 평가분기 ==! */
	        , EV_QRT AS EV_QRT2 /* Trimestre d'évaluation  !== 평가분기 ==! */
	        , EV_CO_TP_CD       /* Code de type de contrat !== 평가업체구분코드 ==!*/
	        , NIF               /* NIF !== 납세번호 ==! */
	        , EV_GD_CD          /* Code de groupe d'évaluation !== 평가등급코드 ==!*/
	        , CO_EV_SCR         /* Note d'évaluation  !== 업체평가점수 ==!*/
	    FROM  TB_RSMI_CO_EV_COMN A
	    WHERE EXISTS (
	          SELECT
	                *
	          FROM  (
	                SELECT
	                      NIF
	                    , EV_QRT AS EV_QRT
	                    , MAX(EV_QRT_SRNO) AS EV_QRT_SRNO
	                FROM  TB_RSMI_CO_EV_COMN
	                WHERE EV_CO_TP_CD = #{evCoTpCd}		/* Code de type de contrat !== 평가업체구분코드 ==! */
	                AND   NIF = #{nif} 					/* NIF !== 납세번호 ==! */
	                GROUP BY NIF, EV_QRT
	          ) B
	          WHERE A.NIF = B.NIF 						/* NIF !== 납세번호 ==! */
	          AND   A.EV_QRT = B.EV_QRT 				/* Trimestre d'évaluation  !== 평가분기 ==! */
	          AND   A.EV_QRT_SRNO = B.EV_QRT_SRNO 		/* Numéro De Série De La Période D'Évaluation !== 평가분기일련번호 ==! */
	    )
	    ORDER BY EV_QRT2
    </select>

	<!--
        [Composante détaillée du niveau de conformité] Consulter la liste des niveaux de conformité !== [법규준수도 상세 컴포넌트] 법규준수도 목록 조회 ==!
    -->
	<select id="selectCoLwcsDtlLwcsList"
		parameterType="alpass.ipt.rsm.lwcs.vo.RsmLwcsCoEvDtlInqtVo"
		resultType="alpass.ipt.rsm.lwcs.vo.RsmLwcsCoEvDtlInqtVo">
		/* selectCoLwcsDtlLwcsList */
		SELECT
	          EV_QRT                                              /* Trimestre d'évaluation  !== 평가분기 ==!*/
	        , EV_CO_TP_CD                                         /* Code de type de contrat !== 평가업체구분코드 ==!*/
	        , NIF                                                 /* NIF !== 납세번호 ==! */
	        , EV_GD_CD                                            /* Code de groupe d'évaluation !== 평가등급코드 ==!*/
			, NVL(CO_EV_SCR, 0) AS CO_EV_SCR                      /* Note d'évaluation  !== 업체평가점수 ==!*/
			, NVL(DCLR_ACDG_SCR, 0) AS DCLR_ACDG_SCR              /* Note de la précision de déclaration !== 신고정확도점수 ==!*/
			, NVL(IMPO_VLTN_MTR_SCR, 0) AS IMPO_VLTN_MTR_SCR      /* Note de l'infraction majeure  !== 중요위반사항점수 ==!*/
			, NVL(TRIF_CODG_SCR, 0) AS TRIF_CODG_SCR              /* Note de la conformité !== 관세협력도점수 ==!*/
			, NVL(EV_GD_ACML_DSTB_RT, 0) AS EV_GD_ACML_DSTB_RT    /* Taux de distribution cumulative du groupe d'évaluation !== 평가등급누적분포율 ==!*/
		    , NVL(DCLR_CNT, 0) AS DCLR_CNT                        /* Nombre de declarations !== 신고건수 ==!*/
		    , NVL(DCLR_PDLS_CNT, 0) AS DCLR_PDLS_CNT              /* Nombre d'article declare !== 신고품목건수 ==!*/
			, NVL(FRST_PAY_XAMT, 0) AS FRST_PAY_XAMT              /* Droits et taxes payes  !== 최초납부세액 ==!*/
			, NVL(ADIT_PAY_XAMT, 0) AS ADIT_PAY_XAMT              /* Droits et taxes additionnels !== 추가납부세액 ==!*/
			, NVL(LAST_PAY_XAMT, 0) AS LAST_PAY_XAMT              /* Montant definitif de droits et taxes payes !== 최종납부세액 ==!*/
			, NVL(XAMT_CHG_RT, 0) AS XAMT_CHG_RT                  /* Taux de redressement !== 세액변경율 ==!*/

	    FROM  TB_RSMI_CO_EV_COMN A
		WHERE A.DEL_YN = 'N' 						/** Suppression ON !== 삭제여부 ==! */
		<choose>
			<when test="dcerCd != null and !''.equals(dcerCd)">
				AND A.NIF = #{dcerCd}
			</when>
			<otherwise>
				AND A.NIF = #{nif} 							/* NIF !== 납세번호 ==! */
			</otherwise>
		</choose>
		ORDER BY EV_QRT DESC
		FETCH FIRST 4 ROWS ONLY
	</select>

	<!--
       [Composante détaillée du niveau de conformité] Consulter les profils des opérateurs !== 법규준수도 업체 프로파일 조회 ==!
    -->
	<select id="selectLwcsCoPrfl_backup"
		parameterType="alpass.ipt.rsm.lwcs.vo.RsmLwcsCoEvDtlInqtVo"
		resultType="alpass.ipt.rsm.prfl.vo.RsmCoPrflVo">
		/* selectLwcsCoPrfl */
		SELECT
			  A.NIF AS NIF 						/** NIF !== 납세번호 ==! */
			, DECODE(A.CO_NM, NULL, B.CONM, A.CO_NM) AS CO_NM 		/** Entreprise !== 업체명 ==! */
			, B.MN_BIZ_NM 						/** Nom De L'Activité Principale !== 주요사업명 ==! */
			, A.RPRS_TLPH_NO AS RPRS_TLPH_NO 	/** N° de telephone principale !== 대표전화번호 ==! */
			, A.CO_ADDR 						/** Adresse de l'entreprise !== 업체주소 ==! */
			, A.RPRS_EML 						/** Email Principal !== 대표이메일 ==! */
			, A.CO_TP_CD 						/** Code de type d'entreprise  !== 업체구분코드 ==! */
			, A.RPRS_FAX_NO 					/** N° de fax principal !== 대표팩스번호 ==! */
		FROM  TB_COM_CO A
		    , TB_POTE_NIF B
		WHERE A.DEL_YN = 'N' 					/** Suppression ON !== 삭제여부 ==! */
		AND B.DEL_YN(+) = 'N'
		AND A.NIF = B.NIF(+) 					/* NIF !== 납세번호 ==! */
		AND A.NIF = #{nif}
	</select>

	<!--
       [Composante détaillée du niveau de conformité] Consulter les profils des opérateurs !== [법규준수도 상세 컴포넌트] 업체 프로파일 조회 ==!
    -->
	<select id="selectLwcsCoPrfl"
			parameterType="alpass.ipt.rsm.lwcs.vo.RsmLwcsCoEvDtlInqtVo"
			resultType="alpass.ipt.rsm.prfl.vo.RsmCoPrflVo">
		SELECT * FROM (
			SELECT
					  A.NIF AS NIF 			/** NIF !== 납세식별번호 ==! */
					, A.CO_NM 				/** Entreprise !== 업체명 ==! */
					, '' AS MN_BIZ_NM 		/** Nom De L'Activité Principale !== 주요사업명 ==! */
					, A.RPRS_TLPH_NO AS RPRS_TLPH_NO 		/** N° de telephone principale !== 대표전화번호 ==! */
					, A.CO_ADDR 			/** Adresse de l'entreprise !== 업체주소 ==! */
					, A.RPRS_EML 			/** Email Principal !== 대표이메일 ==! */
					, A.CO_TP_CD 			/** Code de type d'entreprise  !== 업체구분코드 ==! */
					, A.RPRS_FAX_NO 		/** N° de fax principal !== 대표팩스번호 ==! */
				FROM  TB_COM_CO A
				WHERE A.DEL_YN = 'N' 		/** Suppression ON !== 삭제여부 ==! */
				AND A.NIF = #{nif} 			/** NIF !== 납세번호 ==! */
			UNION ALL
			SELECT
					  A.NIF AS NIF
					, A.CO_NM
					, A.MN_BIZ_NM
					, '' AS RPRS_TLPH_NO
					, A.CO_DTL_ADDR AS CO_ADDR
					, '' AS RPRS_EML
					, '' AS CO_TP_CD
					, '' AS RPRS_FAX_NO
				FROM  TB_POTE_NIF A
				WHERE A.DEL_YN = 'N' 		/** Suppression ON !== 삭제여부 ==! */
				AND A.NIF = #{nif} 			/** NIF !== 납세번호 ==! */
		) WHERE ROWNUM = 1
	</select>

</mapper>