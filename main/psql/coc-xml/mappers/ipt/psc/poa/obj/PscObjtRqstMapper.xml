<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="alpass.ipt.psc.poa.obj.mapper.PscObjtRqstMapper">
    <select id="selectPscObjtRqstList" parameterType ="alpass.ipt.psc.poa.obj.vo.PscObjtRqstVo"  resultType="alpass.ipt.psc.poa.obj.vo.PscObjtRqstVo">
        /* selectPscObjtRqstList : Consulter la liste des recours formulés !==이의신청 목록조회==! */
        <include refid="pagination.header" />
        SELECT
            OBJT_RQST_NO,
            OBJT_RQST_KND_CD,
            OBJT_RQST_DGCNT,
            RQST_DT,
            FRST_REGST_ID,
            RQST_CSTM_CD,
            DEPT_CD,
            RELA_BSOP_CD,
            RELA_BSOP_RQST_NO,
            OBJT_RQST_TTLE_NM,
            OBJT_RQST_CN,
            OBJT_RQST_ANPN_ID,
            OBJT_RQST_ANSW_CN,
            PRCS_STTS_CD,
            PSNR_FMNM,
            PSNR_GVNM_NM,
            ATCH_FILE_ID,
            APRV_ID,
            DEL_YN,
            ANSW_DT
        FROM
        (
            SELECT
                ROW_NUMBER() OVER(PARTITION BY A.OBJT_RQST_NO ORDER BY A.OBJT_RQST_DGCNT DESC )RN,
                A.OBJT_RQST_NO,
                A.OBJT_RQST_KND_CD,
                A.OBJT_RQST_DGCNT,
                TO_CHAR(TO_DATE(A.RQST_DT, 'YYYYMMDD'), 'DD/MM/YYYY') RQST_DT,
                A.FRST_REGST_ID,
                A.RQST_CSTM_CD,
                A.DEPT_CD,
                A.RELA_BSOP_CD,
                A.RELA_BSOP_RQST_NO,
                A.OBJT_RQST_TTLE_NM,
                A.OBJT_RQST_CN,
                A.OBJT_RQST_ANPN_ID,
                A.OBJT_RQST_ANSW_CN,
                CASE WHEN A.PRCS_STTS_CD in ('I01','I04','I05','I06') THEN 'C' ELSE A.PRCS_STTS_CD END PRCS_STTS_CD,
                A.PSNR_FMNM,
                A.PSNR_GVNM_NM,
                A.ATCH_FILE_ID,
                A.APRV_ID,
                A.DEL_YN,
                TO_CHAR(TO_DATE(A.ANSW_DT, 'YYYYMMDD'), 'DD/MM/YYYY') ANSW_DT
            FROM ALPASSINT.TB_PSCI_OBJT_RQST_AUDT A
            WHERE 1=1
            AND A.DEL_YN = 'N'
            <if test="@org.apache.commons.lang3.StringUtils@isNotBlank(rqstDtFrom)">
                <if test="@org.apache.commons.lang3.StringUtils@isNotBlank(rqstDtTo)">
                    AND A.RQST_DT BETWEEN TO_CHAR(TO_DATE(#{rqstDtFrom}, 'DD/MM/YYYY'), 'YYYYMMDD')  AND TO_CHAR(TO_DATE(#{rqstDtTo}, 'DD/MM/YYYY'), 'YYYYMMDD')
                </if>
            </if>
            <if test="@org.apache.commons.lang3.StringUtils@isNotBlank(objtRqstKndCd)">
                AND A.OBJT_RQST_KND_CD = #{objtRqstKndCd}
            </if>
            <if test="@org.apache.commons.lang3.StringUtils@isNotBlank(objtRqstNo)">
                AND UPPER(A.OBJT_RQST_NO) LIKE '%' || UPPER(REPLACE(#{objtRqstNo},'-','')) || '%'
            </if>
            <if test="@org.apache.commons.lang3.StringUtils@isNotBlank(relaBsopRqstNo)">
                AND UPPER(A.RELA_BSOP_RQST_NO) LIKE '%' || UPPER(#{relaBsopRqstNo}) || '%'
            </if>
            <if test="@org.apache.commons.lang3.StringUtils@isNotBlank(prcsSttsCd)">
                AND A.PRCS_STTS_CD =#{prcsSttsCd}
            </if>
            <if test="@org.apache.commons.lang3.StringUtils@isNotBlank(relaBsopCd)">
                AND A.RELA_BSOP_CD =#{relaBsopCd}
            </if>
            <if test="@org.apache.commons.lang3.StringUtils@isNotBlank(rqstCstmCd)">
                AND A.RQST_CSTM_CD =#{rqstCstmCd}
            </if>
            ORDER BY RQST_DT DESC,OBJT_RQST_NO DESC ,PRCS_STTS_CD
        )
        WHERE RN =1
        <include refid="pagination.footer" />
    </select>

    <select id="selectPscObjtRqstDtl" parameterType ="alpass.ipt.psc.poa.obj.vo.PscObjtRqstVo"  resultType="alpass.ipt.psc.poa.obj.vo.PscObjtRqstVo">
        /* selectPscObjtRqstDtl : Consulter la Formuler un recours !==이의신청 상세조회==! */
        SELECT
            A.OBJT_RQST_NO,
            A.OBJT_RQST_KND_CD,
            A.OBJT_RQST_DGCNT,
            TO_CHAR(TO_DATE(A.RQST_DT, 'YYYYMMDD'), 'DD/MM/YYYY') RQST_DT,
            A.FRST_REGST_ID,
            A.RQST_CSTM_CD,
            A.DEPT_CD,
            A.RELA_BSOP_CD,
            A.RELA_BSOP_RQST_NO,
            A.OBJT_RQST_TTLE_NM,
            A.OBJT_RQST_CN,
            A.OBJT_RQST_ANPN_ID,
            A.OBJT_RQST_ANSW_CN,
            A.PRCS_STTS_CD,
            A.PSNR_FMNM,
            A.PSNR_GVNM_NM,
            A.ATCH_FILE_ID,
            A.APRV_ID,
            A.DEL_YN,
            TO_CHAR(TO_DATE(A.ANSW_DT, 'YYYYMMDD'), 'DD/MM/YYYY') ANSW_DT,
            A.SPLM_QRY_CN
        FROM ALPASSINT.TB_PSCI_OBJT_RQST_AUDT A
        WHERE 1=1
        AND A.OBJT_RQST_NO = #{objtRqstNo}
        AND A.OBJT_RQST_DGCNT = #{objtRqstDgcnt}
    </select>

    <update id="updatePsceObjtRqst" parameterType ="alpass.ipt.psc.poa.obj.vo.PscObjtRqstVo">
        UPDATE ALPASSINT.TB_PSCI_OBJT_RQST_AUDT
        SET PRCS_STTS_CD = #{prcsSttsCd},
            <if test='prcsSttsCd.equals("C")'>
                OBJT_RQST_ANPN_ID = #{objtRqstAnpnId},
                OBJT_RQST_ANSW_CN = #{objtRqstAnswCn},
            </if>
            <if test='prcsSttsCd.equals("I01")'>
                OBJT_RQST_ANSW_CN = #{objtRqstAnswCn},
                APRV_ID = #{aprvId},
            </if>
            <if test='prcsSttsCd.equals("D")'>
                ANSW_DT = TO_CHAR(TO_DATE(#{answDt}, 'DD/MM/YYYY'), 'YYYYMMDD'),
                OBJT_RQST_ANSW_CN = #{objtRqstAnswCn},
            </if>
            <if test='prcsSttsCd.equals("F")'>
                SPLM_QRY_CN = #{splmQryCn},
                OBJT_RQST_ANPN_ID = #{objtRqstAnpnId},
            </if>
            LAST_CHPR_ID = #{lastChprId},                /** Id Du Modificateur Final !== 최종변경자ID ==! */
            LAST_CHG_DTTM = SYSTIMESTAMP                 /** Date Et Heure De Modification Finale !== 최종변경일시 ==! */
        WHERE OBJT_RQST_NO = #{objtRqstNo} AND OBJT_RQST_DGCNT =#{objtRqstDgcnt}
    </update>

    <update id="updatePsciObjtRqstAudt" parameterType ="alpass.ipt.psc.poa.obj.vo.PscObjtRqstVo">
      WITH upset AS (
          UPDATE ALPASSINT.TB_PSCI_OBJT_RQST_AUDT
          SET PRCS_STTS_CD = #{prcsSttsCd},
              <if test='prcsSttsCd.equals("C")'>
                  OBJT_RQST_ANPN_ID = #{objtRqstAnpnId},
                  OBJT_RQST_ANSW_CN = #{objtRqstAnswCn},
              </if>
              <if test='prcsSttsCd.equals("I01")'>
                  OBJT_RQST_ANSW_CN = #{objtRqstAnswCn},
                  APRV_ID = #{aprvId},
              </if>
              <if test='prcsSttsCd.equals("D")'>
                  ANSW_DT = TO_CHAR(TO_DATE(#{answDt}, 'DD/MM/YYYY'), 'YYYYMMDD'),
                  OBJT_RQST_ANSW_CN = #{objtRqstAnswCn},
              </if>
              <if test='prcsSttsCd.equals("F")'>
                  SPLM_QRY_CN = #{splmQryCn},
                  OBJT_RQST_ANPN_ID = #{objtRqstAnpnId},
              </if>
              DEL_YN = 'N',
              LAST_CHPR_ID = #{lastChprId},                /** Id Du Modificateur Final !== 최종변경자ID ==! */
              LAST_CHG_DTTM = SYSTIMESTAMP                 /** Date Et Heure De Modification Finale !== 최종변경일시 ==! */
          WHERE OBJT_RQST_NO = #{objtRqstNo} AND OBJT_RQST_DGCNT =#{objtRqstDgcnt}
          RETURNING *
      )
      INSERT INTO ALPASSINT.TB_PSCI_OBJT_RQST_AUDT
      (
          OBJT_RQST_NO,
          OBJT_RQST_KND_CD,
          OBJT_RQST_DGCNT,
    <if test='prcsSttsCd.equals("C")'>
          OBJT_RQST_ANPN_ID ,
          OBJT_RQST_ANSW_CN,
    </if>
    <if test='prcsSttsCd.equals("I01")'>
          OBJT_RQST_ANSW_CN ,
          APRV_ID,
    </if>
    <if test='prcsSttsCd.equals("D")'>
          ANSW_DT,
          OBJT_RQST_ANSW_CN,
    </if>
    <if test='prcsSttsCd.equals("F")'>
          SPLM_QRY_CN,
          OBJT_RQST_ANPN_ID,
    </if>
          DEL_YN,
          FRST_REGST_ID,
          FRST_RGSR_DTTM,
          LAST_CHPR_ID,
          LAST_CHG_DTTM
      )
      SELECT
          #{objtRqstNo},
          #{objtRqstKndCd},
          #{objtRqstDgcnt},
        <if test='prcsSttsCd.equals("C")'>
          #{objtRqstAnpnId},
          #{objtRqstAnswCn},
        </if>
        <if test='prcsSttsCd.equals("I01")'>
          #{objtRqstAnswCn},
          #{aprvId},
        </if>
        <if test='prcsSttsCd.equals("D")'>
           TO_CHAR(TO_DATE(#{answDt}, 'DD/MM/YYYY'), 'YYYYMMDD'),
           #{objtRqstAnswCn},
        </if>
        <if test='prcsSttsCd.equals("F")'>
           #{splmQryCn},
           #{objtRqstAnpnId},
        </if>
          'N',
          #{frstRegstId},
          systimestamp,
          #{lastChprId},
          systimestamp
          WHERE NOT EXISTS(SELECT * FROM upset)
    </update>

    <select id="selectPscObjtRqstMdfyDgcnt" parameterType ="alpass.ipt.psc.poa.obj.vo.PscObjtRqstVo" resultType="int">
        SELECT NVL(MAX(OBJT_RQST_DGCNT),1) OBJT_RQST_DGCNT FROM  ALPASSINT.TB_PSCI_OBJT_RQST_AUDT WHERE OBJT_RQST_NO = #{objtRqstNo}
    </select>

    <insert id="insertPscObjtRqstAudtPrcsBkrd" parameterType ="alpass.ipt.psc.poa.obj.vo.PscObjtRqstVo">
        /*insertPscObjtRqstAudtPrcsBkrd : historical */
        <selectKey keyProperty="prcsSrno" order="BEFORE" resultType="java.math.BigDecimal">
            SELECT NVL(MAX(PRCS_SRNO),0)+1 FROM ALPASSINT.TB_PSCI_OBJT_RQST_AUDT_PRCS_BRKD WHERE OBJT_RQST_NO = #{objtRqstNo}
        </selectKey>
        INSERT INTO ALPASSINT.TB_PSCI_OBJT_RQST_AUDT_PRCS_BRKD
        (
        OBJT_RQST_NO,
        OBJT_RQST_KND_CD,
        OBJT_RQST_DGCNT,
        PRCS_SRNO,
        PRCS_STTS_CD,
        PRCS_DTRM_DTTM,
        PRCS_STTS_CN,
        DEL_YN,
        FRST_REGST_ID,
        FRST_RGSR_DTTM,
        LAST_CHPR_ID,
        LAST_CHG_DTTM
        )
        VALUES
        (
        #{objtRqstNo},
        #{objtRqstKndCd},
        #{objtRqstDgcnt},
        #{prcsSrno},
        #{prcsSttsCd},
        SYSTIMESTAMP,
        #{prcsSttsCn},
        'N',
        #{frstRegstId},
        SYSTIMESTAMP,
        #{lastChprId},
        SYSTIMESTAMP
        )
    </insert>

    <select id="selectPscObjtRqstAudtPrcsBrkdList" parameterType ="alpass.ipt.psc.poa.obj.vo.PscObjtRqstVo"  resultType="alpass.ipt.psc.poa.obj.vo.PscObjtRqstVo">
        SELECT
            OBJT_RQST_NO,
            OBJT_RQST_KND_CD,
            OBJT_RQST_DGCNT,
            PRCS_SRNO,
            PRCS_STTS_CD,
            TO_CHAR(PRCS_DTRM_DTTM,'DD/MM/YYYY HH24:MI:SS') PRCS_DTRM_DTTM,
            PRCS_STTS_CN,
            DEL_YN
        FROM ALPASSINT.TB_PSCI_OBJT_RQST_AUDT_PRCS_BRKD
        WHERE OBJT_RQST_NO = #{objtRqstNo}
    </select>


    <select id="selectPsnrInfoDetail" parameterType ="alpass.ipt.psc.poa.obj.vo.PscObjtRqstVo"  resultType="alpass.ipt.psc.poa.obj.vo.PscObjtRqstVo">

        SELECT * FROM 
                    (
                    SELECT FRST_REGST_ID 
                    , FN_GET_CD_VDVAL_NM('PSC_0056', OBJT_RQST_KND_CD, 'FR') AS OBJT_RQST_KND_NM   
                    FROM ALPASSINT.TB_PSCI_OBJT_RQST_AUDT  
                    WHERE 1=1
                    AND OBJT_RQST_NO = #{objtRqstNo}
                  
                    ) BSCS
                    ,
                    (
                         SELECT USER_ID , USER_NM , TLPH_NO , EML , EML_RCPN_YN , SMS_RCPN_YN 
                         FROM ALPASSINT.TB_COM_CO_USER
                         WHERE DEL_YN = 'N'
                         UNION ALL 
                             
                         SELECT USER_ID ,USER_NM , TLPH_NO , EML , EML_RCPN_YN , SMS_RCPN_YN 
                         FROM ALPASSEXT.TB_POTE_PSN_USER
                         WHERE DEL_YN = 'N'
                      
                    )INFO
                    WHERE BSCS.FRST_REGST_ID = INFO.USER_ID;
    </select>





</mapper>
