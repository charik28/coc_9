<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >

<mapper namespace="alpass.ipt.clr.trm.cpc.mapper.ClrApcMgmtEpcApcMpngMapper">

    <select id="selectClrApcMgmtEpcApcMpngList" parameterType="alpass.ipt.clr.trm.cpc.vo.ClrTrmApcMgmtEpcApcMpngVo" resultType="alpass.ipt.clr.trm.cpc.vo.ClrTrmApcMgmtEpcApcMpngVo">
        /* selectClrApcMgmtEpcApcMpngList : EPC별 APC 매핑 관리 목록 조회 */
        <include refid="pagination.header" />
        SELECT
        BB.EPC_CD                     /** Code EPC !== EPC코드 ==! */
        , AA.EPC_NM                     /** Nom de l'EPC !== EPC명 ==! */
        , BB.APC_CD                     /** Code APC !== APC코드 ==! */
        , CC.APC_NM                     /** Nom de l'APC !== APC명 ==! */
        , BB.USE_YN
        , TO_CHAR(TO_DATE(AA.EPC_APLY_STRT_DT, 'YYYYMMDD'), 'DD/MM/YYYY') EPC_APLY_STRT_DT
        , TO_CHAR(TO_DATE(AA.EPC_APLY_END_DT, 'YYYYMMDD'), 'DD/MM/YYYY') EPC_APLY_END_DT
        , TO_CHAR(TO_DATE(BB.MPNG_APLY_STRT_DT, 'YYYYMMDD'), 'DD/MM/YYYY') MPNG_APLY_STRT_DT
        , TO_CHAR(TO_DATE(BB.MPNG_APLY_END_DT, 'YYYYMMDD'), 'DD/MM/YYYY') MPNG_APLY_END_DT
        , BB.REGM_PERM_NEED_YN
        , BB.REGM_MDL_CD
        , BB.FFMN_TRGT_YN
        FROM   TB_CLRI_EPC_CD AA
        , TB_CLRI_EPC_APC_CD_MPNG_BRKD BB
        , TB_CLRI_APC_CD CC
        WHERE  AA.EPC_CD = BB.EPC_CD
        AND  BB.APC_CD = CC.APC_CD
        AND AA.EPC_APLY_STRT_DT = BB.EPC_APLY_STRT_DT
        <if test="epcCd != null and epcCd !=''">
            AND  BB.EPC_CD = #{epcCd}                         	 /** Code EPC !== EPC코드 ==! */
        </if>
        <if test="apcCd != null and apcCd !=''">
            AND BB.APC_CD = #{apcCd}                         	 /** Code APC !== APC코드 ==! */
        </if>
        AND  AA.DEL_YN = 'N'                                /** Suppression ON !== 삭제여부 ==! */
        AND  BB.DEL_YN = 'N'                                /** Suppression ON !== 삭제여부 ==! */
        AND  CC.DEL_YN = 'N'                                /** Suppression ON !== 삭제여부 ==! */
        ORDER BY BB.EPC_CD, BB.APC_CD
        <include refid="pagination.footer" />
    </select>

    <select id="selectClrApcMgmtEpcApcMpngApcList" parameterType="alpass.ipt.clr.trm.cpc.vo.ClrTrmApcMgmtEpcApcMpngVo" resultType="alpass.ipt.clr.trm.cpc.vo.ClrTrmApcMgmtEpcApcMpngVo">
        /* selectClrApcMgmtEpcApcMpngApcList : EPC별 APC 매핑 관리 APC 목록 조회*/
        SELECT
            ROW_NUMBER() OVER(ORDER BY BB.APC_CD) AS RNUM
            , BB.EPC_CD                     /** Code EPC !== EPC코드 ==! */
             , AA.EPC_NM                     /** Nom de l'EPC !== EPC명 ==! */
             , BB.APC_CD                     /** Code APC !== APC코드 ==! */
             , CC.APC_NM                     /** Nom de l'APC !== APC명 ==! */
             , BB.USE_YN
             , TO_CHAR(TO_DATE(AA.EPC_APLY_STRT_DT, 'YYYYMMDD'), 'DD/MM/YYYY') EPC_APLY_STRT_DT
             , TO_CHAR(TO_DATE(AA.EPC_APLY_END_DT, 'YYYYMMDD'), 'DD/MM/YYYY') EPC_APLY_END_DT
             , TO_CHAR(TO_DATE(BB.MPNG_APLY_STRT_DT, 'YYYYMMDD'), 'DD/MM/YYYY') MPNG_APLY_STRT_DT
             , TO_CHAR(TO_DATE(BB.MPNG_APLY_END_DT, 'YYYYMMDD'), 'DD/MM/YYYY') MPNG_APLY_END_DT
             , CASE WHEN MPNG_APLY_STRT_DT > TO_CHAR(CURRENT_DATE,'YYYYMMDD') THEN 'N' ELSE 'Y' END MPNG_STRT_YN
             , CASE WHEN MPNG_APLY_END_DT > TO_CHAR(CURRENT_DATE,'YYYYMMDD') THEN 'N' ELSE 'Y' END MPNG_END_YN
             , 'Y' FIX_YN
             , BB.REGM_PERM_NEED_YN
             , BB.REGM_MDL_CD
             , BB.FFMN_TRGT_YN
        FROM   TB_CLRI_EPC_CD AA
           , TB_CLRI_EPC_APC_CD_MPNG_BRKD BB
           , TB_CLRI_APC_CD CC
        WHERE  AA.EPC_CD = BB.EPC_CD
          AND  BB.APC_CD = CC.APC_CD
          AND  AA.EPC_APLY_STRT_DT = BB.EPC_APLY_STRT_DT
          AND  BB.EPC_CD = #{epcCd}                         	 /** Code EPC !== EPC코드 ==! */
          AND  BB.EPC_APLY_STRT_DT = TO_CHAR(TO_DATE(#{epcAplyStrtDt}, 'DD/MM/YYYY'), 'YYYYMMDD')
          AND  AA.DEL_YN = 'N'                                /** Suppression ON !== 삭제여부 ==! */
          AND  BB.DEL_YN = 'N'                                /** Suppression ON !== 삭제여부 ==! */
          AND  CC.DEL_YN = 'N'                                /** Suppression ON !== 삭제여부 ==! */
    </select>

    <select id="selectClrApcMgmtEpcApcMpngEpcDupCheck" parameterType="alpass.ipt.clr.trm.cpc.vo.ClrTrmApcMgmtEpcApcMpngVo" resultType="int">
        /* selectClrApcMgmtEpcApcMpngEpcDupCheck : EPC별 APC 매핑 관리 EPC 중복 체크  */
        SELECT
            COUNT(AA.EPC_CD) AS CNT                        /** Code EPC !== EPC코드 ==! */
        FROM  TB_CLRI_EPC_APC_CD_MPNG_BRKD AA
        WHERE  AA.EPC_CD = #{epcCd}                         	 /** Code EPC !== EPC코드 ==! */
          AND  AA.APC_CD = #{apcCd}
          AND  AA.DEL_YN = 'N'                                /** Suppression ON !== 삭제여부 ==! */
          AND  AA.EPC_APLY_STRT_DT = TO_CHAR(TO_DATE(#{epcAplyStrtDt}, 'DD/MM/YYYY'), 'YYYYMMDD')
          AND ( TO_CHAR(TO_DATE(#{mpngAplyStrtDt}, 'DD/MM/YYYY'), 'YYYYMMDD') BETWEEN   MPNG_APLY_STRT_DT AND  MPNG_APLY_END_DT
            OR TO_CHAR(TO_DATE(#{mpngAplyEndDt}, 'DD/MM/YYYY'), 'YYYYMMDD') BETWEEN   MPNG_APLY_STRT_DT AND  MPNG_APLY_END_DT)
    </select>

    <select id="selectClrApcMgmtEpcApcMpngApcCheck" parameterType="alpass.ipt.clr.trm.cpc.vo.ClrTrmApcMgmtEpcApcMpngVo" resultType="int">
        /* selectClrApcMgmtEpcApcMpngApcCheck :EPC별 APC매핑 관리 APC 유효성 체크 */
        SELECT
            COUNT(AA.APC_CD) AS CNT
        FROM  TB_CLRI_APC_CD AA
        WHERE  AA.APC_CD = #{apcCd}                                  /** Code APC !== APC코드 ==! */
          AND  AA.DEL_YN = 'N'                                       /** Suppression ON !== 삭제여부 ==! */
    </select>

    <update id="updateClrApcMgmtEpcApcMpngDBefore" parameterType="alpass.ipt.clr.trm.cpc.vo.ClrTrmApcMgmtEpcApcMpngVo">
        /* updateClrApcMgmtEpcApcMpngDBefore : EPC별 APC매핑 관리 이전데이터 삭제 */
        UPDATE  TB_CLRI_EPC_APC_CD_MPNG_BRKD SET
        <trim prefixOverrides="," >
            DEL_YN = 'Y'                                /** Suppression ON !== 삭제여부 ==! */
            , LAST_CHPR_ID = #{lastChprId}                /** ID du modificateur final !== 최종변경자ID ==! */
            , LAST_CHG_DTTM = SYSTIMESTAMP                /** Date et heure de modification finale !== 최종변경일시 ==! */
        </trim>
        WHERE  DEL_YN = 'N'                                /** Suppression ON !== 삭제여부 ==! */
        AND  EPC_CD = #{epcCd}                           /** Code EPC !== EPC코드 ==! */
        AND  EPC_APLY_STRT_DT = TO_CHAR(TO_DATE(#{epcAplyStrtDt}, 'DD/MM/YYYY'), 'YYYYMMDD')
    </update>

    <update id="mergeClrApcMgmtEpcApcMpng" parameterType="alpass.ipt.clr.trm.cpc.vo.ClrTrmApcMgmtEpcApcMpngVo">
        /* mergeClrApcMgmtEpcApcMpng : EPC별 APC 매핑 관리 등록 및 수정*/
        WITH UPSET AS
            (
                UPDATE TB_CLRI_EPC_APC_CD_MPNG_BRKD M
                SET MPNG_APLY_END_DT = TO_CHAR(TO_DATE(#{mpngAplyEndDt}, 'DD/MM/YYYY'), 'YYYYMMDD'),
                    USE_YN = #{useYn},
                    DEL_YN = 'N',
                    REGM_PERM_NEED_YN = #{regmPermNeedYn},
                    REGM_MDL_CD = #{regmMdlCd},
                    FFMN_TRGT_YN = #{ffmnTrgtYn},
                    LAST_CHPR_ID = #{lastChprId},
                    LAST_CHG_DTTM = SYSDATE
                WHERE EPC_CD = #{epcCd}
                  AND APC_CD = #{apcCd}
                  AND EPC_APLY_STRT_DT = TO_CHAR(TO_DATE(#{epcAplyStrtDt}, 'DD/MM/YYYY'), 'YYYYMMDD')
                  AND MPNG_APLY_STRT_DT = TO_CHAR(TO_DATE(#{mpngAplyStrtDt}, 'DD/MM/YYYY'), 'YYYYMMDD')
                    RETURNING M.*
            )
        INSERT INTO TB_CLRI_EPC_APC_CD_MPNG_BRKD
                (EPC_CD
                ,APC_CD
                ,EPC_APLY_STRT_DT
                ,MPNG_APLY_STRT_DT
                ,MPNG_APLY_END_DT
                ,REGM_PERM_NEED_YN
                ,REGM_MDL_CD
                ,FFMN_TRGT_YN
                ,USE_YN
                ,DEL_YN
                ,FRST_REGST_ID
                ,FRST_RGSR_DTTM
                ,LAST_CHPR_ID
                ,LAST_CHG_DTTM
                )
        SELECT
              #{epcCd}
             ,#{apcCd}
             ,TO_CHAR(TO_DATE(#{epcAplyStrtDt}, 'DD/MM/YYYY'), 'YYYYMMDD')
             ,TO_CHAR(TO_DATE(#{mpngAplyStrtDt}, 'DD/MM/YYYY'), 'YYYYMMDD')
             ,TO_CHAR(TO_DATE(#{mpngAplyEndDt}, 'DD/MM/YYYY'), 'YYYYMMDD')
             ,#{regmPermNeedYn}
             ,#{regmMdlCd}
             ,#{ffmnTrgtYn}
             ,#{useYn}
             ,'N'
             ,#{frstRegstId}
             ,SYSDATE
             ,#{lastChprId}
             ,SYSDATE
        WHERE NOT EXISTS( SELECT * FROM UPSET)
    </update>



</mapper>