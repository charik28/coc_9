<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >

<mapper namespace="alpass.ipt.col.affc.mapper.ColAffcPayMgMgmtMapper">

    <!--
    Consulter la liste de la gestion des crédits d'enlèvement !== 사후 납부 담보 관리 목록을 조회한다 ==!
    -->
    <select id="selectAffcPayMgMgmtLst" parameterType="alpass.ipt.col.affc.vo.ColAffcPayMgMgmtVo" resultType="alpass.ipt.col.affc.vo.ColAffcPayMgMgmtVo">
        /** colAffcPayMgMgmt_selectAffcPayMgMgmtLst **/
        <include refid="pagination.header" />
        SELECT
            A.MG_NO                      /** N° de caution !== 담보번호 ==! */
            , A.NIF                        /** NIF !== 납세번호 ==! */
            , TO_CHAR(TO_DATE(A.VALD_STRT_DT, 'YYYYMMDD'),'DD/MM/YYYY') VALD_STRT_DT       /** Date du debut de validite !== 유효시작일자 ==! */
            , TO_CHAR(TO_DATE(A.VALD_END_DT, 'YYYYMMDD'),'DD/MM/YYYY') VALD_END_DT         /** Date de la fin de validite !== 유효종료일자 ==! */
            , A.REGST_ID                   /** ID de la personne enregistrant !== 등록자ID ==! */
            , TO_CHAR(TO_DATE(A.RGSR_DT, 'YYYYMMDD'),'DD/MM/YYYY') RGSR_DT                 /** Date de l'enregistrement !== 등록일자 ==! */
            , A.MG_EXTN_YN                 /** Caution cloturee (ON) !== 담보소멸여부 ==! */
            , TO_CHAR(TO_DATE(A.MG_EXTN_DT, 'YYYYMMDD'),'DD/MM/YYYY')  MG_EXTN_DT           /** Date de cloture de caution !== 담보소멸일자 ==! */
            , TO_CHAR(TO_DATE(A.MG_RELE_CRPP_PBLS_DT, 'YYYYMMDD'),'DD/MM/YYYY') MG_RELE_CRPP_PBLS_DT       /** Date de délivrance du certificat de décharge !== 담보해제증명서발행일자 ==! */
            , A.MG_RELE_CRPP_PBLH_ID       /** ID de personne délivrant le certificat de décharge !== 담보해제증명서발행자ID ==! */
            , A.MG_VALD_STTS_CD            /** Statut de validité !== 담보유효상태코드 ==! */
            , A.ATCH_FILE_ID               /** Date et heure de modification finale !== 첨부파일ID ==! */
            , A.DEL_YN                     /** Suppression ON !== 삭제여부 ==! */
            , A.FRST_REGST_ID              /** ID du premier enregistrant  !== 최초등록자ID ==! */
      , A.FRST_RGSR_DTTM /** Date et heure de premier enregistrement !== 최초등록일시 ==! */
      , A.LAST_CHPR_ID /** ID du modificateur final !== 최종변경자ID ==! */
      , A.LAST_CHG_DTTM /** Date et heure de modification finale !== 최종변경일시 ==! */
      , TO_CHAR(TO_DATE(A.VALD_STRT_DT, 'YYYYMMDD'),'DD/MM/YYYY')||' ~
      '||TO_CHAR(TO_DATE(A.VALD_END_DT, 'YYYYMMDD'),'DD/MM/YYYY') AS VALD_PRID /** Durée de validité
      de la caution !==담보유효기간==! */
      , A.REFS_YN
      , A.CSTM_WRTE_CN
      , A.RQST_NO
      , A.DEPT_CD
      , (SELECT ORGN_NM FROM TB_POTI_ORGN WHERE ORGN_CD = UPPER(A.DEPT_CD) AND DEL_YN = 'N') AS
      DEPT_NM
      , A.BNK_CD
      , A.BNK_BRNH_CD
      , A.BNK_BRNH_ADDR_NM
      , A.CO_ADDR
      , A.JOB_NM
      , A.RPPN_FNM
      , A.RPPN_NM
      , A.DBTR_NM
      , TO_CHAR(TO_DATE(A.RQST_DT, 'YYYYMMDD'),'DD/MM/YYYY') AS RQST_DT
      , A.PRCS_STTS_CD
      , A.MG_RTRN_RSN_CD
      , A.APRV_ID
      , A.CO_NM
            , (SELECT BNK_NM FROM TB_COM_BNK_CD WHERE DEL_YN = 'N' AND BNK_CD = A.BNK_CD) AS FNNC_ITT_NM     /** Nom de l'institution financière !== 금융기관명 ==! */
            , (SELECT MG_LMT_AMT FROM TB_COLI_MG_USE WHERE RQST_NO = A.RQST_NO AND ROWNUM = 1) AS MG_RQST_TAMT       /** Montant global de la soumission annuelle !== 담보총금액 ==! */
            , NVL(A.MG_AMT,0.0) AS MG_AMT      /** Montant de caution !== 담보금액 ==! */
            , FN_GET_ORGN_NM(A.CSTM_CD) AS CSTM_NM
            , A.CSTM_CD
            , (SELECT B.ORGN_CD FROM    TB_POTI_ORGN B, TB_POTI_ORGN C
                                WHERE   C.UPR_ORGN_MGMT_CD = B.ORGN_MGMT_CD
                                    AND C.ORGN_CD = A.CSTM_CD
                                    AND B.DEL_YN            = 'N'
                                    AND C.DEL_YN            = 'N'
            ) AS SCTR_CD
            , (SELECT B.ORGN_NM FROM TB_POTI_ORGN B, TB_POTI_ORGN C
                                WHERE   C.UPR_ORGN_MGMT_CD = B.ORGN_MGMT_CD
                                    AND C.ORGN_CD           = A.CSTM_CD
                                    AND B.DEL_YN            = 'N'
                                    AND C.DEL_YN            = 'N'
            ) AS SCTR_NM
            , A.CESE_CN
            , A.DCLR_NO
            , TO_CHAR(TO_DATE(A.DCLR_DT, 'YYYYMMDD'),'DD/MM/YYYY') AS DCLR_DT
            , (SELECT DEPT_CD FROM TB_CLRI_DED_COMN B WHERE DEL_YN ='N' AND B.DTL_DCSH_NO = A.DCLR_NO ) DCLR_DEPT_CD
            , A.MG_PT_CD
            , A.MG_TP_CD
            , A.RTRN_RSN_CN
            , CASE WHEN A.PRCS_STTS_CD = '06' THEN TO_CHAR(TO_DATE(A.MG_EXTN_DT, 'YYYYMMDD'),'DD/MM/YYYY')
                    ELSE NULL
                END AS DSMS_DT          /*기각일자*/
        FROM   TB_COLI_MG A
        WHERE   A.DEL_YN = 'N'                /** Suppression ON !== 삭제여부 ==! */
        AND     A.PRCS_STTS_CD != '00'        /*임시저장일 경우 제외*/
        <if test="sctrCd != null and sctrCd != ''">
            AND  A.CSTM_CD LIKE SUBSTRING(#{sctrCd},1,3) || '%'
        </if>
        <if test='cstmCd != null and cstmCd !=""'>
            AND  A.CSTM_CD = #{cstmCd}
        </if>
        <if test='deptCd != null and deptCd !=""'>
            AND  (A.DEPT_CD = #{deptCd} OR A.DEPT_CD IN (SELECT ORGN_CD FROM TB_POTI_ORGN WHERE (SELECT ACTV_CSTM_CD FROM TB_POTI_ORGN WHERE ORGN_CD = #{deptCd}) LIKE '%'||ORGN_MGMT_CD||'%')
            OR A.DEPT_CD IN (SELECT ORGN_CD FROM TB_POTI_ORGN WHERE ORGN_MGMT_CD IN (SELECT UNNEST(STRING_TO_ARRAY(ACTV_CSTM_CD,'|')) FROM TB_POTI_ORGN WHERE ORGN_MGMT_CD IN (SELECT UNNEST(STRING_TO_ARRAY(ACTV_CSTM_CD,'|')) FROM TB_POTI_ORGN WHERE ORGN_CD = #{deptCd}))
                                                              OR UPR_ORGN_MGMT_CD IN (SELECT UNNEST(STRING_TO_ARRAY(ACTV_CSTM_CD,'|')) FROM TB_POTI_ORGN WHERE ORGN_MGMT_CD IN (SELECT UNNEST(STRING_TO_ARRAY(ACTV_CSTM_CD,'|')) FROM TB_POTI_ORGN WHERE ORGN_CD = #{deptCd}))))
        </if>
        <if test="uprOrgnCd != null and uprOrgnCd != ''">
            AND  A.CSTM_CD = #{uprOrgnCd}
        </if>
        <if test="orgnCd != null and orgnCd != ''">
            AND  (A.DEPT_CD = #{orgnCd} OR A.DEPT_CD IN (SELECT ORGN_CD FROM TB_POTI_ORGN WHERE (SELECT ACTV_CSTM_CD FROM TB_POTI_ORGN WHERE ORGN_CD = #{orgnCd}) LIKE '%'||ORGN_MGMT_CD||'%')
                                        OR A.DEPT_CD IN (SELECT ORGN_CD FROM TB_POTI_ORGN WHERE ORGN_MGMT_CD IN (SELECT UNNEST(STRING_TO_ARRAY(ACTV_CSTM_CD,'|')) FROM TB_POTI_ORGN WHERE ORGN_MGMT_CD IN (SELECT UNNEST(STRING_TO_ARRAY(ACTV_CSTM_CD,'|')) FROM TB_POTI_ORGN WHERE ORGN_CD = #{orgnCd})))
            )
        </if>
        <if test="mgPtCd != null and mgPtCd !=''">
            AND A.MG_PT_CD  = #{mgPtCd}
        </if>
        <if test="mgTpCd != null and mgTpCd !=''">
            AND A.MG_TP_CD  = #{mgTpCd}
        </if>
        <if test="rqstNo != null and rqstNo !=''">
            AND A.RQST_NO LIKE TRIM(#{rqstNo}) || '%'
        </if>
        <if test="nif != null and nif !=''">
            AND A.NIF LIKE #{nif}||'%'
        </if>
        <if test="mgNo != null and mgNo !=''">
            AND A.MG_NO LIKE TRIM(#{mgNo}) || '%'
        </if>
        <if test="mgValdSttsCd != null and mgValdSttsCd !=''">
            AND A.MG_VALD_STTS_CD = #{mgValdSttsCd}
        </if>
        <if test="jrpnIttCd != null and jrpnIttCd != ''">
            AND A.ITT_CD = #{jrpnIttCd}
        </if>
        <if test="rqstDtFrom != null and rqstDtFrom != '' and rqstDtTo != null and rqstDtTo != ''">
            AND A.RQST_DT <![CDATA[ >= ]]> TO_CHAR(TO_DATE(#{rqstDtFrom}, 'DD/MM/YYYY'), 'YYYYMMDD')
            AND A.RQST_DT <![CDATA[ <= ]]> TO_CHAR(TO_DATE(#{rqstDtTo}, 'DD/MM/YYYY'), 'YYYYMMDD')
        </if>
        <if test="rgsrDtFrom != null and rgsrDtFrom != '' and rgsrDtTo != null and rgsrDtTo != ''">
            AND A.RGSR_DT <![CDATA[ >= ]]> TO_CHAR(TO_DATE(#{rgsrDtFrom}, 'DD/MM/YYYY'), 'YYYYMMDD')
            AND A.RGSR_DT <![CDATA[ <= ]]> TO_CHAR(TO_DATE(#{rgsrDtTo}, 'DD/MM/YYYY'), 'YYYYMMDD')
        </if>
        <if test="refsYn != null and refsYn != ''">
            AND A.REFS_YN = #{refsYn}
        </if>
        <if test="coNm != null and coNm !=''">
            AND A.CO_NM LIKE '%'||TRIM(#{coNm}) || '%'
        </if>
        <if test="dclrNo != null and dclrNo !=''">
            AND A.DCLR_NO LIKE '%'||TRIM(#{dclrNo}) || '%'
        </if>
        <if test="dclrDtFrom != null and dclrDtFrom != '' and dclrDtTo != null and dclrDtTo != ''">
            AND A.DCLR_DT <![CDATA[ >= ]]> TO_CHAR(TO_DATE(#{dclrDtFrom}, 'DD/MM/YYYY'), 'YYYYMMDD')
            AND A.DCLR_DT <![CDATA[ <= ]]> TO_CHAR(TO_DATE(#{dclrDtTo}, 'DD/MM/YYYY'), 'YYYYMMDD')
        </if>
        <if test="prcsSttsCd != null and prcsSttsCd !=''">
            AND A.PRCS_STTS_CD = #{prcsSttsCd}
        </if>
        /*AND (
            A.MG_VALD_STTS_CD != '01'
            OR (
                A.MG_VALD_STTS_CD = '01'
                AND (
                    MG_NO NOT LIKE '%G'
                    OR (
                        MG_NO LIKE '%G'
                        AND (
                                (
                                    FRST_RGSR_DTTM  <![CDATA[ >= ]]>  TO_TIMESTAMP((SELECT PRMT_VAL_CN FROM TB_COM_PRMT WHERE DEL_YN = 'N' AND PRMT_ID = 'COL_0004'), 'YYYYMMDDHH24MI')
                                    AND 'I04' = (SELECT APRV_PRCS_STTS_CD FROM TB_POTI_APRV WHERE APRV_ID = A.APRV_ID AND DEL_YN = 'N')
                                )
                            OR
                                FRST_RGSR_DTTM  <![CDATA[ < ]]>  TO_TIMESTAMP((SELECT PRMT_VAL_CN FROM TB_COM_PRMT WHERE DEL_YN = 'N' AND PRMT_ID = 'COL_0004'), 'YYYYMMDDHH24MI')
                        )
                    )
                )
            )
        )*/
        ORDER BY A.FRST_RGSR_DTTM DESC
        <include refid="pagination.footer" />
    </select>

    <!--
    Consulter le crédit d'enlèvement !== 사후 납부 담보 조회 ==!
    -->
    <select id="selectAffcPayMgMgmt" parameterType="alpass.ipt.col.affc.vo.ColAffcPayMgMgmtVo" resultType="alpass.ipt.col.affc.vo.ColAffcPayMgMgmtVo">
        /** colAffcPayMgMgmt_selectAffcPayMgMgmt **/
        SELECT
            A.MG_NO                      /** N° de caution !== 담보번호 ==! */
            , A.NIF                        /** NIF !== 납세번호 ==! */
            , TO_CHAR(TO_DATE(A.VALD_STRT_DT, 'YYYYMMDD'),'DD/MM/YYYY') VALD_STRT_DT       /** Date du debut de validite !== 유효시작일자 ==! */
            , TO_CHAR(TO_DATE(A.VALD_END_DT, 'YYYYMMDD'),'DD/MM/YYYY') VALD_END_DT         /** Date de la fin de validite !== 유효종료일자 ==! */
            , A.REGST_ID                   /** ID de la personne enregistrant !== 등록자ID ==! */
            , TO_CHAR(TO_DATE(A.RGSR_DT, 'YYYYMMDD'),'DD/MM/YYYY') RGSR_DT                 /** Date de l'enregistrement !== 등록일자 ==! */
            , A.MG_EXTN_YN                 /** Caution cloturee (ON) !== 담보소멸여부 ==! */
            , TO_CHAR(TO_DATE(A.MG_EXTN_DT, 'YYYYMMDD'),'DD/MM/YYYY')  MG_EXTN_DT           /** Date de cloture de caution !== 담보소멸일자 ==! */
            , TO_CHAR(TO_DATE(A.MG_RELE_CRPP_PBLS_DT, 'YYYYMMDD'),'DD/MM/YYYY') MG_RELE_CRPP_PBLS_DT       /** Date de délivrance du certificat de décharge !== 담보해제증명서발행일자 ==! */
            , A.MG_RELE_CRPP_PBLH_ID       /** ID de personne délivrant le certificat de décharge !== 담보해제증명서발행자ID ==! */
            , A.MG_VALD_STTS_CD            /** Statut de validité !== 담보유효상태코드 ==! */
            , A.ATCH_FILE_ID               /** Date et heure de modification finale !== 첨부파일ID ==! */
            , A.DEL_YN                     /** Suppression ON !== 삭제여부 ==! */
            , A.FRST_REGST_ID              /** ID du premier enregistrant  !== 최초등록자ID ==! */
      , A.FRST_RGSR_DTTM /** Date et heure de premier enregistrement !== 최초등록일시 ==! */
      , A.LAST_CHPR_ID /** ID du modificateur final !== 최종변경자ID ==! */
      , A.LAST_CHG_DTTM /** Date et heure de modification finale !== 최종변경일시 ==! */
      , TO_CHAR(TO_DATE(A.VALD_STRT_DT, 'YYYYMMDD'),'DD/MM/YYYY')||' ~
      '||TO_CHAR(TO_DATE(A.VALD_END_DT, 'YYYYMMDD'),'DD/MM/YYYY') AS VALD_PRID /** Durée de validité
      de la caution !==담보유효기간==! */
      , A.REFS_YN
      , A.CSTM_WRTE_CN
      , A.RQST_NO
      , A.DEPT_CD
      , (SELECT ORGN_NM FROM TB_POTI_ORGN WHERE ORGN_CD = UPPER(A.DEPT_CD) AND DEL_YN = 'N') AS
      DEPT_NM
      , A.BNK_CD
      , A.BNK_BRNH_CD
      , A.BNK_BRNH_ADDR_NM
      , A.CO_ADDR
      , A.JOB_NM
      , A.RPPN_FNM
      , A.RPPN_NM
      , A.DBTR_NM
      , TO_CHAR(TO_DATE(A.RQST_DT, 'YYYYMMDD'),'DD/MM/YYYY') AS RQST_DT
      , A.PRCS_STTS_CD
      , A.MG_RTRN_RSN_CD
      , A.APRV_ID
      , A.CO_NM
            , (SELECT BNK_NM FROM TB_COM_BNK_CD WHERE DEL_YN = 'N' AND BNK_CD = A.BNK_CD) AS FNNC_ITT_NM     /** Nom de l'institution financière !== 금융기관명 ==! */
            , (SELECT MG_LMT_AMT FROM TB_COLI_MG_USE WHERE RQST_NO = A.RQST_NO AND ROWNUM = 1) AS MG_RQST_TAMT       /** Montant global de la soumission annuelle !== 담보총금액 ==! */
            , NVL(A.MG_AMT,0.0) AS MG_AMT      /** Montant de caution !== 담보금액 ==! */
            , FN_GET_ORGN_NM(A.CSTM_CD) AS CSTM_NM
            , A.CSTM_CD
            , (SELECT B.ORGN_CD FROM    TB_POTI_ORGN B, TB_POTI_ORGN C
                WHERE   C.UPR_ORGN_MGMT_CD = B.ORGN_MGMT_CD
                AND C.ORGN_CD = A.CSTM_CD
                AND B.DEL_YN            = 'N'
                AND C.DEL_YN            = 'N'
                ) AS SCTR_CD
            , (SELECT B.ORGN_NM FROM TB_POTI_ORGN B, TB_POTI_ORGN C
                WHERE   C.UPR_ORGN_MGMT_CD = B.ORGN_MGMT_CD
                AND C.ORGN_CD           = A.CSTM_CD
                AND B.DEL_YN            = 'N'
                AND C.DEL_YN            = 'N'
                ) AS SCTR_NM
            , A.CESE_CN
            , A.DCLR_NO
            , TO_CHAR(TO_DATE(A.DCLR_DT, 'YYYYMMDD'),'DD/MM/YYYY') AS DCLR_DT
            , A.MG_PT_CD
            , A.MG_TP_CD
            , A.RTRN_RSN_CN
            , CASE WHEN A.PRCS_STTS_CD = '06' THEN TO_CHAR(TO_DATE(A.MG_EXTN_DT, 'YYYYMMDD'),'DD/MM/YYYY')
                    ELSE NULL
                END AS DSMS_DT          /*기각일자*/
        FROM   TB_COLI_MG A
        WHERE   A.DEL_YN = 'N'                /** Suppression ON !== 삭제여부 ==! */
        <if test="mgPtCd != null and mgPtCd !=''">
            AND A.MG_PT_CD  = #{mgPtCd}
        </if>
        <if test="mgTpCd != null and mgTpCd !=''">
            AND A.MG_TP_CD  = #{mgTpCd}
        </if>
        <if test="rqstNo != null and rqstNo !=''">
            AND A.RQST_NO = #{rqstNo}
        </if>
        <if test="mgNo != null and mgNo !=''">
            AND A.MG_NO LIKE TRIM(#{mgNo}) || '%'
        </if>
    </select>

    <!--
    Approuver/rejeter la gestion des crédits d'enlèvement !== 사후 납부 담보 관리 승인/기각 처리 ==!
    -->
    <update id="updateAffcPayMgMgmtPrcsSttsCd" parameterType="alpass.ipt.col.affc.vo.ColAffcPayMgMgmtVo" >
        /** colAffcPayMgMgmt_updateAffcPayMgMgmtPrcsSttsCd **/
        UPDATE TB_COLI_MG SET
            PRCS_STTS_CD = #{prcsSttsCd}
            , APRV_ID = #{lastChprId}
            , LAST_CHPR_ID = #{lastChprId}     	/* ID du modificateur final !== 최종변경자ID ==! */
            , LAST_CHG_DTTM = SYSTIMESTAMP 		/* Date et heure de modification finale !== 최종변경일시 ==! */
            , ATCH_FILE_ID = #{atchFileId}
            , CSTM_WRTE_CN = #{cstmWrteCn}
            <if test="prcsSttsCd != null and prcsSttsCd == '02'.toString()">
                , REFS_YN = 'N'
                , MG_EXTN_YN = 'N'
            </if>

            <if test="prcsSttsCd != null and (prcsSttsCd == '03'.toString() or prcsSttsCd == '06'.toString())">
                , MG_RTRN_RSN_CD = #{mgRtrnRsnCd}
                , RTRN_RSN_CN = #{rtrnRsnCn}
                , REFS_YN = 'Y'
                , MG_EXTN_YN = 'Y'
                , MG_EXTN_DT = TO_CHAR(SYSTIMESTAMP,'YYYYMMDD')
                , MG_VALD_STTS_CD = '06'
            </if>

            <if test="prcsSttsCd != null and prcsSttsCd == '05'.toString()">
                , MG_NO = #{mgNo}
                , REFS_YN = 'N'
                , MG_EXTN_YN = 'N'
                , REGST_ID = #{lastChprId}
                , RGSR_DT = TO_CHAR(SYSTIMESTAMP,'YYYYMMDD')
                , MG_VALD_STTS_CD = '02'
            </if>
        WHERE RQST_NO = #{rqstNo}           /* 신청번호 !== 신청번호 ==!*/
    </update>

    <!--
    Consulter la liste de l'historique de l'utilisation dans la gestion des crédits d'enlèvement !==사후 납부 담보 관리 사용 이력 목록 조회==!
    -->
    <select id="selectAffcPayUseHistLst" parameterType="alpass.ipt.col.affc.vo.ColAffcPayMgMgmtVo" resultType="alpass.ipt.col.affc.vo.ColAffcPayMgMgmtVo">
        /** colAffcPayMgMgmt_selectAffcPayUseHistLst **/
        <include refid="pagination.header" />
        SELECT
            A.RQST_NO
            , B.USE_DGCNT
            , A.CO_NM
            , A.MG_NO                      /** N° de caution !== 담보번호 ==! */
            , B.MG_LMT_AMT
            , A.MG_AMT
            , TO_CHAR(B.USE_DTTM,'DD/MM/YYYY') AS USE_DTTM       /** Moment d'utilisation !== 사용일시 ==! */
            , TO_CHAR(TO_DATE(A.VALD_STRT_DT,'YYYYMMDD'),'DD/MM/YYYY') AS VALD_STRT_DT
            , B.USE_AMT
            , (
                A.MG_AMT
                - (SELECT NVL(SUM(USE_AMT),0) FROM TB_COLI_MG_USE WHERE RQST_NO = A.RQST_NO AND DEL_YN = 'N' AND USE_DGCNT <![CDATA[ <= ]]> B.USE_DGCNT)
                + (SELECT NVL(SUM(MG_RELE_AMT),0) FROM TB_COLI_MG_RELE WHERE RQST_NO = A.RQST_NO AND DEL_YN = 'N' AND USE_REFF_NO IN (SELECT REFF_NO FROM TB_COLI_MG_USE WHERE RQST_NO = A.RQST_NO AND DEL_YN = 'N' AND USE_DGCNT <![CDATA[ <= ]]> B.USE_DGCNT))
              ) AS USED_BLAMT
            , NVL(C.MG_RELE_AMT,0) AS RELE_AMT
            , B.REFF_NO
            , (SELECT BNK_NM FROM TB_COM_BNK_CD WHERE DEL_YN = 'N' AND BNK_CD = A.BNK_CD) AS FNNC_ITT_NM
            , TO_CHAR(B.USE_DTTM, 'DD/MM/YYYY') AS RQST_DT
            , FN_GET_ORGN_NM(D.DCLR_CSTM_CD) AS CSTM_NM
            , D.EPC_CD || ' | ' || (SELECT EPC_NM FROM TB_CLRI_EPC_CD WHERE EPC_CD = D.EPC_CD AND D.DCLR_DT BETWEEN EPC_APLY_STRT_DT AND EPC_APLY_END_DT AND ROWNUM = 1) AS REGM
            , TO_CHAR(TO_DATE(D.DCLR_DT, 'YYYYMMDD'),'DD/MM/YYYY') as DCLR_DT
            , FN_GET_ORGN_NM(D.DEPT_CD) AS DEPT_NM
            , E.RCVE_NO
            , TO_CHAR(TO_DATE(E.RCVE_DT, 'YYYYMMDD'),'DD/MM/YYYY') AS RCVE_DT       
            , F.CLT_NO                                                                  /** N° bon à enlever != 반출증번호 */
            , TO_CHAR(TO_DATE(F.RGSR_DT, 'YYYYMMDD'),'DD/MM/YYYY') AS CLT_RGSR_DT       /** Date bon à enlever != 반출증발행일자 */
            , TO_CHAR(TO_DATE(D.RLSE_DT, 'YYYYMMDD'),'DD/MM/YYYY') AS RLSE_DT           /** Date d‘enlèvement !== 반출일자 ==! */
        FROM   TB_COLI_MG A
             , TB_COLI_MG_USE B
             , TB_COLI_MG_RELE C
             , TB_CLRI_DED_COMN D
             , TB_COLI_RCVE E
             , TB_COLI_CLT_PBLS F
             , TB_COLI_NTFC G
        WHERE   A.DEL_YN = 'N'
        AND     B.DEL_YN = 'N'
        AND     A.RQST_NO = B.RQST_NO
        AND     B.RQST_NO = C.RQST_NO(+)   
        AND     B.REFF_NO = C.USE_REFF_NO(+)
        AND     B.REFF_NO = D.DTL_DCSH_NO
        AND     D.DTL_DCSH_NO = G.DCLR_NO
        AND     G.NTFC_NO = E.NTFC_NO(+)
        AND     G.NTFC_NO = F.NTFC_NO(+)
        <if test="mgPtCd != null and mgPtCd !=''">
            AND A.MG_PT_CD  = #{mgPtCd}
        </if>
        <if test="mgTpCd != null and mgTpCd !=''">
            AND A.MG_TP_CD  = #{mgTpCd}
        </if>
        <if test="rqstNo != null and rqstNo !=''">
            AND A.RQST_NO = #{rqstNo}
        </if>
        ORDER BY B.USE_DGCNT
        <include refid="pagination.footer" />
    </select>

    <!--
    Vérifier le cas qui n'est pas dans un état traitable. !==처리 가능한 상태가 아닌 경우를 검증한다==!
    -->
    <select id="selectIsAffcPayMgMgmtPrcsStts" resultType="string">
        /* colAffcPayMgMgmt_selectIsAffcPayMgMgmtPrcsStts */
        SELECT 1
        FROM TB_COLI_MG
        WHERE RQST_NO = #{rqstNo}
          AND PRCS_STTS_CD IN ('01','04')
          AND DEL_YN = 'N'
    </select>

    <!--
    Traitement de suspension/reprise de la gestion des crédits d'enlèvement !==사후 납부 담보 관리 중지/재개 처리==!
    -->
    <update id="updatePuseRopnSttsCd" parameterType="alpass.ipt.col.affc.vo.ColAffcPayMgMgmtVo" >
        /** colAffcPayMgMgmt_updatePuseRopnSttsCd **/
        UPDATE TB_COLI_MG A SET
        A.LAST_CHPR_ID = #{lastChprId}     	/* ID du modificateur final !== 최종변경자ID ==! */
        , A.LAST_CHG_DTTM = SYSTIMESTAMP 		/* Date et heure de modification finale !== 최종변경일시 ==! */
        <if test="mgValdSttsCd != null and mgValdSttsCd !=''">
            , MG_VALD_STTS_CD = #{mgValdSttsCd}
        </if>
        <if test="ceseCn != null and ceseCn !=''">
            , CESE_CN = #{ceseCn}
        </if>
        WHERE RQST_NO = #{rqstNo}           /* 신청번호 !== 신청번호 ==!*/
    </update>

    <!--
    Consultation du nombre de demandes de la gestion des crédits d'enlèvement !==사후 납부 담보 관리 신청 개수 조회==!
    -->
    <select id="selectAffcPayUseHistCount" resultType="int">
        /* colAffcPayMgMgmt_selectAffcPayUseHistCount */
        SELECT COUNT(*)
        FROM TB_COLI_MG_USE
        WHERE RQST_NO = #{rqstNo}
          AND DEL_YN = 'N'
    </select>

    <!--
    Traitement d'achèvement de My To-do !==나의 할일(TO-DO) 완료 처리==!
    -->
    <update id="updateMytodo" parameterType="alpass.com.todo.vo.ComTodoVo">
        /* colAffcPayMgMgmt_updateConfirmToDo */
        UPDATE TB_POTI_TODO
        SET TODO_STTS_CD = 'B'                   /** Code de statut de l'à faire !== 할일상태코드 ==! */
            , LAST_CHPR_ID = #{lastChprId}			/** ID du modificateur final !== 최종변경자ID ==! */
            , LAST_CHG_DTTM = SYSTIMESTAMP			/** Date et heure de modification finale !== 최종변경일시 ==! */
        WHERE DEL_YN = 'N'
        AND TODO_STTS_CD = 'A'                    /** Code de statut de l'à faire !== 할일상태코드 ==! */
        AND BSOP_CLSF_CD = #{bsopClsfCd}          /** Code de type de travail !== 업무분류코드 ==! */
        AND TODO_REFF_NO = #{todoReffNo}          /** N° de référence !== 참조번호 ==! */
        <if test="todoBsopTpCd != null and todoBsopTpCd != ''">
            AND TODO_BSOP_TP_CD = #{todoBsopTpCd}     /** Code de catégorie des tâches à faire !== 할일업무구분코드 ==! */
        </if>
        <if test="mdfyDgcnt != null and mdfyDgcnt != ''">
            AND MDFY_DGCNT = #{mdfyDgcnt}             /** Nombre de fois !==차수==! */
        </if>
        <if test="docDtlCd != null and docDtlCd != ''">
            AND DOC_DTL_CD = #{docDtlCd}              /** Code détaillé de document !==문서상세코드==! */
        </if>
        <if test="chpnId != null and chpnId != ''">
            AND CHPN_ID = #{chpnId}                   /** ID de charge !== 담당자ID ==! */
        </if>
        <if test="todoId != null and todoId != ''">
            AND TODO_ID = #{todoId}                   /** ID de charge !== 담당자ID ==! */
        </if>
    </update>


</mapper>