<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >

<mapper namespace="alpass.ipt.col.acnt.mapper.ColAcntExpnCrppSeoaMapper">

  <!--
      Consulter la liste des État de l'arrêté des certificats de dépenses !==지출증명서결산현황 목록을 조회한다==!
  -->
  <select id="selectColExpnCrppSeoaList" parameterType="alpass.ipt.col.com.vo.ColAcntExpnCrppSeoaVo"
    resultType="alpass.ipt.col.com.vo.ColAcntExpnCrppSeoaVo">
    /* ColAcntExpnCrppSeoaMapper_selectColExpnCrppSeoaList */
    <include refid="pagination.header"/>
    SELECT
    A.EXPN_CRPP_NO
    , A.DRWB_TRGT_AMT
    ,(SELECT 	B.ORGN_CD
        FROM 	TB_POTI_ORGN B,  TB_POTI_ORGN C
       WHERE 	C.HSRK_ORGN_MGMT_CD = B.ORGN_MGMT_CD
         AND  C.ORGN_CD           = A.CSTM_CD
         AND  B.DEL_YN            = 'N'
         AND  C.DEL_YN            = 'N'
      ) AS SCTR_CD
    , A.CSTM_CD
    , A.DEPT_CD
    , TO_CHAR(TO_DATE(A.EXPN_CRPP_RGSR_DT , 'YYYYMMDD'),'DD/MM/YYYY') AS EXPN_CRPP_RGSR_DT
    , A.AC_NO
    , A.RECP_NO
    , TO_CHAR(TO_DATE(A.RECP_DT , 'YYYYMMDD'),'DD/MM/YYYY') AS RECP_DT
    , A.EXPN_RSN_CD
    , A.ACCT_CD
    , A.DEPT_CD
    , A.CLTR_ID
    , A.TXPR_IDFY_NO_TP_CD	AS	EXPN_TXPR_IDFY_NO_TP_CD
    , A.TXPR_IDFY_NO AS	EXPN_TXPR_IDFY_NO
    , A.TXPR_NM AS EXPN_TXPR_NM
    , T.EXPN_AMT
    , T.CAST_ACCT_CD
    , T.DBTOR_ACCT_CD
    , T.EXPN_CRPP_CD
    , T.DTL_SRNO
    FROM TB_COLI_EXPN_CRPP A
      LEFT OUTER JOIN TB_COLI_EXPN_CRPP_DTL T  ON (A.EXPN_CRPP_NO = T.EXPN_CRPP_NO)
      RIGHT JOIN (
        SELECT EXPN_CRPP_NO, MAX(DTL_SRNO) AS DTL_SRNO FROM TB_COLI_EXPN_CRPP_DTL
        GROUP BY EXPN_CRPP_NO
        ) X ON (T.EXPN_CRPP_NO = X.EXPN_CRPP_NO AND T.DTL_SRNO = X.DTL_SRNO)
    WHERE  A.DEL_YN = 'N'
    <if test='cstmCd != null and cstmCd !="" '>
      AND A.CSTM_CD = #{cstmCd}
    </if>
    <if test="deptCd != null and deptCd != ''">
      AND A.DEPT_CD = #{deptCd}
    </if>
    <if test='expnCrppRgsrDtFrom != null and expnCrppRgsrDtFrom !="" and expnCrppRgsrDtTo != null and expnCrppRgsrDtTo !="" '>
      AND A.EXPN_CRPP_RGSR_DT BETWEEN TO_CHAR(TO_DATE(#{expnCrppRgsrDtFrom},'DD/MM/YYYY'),'YYYYMMDD') AND
      TO_CHAR(TO_DATE(#{expnCrppRgsrDtTo},'DD/MM/YYYY'),'YYYYMMDD')
    </if>
    <if test='dnlgPt == "D"'>
      <if test='expnRsnCd == null or expnRsnCd == ""'>
        AND A.EXPN_RSN_CD in ('001','002','005','007','009')
      </if>
    </if>
    <if test='dnlgPt == "O"'>
      <if test='expnRsnCd == null or expnRsnCd == ""'>
        AND A.EXPN_RSN_CD in ('003','004','006','008')
      </if>
    </if>
    <if test='expnRsnCd != null and expnRsnCd != ""'>
      AND A.EXPN_RSN_CD = #{expnRsnCd}
    </if>
    ORDER BY A.EXPN_CRPP_RGSR_DT DESC
    <include refid="pagination.footer"/>
  </select>

</mapper>